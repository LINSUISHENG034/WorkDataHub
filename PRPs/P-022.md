name: "Data Cleansing Framework Optimization"
description: |

## Purpose
Optimize the existing data cleansing framework architecture to eliminate over-engineering components while preserving core functionality needed to support migration of 21 legacy domains, ensuring the framework adheres to KISS and YAGNI principles.

## Core Principles
1. **Context is King**: Include ALL necessary documentation, examples, and caveats
2. **Validation Loops**: Provide executable tests/lints the AI can run and fix
3. **Information Dense**: Use keywords and patterns from the codebase
4. **Progressive Success**: Start simple, validate, then enhance
5. **Global rules**: Be sure to follow all rules in CLAUDE.md

---

## Goal
Simplify the data cleansing framework by removing over-engineered components while eliminating 151 lines of duplicate `clean_decimal_fields` code between domain models. Reduce total framework lines by 20-30% while maintaining core functionality for 21 legacy domain migrations.

## Why
- **Business value**: Eliminates code duplication across 21 confirmed legacy domains requiring migration
- **Integration**: Provides unified cleansing capabilities for enterprise-scale domain migration
- **Problems solved**: Removes 151 lines of duplicate decimal field cleaning logic between annuity_performance and trustee_performance domains
- **Maintenance**: Simplifies complex registry indexing system for easier future domain additions

## What
A simplified cleansing framework that:
- Eliminates duplicate `clean_decimal_fields` methods (151 lines total)
- Simplifies `CleansingRegistry` by removing complex multi-layer indexing
- Streamlines `CleansingRule` dataclass by removing unnecessary metadata fields
- Maintains Pydantic v2 integration with proper `@field_validator` patterns
- Preserves comprehensive decimal cleaning functionality and Chinese field name support

### Success Criteria
- [ ] Both existing domain models successfully use optimized cleansing framework
- [ ] `clean_decimal_fields` duplicate code (151 lines) is eliminated
- [ ] Registry system complexity reduced while maintaining basic functionality
- [ ] Framework total code lines reduced by 20-30%
- [ ] All existing tests continue to pass
- [ ] Chinese field names ("期初资产规模", "期末资产规模", etc.) continue to process correctly

## All Needed Context

### Documentation & References
```yaml
# MUST READ - Include these in your context window
- url: https://docs.pydantic.dev/latest/concepts/validators/
  why: Pydantic v2 field_validator patterns, mode="before" vs mode="after"
  
- url: https://docs.pydantic.dev/latest/migration/
  why: V1 to V2 migration guide for validator decorator changes
  
- file: src/work_data_hub/cleansing/rules/numeric_rules.py
  why: Contains comprehensive_decimal_cleaning function - the actual solution to duplication
  
- file: src/work_data_hub/domain/annuity_performance/models.py:257-336
  why: 80 lines of duplicate clean_decimal_fields method to be eliminated
  
- file: src/work_data_hub/domain/trustee_performance/models.py:167-237
  why: 71 lines of duplicate clean_decimal_fields method to be eliminated
  
- file: src/work_data_hub/cleansing/registry.py
  why: Complex indexing system to be simplified (254 lines)
  
- file: tests/test_cleansing_framework.py
  why: Existing test patterns for validation framework
  
- file: CLAUDE.md
  why: Project coding standards, KISS/YAGNI principles, line limits
```

### Implementation-Facing Research Notes
Purpose: Consolidate Pydantic v2 and cleansing framework research into actionable implementation guidance.

```yaml
sources:
  - url: https://docs.pydantic.dev/latest/concepts/validators/#field-validators
    section: field_validator decorator usage
    why: Critical for implementing mode="before" data cleansing pattern
    type: docs

  - url: https://docs.pydantic.dev/latest/concepts/validators/#model-validators
    section: mode parameter explanation
    why: Understanding when to use mode="before" vs mode="after"
    type: docs

tldr:
  - Use @field_validator with mode="before" for data cleansing (runs before Pydantic type conversion)
  - Use @classmethod decorator for all field validators in Pydantic v2
  - comprehensive_decimal_cleaning function already exists and solves duplication problem
  - Simple registry lookup is faster than complex indexing for 21 domains
  - Chinese field names require proper Unicode handling in validators

setup_commands:
  - "# No additional packages needed - using existing pydantic v2"
  - "uv run ruff check src/ --fix"
  - "uv run mypy src/"
  - "uv run pytest tests/test_cleansing_framework.py -v"

api_decisions:
  - name: field_validator decorator
    choice: mode="before" with @classmethod
    rationale: Required for data cleansing before type conversion
    
  - name: registry simplification
    choice: Remove complex indexing, keep name-based lookup
    rationale: Simpler is better for 21 domains, follows KISS principle
    
  - name: CleansingRule fields
    choice: Remove version, author, applicable_types, field_patterns
    rationale: Over-engineering, not needed for core functionality

versions:
  - library: pydantic
    constraint: "v2 (already in use)"
    compatibility: Python 3.10+, current project setup

pitfalls_and_mitigations:
  - issue: Pydantic v2 requires @classmethod for field validators
    mitigation: Always use @classmethod decorator in field validators
    
  - issue: mode="before" vs mode="after" confusion
    mitigation: Use mode="before" for data cleaning, mode="after" for validation
    
  - issue: Chinese field names Unicode handling
    mitigation: Test with actual Chinese field names from existing models
    
  - issue: Decimal precision loss during conversion
    mitigation: Use ROUND_HALF_UP and maintain existing precision mapping

open_questions:
  - Verify backward compatibility during transition phase
  - Confirm singleton registry pattern preservation
```

### Current Codebase tree
```bash
src/work_data_hub/
  cleansing/                    # Current framework (893 lines total)
    __init__.py                 # 137 lines - Framework entry point
    registry.py                 # 254 lines - Registry and indexing system [SIMPLIFY]
    rules/
      numeric_rules.py          # 286 lines - Core cleansing rules [PRESERVE/OPTIMIZE]
    integrations/
      pydantic_adapter.py       # 216 lines - Pydantic integration [SIMPLIFY]
  domain/
    annuity_performance/models.py    # Contains duplicate clean_decimal_fields (80 lines)
    trustee_performance/models.py    # Contains duplicate clean_decimal_fields (71 lines)
  
tests/
  test_cleansing_framework.py   # Existing validation framework
```

### Desired Codebase tree with files to be modified
```bash
src/work_data_hub/
  cleansing/                    # Optimized framework (~625 lines total, 30% reduction)
    __init__.py                 # ~137 lines - Framework entry point [UNCHANGED]
    registry.py                 # ~150 lines - Simplified registry [SIMPLIFIED FROM 254]
    rules/
      numeric_rules.py          # ~286 lines - Core cleansing rules [PRESERVED]
    integrations/
      pydantic_adapter.py       # ~120 lines - Simplified Pydantic integration [SIMPLIFIED FROM 216]
  domain/
    annuity_performance/models.py    # Remove 80-line clean_decimal_fields, use framework
    trustee_performance/models.py    # Remove 71-line clean_decimal_fields, use framework

tests/
  test_cleansing_framework.py   # Updated tests for simplified API
```

### Known Gotchas & Library Quirks
```python
# CRITICAL: Pydantic v2 requires @classmethod decorator for field validators
# Example: @field_validator('field_name') @classmethod def validate_field(cls, v): ...

# CRITICAL: mode="before" runs before Pydantic type conversion (for cleaning)
# mode="after" runs after conversion (for validation only)

# CRITICAL: Chinese field names require proper Unicode handling
# Fields: "期初资产规模", "期末资产规模", "供款", "当期收益率"

# CRITICAL: Decimal quantization must use ROUND_HALF_UP for financial consistency
# from decimal import ROUND_HALF_UP

# CRITICAL: Registry singleton pattern must be preserved for global state
# Current: CleansingRegistry.__new__ implements singleton

# CRITICAL: Use `rg` (ripgrep) for searches, not `grep/find` per project standards

# CRITICAL: comprehensive_decimal_cleaning function already exists and works
# Location: src/work_data_hub/cleansing/rules/numeric_rules.py:183-246
```

## Implementation Blueprint

### Data models and structure

Simplified cleansing framework maintaining core functionality while removing over-engineering.

```python
# Simplified CleansingRule (remove unnecessary fields)
@dataclass
class CleansingRule:
    name: str
    category: RuleCategory
    func: Callable
    description: str
    # REMOVED: applicable_types, field_patterns, version, author (over-engineering)

# Simplified CleansingRegistry (remove complex indexing)
class CleansingRegistry:
    _instance = None
    _rules: Dict[str, CleansingRule] = {}
    # REMOVED: _category_index, _type_index, _pattern_index (complex indexing)
    
    def register(self, rule: CleansingRule) -> None:
        """Register a cleansing rule by name."""
        self._rules[rule.name] = rule
    
    def get_rule(self, name: str) -> Optional[CleansingRule]:
        """Get rule by name for direct lookup."""
        return self._rules.get(name)
    
    def find_numeric_rules(self) -> List[CleansingRule]:
        """Find rules for numeric data types."""
        return [r for r in self._rules.values() if r.category == RuleCategory.NUMERIC]

# Domain model integration using Pydantic v2 patterns
class AnnuityPerformanceRecord(BaseModel):
    期初资产规模: Optional[Decimal] = None
    期末资产规模: Optional[Decimal] = None
    当期收益率: Optional[Decimal] = None
    
    @field_validator("期初资产规模", "期末资产规模", "当期收益率", mode="before")
    @classmethod
    def clean_decimal_fields(cls, v, info: FieldInfo):
        """Clean decimal fields using framework."""
        from src.work_data_hub.cleansing.rules.numeric_rules import comprehensive_decimal_cleaning
        return comprehensive_decimal_cleaning(v, field_name=info.field_name)
```

### List of tasks to be completed to fulfill the PRP in the order they should be completed

```yaml
Task 1: Simplify CleansingRule Dataclass
MODIFY src/work_data_hub/cleansing/registry.py:
  - FIND CleansingRule dataclass definition (lines 26-46)
  - REMOVE fields: applicable_types, field_patterns, version, author
  - PRESERVE fields: name, category, func, description
  - UPDATE __post_init__ validation logic accordingly

Task 2: Simplify CleansingRegistry Class  
MODIFY src/work_data_hub/cleansing/registry.py:
  - FIND CleansingRegistry class (lines 49-194)
  - REMOVE complex indexing: _category_index, _type_index, _pattern_index
  - REMOVE methods: find_by_type, find_by_field_pattern, _match_pattern
  - PRESERVE: singleton pattern, basic register/find_by_name functionality
  - ADD: simple find_by_category method for numeric rules

Task 3: Update Annuity Performance Model
MODIFY src/work_data_hub/domain/annuity_performance/models.py:
  - FIND clean_decimal_fields method (lines 258-337, 80 lines)
  - REPLACE entire method with simple call to comprehensive_decimal_cleaning
  - USE @field_validator(mode="before") @classmethod pattern
  - PRESERVE field names and precision requirements

Task 4: Update Trustee Performance Model
MODIFY src/work_data_hub/domain/trustee_performance/models.py:
  - FIND clean_decimal_fields method (lines 168-237, 71 lines)  
  - REPLACE entire method with simple call to comprehensive_decimal_cleaning
  - USE @field_validator(mode="before") @classmethod pattern
  - PRESERVE field names and precision requirements

Task 5: Simplify Pydantic Adapter Integration
MODIFY src/work_data_hub/cleansing/integrations/pydantic_adapter.py:
  - SIMPLIFY decimal_fields_cleaner decorator implementation
  - REMOVE complex _load_cleansing_rules logic
  - STREAMLINE to directly use comprehensive_decimal_cleaning function
  - MAINTAIN backward compatibility for existing usage

Task 6: Update Tests for Simplified API
MODIFY tests/test_cleansing_framework.py:
  - UPDATE tests to work with simplified registry API
  - REMOVE tests for removed complex indexing functionality
  - ADD tests for simplified field validator pattern
  - ENSURE Chinese field name processing still works

Task 7: Validate Framework Reduction
RUN validation commands:
  - COUNT total lines before and after changes
  - VERIFY 20-30% reduction achieved
  - CONFIRM all existing functionality preserved
  - VALIDATE no regressions in domain models
```

### Per task pseudocode

```python
# Task 1: Simplified CleansingRule
@dataclass
class CleansingRule:
    """Simplified cleansing rule - removed over-engineered fields."""
    name: str
    category: RuleCategory
    func: Callable
    description: str
    # REMOVED: applicable_types, field_patterns, version, author
    
    def __post_init__(self):
        """Validate rule has callable function."""
        if not callable(self.func):
            raise ValueError(f"Rule {self.name} must have a callable function")

# Task 2: Simplified CleansingRegistry  
class CleansingRegistry:
    """Simplified registry - removed complex indexing."""
    _instance = None
    _rules: Dict[str, CleansingRule] = {}
    # REMOVED: _category_index, _type_index, _pattern_index
    
    def register(self, rule: CleansingRule) -> None:
        """Register rule by name only."""
        self._rules[rule.name] = rule
        
    def get_rule(self, name: str) -> Optional[CleansingRule]:
        """Direct lookup by name."""
        return self._rules.get(name)
        
    def find_by_category(self, category: RuleCategory) -> List[CleansingRule]:
        """Simple category filtering."""
        return [r for r in self._rules.values() if r.category == category]

# Task 3 & 4: Domain Model Integration
class AnnuityPerformanceRecord(BaseModel):
    期初资产规模: Optional[Decimal] = None
    期末资产规模: Optional[Decimal] = None
    当期收益率: Optional[Decimal] = None
    
    @field_validator("期初资产规模", "期末资产规模", "当期收益率", mode="before")
    @classmethod
    def clean_decimal_fields(cls, v, info: FieldInfo):
        """Simplified field cleaning using framework function."""
        from src.work_data_hub.cleansing.rules.numeric_rules import comprehensive_decimal_cleaning
        
        # PATTERN: Use existing precision mapping
        precision_config = {
            "当期收益率": 6,
            "期初资产规模": 4,
            "期末资产规模": 4,
        }
        
        return comprehensive_decimal_cleaning(
            v, 
            field_name=info.field_name,
            precision_config=precision_config
        )
```

### Integration Points
```yaml
EXISTING_FRAMEWORK:
  - preserve: comprehensive_decimal_cleaning function (already works)
  - preserve: RuleCategory enum and basic rule registration
  - preserve: Pydantic v2 integration pattern
  
DOMAIN_MODELS:
  - update: Replace 151 lines of duplicate clean_decimal_fields code
  - preserve: Field names, precision requirements, error handling
  - maintain: Chinese field name support and Unicode handling
  
TESTING:
  - update: tests/test_cleansing_framework.py for simplified API
  - preserve: All existing test cases and validation logic
  - ensure: No regressions in decimal conversion and precision
```

## Validation Loop

### Level 1: Syntax & Style
```bash
# Run these FIRST - fix any errors before proceeding
uv run ruff check src/ --fix               # Auto-fix style issues
uv run mypy src/                           # Type checking

# Expected: No errors. If errors, READ and fix immediately.
```

### Level 2: Unit Tests
```bash
# Test core cleansing framework functionality
uv run pytest tests/test_cleansing_framework.py -v

# Test domain model integration  
uv run pytest tests/domain/ -k "decimal" -v

# Test specific domain models
uv run pytest tests/domain/test_trustee_performance.py -v
uv run pytest tests/domain/test_annuity_performance.py -v

# If failing: Debug specific test, understand root cause, fix code, re-run
```

### Level 3: Integration Test
```bash
# Test that Chinese field names still work correctly
uv run python -c "
from src.work_data_hub.domain.annuity_performance.models import AnnuityPerformanceRecord
from decimal import Decimal

# Test Chinese field names with currency symbols
record = AnnuityPerformanceRecord(
    期初资产规模='¥1,234.56',
    期末资产规模='￥2,345.67', 
    当期收益率='5.25%'
)
print(f'期初资产规模: {record.期初资产规模}')
print(f'期末资产规模: {record.期末资产规模}') 
print(f'当期收益率: {record.当期收益率}')
assert record.期初资产规模 == Decimal('1234.5600')
assert record.期末资产规模 == Decimal('2345.6700')
assert record.当期收益率 == Decimal('0.052500')
print('✅ Chinese field names and decimal cleaning work correctly')
"

# Expected: All assertions pass, proper decimal formatting
```

### Level 4: Framework Reduction Validation
```bash
# Count lines before and after optimization
echo "Counting framework lines..."
find src/work_data_hub/cleansing -name "*.py" -exec wc -l {} + | tail -1
find src/work_data_hub/domain -name "models.py" -exec grep -c "clean_decimal_fields" {} +

# Expected: 20-30% reduction in total framework lines
# Expected: Zero occurrences of old clean_decimal_fields duplicate code
```

## Final Validation Checklist
- [ ] All tests pass: `uv run pytest -v`
- [ ] No linting errors: `uv run ruff check src/`
- [ ] No type errors: `uv run mypy src/`
- [ ] Chinese field names process correctly in integration test
- [ ] Framework total lines reduced by 20-30%
- [ ] 151 lines of duplicate clean_decimal_fields code eliminated
- [ ] Both domain models use simplified cleansing framework
- [ ] Registry system simplified while maintaining core functionality
- [ ] comprehensive_decimal_cleaning function preserved and working
- [ ] Decimal precision and ROUND_HALF_UP behavior maintained

---

## Anti-Patterns to Avoid
- ❌ Don't remove comprehensive_decimal_cleaning function - it's the solution
- ❌ Don't break Chinese field name Unicode handling
- ❌ Don't change decimal precision or ROUND_HALF_UP behavior  
- ❌ Don't remove singleton registry pattern
- ❌ Don't use mode="after" for data cleansing - use mode="before"
- ❌ Don't forget @classmethod decorator in Pydantic v2 field validators
- ❌ Don't skip testing with actual Chinese field names and currency symbols

## Confidence Score: 9/10

High confidence due to:
- comprehensive_decimal_cleaning function already exists and works perfectly
- Clear duplicate code patterns identified (151 lines to eliminate)
- Well-defined simplification targets in registry and rule classes
- Existing test framework provides validation safety net
- Pydantic v2 patterns are well-researched and documented
- Clear acceptance criteria and measurable success metrics

Minor uncertainty on preserving exact Chinese field name behavior during refactoring, but comprehensive validation steps mitigate this risk.