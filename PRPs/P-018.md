name: "Annuity Performance Smoke Test Scaffold v2.03"
description: |

## Purpose
Create an opt-in test scaffold and documentation for running real-sample smoke tests for the "Annuity Performance (规模明细)" domain locally. This establishes a safe testing runway for future annuity performance pipeline development without touching discovery/DDL/pipeline logic.

## Core Principles
1. **Context is King**: Include ALL necessary documentation, examples, and caveats
2. **Validation Loops**: Provide executable tests/lints the AI can run and fix
3. **Information Dense**: Use keywords and patterns from the codebase
4. **Progressive Success**: Start simple, validate, then enhance
5. **Global rules**: Be sure to follow all rules in CLAUDE.md

---

## Goal
Add an opt-in test scaffold for "Annuity Performance (规模明细)" smoke testing that enables local, real-sample validation without affecting CI or existing pipeline logic. The scaffold should mirror existing smoke test patterns and provide a foundation for future development stages.

## Why
- **Business value**: Enables safe local validation of annuity performance data without disrupting production workflows
- **Integration**: Prepares foundation for future annuity performance pipeline integration
- **Problems solved**: Provides developers with local testing capabilities for Chinese financial data formats before implementing full pipeline integration

## What
A minimal, opt-in test infrastructure that:
- Creates `legacy_data` pytest marker for selective test execution
- Implements robust skip conditions to prevent CI failures
- Provides smoke test skeleton for annuity performance domain
- Updates README documentation with clear usage instructions

### Success Criteria
- [ ] `legacy_data` marker registered in pyproject.toml and skipped by default
- [ ] `tests/legacy/test_annuity_performance_smoke.py` created with robust skip conditions
- [ ] README updated with "Real Sample Smoke (Annuity Performance)" section
- [ ] CI unaffected (tests skipped by default)
- [ ] Tests pass when reference data is present

## All Needed Context

### Documentation & References
```yaml
# MUST READ - Include these in your context window
- file: tests/smoke/test_monthly_data_smoke.py
  why: Existing smoke test pattern to mirror, fixture setup, skip conditions, environment overrides
  
- file: pyproject.toml
  why: Current marker registration pattern (monthly_data), pytest configuration
  
- file: INITIAL.C-024.md
  why: Original requirements specification, acceptance criteria, implementation notes
  
- file: README.md
  why: Documentation structure for Local Smoke Test section, existing patterns
  
- file: src/work_data_hub/io/connectors/file_connector.py
  why: DataSourceConnector discovery pattern used in smoke tests
  
- file: src/work_data_hub/config/settings.py
  why: Settings override pattern for WDH_DATA_BASE_DIR
```

### Implementation-Facing Research Notes
```yaml
sources:
  - file: tests/smoke/test_monthly_data_smoke.py
    section: class TestMonthlyDataSmoke, fixture setup patterns
    why: Template for opt-in test structure and skip conditions
    type: codebase_pattern

  - external_research: pytest markers best practices
    section: marker registration, opt-in patterns, CI integration
    why: External validation of marker implementation approach
    type: best_practices

tldr:
  - Follow existing `monthly_data` marker pattern in pyproject.toml
  - Use fixture-based skip conditions (existing pattern) not conftest.py hooks
  - Mirror TestMonthlyDataSmoke class structure with robust error handling
  - Keep tests lightweight with discovery placeholders and plan-only assertions
  - Use WDH_DATA_BASE_DIR environment override for reference path configuration

setup_commands:
  - "No new dependencies required"
  - "mkdir tests/legacy (if not exists)"
  - "Update pyproject.toml markers section"

api_decisions:
  - name: pytest marker approach
    choice: fixture-based skip conditions (existing pattern)
    rationale: Maintains consistency with existing monthly_data marker implementation

  - name: skip condition strategy
    choice: Path.exists() check for reference/monthly directory
    rationale: Mirrors existing smoke test pattern, robust and clear

versions:
  - library: pytest
    constraint: existing (already in dependency-groups.dev)
    compatibility: python 3.10+, existing test infrastructure

pitfalls_and_mitigations:
  - issue: Windows paths and Unicode filenames in Chinese data
    mitigation: Use pathlib.Path for cross-platform compatibility, avoid hardcoded separators
  
  - issue: Tests running in CI by default affecting build times
    mitigation: Ensure marker is opt-in only, tests skip when reference data not present
  
  - issue: Hardcoded paths breaking test portability
    mitigation: Use environment variable overrides (WDH_DATA_BASE_DIR pattern)

open_questions:
  - Should tests create legacy/ directory or assume it exists?
  - Follow existing __init__.py pattern in test directories?
```

### Current Codebase tree
```bash
src/work_data_hub/
  config/
    settings.py            # pydantic‑settings; env vars prefixed WDH_*
    schema.py              # config schema validation
    data_sources.yml       # discovery patterns, selection, table/pk
  io/
    connectors/
      file_connector.py    # config‑driven file discovery
    readers/
      excel_reader.py      # resilient Excel ingestion
    loader/
      warehouse_loader.py  # PostgreSQL loader (plan‑only or execute)
  domain/
    trustee_performance/
      models.py            # Pydantic v2 models (in/out)
      service.py           # pure transformation functions
  orchestration/
    ops.py                 # discover/read/process/load ops
    jobs.py                # single/multi‑file jobs + CLI entry
    schedules.py           # production schedules
    sensors.py             # file/new‑data sensors
    repository.py          # Dagster Definitions registry
  utils/
    types.py               # shared types/helpers

tests/
  config/                  # config tests
  domain/trustee_performance/  # domain tests
  e2e/                     # end‑to‑end flows
  fixtures/                # test fixtures
  io/                      # IO layer tests
  orchestration/           # orchestration tests
  smoke/
    test_monthly_data_smoke.py  # existing smoke test pattern
  unit/                    # unit tests

reference/monthly/         # sample data location
  数据采集/
    V1/【for年金分战区经营分析】24年11月年金终稿数据1209采集.xlsx
```

### Desired Codebase tree with files to be added
```bash
tests/
  legacy/                  # new directory for legacy data tests
    test_annuity_performance_smoke.py  # new smoke test file
    __init__.py            # package init (following existing pattern)
```

### Known Gotchas of our codebase & Library Quirks
```python
# CRITICAL: Tests must be opt-in only; do not enable by default in CI
# CRITICAL: Use robust skip conditions (no sample root / no DB / no psycopg2)
# CRITICAL: Windows paths and Unicode filenames are common; use pathlib.Path
# CRITICAL: Follow existing monthly_data marker pattern in pyproject.toml
# CRITICAL: Keep tests lightweight with discovery and plan-only placeholders
# CRITICAL: Use WDH_DATA_BASE_DIR=./reference/monthly in examples, not hardcoded in tests
# CRITICAL: Mirror existing TestMonthlyDataSmoke fixture and error handling patterns
```

## Implementation Blueprint

### Data models and structure
No new data models required - this is a test scaffold that uses existing infrastructure.

### List of tasks to be completed to fulfill the PRP in the order they should be completed

```yaml
Task 1: Update pyproject.toml
MODIFY pyproject.toml:
  - FIND section: [tool.pytest.ini_options] markers = [
  - ADD new marker: "legacy_data: marks tests requiring legacy data samples (opt-in)"
  - PRESERVE existing markers (postgres, monthly_data)

Task 2: Create legacy test directory structure
CREATE tests/legacy/ directory:
  - CREATE directory if not exists
  - CREATE tests/legacy/__init__.py (following existing test package pattern)

Task 3: Implement annuity performance smoke test
CREATE tests/legacy/test_annuity_performance_smoke.py:
  - MIRROR pattern from: tests/smoke/test_monthly_data_smoke.py
  - MODIFY for annuity performance domain focus
  - KEEP existing error handling and skip condition patterns
  - USE @pytest.mark.legacy_data decorator

Task 4: Update README documentation
MODIFY README.md:
  - FIND section: "## Local Smoke Test"
  - INSERT new subsection: "Real Sample Smoke (Annuity Performance)"
  - MIRROR existing smoke test documentation pattern
  - INCLUDE environment variables and usage commands

Task 5: Validate implementation
RUN validation commands:
  - uv run ruff check src/ --fix
  - uv run mypy src/
  - uv run pytest -v (should skip legacy_data tests)
  - uv run pytest -m legacy_data -v (should run opt-in tests)
```

### Per task pseudocode as needed added to each task

```python
# Task 1: pyproject.toml update
# Add to existing markers array:
markers = [
    "postgres: marks tests as requiring a PostgreSQL database (deselect with '-m \"not postgres\"')",
    "monthly_data: marks tests requiring reference/monthly data (opt-in)",
    "legacy_data: marks tests requiring legacy data samples (opt-in)",  # NEW
]

# Task 3: Smoke test implementation structure
import os
import pytest
from pathlib import Path

pytestmark = pytest.mark.legacy_data  # Apply marker to entire module

class TestAnnuityPerformanceSmoke:
    """Smoke tests for annuity performance domain - opt-in via marker."""
    
    @pytest.fixture(autouse=True)
    def setup_legacy_data_env(self):
        """Setup environment for legacy data testing."""
        # PATTERN: Mirror existing monthly data fixture
        reference_path = Path("./reference/monthly")
        if not reference_path.exists():
            pytest.skip(f"Reference data not found at {reference_path}")
    
    def test_discovery_smoke(self):
        """Validates discovery when WDH_DATA_BASE_DIR=./reference/monthly."""
        # PATTERN: Follow existing discovery smoke test
        # GOTCHA: Use env override, not hardcoded paths
        with patch.dict(os.environ, {"WDH_DATA_BASE_DIR": "./reference/monthly"}):
            # Discovery/pipeline will be exercised in later stages
            assert True  # Placeholder until domain is wired

# Task 4: README documentation structure
## Real Sample Smoke (Annuity Performance)

Test annuity performance processing using real `reference/monthly/` sample data.

### Setup
1. **Ensure reference data exists**:
   ```bash
   # Data should be at:
   ./reference/monthly/数据采集/V1/【for年金分战区经营分析】*.xlsx
   ```

2. **Configure environment**:
   ```bash
   export WDH_DATA_BASE_DIR=./reference/monthly
   ```

### Usage
```bash
# Run annuity performance smoke tests (opt-in)
uv run pytest -m legacy_data -v

# Skip by default (normal test runs)
uv run pytest tests/
```
```

### Integration Points
```yaml
PYTEST_CONFIG:
  - add to: pyproject.toml [tool.pytest.ini_options] markers
  - pattern: "legacy_data: marks tests requiring legacy data samples (opt-in)"
  
TEST_STRUCTURE:
  - create: tests/legacy/ directory with __init__.py
  - pattern: Mirror tests/smoke/ structure and naming
  
DOCUMENTATION:
  - add to: README.md Local Smoke Test section  
  - pattern: Follow existing smoke test documentation format
```

## Validation Loop

### Level 1: Syntax & Style
```bash
# Run these FIRST - fix any errors before proceeding
uv run ruff check src/ --fix    # Auto-fix style issues
uv run ruff format .            # Format code
uv run mypy src/                # Type checking

# Expected: No errors. If errors, READ the error and fix.
```

### Level 2: Unit Tests
```python
# Validate marker registration and skip behavior:
def test_legacy_data_marker_skipped_by_default():
    """Test that legacy_data tests are skipped by default"""
    # Run pytest without -m legacy_data flag
    # Verify tests are skipped with proper reason

def test_legacy_data_marker_runs_when_opted_in():
    """Test that legacy_data tests run when explicitly requested"""  
    # Run pytest with -m legacy_data flag
    # Verify tests execute (or skip with proper reference data message)

def test_reference_data_skip_condition():
    """Test skip condition when reference data not present"""
    # Mock Path("./reference/monthly").exists() to return False
    # Verify pytest.skip is called with proper message
```

```bash
# Run and iterate until passing:
uv run pytest tests/ -v
# Should skip legacy_data tests and show reason

uv run pytest -m legacy_data -v  
# Should run legacy tests (or skip with reference data message)
```

### Level 3: Integration Test
```bash
# Test the complete opt-in workflow:

# 1. Verify default behavior (legacy tests skipped)
uv run pytest tests/

# Expected output should show:
# tests/legacy/test_annuity_performance_smoke.py::TestAnnuityPerformanceSmoke::test_discovery_smoke SKIPPED [100%] (Reference data not found at ./reference/monthly)

# 2. Test opt-in behavior
uv run pytest -m legacy_data -v

# Expected: Either runs tests (if reference data exists) or skips with clear message

# 3. Verify marker registration
uv run pytest --markers | grep legacy_data

# Expected: Shows legacy_data marker description
```

## Final validation Checklist
- [ ] All tests pass: `uv run pytest -v`
- [ ] Legacy data tests skipped by default with clear reason
- [ ] Legacy data tests run when opted in: `uv run pytest -m legacy_data -v`
- [ ] No linting errors: `uv run ruff check src/`
- [ ] No type errors: `uv run mypy src/`
- [ ] README documentation updated with clear usage instructions
- [ ] pyproject.toml contains legacy_data marker registration
- [ ] Directory structure created with proper __init__.py files
- [ ] Skip conditions work robustly (tested with/without reference data)

---

## Anti-Patterns to Avoid
- ❌ Don't enable legacy tests by default - they must be opt-in only
- ❌ Don't hardcode reference data paths in test code - use environment overrides
- ❌ Don't skip validation because tests are "just placeholders"
- ❌ Don't break existing CI by changing default test behavior
- ❌ Don't ignore Windows path compatibility issues
- ❌ Don't deviate from existing smoke test patterns without good reason

## Confidence Score: 9/10

High confidence due to:
- Clear existing patterns to follow (monthly_data marker, smoke test structure)
- Comprehensive codebase understanding from research
- Well-defined requirements with clear acceptance criteria
- Robust validation gates with executable commands
- External research validating pytest marker best practices

Minor uncertainty around whether tests/legacy directory exists, but creation is straightforward and follows existing patterns.