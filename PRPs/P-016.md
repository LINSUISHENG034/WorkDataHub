name: "Critical Stability Patches: C-019 through C-022 (Small fixes to reduce key use case failures)"
description: |

## Purpose
Implement minimal targeted fixes to address the four most critical failure clusters affecting end-to-end stability in the WorkDataHub pipeline. These changes focus on compatibility, robustness, and edge case handling without altering architecture or expanding scope.

## Core Principles
1. **Context is King**: Include ALL necessary documentation, examples, and caveats
2. **Validation Loops**: Provide executable tests/lints the AI can run and fix
3. **Information Dense**: Use keywords and patterns from the codebase
4. **Progressive Success**: Start simple, validate, then enhance
5. **Global rules**: Be sure to follow all rules in CLAUDE.md

---

## Goal
Fix four specific compatibility and robustness issues that are causing the majority of test failures in the WorkDataHub pipeline:
- C-019: Database settings compatibility layer with unified DSN retrieval
- C-020: ExcelReader robustness for consistent column handling and error messages
- C-021: Month extraction robustness in file discovery
- C-022: Trustee performance decimal/percentage handling with quantization stability

## Why
- **Business value**: Reduces end-to-end pipeline failure rate by addressing high-leverage issues
- **Integration**: Maintains backward compatibility while fixing critical edge cases
- **Problems solved**: Addresses configuration mismatches, data parsing inconsistencies, regex extraction issues, and decimal precision problems

## What
Implement minimal changes to five core files to fix compatibility and robustness issues:

### Success Criteria
- [ ] Configuration compatibility: `tests/io/test_warehouse_loader.py::TestDatabaseSettings::*` passes
- [ ] ExcelReader robustness: Year/month fields remain as strings, unnamed columns cleaned, corrupted file errors unified
- [ ] Month extraction: 12-month files correctly identified instead of matching "1"
- [ ] Decimal handling: `return_rate=5.5` correctly interpreted as percentage (0.055)
- [ ] No new mypy/ruff errors introduced

## All Needed Context

### Documentation & References
```yaml
# MUST READ - Include these in your context window
- url: https://docs.pydantic.dev/latest/concepts/validators/
  why: Pydantic v2 field validator patterns, mode="before" for data cleaning
  
- url: https://docs.python.org/3/library/decimal.html#decimal.Decimal.quantize
  why: Decimal quantization with ROUND_HALF_UP and scaleb methods

- file: src/work_data_hub/config/settings.py
  why: Current Settings class structure and database configuration pattern
  
- file: src/work_data_hub/orchestration/ops.py
  why: Current DSN retrieval pattern in load_op, line 326-327
  
- file: src/work_data_hub/io/readers/excel_reader.py  
  why: Current ExcelReader structure and _dataframe_to_rows method
  
- file: src/work_data_hub/io/connectors/file_connector.py
  why: Current file discovery and regex month extraction logic
  
- file: src/work_data_hub/domain/trustee_performance/models.py
  why: Current clean_decimal_fields validator pattern and quantization approach

- file: tests/io/test_warehouse_loader.py
  why: Expected DatabaseSettings import and API from failing tests (line 270-287)
  
- file: tests/io/test_excel_reader.py
  why: Test expectations for string year/month handling and error messages (lines 83-84, 149)
```

### Current Codebase Tree (relevant sections)
```bash
src/work_data_hub/
├── config/
│   └── settings.py           # Settings class with database_* fields
├── orchestration/
│   └── ops.py               # load_op with DSN retrieval 
├── io/
│   ├── connectors/
│   │   └── file_connector.py # Month regex extraction in _scan_directory_for_domain
│   └── readers/
│       └── excel_reader.py   # _dataframe_to_rows column cleaning
└── domain/
    └── trustee_performance/
        └── models.py         # clean_decimal_fields validator

tests/
├── io/
│   ├── test_warehouse_loader.py # DatabaseSettings import expectations
│   └── test_excel_reader.py     # String year/month and error message tests
└── domain/trustee_performance/
    └── test_models.py            # return_rate percentage conversion tests
```

### Known Gotchas & Library Quirks
```python
# CRITICAL: Pydantic v2 uses field_validator with mode="before" for data cleaning
# CRITICAL: Decimal quantization should use scaleb(-places) for robust quantizer construction
# CRITICAL: pandas read_excel with openpyxl requires zipfile.BadZipFile handling
# CRITICAL: Regex alternation (?P<month>0?[1-9]|1[0-2]) matches leftmost alternative first
# CRITICAL: psycopg2 connection management requires explicit close() in finally blocks  
# CRITICAL: Column name cleaning must handle "Unnamed: n" patterns to empty strings
# CRITICAL: Settings class uses WDH_ prefix with double underscore for nested fields
# CRITICAL: Return rate >1 values should be interpreted as percentages when <= 100
```

## Implementation Blueprint

### Data models and structure
The existing models and configuration classes will be minimally extended:

```python
# C-019: Add DatabaseSettings compatibility class
class DatabaseSettings:
    def __init__(self, host, port, user, password, db, uri=None):
        # Lightweight compatibility wrapper
    
    def get_connection_string(self) -> str:
        # Return DSN string compatible with existing tests

# C-020: Enhanced error handling for Excel reading
# Catch zipfile.BadZipFile and openpyxl exceptions -> ExcelReadError("Failed to parse Excel file...")

# C-021: Post-process regex match results for month extraction
# Check if single digit followed by another digit forms valid 10-12 month

# C-022: Enhanced return_rate processing in clean_decimal_fields
# Detect numeric values >1 and <=100, interpret as percentages
```

### List of tasks to be completed to fulfill the PRP in order

```yaml
Task 1: Database Settings Compatibility Layer (C-019)
MODIFY src/work_data_hub/config/settings.py:
  - ADD lightweight DatabaseSettings class with constructor taking individual fields
  - ADD get_connection_string() method returning DSN  
  - ADD database property to Settings class assembling from existing database_* fields
  - MODIFY existing get_database_connection_string() to delegate to self.database.get_connection_string()
  - PRESERVE existing database_uri direct connection priority logic

MODIFY src/work_data_hub/orchestration/ops.py:
  - ADD fallback DSN retrieval in load_op around line 327
  - WRAP primary settings.get_database_connection_string() call in try/except
  - ADD fallback to settings.database.get_connection_string() for test compatibility

Task 2: ExcelReader Error Handling and Column Cleaning (C-020)  
MODIFY src/work_data_hub/io/readers/excel_reader.py:
  - ADD zipfile.BadZipFile import
  - MODIFY read_rows method exception handling to catch zipfile.BadZipFile
  - ADD openpyxl exception catching to unify error messages
  - MODIFY _dataframe_to_rows method to handle column name cleaning
  - ADD regex pattern to convert "Unnamed: n" columns to empty strings
  - PRESERVE existing data type handling but ensure year/month stay as strings

Task 3: Month Extraction Robustness (C-021)
MODIFY src/work_data_hub/io/connectors/file_connector.py:
  - LOCATE month extraction in _scan_directory_for_domain method around line 230-240
  - ADD post-processing logic after regex match
  - CHECK if month is single digit and next character would form valid 10-12 month
  - MODIFY month value when appropriate without changing original regex pattern

Task 4: Decimal/Percentage Handling and Quantization (C-022)
MODIFY src/work_data_hub/domain/trustee_performance/models.py:
  - MODIFY clean_decimal_fields validator around line 170
  - ADD return_rate percentage detection for numeric values >1 and <=100
  - REPLACE current quantizer construction with Decimal(1).scaleb(-places) pattern
  - ADD ROUND_HALF_UP explicit rounding mode for robustness
  - PRESERVE existing logic for net_asset_value and fund_scale fields
```

### Per task pseudocode

```python
# Task 1: DatabaseSettings Compatibility (C-019)
class DatabaseSettings:
    def __init__(self, host: str, port: int, user: str, password: str, db: str, uri: Optional[str] = None):
        # Store parameters for DSN construction
        
    def get_connection_string(self) -> str:
        # PATTERN: Mirror existing Settings.get_database_connection_string() logic
        if self.uri:
            return self.uri
        return f"postgresql://{self.user}:{self.password}@{self.host}:{self.port}/{self.db}"

class Settings:
    @property
    def database(self) -> DatabaseSettings:
        # PATTERN: Assemble from existing self.database_* fields
        return DatabaseSettings(
            host=self.database_host,
            port=self.database_port, 
            user=self.database_user,
            password=self.database_password,
            db=self.database_db,
            uri=self.database_uri
        )

# Task 2: ExcelReader Robustness (C-020)
def read_rows(self, file_path, ...):
    try:
        # Existing pandas read_excel logic
    except zipfile.BadZipFile:
        raise ExcelReadError(f"Failed to parse Excel file {file_path}: corrupted or invalid format")
    except Exception as e:
        # PATTERN: Unify error messages for openpyxl-related issues
        if "openpyxl" in str(e):
            raise ExcelReadError(f"Failed to parse Excel file {file_path}: {e}")

def _dataframe_to_rows(self, df):
    # PATTERN: Clean unnamed columns before processing
    cleaned_columns = []
    for col in df.columns:
        col_str = str(col).strip()
        if re.match(r'^Unnamed:\s*\d+', col_str):
            cleaned_columns.append("")  # Convert to empty string
        else:
            cleaned_columns.append(col_str)
    df.columns = cleaned_columns

# Task 3: Month Extraction Fix (C-021)  
def _scan_directory_for_domain(self, ...):
    match = pattern.search(filename)
    if match:
        groups = match.groupdict()
        month = groups.get("month")
        
        # CRITICAL: Post-process month extraction
        if month and len(month) == 1 and month in "12":
            # Check if this is actually part of "10", "11", or "12"
            match_end = match.end("month")
            if match_end < len(filename):
                next_char = filename[match_end]
                if month == "1" and next_char in "012":
                    month = month + next_char  # Form "10", "11", "12"

# Task 4: Decimal/Percentage Robustness (C-022)
@field_validator("return_rate", mode="before") 
def clean_decimal_fields(cls, v, info):
    # PATTERN: Check for percentage interpretation
    if info.field_name == "return_rate" and isinstance(v, (int, float)):
        if 1 < v <= 100:  # Interpret as percentage
            v = v / 100.0
    
    # PATTERN: Robust quantizer construction  
    from decimal import ROUND_HALF_UP
    places = 6 if info.field_name == "return_rate" else 4
    quantizer = Decimal(1).scaleb(-places)  # More robust than string construction
    return Decimal(str(v)).quantize(quantizer, rounding=ROUND_HALF_UP)
```

### Integration Points
```yaml
SETTINGS:
  - maintain: WDH_ environment variable prefix support
  - preserve: Existing database_uri priority override logic
  - add: DatabaseSettings compatibility layer for tests
  
OPERATIONS:
  - preserve: Existing connection management patterns
  - add: Fallback DSN retrieval for test compatibility
  - maintain: Transaction handling in warehouse_loader

VALIDATION:  
  - preserve: Existing Pydantic v2 field validation structure
  - enhance: Decimal quantization robustness with scaleb method
  - add: Percentage detection for return_rate fields

ERROR_HANDLING:
  - unify: Excel file parsing error messages
  - preserve: Existing exception hierarchy and types
  - enhance: zipfile.BadZipFile and openpyxl exception handling
```

## Validation Loop

### Level 1: Syntax & Style
```bash
# Run these FIRST - fix any errors before proceeding
uv run ruff check src/ --fix        # Auto-fix style issues
uv run mypy src/                     # Type checking

# Expected: No errors. If errors, READ and fix.
```

### Level 2: Unit Tests - Key Affected Areas
```bash
# Test database settings compatibility 
uv run pytest tests/io/test_warehouse_loader.py::TestDatabaseSettings -v

# Test Excel reader robustness
uv run pytest tests/io/test_excel_reader.py -k "read_rows_success or corrupted_file or column_name_cleaning" -v

# Test file connector month extraction
uv run pytest tests/io/test_file_connector.py -k "latest_by_year_month_selection" -v

# Test trustee performance decimal handling  
uv run pytest tests/domain/trustee_performance/test_models.py -k "validator_handles_various_input_types" -v

# Test end-to-end pipeline
uv run pytest tests/e2e/test_trustee_performance_e2e.py -k "complete_pipeline_plan_only_mode" -v
```

### Level 3: Full Integration Test
```bash
# Run complete test suite to ensure no regressions
uv run pytest -v

# Expected: All tests pass or show clear improvement in failure count
# Focus: Should see specific test cases mentioned in INITIAL.md now passing
```

## Final validation Checklist
- [ ] All syntax/style checks pass: `uv run ruff check src/` and `uv run mypy src/`
- [ ] DatabaseSettings can be imported and generates correct DSN
- [ ] Excel reader handles corrupted files with "Failed to parse Excel file" message
- [ ] Year/month fields from Excel remain as strings (not integers)
- [ ] Unnamed Excel columns are converted to empty strings
- [ ] Month extraction correctly identifies "12" instead of "1" 
- [ ] return_rate=5.5 converts to 0.055000 (percentage interpretation)
- [ ] Decimal quantization uses robust scaleb construction with ROUND_HALF_UP
- [ ] No new mypy or ruff errors introduced
- [ ] Key failing test cases now pass

---

## Anti-Patterns to Avoid
- ❌ Don't change test files - these fixes are code-only changes
- ❌ Don't modify data_sources.yml configuration files
- ❌ Don't alter existing API contracts beyond adding compatibility layers
- ❌ Don't use hardcoded decimal quantizers - use scaleb(-places) pattern
- ❌ Don't catch broad Exception types when specific exceptions are appropriate
- ❌ Don't change regex patterns in test configurations
- ❌ Don't modify column naming expectations beyond cleaning unnamed columns

## Confidence Score: 9/10

High confidence due to:
- Clear, specific requirements from INITIAL.md with exact line references
- Well-documented existing patterns to follow in the codebase
- Targeted changes that preserve existing behavior while fixing edge cases
- Comprehensive test validation gates to ensure success
- Research-backed approaches for decimal quantization and error handling

Minor uncertainty only around exact regex match position handling in month extraction, but the pattern is well-documented in the requirements.