name: "Bugfix PRP: Pydantic v2 ValidationError Misuse in Trustee Performance Service"
description: |

## Purpose
Fix incorrect manual construction of pydantic.ValidationError instances in trustee_performance service that causes TypeError crashes when processing invalid input data (e.g., month == 13). Restore graceful validation behavior and align error semantics with existing tests and design contracts.

## Core Principles
1. **Context is King**: Include ALL necessary documentation, examples, and caveats
2. **Validation Loops**: Provide executable tests/lints the AI can run and fix  
3. **Information Dense**: Use keywords and patterns from the codebase
4. **Progressive Success**: Start simple, validate, then enhance
5. **Global rules**: Follow all rules in CLAUDE.md

---

## Goal
Eliminate TypeError crashes in trustee_performance service when processing rows with invalid date values (e.g., month=13) by correcting Pydantic v2 ValidationError handling and aligning behavior with existing test contracts.

## Why
- **Business Impact**: Service crashes prevent processing of trustee performance data batches, blocking ETL pipeline
- **Technical Debt**: Manual ValidationError construction violates Pydantic v2 patterns and causes runtime failures
- **Test Alignment**: Current implementation contradicts existing test expectations that invalid dates return `None`

## What
Fix exception handling in `src/work_data_hub/domain/trustee_performance/service.py` to:
- Remove manual ValidationError constructions that cause TypeError in Pydantic v2
- Return `None` for invalid date ranges instead of raising ValidationError (per existing test contracts)
- Allow original Pydantic ValidationError instances to bubble up without wrapping
- Maintain informative logging when filtering invalid data

### Success Criteria
- [ ] No TypeError crashes when processing month=13 or other invalid date values
- [ ] `_extract_report_date` returns `None` for invalid year/month ranges
- [ ] All existing trustee_performance tests pass
- [ ] Bug reproducer test validates corrected behavior
- [ ] Validation gates pass: ruff, mypy, pytest

## All Needed Context

### Documentation & References
```yaml
# MUST READ - Include these in your context window
- url: https://docs.pydantic.dev/latest/errors/
  why: Pydantic v2 ValidationError construction patterns and best practices
  
- url: https://docs.pydantic.dev/latest/usage/validators/
  why: Proper validator error handling in Pydantic v2
  
- file: src/work_data_hub/domain/trustee_performance/service.py
  why: Contains the buggy ValidationError constructions (lines 120, 154, 204-215)
  critical: Manual ValidationError("string") construction fails in v2
  
- file: tests/domain/trustee_performance/test_service.py  
  why: Shows expected behavior - invalid dates should return None (lines 223-229)
  pattern: test_extract_date_invalid_month expects result is None
  
- file: tests/domain/trustee_performance/test_service_bug.py
  why: Bug reproducer that crashes with TypeError
  critical: Month=13 triggers the manual ValidationError construction bug
  
- external_research: "Pydantic v2 ValidationError requires line_errors parameter, not string. Use ValueError in custom validation or let original ValidationError bubble up"
```

### Current Codebase Structure
```bash
src/work_data_hub/domain/trustee_performance/
├── __init__.py
├── models.py                    # TrusteePerformanceIn/Out models
└── service.py                   # Contains buggy ValidationError handling

tests/domain/trustee_performance/
├── __init__.py  
├── test_service.py             # Existing tests expect None for invalid dates
└── test_service_bug.py         # Bug reproducer (crashes with TypeError)
```

### Known Gotchas & Library Quirks
```python
# CRITICAL: Pydantic v2 ValidationError cannot be constructed with just a string
# ❌ BROKEN in v2: raise ValidationError("Invalid month")  
# ✅ CORRECT: raise ValueError("Invalid month") or let original ValidationError bubble

# CRITICAL: Existing tests expect _extract_report_date to return None for invalid ranges
# Lines 223-229 in test_service.py: test_extract_date_invalid_month expects None

# CRITICAL: Current TypeError crash location in service.py:
# Line 120: except ValidationError as e: raise ValidationError(f"Input validation failed: {e}")
# Line 154: except ValidationError as e: raise ValidationError(f"Output validation failed: {e}")  
# Line 207: raise ValidationError(f"Invalid month {month} in row {row_index}")
# Line 213: raise ValidationError(f"Cannot construct date from year={year}, month={month}: {e}")

# CRITICAL: Use uv run for all Python commands per CLAUDE.md
# CRITICAL: Line length max 100 characters per CLAUDE.md ruff config
```

## Implementation Blueprint

### Data models and structure
Models remain unchanged - the bug is purely in error handling logic:
```python
# No changes needed to TrusteePerformanceIn/Out models
# Bug is in service.py exception handling only
```

### List of tasks to be completed

```yaml
Task 1: Fix ValidationError wrapping in _transform_single_row
MODIFY src/work_data_hub/domain/trustee_performance/service.py:
  - FIND lines 119-121: "except ValidationError as e: raise ValidationError(f'Input validation failed: {e}')"
  - REPLACE with: "except ValidationError: raise"
  - FIND lines 153-154: "except ValidationError as e: raise ValidationError(f'Output validation failed: {e}')" 
  - REPLACE with: "except ValidationError: raise"
  - PRESERVE all existing logging and logic flow

Task 2: Fix manual ValidationError construction in _extract_report_date  
MODIFY src/work_data_hub/domain/trustee_performance/service.py:
  - FIND lines 203-205: "if not (2000 <= year <= 2030): raise ValidationError(...)"
  - REPLACE with: log debug message and return None
  - FIND lines 206-208: "if not (1 <= month <= 12): raise ValidationError(...)"
  - REPLACE with: log debug message and return None
  - FIND lines 212-215: "except ValueError as e: raise ValidationError(...)"
  - REPLACE with: log debug message and return None
  - PATTERN: Follow existing debug logging style from lines 176, 182

Task 3: Update bug reproducer test to validate fix
MODIFY tests/domain/trustee_performance/test_service_bug.py:
  - FIND function: test_transform_row_with_invalid_month_reproduces_bug
  - REPLACE test body to assert no TypeError and proper None handling
  - ADD assertion that result is None (filtered out)
  - PRESERVE test documentation explaining the original bug

Task 4: Validate all existing tests pass
RUN validation commands:
  - uv run pytest tests/domain/trustee_performance/ -v
  - uv run ruff check src/work_data_hub/domain/trustee_performance/ --fix
  - uv run mypy src/work_data_hub/domain/trustee_performance/
```

### Per task pseudocode

```python
# Task 1: Fix ValidationError wrapping
# Lines 119-121 BEFORE:
except ValidationError as e:
    raise ValidationError(f"Input validation failed: {e}")

# Lines 119-121 AFTER:
except ValidationError:
    raise  # Let original ValidationError bubble up

# Task 2: Fix _extract_report_date invalid range handling
# Lines 206-208 BEFORE:
if not (1 <= month <= 12):
    raise ValidationError(f"Invalid month {month} in row {row_index}")

# Lines 206-208 AFTER: 
if not (1 <= month <= 12):
    logger.debug(f"Row {row_index}: Invalid month {month}; returning None")
    return None

# Similar pattern for year validation and date construction ValueError
```

### Integration Points
```yaml
LOGGING:
  - pattern: Use existing logger.debug() pattern from lines 176, 182
  - format: "Row {row_index}: Invalid {field} {value}; returning None"
  
EXISTING_CONTRACTS:
  - _extract_report_date returns Optional[date] - None means "cannot determine date"
  - Test expectations: invalid ranges → None (lines 221, 229 in test_service.py)
  - process() already handles None return values by filtering rows
```

## Validation Loop

### Level 1: Syntax & Style  
```bash
# Run these FIRST - fix any errors before proceeding
uv run ruff check src/work_data_hub/domain/trustee_performance/ --fix
uv run mypy src/work_data_hub/domain/trustee_performance/

# Expected: No errors. If errors, READ and fix.
```

### Level 2: Unit Tests - Focused Bug Validation
```bash
# Test the specific bug fix first
uv run pytest tests/domain/trustee_performance/test_service_bug.py -v
# Expected: PASS (no more TypeError)

# Test existing invalid date handling
uv run pytest -k "test_extract_date_invalid_month or test_extract_date_invalid_year" -v  
# Expected: PASS (returns None as expected)

# Run all trustee_performance tests
uv run pytest tests/domain/trustee_performance/ -v
# Expected: All tests pass
```

### Level 3: Integration Test - Manual Verification
```python
# Manual test script to verify fix:
from src.work_data_hub.domain.trustee_performance.service import _transform_single_row

# This should NOT crash and should return None (filtered out)
bug_row = {
    "年": "2024", 
    "月": "13",  # Invalid month
    "计划代码": "TEST",
    "公司代码": "TEST"
}

result = _transform_single_row(bug_row, "test", 0)
assert result is None  # Row filtered out due to invalid date

print("✅ Bug fix verified - no TypeError crash")
```

## Final Validation Checklist
- [ ] No TypeError when processing month=13: `uv run pytest tests/domain/trustee_performance/test_service_bug.py`
- [ ] Invalid dates return None: `uv run pytest -k test_extract_date_invalid_month`
- [ ] All existing tests pass: `uv run pytest tests/domain/trustee_performance/ -v`
- [ ] No linting errors: `uv run ruff check src/work_data_hub/domain/trustee_performance/`
- [ ] No type errors: `uv run mypy src/work_data_hub/domain/trustee_performance/`
- [ ] Debug logging is informative when returning None
- [ ] Original ValidationError instances bubble up correctly  

---

## Anti-Patterns to Avoid
- ❌ Don't manually construct ValidationError("string") in Pydantic v2
- ❌ Don't wrap existing ValidationError - let them bubble up
- ❌ Don't change _extract_report_date contract - it should return None for invalid data
- ❌ Don't skip the existing tests - they define expected behavior
- ❌ Don't remove debug logging - it helps diagnose data issues

## Confidence Score: 9/10

High confidence due to:
- Clear identification of exact problem lines and solutions
- Existing tests define expected behavior precisely  
- Simple, surgical changes required (no complex refactoring)
- Well-researched Pydantic v2 patterns
- Comprehensive validation approach

Minor uncertainty only around exact debug message formatting to match existing style.