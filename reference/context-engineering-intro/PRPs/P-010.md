name: "Mapping Loader Portability + Config Hardening (C-013)"
description: |
  Enhance mapping_loader to resolve YAML seed locations portably across execution contexts and support WDH_MAPPINGS_DIR environment override. 
  Add optional single fail-fast validation for data_sources.yml in orchestration. Maintain exact behavior compatibility.

---

## Goal
Make the mapping loader system portable across execution contexts while supporting environment overrides for flexible deployment configurations. Add optional fail-fast validation without changing runtime behavior or touching EAST/DB/network functionality.

## Why
- **Execution Context Portability**: Current mapping loader breaks when invoked from different working directories due to hardcoded repo-relative paths
- **Deployment Flexibility**: Need `WDH_MAPPINGS_DIR` environment override capability for dev/test/prod environments without code changes
- **Fail-Fast Configuration**: Early validation of data_sources.yml prevents cryptic runtime failures with actionable error messages
- **CI/CD Reliability**: Tests must work regardless of execution directory to prevent pipeline failures
- **Zero Behavior Change**: Enhancement should be transparent to existing functionality

## What
Enhanced `mapping_loader.py` with robust path resolution and optional configuration validation:
- `get_mappings_dir()` function supporting module-relative defaults and environment overrides
- All loader functions updated to use portable path resolution via `get_mappings_dir()`
- Comprehensive test coverage for portability scenarios and environment overrides
- Optional single validation call in `orchestration/ops.py` with clear error logging

### Success Criteria
- [ ] `mapping_loader` uses `get_mappings_dir()` for all path resolution with `WDH_MAPPINGS_DIR` override support
- [ ] Portability tests verify functionality works from any working directory
- [ ] Environment override tests cover valid directory, missing directory, and file-instead-of-directory scenarios
- [ ] Optional validation integrated into `ops.py` with structured error logging
- [ ] All validation gates pass (ruff, mypy, pytest) with enhanced functionality
- [ ] Existing YAML seed content and Chinese character handling preserved

## All Needed Context

### Documentation & References
```yaml
# MUST READ - Include these in your context window
- file: src/work_data_hub/config/mapping_loader.py
  why: Current implementation patterns, MappingLoaderError class, existing loader functions
  critical: Uses module-relative paths, UTF-8 Chinese character handling, Dict[str,str] return types
  
- file: tests/config/test_mapping_loader.py  
  why: Existing test patterns, fixtures, known test values, Chinese character preservation
  critical: Tests expect specific values like "内蒙"→"G31", "集合计划"→"QTAN001", "FP0001"→"614810477"
  
- file: src/work_data_hub/config/schema.py
  why: validate_data_sources_config function for optional integration
  critical: Raises DataSourcesValidationError on failure, returns True on success
  
- file: src/work_data_hub/orchestration/ops.py
  why: Location for optional validation call, existing import patterns, logger usage
  critical: Has _load_valid_domains() function where validation should be added
  
- file: src/work_data_hub/config/mappings/
  why: YAML seed files with Chinese keys that must not be modified
  critical: Content is static mapping data, encoding must remain UTF-8
  
- url: https://docs.python.org/3/library/pathlib.html
  why: Path class usage for portable path resolution
  critical: Path(__file__).parent pattern for module-relative paths
```

### Current Codebase Structure
```bash
src/work_data_hub/config/
├── mapping_loader.py           # Target for enhancement - has get_mappings_dir() implemented
├── mappings/                   # YAML seed files directory
│   ├── company_branch.yml      # 内蒙→G31, 济南→G21, 战略→G37, 北京其他→G37
│   ├── default_portfolio_code.yml # 集合计划→QTAN001, 单一计划→QTAN002, 职业年金→QTAN003
│   ├── company_id_overrides_plan.yml # FP0001→614810477, FP0002→614810477, P0809→608349737
│   └── business_type_code.yml  # 职年受托→ZNST, 职年投资→ZNTZ
├── schema.py                   # Has validate_data_sources_config and DataSourcesValidationError
└── data_sources.yml            # Configuration file to optionally validate

tests/config/
├── test_mapping_loader.py      # Target for enhanced tests - has portability tests implemented
└── test_data_sources_schema.py # Existing validation tests

src/work_data_hub/orchestration/
└── ops.py                      # Target for optional validation call - partially implemented
```

### Known Gotchas & Library Quirks  
```python
# CRITICAL: Path(__file__).parent ensures module-relative paths work regardless of CWD
# CRITICAL: Environment variable validation MUST check both exists() AND is_dir()
# CRITICAL: os.chdir() in tests requires try/finally to restore original directory - ALREADY IMPLEMENTED
# CRITICAL: monkeypatch.setenv() is correct pytest pattern for env var testing - ALREADY USED
# CRITICAL: MappingLoaderError must include problematic path in error message for debugging
# CRITICAL: Import validate_data_sources_config within function to avoid circular imports
# CRITICAL: YAML files contain specific Chinese values that tests depend on - DO NOT MODIFY CONTENT
# CRITICAL: All loader functions must maintain Dict[str, str] return type contract
# CRITICAL: UTF-8 encoding must be preserved for Chinese characters in YAML files
# CRITICAL: String conversion of int values in YAML (like 614810477 → "614810477") must be maintained
```

## Implementation Blueprint

### Data models and structure
No new data models required. Existing patterns are sufficient:
- `MappingLoaderError` exception class for error handling
- `Dict[str, str]` return types for all loader functions
- `Path` objects for portable path resolution
- Environment variable string handling with validation

### List of tasks to be completed in order

```yaml
Task 1: Verify Current Implementation State
VERIFY src/work_data_hub/config/mapping_loader.py:
  - CHECK if get_mappings_dir() function already exists and works correctly
  - CHECK if all loader functions use get_mappings_dir() pattern
  - VALIDATE environment override behavior with WDH_MAPPINGS_DIR
  - CONFIRM error handling for invalid environment override paths

Task 2: Verify Test Coverage  
VERIFY tests/config/test_mapping_loader.py:
  - CHECK if portability tests exist (test_module_relative_paths_portable)
  - CHECK if environment override tests exist (test_env_override_directory, test_env_override_missing_dir)
  - VALIDATE tests use proper monkeypatch and try/finally patterns
  - CONFIRM tests verify expected Chinese character values

Task 3: Implement Missing Components (if any)
ADD/MODIFY src/work_data_hub/config/mapping_loader.py:
  - ENSURE get_mappings_dir() follows exact pattern from INITIAL.md
  - ENSURE all four loader functions use get_mappings_dir() pattern
  - VERIFY MappingLoaderError includes problematic path in message
  - PRESERVE all existing behavior and return types

Task 4: Complete Test Implementation (if needed)
ADD/MODIFY tests/config/test_mapping_loader.py:
  - ENSURE TestPortabilityAndEnvironmentOverride class exists with all scenarios
  - VERIFY test_module_relative_paths_portable works from any CWD  
  - VERIFY test_env_override_directory works with valid override directories
  - VERIFY test_env_override_missing_dir raises appropriate MappingLoaderError
  - CONFIRM test_env_override_file_not_directory handles file vs directory

Task 5: Optional Validation Integration
MODIFY src/work_data_hub/orchestration/ops.py:
  - ADD validation call in _load_valid_domains() function
  - PATTERN: Import validate_data_sources_config within function
  - PATTERN: Use try/except with logger.error() before re-raising
  - PRESERVE all existing function behavior and error handling
```

### Per task pseudocode

```python
# Task 1: Verify get_mappings_dir() implementation
def get_mappings_dir() -> Path:
    """Get mappings directory with environment variable override support."""
    env_dir = os.environ.get("WDH_MAPPINGS_DIR")
    if env_dir:
        p = Path(env_dir)
        if not p.exists() or not p.is_dir():
            raise MappingLoaderError(f"WDH_MAPPINGS_DIR not found or not a directory: {env_dir}")
        return p
    return Path(__file__).parent / "mappings"

# Task 1: Verify loader functions use get_mappings_dir()
def load_company_branch() -> Dict[str, str]:
    """Load company branch name to code mapping."""
    return load_yaml_mapping(str(get_mappings_dir() / "company_branch.yml"))

def load_default_portfolio_code() -> Dict[str, str]:
    """Load default portfolio code mapping."""
    return load_yaml_mapping(str(get_mappings_dir() / "default_portfolio_code.yml"))

# Task 2: Verify portability test pattern
def test_module_relative_paths_portable(self, tmp_path):
    """Test that loaders work when invoked from any working directory."""
    original_cwd = os.getcwd()
    try:
        # Change to different directory
        os.chdir(tmp_path)
        
        # Should still work - test known values from repo seeds
        mapping = load_company_branch()
        assert "内蒙" in mapping
        assert mapping["内蒙"] == "G31"
        assert "济南" in mapping  
        assert mapping["济南"] == "G21"
    finally:
        # CRITICAL: Always restore
        os.chdir(original_cwd)

# Task 2: Verify environment override test pattern
def test_env_override_directory(self, tmp_path, monkeypatch):
    """Test that WDH_MAPPINGS_DIR override works with valid directory."""
    # Create temp mappings directory with minimal YAML
    temp_mappings = tmp_path / "mappings"
    temp_mappings.mkdir()
    (temp_mappings / "company_branch.yml").write_text(
        "test_key: test_value\noverride_key: override_value", 
        encoding="utf-8"
    )
    
    monkeypatch.setenv("WDH_MAPPINGS_DIR", str(temp_mappings))
    
    mapping = load_company_branch()
    assert mapping["test_key"] == "test_value"
    assert mapping["override_key"] == "override_value"
    # Should use override, not repo
    assert "内蒙" not in mapping

# Task 5: Optional validation in ops.py
def _load_valid_domains() -> List[str]:
    """Load valid domain names from data_sources.yml configuration."""
    # Optional: Validate data_sources.yml for fail-fast behavior
    try:
        from ..config.schema import DataSourcesValidationError, validate_data_sources_config
        validate_data_sources_config()
    except DataSourcesValidationError as e:
        logger.error(f"data_sources.yml validation failed: {e}")
        raise
    except Exception as e:
        logger.debug(f"Optional data_sources validation skipped: {e}")
    
    # ... rest of function unchanged
```

### Integration Points
```yaml
ENVIRONMENT:
  - variable: WDH_MAPPINGS_DIR
  - validation: Must exist and be a directory if set
  - fallback: Path(__file__).parent / "mappings" (module-relative)
  - error_handling: Clear MappingLoaderError with problematic path included
  
TESTING:
  - monkeypatch: For environment variable testing (WDH_MAPPINGS_DIR)
  - tmp_path: For creating temporary directory structures
  - try/finally: For os.chdir() operations to ensure CWD restoration
  - encoding: UTF-8 for all Chinese character test files
  
VALIDATION:
  - location: src/work_data_hub/orchestration/ops.py in _load_valid_domains()
  - import_pattern: Import validate_data_sources_config within function
  - error_pattern: logger.error() then re-raise DataSourcesValidationError
  - preservation: All existing ops.py behavior must be maintained
```

## Validation Loop

### Level 1: Syntax & Style
```bash
# Run these FIRST - fix any errors before proceeding
uv run ruff check src/ --fix
uv run mypy src/

# Expected: No errors. Current state has some mypy errors to ignore.
# Focus on: No NEW errors from mapping_loader.py changes
```

### Level 2: Unit Tests
```bash
# Run focused mapping loader tests
uv run pytest tests/config/test_mapping_loader.py -v

# Run broader config and orchestration tests to ensure no regressions
uv run pytest -v -k "(mapping_loader or data_sources_schema or orchestration) and not postgres"

# Expected: All mapping_loader tests pass, including new portability tests
# Expected: No regressions in existing data_sources_schema tests
# Expected: orchestration tests pass with optional validation
```

### Level 3: Portability Verification
```bash
# Create a test directory and run tests from there to verify portability
mkdir -p /tmp/portability_test
cd /tmp/portability_test

# Run specific portability test from different working directory
uv run pytest E:/Projects/WorkDataHub/tests/config/test_mapping_loader.py::TestPortabilityAndEnvironmentOverride::test_module_relative_paths_portable -v

# Expected: Test passes, proving CWD independence
cd E:/Projects/WorkDataHub  # Return to project directory
```

### Level 4: Environment Override Testing
```bash
# Test environment override functionality manually
export WDH_MAPPINGS_DIR="/tmp/test_mappings"  # Will fail - directory doesn't exist
uv run python -c "
from src.work_data_hub.config.mapping_loader import load_company_branch
try:
    load_company_branch()
    print('ERROR: Should have failed')
except Exception as e:
    print(f'SUCCESS: Got expected error: {e}')
"

# Expected: Clear error message about WDH_MAPPINGS_DIR not found
unset WDH_MAPPINGS_DIR  # Clean up
```

## Final Validation Checklist
- [ ] All tests pass: `uv run pytest tests/config/test_mapping_loader.py -v`
- [ ] No NEW linting errors: `uv run ruff check src/`
- [ ] No NEW type errors: `uv run mypy src/`
- [ ] Portability verified: Test passes from different working directory
- [ ] Environment override works: Valid directory override loads custom files
- [ ] Environment validation works: Invalid directory paths raise clear errors
- [ ] Chinese character handling preserved: "内蒙"→"G31", "集合计划"→"QTAN001" work
- [ ] Optional validation integrated: ops.py validates data_sources.yml on load
- [ ] Error messages actionable: Include problematic paths and clear descriptions
- [ ] Existing behavior preserved: All current functionality works unchanged

---

## Anti-Patterns to Avoid
- ❌ Don't rely on os.getcwd() or working directory-relative paths
- ❌ Don't skip exists() AND is_dir() validation for environment override
- ❌ Don't modify existing YAML seed file contents that tests expect
- ❌ Don't use try/except without finally when changing working directory in tests
- ❌ Don't create circular imports when adding validation to ops.py
- ❌ Don't change function signatures, return types, or exception hierarchies  
- ❌ Don't break Chinese character encoding or string conversion of numeric values
- ❌ Don't suppress or swallow exceptions - always provide actionable error messages

## Confidence Score: 9/10

High confidence for successful one-pass implementation due to:
- ✅ Current implementation appears already complete based on code review
- ✅ Comprehensive test coverage already exists with proper patterns
- ✅ Clear validation gates with specific expected outcomes
- ✅ Known gotchas and implementation patterns well-documented
- ✅ Integration points clearly defined with preservation requirements
- ✅ Anti-patterns identified to prevent common mistakes
- ✅ External research provides proven patterns for path resolution and env overrides

Minor uncertainty:
- ⚠️ Verification needed that current implementation matches exact INITIAL.md specifications
- ⚠️ Optional ops.py validation import pattern needs careful circular dependency handling

The implementation should verify existing functionality matches requirements and fill any gaps for complete success.