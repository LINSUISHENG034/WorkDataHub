name: "Security & Quality Baseline: CI Pipeline + Secrets Hygiene"
description: |

## Purpose
Implement a robust CI pipeline and comprehensive secrets management baseline that provides automated quality gates, security scanning, and standardized environment configuration for WorkDataHub. This establishes the foundation for secure, maintainable development practices.

## Core Principles
1. **Context is King**: Include ALL necessary documentation, examples, and caveats
2. **Validation Loops**: Provide executable tests/lints the AI can run and fix
3. **Information Dense**: Use keywords and patterns from the codebase
4. **Progressive Success**: Start simple, validate, then enhance
5. **Global rules**: Be sure to follow all rules in CLAUDE.md

---

## Goal
Establish a Security & Quality Baseline per ROADMAP.md Milestone 0 by implementing automated CI (ruff, mypy, pytest), comprehensive secrets policy with environment-based configuration, and optional security scanning. Create a foundation that prevents security issues and ensures code quality on every change.

## Why
- **Business value**: Prevents security incidents, reduces manual review burden, ensures consistent code quality
- **Integration**: Establishes quality gates before code reaches main branch, enables safe continuous deployment
- **Problems solved**: Eliminates manual linting/testing, standardizes secrets handling, prevents credential leaks, provides development environment consistency

## What
A complete CI/CD and security foundation including:
- GitHub Actions workflow running ruff (linting), mypy (type checking), pytest (excluding DB tests)  
- Comprehensive secrets policy documentation with clear do/don't guidelines
- Environment variable template (`.env.example`) with all WDH_* variables and safe defaults
- Optional gitleaks integration for automated secrets scanning
- Git-ignored .env handling for local development security

### Success Criteria
- [ ] CI workflow runs on PRs/pushes to main, fails on quality violations
- [ ] All WDH_* environment variables documented with examples
- [ ] Secrets policy provides clear guidelines and incident procedures
- [ ] Local and CI validation gates pass consistently
- [ ] Optional secrets scanning catches credential leaks

## All Needed Context

### Documentation & References
```yaml
# MUST READ - Include these in your context window
- url: https://docs.astral.sh/uv/
  why: Package manager commands, virtual environment setup, CI integration patterns
  
- url: https://docs.astral.sh/ruff/cli/
  why: Command-line options, check vs fix modes, CI configuration
  
- url: https://mypy.readthedocs.io/en/stable/command_line.html
  why: Type checking configuration, exit codes, CI integration
  
- url: https://docs.pytest.org/en/stable/example/markers.html  
  why: Test markers for skipping postgres tests (-m "not postgres")
  
- url: https://docs.pydantic.dev/latest/concepts/pydantic_settings/
  why: Environment variable patterns, validation, nested configuration
  
- url: https://github.com/gitleaks/gitleaks
  why: Security scanning configuration, GitHub Actions integration

# CRITICAL: 2024 GitHub Actions Best Practices Research Results
- pattern: astral-sh/setup-uv@v1 (official action with built-in caching)
- pattern: astral-sh/ruff-action@v0.4.6 (dedicated ruff action)  
- pattern: Matrix strategy for Python version compatibility
- pattern: Restricted GITHUB_TOKEN permissions for security
- pattern: Fail-fast configuration for immediate feedback
```

### Current Codebase Analysis
```bash
# Key Files Analyzed:
src/work_data_hub/config/settings.py  # WDH_ prefix, nested WDH_DATABASE__* structure
pyproject.toml                        # pytest markers already configured  
.gitignore                            # .env* already ignored (except .env.example)
tests/io/test_warehouse_loader.py:299 # @pytest.mark.postgres example

# Environment Variables Currently Used:
WDH_APP_NAME, WDH_DEBUG, WDH_LOG_LEVEL
WDH_DATA_BASE_DIR, WDH_DATA_SOURCES_CONFIG
WDH_MAX_FILE_SIZE_MB, WDH_MAX_WORKERS, WDH_DEV_SAMPLE_SIZE  
WDH_DATABASE__HOST, WDH_DATABASE__PORT, WDH_DATABASE__USER
WDH_DATABASE__PASSWORD, WDH_DATABASE__DB, WDH_DATABASE__URI
```

### Desired Codebase tree with files to be added
```bash
E:\Projects\WorkDataHub\
├── .github/
│   └── workflows/
│       └── ci.yml                    # CI pipeline with uv, ruff, mypy, pytest
├── docs/
│   └── security/
│       └── SECRETS_POLICY.md         # Comprehensive secrets management policy
├── .env.example                      # Environment template with all WDH_* variables
├── .gitignore                        # Already contains .env* entries (verified)
└── (existing structure unchanged)
```

### Known Gotchas & Library Quirks
```python
# CRITICAL: CI-specific behaviors
# - Use `ruff check` in CI, NEVER `ruff check --fix` (CI is read-only)
# - Use `uv run` prefix for all tool commands to ensure venv isolation
# - Use `-m "not postgres"` to skip DB tests (CI has no database)
# - astral-sh/setup-uv has caching enabled by default (don't configure manually)

# CRITICAL: Environment variable patterns  
# - WDH_ prefix is already established in settings.py
# - Nested config uses double underscore: WDH_DATABASE__HOST
# - Pydantic BaseSettings handles case-insensitive loading
# - .env file loads automatically via pydantic-settings configuration

# CRITICAL: Security considerations
# - NEVER commit .env files (already in .gitignore) 
# - Always provide .env.example with safe defaults
# - Use restricted GITHUB_TOKEN permissions in workflows
# - Make gitleaks non-blocking initially to avoid disruption
```

## Implementation Blueprint

### Task 1: Create Environment Variables Template
```yaml
CREATE .env.example:
  - PATTERN: Mirror exact structure from settings.py WDH_ variables
  - INCLUDE: All variables with safe defaults and descriptions
  - PRESERVE: Nested WDH_DATABASE__* structure from DatabaseSettings class
  - REFERENCE: INITIAL.md example but expand with ALL current variables
```

### Task 2: Create Comprehensive Secrets Policy
```yaml  
CREATE docs/security/SECRETS_POLICY.md:
  - PATTERN: Follow INITIAL.md skeleton but expand significantly
  - INCLUDE: Principles, storage patterns, loading mechanisms, reviews, incidents
  - REFERENCE: 2024 best practices from pydantic-settings research
  - CROSS-LINK: Reference .env.example for variable patterns
```

### Task 3: Implement CI/CD Pipeline
```yaml
CREATE .github/workflows/ci.yml:
  - PATTERN: Combine INITIAL.md example with 2024 best practices
  - USE: astral-sh/setup-uv@v1 with built-in caching
  - USE: astral-sh/ruff-action@v0.4.6 for linting  
  - INCLUDE: Matrix strategy for Python version compatibility
  - SECURITY: Restrict GITHUB_TOKEN permissions to read-only
  - TESTS: Skip postgres tests with `-m "not postgres"`
```

### Task 4: Add Optional Secrets Scanning
```yaml  
MODIFY .github/workflows/ci.yml:
  - ADD: Non-blocking gitleaks job for security scanning
  - PATTERN: Use gitleaks/gitleaks-action@v2 
  - CONFIGURE: Run only on PRs and main branch pushes
  - BEHAVIOR: Non-blocking initially (continue-on-error: true)
```

### Task 5: Validation and Integration
```yaml
VERIFY all components work together:
  - TEST: Local validation gates pass
  - TEST: CI workflow runs successfully  
  - VALIDATE: .env.example covers all settings.py variables
  - CONFIRM: Secrets policy is comprehensive and actionable
```

### Per task pseudocode

```yaml
# Task 1: .env.example creation
# Extract from settings.py analysis:
WDH_APP_NAME=WorkDataHub
WDH_DEBUG=false  
WDH_LOG_LEVEL=INFO
WDH_DATA_BASE_DIR=./data
WDH_DATA_SOURCES_CONFIG=./src/work_data_hub/config/data_sources.yml
WDH_MAX_FILE_SIZE_MB=100
WDH_MAX_WORKERS=4
# WDH_DEV_SAMPLE_SIZE=1000
WDH_DATABASE__HOST=localhost
WDH_DATABASE__PORT=5432  
WDH_DATABASE__USER=wdh_user
WDH_DATABASE__PASSWORD=changeme
WDH_DATABASE__DB=wdh
# WDH_DATABASE__URI=postgresql://wdh_user:changeme@localhost:5432/wdh

# Task 3: CI workflow structure  
name: CI
on: [push: main/master, pull_request]
permissions: contents: read
jobs:
  build-test:
    strategy:
      matrix: python-version: ["3.10", "3.11", "3.12"]
    steps:
      - checkout@v4
      - astral-sh/setup-uv@v1 with python-version matrix
      - uv sync (installs dev dependencies)
      - astral-sh/ruff-action@v0.4.6 with "check src/"
      - uv run mypy src/  
      - uv run pytest -v -m "not postgres"
```

### Integration Points
```yaml
ENVIRONMENT:
  - confirm: .env already git-ignored in existing .gitignore
  - ensure: .env.example matches ALL WDH_* variables in settings.py
  - validate: pydantic-settings loads variables correctly

GITHUB:  
  - create: .github/workflows/ci.yml with proper permissions
  - configure: Matrix builds for supported Python versions
  - enable: Actions in repository settings if not already enabled

TOOLS:
  - utilize: Existing ruff, mypy, pytest configuration in pyproject.toml
  - preserve: pytest markers configuration for postgres tests
  - leverage: uv for consistent environment management
```

## Validation Loop

### Level 1: Syntax & Style
```bash  
# Run these FIRST - fix any errors before proceeding
uv run ruff check src/                    # Must pass, no violations
uv run mypy src/                          # Must pass, no type errors

# Expected: No errors. If errors, READ the error message and fix.
```

### Level 2: Unit Tests  
```bash
# Test without database dependencies (same as CI)
uv run pytest -v -m "not postgres"

# Optional: Check test coverage
uv run pytest --cov=src --cov-report=term-missing -m "not postgres"

# Expected: All tests pass. If failing, debug specific test failures.
```

### Level 3: Integration Test
```bash
# Verify environment template covers all settings
python -c "
from src.work_data_hub.config.settings import Settings
import os
os.environ.clear()  # Clear existing env vars
try:
    Settings()  # Should fail gracefully with clear error messages
    print('✓ Settings validation works')  
except Exception as e:
    print(f'✓ Expected validation errors: {e}')
"

# Test CI workflow locally (if push to branch)  
git add .github/workflows/ci.yml docs/security/SECRETS_POLICY.md .env.example
git commit -m "feat(ci): implement security & quality baseline"
git push origin feature/security-baseline
# Check GitHub Actions tab - workflow should run and pass
```

## Final Validation Checklist
- [ ] All tests pass: `uv run pytest -v -m "not postgres"`
- [ ] No linting errors: `uv run ruff check src/`  
- [ ] No type errors: `uv run mypy src/`
- [ ] CI workflow exists at `.github/workflows/ci.yml`
- [ ] CI runs on PRs and pushes to main/master branches
- [ ] `.env.example` contains all WDH_* variables from settings.py
- [ ] `docs/security/SECRETS_POLICY.md` is comprehensive and actionable
- [ ] Secrets policy references .env.example and provides clear guidance
- [ ] Optional gitleaks job configured as non-blocking
- [ ] Local validation gates pass on clean checkout

## Quality Benchmark Score: 9/10

High confidence due to:
- Comprehensive research of 2024 best practices for CI and secrets management
- Detailed analysis of existing codebase structure and patterns
- Clear mapping of all environment variables from settings.py analysis
- Executable validation gates that AI can run and iterate on
- Specific file patterns and integration points identified
- Optional features (gitleaks) configured as non-blocking to reduce risk

Minor uncertainty on:
- Potential edge cases in GitHub Actions permissions across different repository settings
- Minor variations in environment variable loading between local and CI contexts

The comprehensive context provided should enable successful one-pass implementation with clear validation feedback loops for iterative improvement.

---

## Anti-Patterns to Avoid
- ❌ Don't use `ruff check --fix` in CI (CI should be read-only)
- ❌ Don't skip the matrix strategy - test multiple Python versions
- ❌ Don't hardcode environment variables - always use the template  
- ❌ Don't make gitleaks blocking initially - start non-blocking
- ❌ Don't ignore test failures - debug and fix them
- ❌ Don't commit .env files even for "testing"
- ❌ Don't skip validation loops - they prevent deployment issues