# CI-002C — 同步小预算富化集成（接入 annuity_performance，可选/默认关闭）

## 背景与定位
- 目标：在不阻塞主流程的前提下，提供“小额度在线查询”的即时补全能力；其余未命中仍走异步回填。
- 定位：可选能力，默认关闭；当需要更强的即时性时开启（受 `WDH_ENRICH_SYNC_BUDGET` 控制）。
- 关系：建立在 CI-002A（接口）与 CI-002B（请求队列/缓存）之上，不改变装载与回填主路径。

## 依赖与前置
- 依赖：A/B 完成；Annunity Performance 域流程已能产出基础记录。
- 配置：`WDH_ENRICH_COMPANY_ID=1`、`WDH_ENRICH_SYNC_BUDGET>0`、`WDH_ENTERPRISE_PROVIDER=stub|eqc`。

## 相关文档
- 主文：`docs/company_id/PROBLEM.CI-000_问题定义与解决方案.md`
- 蓝图：`docs/company_id/CI-002_企业信息查询集成与客户ID富化闭环_蓝图.md`
- 配置：`docs/company_id/CONFIG.CI-ENV.md`

目的：在不破坏现有 E2E 的前提下，为规模明细流程接入 Gateway，按小额度执行同步在线查询（预算受 `WDH_ENRICH_SYNC_BUDGET` 限制）；其余未命中入队队列并导出 CSV。默认关闭该能力。

## FEATURE
- 新增开关：`WDH_ENRICH_COMPANY_ID=1` 开启同步富化；`WDH_ENRICH_SYNC_BUDGET=N` 限定每次运行在线查询额度。
- 在 `process_annuity_performance_op` 阶段调用 Gateway：按“内部优先”并在预算内触发在线查询；记录命中来源、预算消耗、unknown。
- 未命中：写入 `enterprise.enrichment_requests` + 导出 `./.wdh/staging/unresolved_company_ids.csv`。

## SCOPE
- In-scope：ops 集成点与统计输出；CSV 导出；预算控制逻辑；内部优先顺序（覆盖→参考/账户→名称索引→在线→入队→兜底）。
- Non-goals：不实现异步消费者；不改变 load/backfill 行为。

## VALIDATION
```bash
uv run ruff check src/ --fix
uv run mypy src/
uv run pytest -v -k enrich_sync

export WDH_DATA_BASE_DIR=tests/fixtures/sample_data/annuity_subsets
export WDH_ENRICH_COMPANY_ID=1
export WDH_ENTERPRISE_PROVIDER=stub
export WDH_ENRICH_SYNC_BUDGET=10
uv run python -m src.work_data_hub.orchestration.jobs \
  --domain annuity_performance \
  --plan-only \
  --max-files 1 \
  --sheet "规模明细" \
  --debug
```

## ACCEPTANCE CRITERIA
- 预算严格生效；Summary 输出命中分布与 unknown；CSV 正确生成（若 unknown>0）。不开关时行为与现有 E2E 一致。

## RISKS
- 运行时抖动：在线查询失败不影响主流程，按未命中入队并记录错误。
