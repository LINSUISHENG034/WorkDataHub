# 外键约束实施评估摘要

**文档日期**: 2025-12-20
**问题**: 在数据库层面创建外键约束是否会破坏当前的外键回填充服务？

## 1. 问题背景

WorkDataHub 当前通过外键回填充服务维护引用数据一致性，**没有**在数据库层面创建实际的外键约束。这存在数据一致性的潜在风险，但如果添加外键约束，需要评估对现有系统的影响。

## 2. 当前状况

### 规模明细表的外键映射
- **计划代码** → mapping.年金计划.年金计划号
- **组合代码** → mapping.组合计划.组合代码
- **产品线代码** → mapping.产品线.产品线代码
- **机构代码** → mapping.组织架构.机构代码

### 外键回填充服务机制
1. 从规模明细事实数据提取引用值
2. 按依赖顺序插入到引用表（年金计划 → 组合计划）
3. 使用 `insert_missing` 模式，只插入不存在的记录
4. 通过 UPSERT 处理重复记录

## 3. 兼容性分析结果

### ✅ 不会破坏现有服务的方面

1. **处理顺序正确**: 服务已使用拓扑排序，确保主表先于从表插入
2. **UPSERT策略兼容**: `ON CONFLICT DO NOTHING` 在外键约束下正常工作
3. **错误处理已有**: 服务具备异常处理机制

### ⚠️ 已识别的潜在风险

#### 高风险
1. **数据不一致风险**
   - 现有规模明细数据可能引用不存在的计划代码
   - 添加外键约束会导致这些数据插入失败
   - **缓解**: 实施前必须清理无效引用数据

2. **数据加载顺序风险**
   - 必须先运行外键回填充服务，再加载规模明细数据
   - 如果顺序错误会导致大量插入失败
   - **缓解**: 修改数据加载流程，确保正确顺序

#### 中等风险
3. **性能影响**
   - 外键约束增加插入验证开销
   - 预期影响: 批量数据加载性能下降 5-15%
   - **缓解**: 在数据加载期间可临时禁用约束

4. **维护窗口压力**
   - 需要额外时间创建约束和清理数据
   - 可能影响其他维护任务
   - **缓解**: 准备详细的实施清单和自动化脚本