# EQC Auth Automation - Requirements & Issues Report

## 1. Project Goal
Develop an enhanced Python script (`auto_eqc_auth.py`) based on `eqc_auth_handler.py` to automate the user login flow for the EQC platform (https://eqc.pingan.com/).

**Specific Objectives:**
1.  **Launch Browser:** Open a headed Chromium browser.
2.  **Navigate to Login:** Automatically handle navigation from the Index page to the Login page.
3.  **Switch to QR Code:** Automatically click the UI element to switch the login form to "QR Code Scan" mode.
4.  **Auto-Agree:** Automatically check the User Agreement checkbox.
5.  **Capture Token:** Wait for the user to scan the code, then intercept the `token` header from network requests and save it to `.env`.

## 2. Current Implementation Status
- **Script Location:** `src/work_data_hub/io/auth/auto_eqc_auth.py`
- **Key Features Implemented:**
    - Playwright with Stealth mode.
    - Token interception logic (working).
    - Basic navigation logic.

## 3. Encountered Issues

### 3.1. Navigation Reliability (Index -> Login)
- **Issue:** The script often lands on the Index page (`/#/index`) instead of the Login page (`/#/login`).
- **Attempted Fixes:** 
    - Added logic to detect "立即体验" or "登录" buttons.
    - Increased timeouts to 15 seconds.
- **Result:** Inconsistent. Sometimes the button is not found, or clicking it does not reliably transition to the login form login box (`.login_box`) in the time expected by the automation.

### 3.2. QR Code Switch Failure
- **Issue:** Even when on the login page (or after attempted navigation), the script fails to click the "Corner Marker" (QR Switch Icon) to change the view.
- **Observations:** User reported the page stays on the initial view.
- **Suspected Causes:**
    - **Timing/Animation:** The element might be present in DOM but not clickable/interactive immediately.
    - **Selector Fragility:** The selector `.login_box img` or `div > img` might be matching the wrong element or failing due to dynamic rendering.
    - **Browser Differences:** User noted UI discrepancies between the automated browser and manual Chrome usage, potentially due to bot detection or specific browser profile states.

### 3.3. Element Visibility
- **Issue:** "Agreement" checkbox or "Immediate Experience" buttons are reported as not found during some runs.

## 4. Requirements for Future Development

### 4.1. Robust SPA Navigation
- Implement reliable detection of the current page state (Index vs. Login).
- Ensure the script waits for the *full* loading of the "Immediate Experience" button before interacting.
- Consider forcing URL navigation to `/#/login` *after* a brief wait on the index page if buttons fail.

### 4.2. Accurate Element Interaction
- **QR Switch Selector:** Re-investigate the exact, unique selector for the QR code switch icon. Ensure it targets the clickable container if the image itself isn't intercepting clicks.
- **State Confirmation:** verification steps *after* clicking (e.g., "Wait until 'Phone Login' text disappears" or "Wait until QR code image is visible").

### 4.3. Debugging Support
- Add screenshot capture at failure points (e.g., if "Button not found", save `debug_nav_fail.png`).
- Log the current URL and page title when exceptions occur.

## 5. Environment
- **OS:** Windows
- **Python:** Using local `.venv`
- **Dependency:** `playwright`
