# Multi-Domain æµ‹è¯•é—®é¢˜æ£€æŸ¥æ¸…å•

> **æ–‡æ¡£ç±»å‹:** éªŒæ”¶æ£€æŸ¥æ¸…å•
> **åˆ›å»ºæ—¥æœŸ:** 2025-12-30
> **æœ€åæ›´æ–°:** 2025-12-31 (ä»£ç å®é”¤éªŒè¯å®Œæˆ)
> **æ¥æºæ–‡æ¡£:** `docs/specific/multi-domain/` ç›®å½•ä¸‹æ‰€æœ‰åˆ†ææ–‡æ¡£
> **é€‚ç”¨èŒƒå›´:** `annuity_performance`ã€`annuity_income` åŠæœªæ¥æ–°å¢åŸŸ

---

## éªŒè¯çŠ¶æ€æ‘˜è¦

**Epic 7.3 (Multi-Domain Consistency Fixes) & Epic 7.4 (Domain Registry Architecture)** å·²å…¨éƒ¨å®Œæˆã€‚

**2025-12-31 ä»£ç å®é”¤éªŒè¯:** å¯¹æ‰€æœ‰å£°ç§°"å·²ä¿®å¤"çš„é—®é¢˜è¿›è¡Œäº†ä»£ç çº§éªŒè¯ï¼Œç¡®è®¤å®é™…ä»£ç ä¸é—®é¢˜æ¸…å•çŠ¶æ€ä¸€è‡´ã€‚

| ä¸¥é‡æ€§        | æ•°é‡ | å·²ä¿®å¤ | å¾…å¤„ç† | ä¿®å¤ç‡ |
| ------------- | ---- | ------ | ------ | ------ |
| **Critical**  | 3    | 3      | 0      | 100%  |
| **High**      | 2    | 2      | 0      | 100%  |
| **Medium**    | 12   | 12     | 0      | 100%  |
| **Low**       | 5    | 5      | 0      | 100%  |
| **Info/Debt** | 8    | 8      | 0      | 100%  |
| **æ€»è®¡**      | 30   | 30     | 0      | 100%  |

**å·²ä¿®å¤é—®é¢˜æ€»æ•°:** 30/30 (100%)

**å‰©ä½™é—®é¢˜:** æ— 

**å…³é”®ä¿®å¤æˆæœ (ä»£ç éªŒè¯ç¡®è®¤):**
1. âœ… æ‰€æœ‰ Critical å’Œ High ä¼˜å…ˆçº§é—®é¢˜å·²è§£å†³
2. âœ… æ•°æ®ä¸€è‡´æ€§å®Œå…¨ç»Ÿä¸€ (null å¤„ç†ã€å­—æ®µéªŒè¯) - è§ `models.py`ã€`validators.py`
3. âœ… FK å›å¡«é…ç½®å®Œæ•´ (annuity_income ä¸ annuity_performance å¯¹ç­‰) - è§ `foreign_keys.yml`
4. âœ… Pipeline å¤„ç†é€»è¾‘å¯¹é½ (company_id è§£æã€å®¢æˆ·åç§°å¡«å……ã€è®¡åˆ’ä»£ç ä¿®æ­£) - è§ `pipeline_builder.py`
5. âœ… æ¶æ„å€ºåŠ¡æ¸…é›¶ (JOB_REGISTRYã€config-driven backfillã€é€šç”¨ ops) - è§ `jobs.py`ã€`executors.py`

---

æœ¬æ¸…å•æ•´ç†è‡ª multi-domain æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°çš„å…¨éƒ¨é—®é¢˜ã€‚å¼€å‘å›¢é˜Ÿåº”åœ¨ä»»åŠ¡å®Œæˆåé€é¡¹æ£€æŸ¥ï¼š

- âœ… å·²ä¿®å¤
- ğŸ”„ è¿›è¡Œä¸­
- â³ å¾…å¤„ç†
- âŒ æœªä¿®å¤

**åé¦ˆæ ¼å¼:** è¯·åœ¨ã€Œå®é™…è¿›å±•ã€åˆ—å¡«å†™ï¼šçŠ¶æ€ + è´£ä»»äºº + æ—¥æœŸ + å¤‡æ³¨

---

## ä¸€ã€æ•°æ®ä¸€è‡´æ€§ä¸ Schema ä¸€è‡´æ€§é—®é¢˜

> **æ¥æº:** `shared-field-validators-analysis.md`ã€`priority-roadmap.md`

### 1.1 Pydantic æ¨¡å‹ä¸ Domain Registry Null å¤„ç†ä¸ä¸€è‡´

| ç¼–å·       | é—®é¢˜æè¿°                                                                                                                                       | é¢„æœŸä¿®å¤æ–¹æ¡ˆ                                                                                              | é¢„æœŸä¿®å¤ç»“æœ                                                           | å®é™…è¿›å±• |
| ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------- | -------- |
| **CN-001** | `annuity_income` çš„ `å®¢æˆ·åç§°` å­—æ®µåœ¨ Pydantic æ¨¡å‹ä¸­å®šä¹‰ä¸º `str` (required)ï¼Œæ‹’ç» null å€¼ï¼Œä¸ `annuity_performance` çš„ `Optional[str]` ä¸ä¸€è‡´ | å°† `domain/annuity_income/models.py` ä¸­ `å®¢æˆ·åç§°` æ”¹ä¸º `Optional[str]`ï¼Œå¹¶åœ¨ validator ä¸­æ·»åŠ  null check | ä¸¤ä¸ª domain çš„ `å®¢æˆ·åç§°` éƒ½å…è®¸ null å€¼ï¼ŒETL ä¸å†å›  null å®¢æˆ·åç§°å¤±è´¥ | âœ… Story 7.3-1 å·²ä¿®å¤ (ä»£ç éªŒè¯: `models.py:58,186` å‡ä¸º `Optional[str]`) |
| **CI-001** | `annuity_income` çš„ `company_id` å­—æ®µå®šä¹‰ä¸º `str` (required)ï¼Œè€Œ `annuity_performance` ä¸º `Optional[str]`                                      | ç»Ÿä¸€ä¸¤ä¸ª domain çš„ `company_id` å¤„ç†é€»è¾‘ï¼Œè€ƒè™‘ä¸šåŠ¡éœ€æ±‚å†³å®šæ˜¯å¦ç»Ÿä¸€ä¸º Optional                             | ä¸¤ä¸ª domain çš„ `company_id` null å¤„ç†è¯­ä¹‰ä¸€è‡´                          | âœ… Story 7.3-1 å·²ä¿®å¤ (ä»£ç éªŒè¯: `models.py:86,178-183` å‡ä¸º `Optional[str]`) |
| **DR-001** | `annuity_income` Domain Registry ä¸­ `å®¢æˆ·åç§°` é…ç½®ä¸º `nullable=False`                                                                         | ä¿®æ”¹ `infrastructure/schema/definitions/annuity_income.py`ï¼Œå°† `å®¢æˆ·åç§°` æ”¹ä¸º `nullable=True`            | Domain Registry ä¸ Pydantic æ¨¡å‹ null è¯­ä¹‰ä¸€è‡´                         | âœ… Story 7.3-1 å·²ä¿®å¤ (ä»£ç éªŒè¯: `annuity_income.py:46` `nullable=True`) |
| **DR-002** | `annuity_income` çš„ `gold_required` åˆ—è¡¨åŒ…å« `å®¢æˆ·åç§°`                                                                                        | ä» `gold_required` åˆ—è¡¨ä¸­ç§»é™¤ `å®¢æˆ·åç§°`                                                                  | å…è®¸ null `å®¢æˆ·åç§°` çš„è®°å½•é€šè¿‡ Gold å±‚éªŒè¯                            | âœ… Story 7.3-1 å·²ä¿®å¤ (ä»£ç éªŒè¯: `annuity_income.py:33-40` ä¸å« `å®¢æˆ·åç§°`) |

### 1.2 éªŒè¯å™¨å‘½åä¸é€»è¾‘ç»Ÿä¸€

| ç¼–å·       | é—®é¢˜æè¿°                                                                            | é¢„æœŸä¿®å¤æ–¹æ¡ˆ                                   | é¢„æœŸä¿®å¤ç»“æœ                           | å®é™…è¿›å±•              |
| ---------- | ----------------------------------------------------------------------------------- | ---------------------------------------------- | -------------------------------------- | --------------------- |
| **PC-001** | ~~ä¸¤ä¸ª domain çš„è®¡åˆ’ä»£ç  validator å‘½åä¸åŒ~~                                       | ~~ç»Ÿä¸€ä¸º `normalize_plan_code`~~               | ~~ä»£ç å¯è¯»æ€§å’Œä¸€è‡´æ€§æå‡~~             | âœ… Story 7.3-3 å·²ä¿®å¤ (ä»£ç éªŒè¯: `validators.py:113-154` å…±äº«å‡½æ•°) |
| **PC-002** | `annuity_performance` çš„ `normalize_plan_code` æœ‰ null checkï¼Œ`annuity_income` æ²¡æœ‰ | ç»Ÿä¸€æ·»åŠ  null check é€»è¾‘ï¼Œæˆ–ä½¿ç”¨å…±äº« validator | ä¸¤ä¸ª domain çš„è®¡åˆ’ä»£ç å¤„ç†é€»è¾‘å®Œå…¨ä¸€è‡´ | âœ… Story 7.3-2 å·²ä¿®å¤ (ä»£ç éªŒè¯: `validators.py:146-149` `allow_null` å‚æ•°æ§åˆ¶) |

### 1.3 ä»£ç é‡å¤æå–

| ç¼–å·        | é—®é¢˜æè¿°                                                                                         | é¢„æœŸä¿®å¤æ–¹æ¡ˆ                                    | é¢„æœŸä¿®å¤ç»“æœ             | å®é™…è¿›å±•              |
| ----------- | ------------------------------------------------------------------------------------------------ | ----------------------------------------------- | ------------------------ | --------------------- |
| **DUP-001** | `apply_domain_rules()` å‡½æ•°åœ¨ä¸¤ä¸ª domain ä¸­é‡å¤å®šä¹‰ (~9 è¡Œ Ã— 2)                                  | æå–åˆ° `infrastructure/cleansing/validators.py` | æ¶ˆé™¤ ~18 è¡Œé‡å¤ä»£ç       | âœ… Story 7.3-2 å·²ä¿®å¤ (ä»£ç éªŒè¯: `validators.py:47-82`) |
| **DUP-002** | `DEFAULT_COMPANY_RULES`ã€`DEFAULT_NUMERIC_RULES` ç­‰å¸¸é‡é‡å¤å®šä¹‰ (~30 è¡Œ Ã— 2)                     | æå–åˆ° `infrastructure/cleansing/validators.py` | æ¶ˆé™¤ ~60 è¡Œé‡å¤å¸¸é‡å®šä¹‰  | âœ… Story 7.3-2 å·²ä¿®å¤ (ä»£ç éªŒè¯: `validators.py:24-34`) |
| **DUP-003** | `clean_code_field`ã€`clean_customer_name`ã€`normalize_company_id` ç­‰ validator é‡å¤ (~64 è¡Œ Ã— 2) | æå–å…±äº« validator å·¥å‚å‡½æ•°åˆ° infrastructure å±‚ | æ¶ˆé™¤ ~128 è¡Œé‡å¤éªŒè¯é€»è¾‘ | âœ… Story 7.3-2 å·²ä¿®å¤ (ä»£ç éªŒè¯: `validators.py:85-234`) |

---

## äºŒã€åŸŸå­—æ®µç¼ºå¤±é—®é¢˜

> **æ¥æº:** `domain-field-gap-summary.md`

### 2.1 annuity_income ç¼ºå¤±å­—æ®µ

| ç¼–å·       | é—®é¢˜æè¿°                          | é¢„æœŸä¿®å¤æ–¹æ¡ˆ                                                                                                            | é¢„æœŸä¿®å¤ç»“æœ                                 | å®é™…è¿›å±•              |
| ---------- | --------------------------------- | ----------------------------------------------------------------------------------------------------------------------- | -------------------------------------------- | --------------------- |
| **DF-001** | `æ”¶å…¥æ˜ç»†` è¡¨ç¼ºå¤± `è®¡åˆ’åç§°` å­—æ®µ | åœ¨ `infrastructure/schema/definitions/annuity_income.py` æ·»åŠ  `ColumnDef("è®¡åˆ’åç§°", ColumnType.STRING, nullable=True)` | è¡¨ç»“æ„åŒ…å« 21 åˆ—ï¼Œ`è®¡åˆ’åç§°` å­˜åœ¨ä¸”å¯ä¸º NULL | âœ… Story 7.3-4 å·²ä¿®å¤ (ä»£ç éªŒè¯: `annuity_income.py:54`) |
| **DF-002** | `æ”¶å…¥æ˜ç»†` è¡¨ç¼ºå¤± `ç»„åˆç±»å‹` å­—æ®µ | åŒä¸Šï¼Œæ·»åŠ  `ColumnDef("ç»„åˆç±»å‹", ...)`                                                                                 | `ç»„åˆç±»å‹` å­—æ®µå­˜åœ¨                          | âœ… Story 7.3-4 å·²ä¿®å¤ (ä»£ç éªŒè¯: `annuity_income.py:55`) |
| **DF-003** | `æ”¶å…¥æ˜ç»†` è¡¨ç¼ºå¤± `ç»„åˆåç§°` å­—æ®µ | åŒä¸Šï¼Œæ·»åŠ  `ColumnDef("ç»„åˆåç§°", ...)`                                                                                 | `ç»„åˆåç§°` å­—æ®µå­˜åœ¨                          | âœ… Story 7.3-4 å·²ä¿®å¤ (ä»£ç éªŒè¯: `annuity_income.py:56`) |
| **DF-004** | `æ”¶å…¥æ˜ç»†` è¡¨ç¼ºå¤± `æœºæ„åç§°` å­—æ®µ | åŒä¸Šï¼Œæ·»åŠ  `ColumnDef("æœºæ„åç§°", ...)`                                                                                 | `æœºæ„åç§°` å­—æ®µå­˜åœ¨                          | âœ… Story 7.3-4 å·²ä¿®å¤ (ä»£ç éªŒè¯: `annuity_income.py:57`) |

### 2.2 annuity_performance ç¼ºå¤±å­—æ®µ

| ç¼–å·       | é—®é¢˜æè¿°                                  | é¢„æœŸä¿®å¤æ–¹æ¡ˆ                                                                                                                                | é¢„æœŸä¿®å¤ç»“æœ                | å®é™…è¿›å±•      |
| ---------- | ----------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------- | ------------- |
| **DF-005** | `è§„æ¨¡æ˜ç»†` è¡¨ç¼ºå¤± `å­ä¼ä¸šå·` å­—æ®µ         | åœ¨ `infrastructure/schema/definitions/annuity_performance.py` æ·»åŠ  `ColumnDef("å­ä¼ä¸šå·", ColumnType.STRING, nullable=True, max_length=50)` | `å­ä¼ä¸šå·` å­—æ®µå­˜åœ¨         | âœ… å·²éªŒè¯åŒ…å« (ä»£ç éªŒè¯: `annuity_performance.py:78`) |
| **DF-006** | `è§„æ¨¡æ˜ç»†` è¡¨ç¼ºå¤± `å­ä¼ä¸šåç§°` å­—æ®µ       | åŒä¸Šï¼Œæ·»åŠ å¯¹åº” ColumnDef                                                                                                                    | `å­ä¼ä¸šåç§°` å­—æ®µå­˜åœ¨       | âœ… å·²éªŒè¯åŒ…å« (ä»£ç éªŒè¯: `annuity_performance.py:79`) |
| **DF-007** | `è§„æ¨¡æ˜ç»†` è¡¨ç¼ºå¤± `é›†å›¢ä¼ä¸šå®¢æˆ·å·` å­—æ®µ   | åŒä¸Šï¼Œæ·»åŠ å¯¹åº” ColumnDef                                                                                                                    | `é›†å›¢ä¼ä¸šå®¢æˆ·å·` å­—æ®µå­˜åœ¨   | âœ… å·²éªŒè¯åŒ…å« (ä»£ç éªŒè¯: `annuity_performance.py:80`) |
| **DF-008** | `è§„æ¨¡æ˜ç»†` è¡¨ç¼ºå¤± `é›†å›¢ä¼ä¸šå®¢æˆ·åç§°` å­—æ®µ | åŒä¸Šï¼Œæ·»åŠ å¯¹åº” ColumnDef                                                                                                                    | `é›†å›¢ä¼ä¸šå®¢æˆ·åç§°` å­—æ®µå­˜åœ¨ | âœ… å·²éªŒè¯åŒ…å« (ä»£ç éªŒè¯: `annuity_performance.py:81`) |

---

## ä¸‰ã€å¤–é”®å›å¡« (FK Backfill) ç¼ºå¤±é—®é¢˜

> **æ¥æº:** `fk-backfill-gap-analysis.md`

### 3.1 annuity_performance FK é…ç½®

| ç¼–å·       | é—®é¢˜æè¿°                                                                          | é¢„æœŸä¿®å¤æ–¹æ¡ˆ                                                                                 | é¢„æœŸä¿®å¤ç»“æœ                             | å®é™…è¿›å±•              |
| ---------- | --------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------- | ---------------------------------------- | --------------------- |
| **BF-001** | `annuity_performance` ç¼ºå¤± `fk_customer` é…ç½® (`company_id` â†’ `mapping.å¹´é‡‘å®¢æˆ·`) | åœ¨ `config/foreign_keys.yml` çš„ `annuity_performance.foreign_keys` ä¸‹æ·»åŠ  `fk_customer` é…ç½® | ETL å®Œæˆå `å¹´é‡‘å®¢æˆ·` è¡¨è‡ªåŠ¨å›å¡«å®¢æˆ·ä¿¡æ¯ | âœ… Story 7.3-7 å·²ä¿®å¤ (ä»£ç éªŒè¯: `foreign_keys.yml:144-175`) |

### 3.2 annuity_income FK é…ç½® (æ•´ä½“ç¼ºå¤±)

| ç¼–å·        | é—®é¢˜æè¿°                                                 | é¢„æœŸä¿®å¤æ–¹æ¡ˆ                                                    | é¢„æœŸä¿®å¤ç»“æœ                                                     | å®é™…è¿›å±•              |
| ----------- | -------------------------------------------------------- | --------------------------------------------------------------- | ---------------------------------------------------------------- | --------------------- |
| **BF-002**  | `annuity_income` å®Œå…¨ç¼ºå¤± FK backfill é…ç½®               | åœ¨ `config/foreign_keys.yml` æ·»åŠ å®Œæ•´çš„ `annuity_income` é…ç½®èŠ‚ | `annuity_income` å…·æœ‰ä¸ `annuity_performance` åŒç­‰çš„ FK å›å¡«èƒ½åŠ› | âœ… Story 7.3-7 å·²ä¿®å¤ (ä»£ç éªŒè¯: `foreign_keys.yml:177-267`) |
| **BF-002a** | ç¼ºå¤± `fk_plan` (`è®¡åˆ’ä»£ç ` â†’ `mapping.å¹´é‡‘è®¡åˆ’`)         | æ·»åŠ åˆ° `foreign_keys.yml` ä¸­ `annuity_income` èŠ‚ä¸‹              | è®¡åˆ’ä»£ç è‡ªåŠ¨å›å¡«åˆ°å¹´é‡‘è®¡åˆ’è¡¨                                     | âœ… Story 7.3-7 å·²ä¿®å¤ (ä»£ç éªŒè¯: `foreign_keys.yml:183-201`) |
| **BF-002b** | ç¼ºå¤± `fk_portfolio` (`ç»„åˆä»£ç ` â†’ `mapping.ç»„åˆè®¡åˆ’`)    | åŒä¸Š                                                            | ç»„åˆä»£ç è‡ªåŠ¨å›å¡«åˆ°ç»„åˆè®¡åˆ’è¡¨                                     | âœ… Story 7.3-7 å·²ä¿®å¤ (ä»£ç éªŒè¯: `foreign_keys.yml:203-221`) |
| **BF-002c** | ç¼ºå¤± `fk_product_line` (`äº§å“çº¿ä»£ç ` â†’ `mapping.äº§å“çº¿`) | åŒä¸Š                                                            | äº§å“çº¿ä»£ç è‡ªåŠ¨å›å¡«                                               | âœ… Story 7.3-7 å·²ä¿®å¤ (ä»£ç éªŒè¯: `foreign_keys.yml:223-235`) |
| **BF-002d** | ç¼ºå¤± `fk_organization` (`æœºæ„ä»£ç ` â†’ `mapping.ç»„ç»‡æ¶æ„`) | åŒä¸Š                                                            | æœºæ„ä»£ç è‡ªåŠ¨å›å¡«                                                 | âœ… Story 7.3-7 å·²ä¿®å¤ (ä»£ç éªŒè¯: `foreign_keys.yml:237-250`) |
| **BF-002e** | ç¼ºå¤± `fk_customer` (`company_id` â†’ `mapping.å¹´é‡‘å®¢æˆ·`)   | åŒä¸Š                                                            | å®¢æˆ·ä¿¡æ¯è‡ªåŠ¨å›å¡«                                                 | âœ… Story 7.3-7 å·²ä¿®å¤ (ä»£ç éªŒè¯: `foreign_keys.yml:252-266`) |

### 3.3 ç›¸å…³ä»£ç æ›´æ–°

| ç¼–å·       | é—®é¢˜æè¿°                                                            | é¢„æœŸä¿®å¤æ–¹æ¡ˆ                                   | é¢„æœŸä¿®å¤ç»“æœ                                 | å®é™…è¿›å±•              |
| ---------- | ------------------------------------------------------------------- | ---------------------------------------------- | -------------------------------------------- | --------------------- |
| **BF-003** | `cli/etl/config.py` æœªå°† `annuity_income` åŠ å…¥ backfill åŸŸåˆ—è¡¨      | ä¿®æ”¹ L157 çš„æ¡ä»¶åˆ¤æ–­ï¼ŒåŠ å…¥ `annuity_income`    | CLI æ‰§è¡Œ `annuity_income` ETL æ—¶è§¦å‘ FK å›å¡« | âœ… Story 7.3-7 å·²ä¿®å¤ (ä»£ç éªŒè¯: `config.py:157-164` ä½¿ç”¨ `requires_backfill` é…ç½®é©±åŠ¨) |
| **BF-004** | `orchestration/jobs.py` çš„ `annuity_income_job` æœªåŒ…å« backfill ops | æ›´æ–° job å®šä¹‰ï¼Œæ·»åŠ  `generic_backfill_refs_op` | Job æ‰§è¡Œæ—¶åŒ…å«å›å¡«æ­¥éª¤                       | âœ… Story 7.3-7 å·²ä¿®å¤ (ä»£ç éªŒè¯: `jobs.py:168` `generic_backfill_refs_op(processed_data)`) |

---

## å››ã€å¤„ç†æµç¨‹å·®å¼‚é—®é¢˜

> **æ¥æº:** `annuity-income-processing-gap-analysis.md`

### 4.1 company_id è§£æé—®é¢˜ (Critical)

| ç¼–å·         | é—®é¢˜æè¿°                                                                                         | é¢„æœŸä¿®å¤æ–¹æ¡ˆ                                                                              | é¢„æœŸä¿®å¤ç»“æœ                                  | å®é™…è¿›å±•                |
| ------------ | ------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------- | --------------------------------------------- | ----------------------- |
| **PIPE-001** | `annuity_income` çš„ `company_id` ç¼ºå°‘å¤šä¼˜å…ˆçº§åŒ¹é…ç­–ç•¥ï¼Œå…¨éƒ¨ç”Ÿæˆä¸´æ—¶ ID                           | åœ¨ `annuity_income/service.py` åˆå§‹åŒ– `CompanyMappingRepository`ï¼Œä¼ é€’ç»™ pipeline builder | ETL å `company_id` æ··åˆä½¿ç”¨ç¼“å­˜ ID å’Œä¸´æ—¶ ID | âœ… Story 7.3-6 å·²ä¿®å¤ (ä»£ç éªŒè¯: `service.py:263-278` åˆå§‹åŒ– `CompanyMappingRepository`) |
| **PIPE-002** | `annuity_income/pipeline_builder.py` çš„ `CompanyIdResolutionStep` ç¼ºå°‘ `mapping_repository` å‚æ•° | æ·»åŠ å‚æ•°å¹¶ä¼ é€’ç»™ `CompanyIdResolver`                                                      | å¯ç”¨æ•°æ®åº“ç¼“å­˜æŸ¥æ‰¾ä¼˜å…ˆçº§                      | âœ… Story 7.3-6 å·²ä¿®å¤ (ä»£ç éªŒè¯: `pipeline_builder.py:122,143`) |
| **PIPE-003** | `build_bronze_to_silver_pipeline()` ç¼ºå°‘ `mapping_repository` å‚æ•°                               | æ·»åŠ å‚æ•°åˆ°å‡½æ•°ç­¾å                                                                        | Pipeline æ”¯æŒæ•°æ®åº“ç¼“å­˜æŸ¥æ‰¾                   | âœ… Story 7.3-6 å·²ä¿®å¤ (ä»£ç éªŒè¯: `pipeline_builder.py:185,298`) |

### 4.2 å®¢æˆ·åç§°å¡«å……é—®é¢˜ (High)

| ç¼–å·         | é—®é¢˜æè¿°                                                                                            | é¢„æœŸä¿®å¤æ–¹æ¡ˆ                                        | é¢„æœŸä¿®å¤ç»“æœ                                       | å®é™…è¿›å±•                |
| ------------ | --------------------------------------------------------------------------------------------------- | --------------------------------------------------- | -------------------------------------------------- | ----------------------- |
| **PIPE-004** | `annuity_income` çš„ `_fill_customer_name` é”™è¯¯åœ°ä½¿ç”¨ `è®¡åˆ’åç§°` ä½œä¸º fallbackï¼Œç„¶åå¡«å…… `"UNKNOWN"` | ä¿®æ”¹ä¸ºä¿ç•™ null å€¼ï¼ˆä¸ `annuity_performance` ä¸€è‡´ï¼‰ | `å®¢æˆ·åç§°` ä¸º null æ—¶ä¿æŒ nullï¼Œä¸è¢«æ›¿æ¢ä¸ºè®¡åˆ’åç§° | âœ… Story 7.3-6 å·²ä¿®å¤ (ä»£ç éªŒè¯: `pipeline_builder.py:43-51` ä»…è¿”å› `df["å®¢æˆ·åç§°"]`ï¼Œæ—  fallback) |

### 4.3 è®¡åˆ’ä»£ç å¤„ç†é—®é¢˜ (Medium)

| ç¼–å·         | é—®é¢˜æè¿°                                                          | é¢„æœŸä¿®å¤æ–¹æ¡ˆ                                                                                           | é¢„æœŸä¿®å¤ç»“æœ                   | å®é™…è¿›å±•                |
| ------------ | ----------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ | ------------------------------ | ----------------------- |
| **PIPE-005** | `annuity_income` ç¼ºå°‘ `PLAN_CODE_CORRECTIONS` å¸¸é‡å’Œå¤„ç†æ­¥éª¤      | åœ¨ `annuity_income/constants.py` æ·»åŠ  `PLAN_CODE_CORRECTIONS = {"1P0290": "P0290", "1P0807": "P0807"}` | è®¡åˆ’ä»£ç é”™è¯¯è‡ªåŠ¨ä¿®æ­£           | âœ… Story 7.3-6 å·²ä¿®å¤ (ä»£ç éªŒè¯: `constants.py:30`) |
| **PIPE-006** | `annuity_income` ç¼ºå°‘ `PLAN_CODE_DEFAULTS` å¸¸é‡å’Œå¤„ç†æ­¥éª¤         | æ·»åŠ  `PLAN_CODE_DEFAULTS = {"é›†åˆè®¡åˆ’": "AN001", "å•ä¸€è®¡åˆ’": "AN002"}`                                 | ç©ºè®¡åˆ’ä»£ç è‡ªåŠ¨åˆ†é…é»˜è®¤å€¼       | âœ… Story 7.3-6 å·²ä¿®å¤ (ä»£ç éªŒè¯: `constants.py:33`) |
| **PIPE-007** | `annuity_income` pipeline ç¼ºå°‘ `ReplacementStep` å¤„ç†è®¡åˆ’ä»£ç ä¿®æ­£ | åœ¨ pipeline ä¸­æ·»åŠ  `ReplacementStep({"è®¡åˆ’ä»£ç ": PLAN_CODE_CORRECTIONS})`                              | Pipeline å…·æœ‰è®¡åˆ’ä»£ç ä¿®æ­£èƒ½åŠ›  | âœ… Story 7.3-6 å·²ä¿®å¤ (ä»£ç éªŒè¯: `pipeline_builder.py:221`) |
| **PIPE-008** | `annuity_income` ç¼ºå°‘ `_apply_plan_code_defaults` å‡½æ•°            | ä» `annuity_performance` å¤åˆ¶æˆ–æå–å…±äº«å‡½æ•°                                                            | ç©ºè®¡åˆ’ä»£ç æ ¹æ®è®¡åˆ’ç±»å‹è‡ªåŠ¨å¡«å…… | âœ… Story 7.3-6 å·²ä¿®å¤ (ä»£ç éªŒè¯: `pipeline_builder.py:54-73`) |

### 4.4 ç»„åˆä»£ç å¤„ç†å·®å¼‚ (Low)

| ç¼–å·         | é—®é¢˜æè¿°                                                                                                         | é¢„æœŸä¿®å¤æ–¹æ¡ˆ                                                | é¢„æœŸä¿®å¤ç»“æœ         | å®é™…è¿›å±• |
| ------------ | ---------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------- | -------------------- | -------- |
| **PIPE-009** | `annuity_performance` ä½¿ç”¨ `_clean_portfolio_code()` å‡½æ•°ï¼Œ`annuity_income` ä½¿ç”¨å†…è” pandas æ–¹æ³•ï¼Œå¤§å°å†™å¤„ç†ä¸åŒ | (å¯é€‰) æå–å…±äº«å‡½æ•°åˆ° infrastructure å±‚ï¼Œæˆ–è®°å½•ä¸ºå¯æ¥å—å·®å¼‚ | ç»„åˆä»£ç å¤„ç†é€»è¾‘ç»Ÿä¸€ | âœ… å¯æ¥å—å·®å¼‚ (ä»£ç éªŒè¯: `pipeline_builder.py:76-111` ä½¿ç”¨ `_apply_portfolio_code_defaults` å‡½æ•°ï¼Œé€»è¾‘ç‹¬ç«‹ä½†å®Œæ•´) |

---

## äº”ã€é…ç½®ä¼˜å…ˆçº§é—®é¢˜

> **æ¥æº:** `config-priority-issue.md`

| ç¼–å·        | é—®é¢˜æè¿°                                                                       | é¢„æœŸä¿®å¤æ–¹æ¡ˆ                                                                                     | é¢„æœŸä¿®å¤ç»“æœ                           | å®é™…è¿›å±•              |
| ----------- | ------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------ | -------------------------------------- | --------------------- |
| **CFG-001** | PowerShell ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§é«˜äº `.wdh_env` æ–‡ä»¶ï¼Œå¯¼è‡´ Alembic è¿ç§»è¿æ¥é”™è¯¯æ•°æ®åº“ | æ–¹æ¡ˆ A: ä¿®æ”¹ `get_database_connection_string()` å¼ºåˆ¶ä» `.wdh_env` è¯»å–ï¼›æˆ–æ–¹æ¡ˆ B: æ–‡æ¡£åŒ–å½“å‰è¡Œä¸º | é…ç½®æ¥æºå•ä¸€æ˜ç¡®ï¼Œé¿å…ç¯å¢ƒå˜é‡æ„å¤–è¦†ç›– | âœ… Story 7.3-5 å·²ä¿®å¤ (ä»£ç éªŒè¯: `settings.py:354-413` ç›´æ¥è§£æ `.wdh_env` æ–‡ä»¶ï¼Œæ³¨é‡Šæ˜ç¡® "System environment variables are IGNORED") |

---

## å…­ã€æ¶æ„å¯ç»´æŠ¤æ€§é—®é¢˜ (Technical Debt)

> **æ¥æº:** `new-domain-checklist.md`ã€`priority-roadmap.md`

### 6.1 ç¡¬ç¼–ç åˆ†æ´¾é—®é¢˜

| ç¼–å·       | é—®é¢˜æè¿°                                                      | é¢„æœŸä¿®å¤æ–¹æ¡ˆ                                                   | é¢„æœŸä¿®å¤ç»“æœ                       | å®é™…è¿›å±•              |
| ---------- | ------------------------------------------------------------- | -------------------------------------------------------------- | ---------------------------------- | --------------------- |
| **MD-001** | `cli/etl/executors.py` L200-232 ä½¿ç”¨ç¡¬ç¼–ç  if/elif é“¾åˆ†æ´¾ job | å®ç° `JOB_REGISTRY: Dict[str, JobDefinition]` æ³¨å†Œè¡¨æ¨¡å¼       | æ–°å¢ domain æ— éœ€ä¿®æ”¹ executor ä»£ç  | âœ… Story 7.4-1 å·²ä¿®å¤ (ä»£ç éªŒè¯: `executors.py:200-214` ä½¿ç”¨ `JOB_REGISTRY.get(domain_key)`) |
| **MD-002** | `cli/etl/config.py` L157 çš„ backfill åŸŸåˆ—è¡¨ç¡¬ç¼–ç              | å°† `requires_backfill` é…ç½®ç§»è‡³ `data_sources.yml` å…ƒæ•°æ®      | é€šè¿‡é…ç½®å£°æ˜ domain èƒ½åŠ›           | âœ… Story 7.4-2 å·²ä¿®å¤ (ä»£ç éªŒè¯: `config.py:157-164` ä½¿ç”¨ `requires_backfill` é…ç½®) |
| **MD-003** | æ¯ä¸ª domain éƒ½éœ€è¦ä¸“é—¨çš„ `process_{domain}_op` å‡½æ•°           | åˆ›å»ºé€šç”¨ `process_generic_domain_op` åŠ¨æ€ä»£ç†åˆ° domain service | å‡å°‘é‡å¤ op å®šä¹‰                   | âœ… Story 7.4-3 å·²ä¿®å¤ (ä»£ç éªŒè¯: `domain_processing.py:57` `process_domain_op` + `DOMAIN_SERVICE_REGISTRY`) |
| **MD-004** | é”™è¯¯æ¶ˆæ¯ä¸­æ”¯æŒçš„ domain åˆ—è¡¨æ‰‹åŠ¨ç»´æŠ¤                          | ä» registry æˆ–é…ç½®åŠ¨æ€ç”Ÿæˆ                                     | é”™è¯¯æ¶ˆæ¯è‡ªåŠ¨æ›´æ–°                   | âœ… Story 7.4-1 å·²ä¿®å¤ (ä»£ç éªŒè¯: `executors.py:213` `sorted(JOB_REGISTRY.keys())`) |
| **MD-005** | æ— æ³•éªŒè¯ `data_sources.yml` ä¸­çš„ domain æ˜¯å¦æœ‰å¯¹åº” job        | æ·»åŠ å¯åŠ¨æ—¶æ ¡éªŒé€»è¾‘                                             | é…ç½®é”™è¯¯æå‰å‘ç°                   | âœ… Story 7.4-4 å·²ä¿®å¤ (ä»£ç éªŒè¯: `main.py:250` `validate_domain_registry()`) |

### 6.2 æ–°å¢ Domain æ‰€éœ€æ”¹åŠ¨æ¸…å•

**Epic 7.4 å‰** (æ—§æ¶æ„) - æ–°å¢ä¸€ä¸ª **ç®€å• domain** (æ—  backfill/enrichment) éœ€è¦ä¿®æ”¹ï¼š

| #   | æ–‡ä»¶                                | ä¿®æ”¹ç±»å‹                   | çŠ¶æ€ |
| --- | ----------------------------------- | -------------------------- | ---- |
| 1   | `domain/{new_domain}/`              | åˆ›å»ºåŒ…                     | å¿…é¡» |
| 2   | `orchestration/ops/pipeline_ops.py` | æ·»åŠ  `process_{domain}_op` | å¿…é¡» |
| 3   | `orchestration/jobs.py`             | æ·»åŠ  `{domain}_job`        | å¿…é¡» |
| 4   | `cli/etl/executors.py`              | æ·»åŠ  elif åˆ†æ”¯             | å¿…é¡» |
| 5   | `config/data_sources.yml`           | æ·»åŠ  domain é…ç½®           | å¿…é¡» |

**å¤æ‚ domain** (å« backfill + enrichment) é¢å¤–éœ€è¦ï¼š

| #   | æ–‡ä»¶                      | ä¿®æ”¹ç±»å‹     | çŠ¶æ€ |
| --- | ------------------------- | ------------ | ---- |
| 6   | `cli/etl/config.py`       | æ·»åŠ æ¡ä»¶åˆ†æ”¯ | å¿…é¡» |
| 7   | `config/foreign_keys.yml` | æ·»åŠ  FK é…ç½® | å¿…é¡» |

---

**Epic 7.4 å** (æ–°æ¶æ„ - Job Registry Pattern) - **ç®€åŒ–æ¸…å•:**

| #   | æ–‡ä»¶                          | ä¿®æ”¹ç±»å‹               | çŠ¶æ€           |
| --- | ----------------------------- | ---------------------- | -------------- |
| 1   | `domain/{new_domain}/`        | åˆ›å»ºåŒ…                 | å¿…é¡»           |
| 2   | `config/data_sources.yml`     | æ·»åŠ  domain é…ç½®       | å¿…é¡»           |
| 3   | `config/foreign_keys.yml`     | (å¯é€‰) æ·»åŠ  FK é…ç½®     | å¤æ‚ domain    |

**Epic 7.4 æ”¹è¿› (Story 7.4-1, 7.4-2, 7.4-3):**
- âœ… `orchestration/ops/pipeline_ops.py` - ä½¿ç”¨ `process_generic_domain_op` (æ— éœ€æ‰‹åŠ¨æ·»åŠ )
- âœ… `orchestration/jobs.py` - ä½¿ç”¨ `JOB_REGISTRY` è‡ªåŠ¨æ³¨å†Œ (æ— éœ€æ‰‹åŠ¨æ·»åŠ )
- âœ… `cli/etl/executors.py` - è‡ªåŠ¨ä» registry å‘ç° (æ— éœ€ if/elif)
- âœ… `cli/etl/config.py` - `requires_backfill` ä» `data_sources.yml` è¯»å– (æ— éœ€ç¡¬ç¼–ç )

**æ–°æ¶æ„ä¼˜åŠ¿:**
- æ–°å¢ç®€å• domain åªéœ€ 2 å¤„ä¿®æ”¹ (domain åŒ… + é…ç½®æ–‡ä»¶)
- æ–°å¢å¤æ‚ domain åªéœ€ 3 å¤„ä¿®æ”¹ (domain åŒ… + é…ç½®æ–‡ä»¶ + FK é…ç½®)
- é›¶ä»£ç ä¿®æ”¹å³å¯æ·»åŠ æ–° domain çš„ CLI æ”¯æŒ

---

## ä¸ƒã€éªŒè¯ SQL è¯­å¥

å®Œæˆä¿®å¤åï¼Œä½¿ç”¨ä»¥ä¸‹ SQL éªŒè¯ä¿®å¤æ•ˆæœï¼š

### 7.1 éªŒè¯è¡¨ç»“æ„

```sql
-- éªŒè¯ æ”¶å…¥æ˜ç»† è¡¨ç»“æ„ (é¢„æœŸ 21 åˆ—)
SELECT COUNT(*) AS column_count
FROM information_schema.columns
WHERE table_schema='business' AND table_name='æ”¶å…¥æ˜ç»†';

-- éªŒè¯ è§„æ¨¡æ˜ç»† è¡¨ç»“æ„ (é¢„æœŸ 27 åˆ—)
SELECT COUNT(*) AS column_count
FROM information_schema.columns
WHERE table_schema='business' AND table_name='è§„æ¨¡æ˜ç»†';

-- ç¡®è®¤ Story 7.3-4 æ–°å¢å­—æ®µå­˜åœ¨
SELECT column_name FROM information_schema.columns
WHERE table_schema='business' AND table_name='æ”¶å…¥æ˜ç»†'
  AND column_name IN ('è®¡åˆ’åç§°', 'ç»„åˆç±»å‹', 'ç»„åˆåç§°', 'æœºæ„åç§°');
```

### 7.2 éªŒè¯æ•°æ®è´¨é‡

```sql
-- éªŒè¯ company_id ä¸å†å…¨éƒ¨æ˜¯ä¸´æ—¶ ID
SELECT
  SUM(CASE WHEN "company_id" LIKE 'IN%' THEN 1 ELSE 0 END) AS temp_ids,
  SUM(CASE WHEN "company_id" NOT LIKE 'IN%' THEN 1 ELSE 0 END) AS cached_ids
FROM "business"."æ”¶å…¥æ˜ç»†"
WHERE "æœˆåº¦" = '2025-10-01';

-- éªŒè¯ å®¢æˆ·åç§° null ä¿ç•™ (ä¸å†è¢«æ›¿æ¢ä¸ºè®¡åˆ’åç§°)
SELECT COUNT(*) AS null_customer_names
FROM "business"."æ”¶å…¥æ˜ç»†"
WHERE "æœˆåº¦" = '2025-10-01' AND "å®¢æˆ·åç§°" IS NULL;
```

---

## é™„å½•ï¼šé—®é¢˜ä¸¥é‡æ€§ç»Ÿè®¡

| ä¸¥é‡æ€§        | æ•°é‡ | å·²ä¿®å¤ | å¾…å¤„ç† |
| ------------- | ---- | ------ | ------ |
| **Critical**  | 3    | 3      | 0      |
| **High**      | 2    | 2      | 0      |
| **Medium**    | 12   | 12     | 0      |
| **Low**       | 5    | 5      | 0      |
| **Info/Debt** | 8    | 8      | 0      |
| **æ€»è®¡**      | 30   | 30     | 0      |

**æœ€åæ›´æ–°:** 2025-12-31 (ä»£ç å®é”¤éªŒè¯å®Œæˆ - 100% ä¿®å¤ç‡ç¡®è®¤)

---

## å‚è€ƒæ–‡æ¡£

- [annuity-income-processing-gap-analysis.md](./annuity-income-processing-gap-analysis.md) - å¤„ç†æµç¨‹å·®å¼‚åˆ†æ
- [shared-field-validators-analysis.md](./shared-field-validators-analysis.md) - å…±äº«å­—æ®µéªŒè¯å™¨åˆ†æ
- [domain-field-gap-summary.md](./domain-field-gap-summary.md) - åŸŸå­—æ®µç¼ºå¤±æ±‡æ€»
- [fk-backfill-gap-analysis.md](./fk-backfill-gap-analysis.md) - FK å›å¡«ç¼ºå¤±åˆ†æ
- [config-priority-issue.md](./config-priority-issue.md) - é…ç½®ä¼˜å…ˆçº§é—®é¢˜
- [new-domain-checklist.md](./new-domain-checklist.md) - æ–°å¢åŸŸæ£€æŸ¥æ¸…å•
- [priority-roadmap.md](./priority-roadmap.md) - ä¿®å¤ä¼˜å…ˆçº§è·¯çº¿å›¾
