# 客户数据管理架构咨询

## 1. 咨询背景

我们是一家年金管理公司，需要管理客户的多种身份状态信息。当前数据库采用 PostgreSQL，客户数据存储在 `customer` schema 下，业务明细数据存储在 `business` schema 下。

### 1.1 业务背景

- **产品线**：企业年金（企年）和职业年金（职年）
- **服务类型**：受托管理和投资管理
- **客户状态**：战客、已客、中标、流失

### 1.2 客户状态定义

| 状态 | 定义 | 数据来源 | 更新频率 |
|------|------|----------|----------|
| **战客** | 战略客户（资产规模≥5亿） | 1. 上年度末资产规模≥5亿自动判定<br>2. 特殊客户手工标注 | 年度初始化 + 手工标注 |
| **已客** | 存量客户 | 上年度末有资产规模 | 年度滚动更新 |
| **新客** | 新增客户 | 上年度末无资产规模 | 年度滚动更新 |
| **中标** | 新签约客户 | 每月收集名单，专人审核确认 | 月度滚动更新 |
| **流失** | 流失客户 | 每月收集名单，专人审核确认 | 月度滚动更新 |

### 1.3 资产规模数据来源

客户资产规模数据来自 `business."规模明细"` 表，该表包含：
- 时间范围：2022-12 至 2025-10
- 总记录数：625,126 条
- 唯一客户数：10,153 个
- 唯一计划数：1,131 个

---

## 2. 当前数据库结构

### 2.1 Customer Schema 表格清单

共 11 个表格，按产品线和客户状态分表：

| 表名 | 记录数 | 主键 | 主键类型 |
|------|--------|------|----------|
| 企年受托中标 | 275 | 无 | - |
| 企年受托已客 | 339 | 年金计划号 | 业务键 |
| 企年受托战客 | 114 | company_id | 客户ID |
| 企年受托流失 | 190 | 无 | - |
| 企年投资中标 | 120 | 无 | - |
| 企年投资已客 | 488 | 年金计划号 | 业务键 |
| 企年投资战客 | 239 | company_id | 客户ID |
| 企年投资流失 | 32 | 无 | - |
| 职年受托已客 | 33 | 年金计划号 | 业务键 |
| 职年投资已客 | 77 | 年金计划号 | 业务键 |
| 续签客户清单 | 730 | 无 | - |

### 2.2 表格结构详情

#### 2.2.1 战客表（以企年受托战客为例）

```sql
-- 主键：company_id（客户维度）
CREATE TABLE customer."企年受托战客" (
    id              INTEGER NOT NULL,
    company_id      VARCHAR NOT NULL PRIMARY KEY,
    客户名称         VARCHAR,
    管理资格         VARCHAR,
    年金计划号       VARCHAR NOT NULL,
    年金计划全称     VARCHAR,
    计划类型         VARCHAR,
    "23年11月底资产规模" DOUBLE PRECISION,
    备注            TEXT
);
```

#### 2.2.2 已客表（以企年受托已客为例）

```sql
-- 主键：年金计划号（计划维度）
CREATE TABLE customer."企年受托已客" (
    id              INTEGER NOT NULL,
    年金计划号       VARCHAR NOT NULL PRIMARY KEY,
    年金计划全称     VARCHAR,
    计划类型         VARCHAR,
    管理资格         VARCHAR,
    客户名称         VARCHAR,
    company_id      VARCHAR,
    "23年11月底资产规模" DOUBLE PRECISION,
    备注            TEXT
);
```

#### 2.2.3 中标表（以企年受托中标为例）

```sql
-- 无主键（数据质量问题）
CREATE TABLE customer."企年受托中标" (
    id INTEGER NOT NULL, 区域 VARCHAR, 年金中心 VARCHAR, 机构 VARCHAR,
    机构代码 VARCHAR, 业务类型 VARCHAR, 客户全称 VARCHAR,
    company_id VARCHAR, 受托人 VARCHAR, 计划规模 DOUBLE PRECISION,
    年缴规模 DOUBLE PRECISION, 计划类型 VARCHAR, 中标日期 DATE,
    证明材料 VARCHAR, 上报月份 DATE, 考核标签 VARCHAR, 考核有效 SMALLINT,
    年金计划号 VARCHAR NOT NULL, 客户类型 VARCHAR, 备注 TEXT
);
-- 注意：客户全称 字段名与其他表的 客户名称 不一致
```

#### 2.2.4 规模明细表（业务数据来源）

```sql
CREATE TABLE business."规模明细" (
    id INTEGER NOT NULL, 月度 DATE, 业务类型 VARCHAR, 计划类型 VARCHAR,
    计划代码 VARCHAR, 计划名称 VARCHAR, 组合类型 VARCHAR, 组合代码 VARCHAR,
    组合名称 VARCHAR, 客户名称 VARCHAR, 期初资产规模 DOUBLE PRECISION,
    期末资产规模 DOUBLE PRECISION, 供款 DOUBLE PRECISION,
    "流失(含待遇支付)" DOUBLE PRECISION, 流失 DOUBLE PRECISION,
    待遇支付 DOUBLE PRECISION, 投资收益 DOUBLE PRECISION,
    当期收益率 DOUBLE PRECISION, 机构代码 VARCHAR, 机构名称 VARCHAR,
    产品线代码 VARCHAR, 年金账户号 VARCHAR, 年金账户名 VARCHAR,
    company_id VARCHAR
);
```

---

## 3. 当前问题分析

### 3.1 主键设计不一致

| 表类型 | 主键 | 问题 |
|--------|------|------|
| 战客表 | company_id | 客户维度，一个客户一条记录 |
| 已客表 | 年金计划号 | 计划维度，一个计划一条记录 |
| 中标/流失表 | 无 | 无法保证数据唯一性 |

**核心矛盾**：同一客户可能有多个年金计划，战客表按客户聚合，已客表按计划展开。

### 3.2 字段命名不一致

- 客户名称字段：`客户名称` vs `客户全称`
- 资产规模字段：`23年11月底资产规模`（硬编码年份）

### 3.3 表格设计问题

1. **按状态分表**：战客、已客、中标、流失各自独立表格
2. **按产品分表**：受托、投资各自独立表格
3. **职年系列不完整**：缺少战客、中标、流失表

### 3.4 数据质量问题

- `续签客户清单` 的 company_id 全部为空（730条记录）
- 中标/流失表无主键约束

### 3.5 数据关系发现

| 发现 | 数据 |
|------|------|
| 客户跨表分布 | 有客户同时出现在4个表中（战客+已客，受托+投资） |
| 客户-计划关系 | 单一计划：1客户=1计划；集合计划：多客户共享少数计划 |
| 战客与已客重叠 | 110/114 战客同时是已客（96.5%） |
| 中标与已客关系 | 275个中标客户都不在已客表中（新签约） |
| 流失与已客关系 | 190个流失中仅41个在已客表中（21.6%） |

---

## 4. 咨询问题

### 4.1 数据建模问题

1. **客户与计划的关系建模**：一个客户可能有多个年金计划，应该如何设计主表和关联表？

2. **状态管理方式**：客户状态（战客/已客/中标/流失）应该：
   - 继续按状态分表？
   - 合并为一张表，用状态字段区分？
   - 使用状态历史表记录变更？

3. **产品线区分**：受托和投资业务应该：
   - 继续按产品分表？
   - 合并为一张表，用产品类型字段区分？

### 4.2 主键设计问题

1. **统一主键策略**：应该使用 company_id（客户维度）还是 年金计划号（计划维度）作为主键？

2. **复合主键**：是否应该使用复合主键（如 company_id + 年金计划号 + 产品类型）？

3. **中标/流失表主键**：如何为滚动更新的数据设计合适的主键？

### 4.3 数据更新策略

1. **战客判定逻辑**：
   - 年度初始化：根据上年度末资产规模自动判定
   - 手工标注：特殊客户需要手工标注为战客
   - 如何设计表结构支持这两种来源？

2. **中标/流失滚动更新**：
   - 每月收集新数据
   - 如何处理历史数据？保留还是覆盖？

---

## 5. 报表需求

### 5.1 常见报表场景

根据不同分类对规模明细数据进行穿透分析：

```
期末资产规模统计维度：
├── 产品线（受托/投资）
│   ├── 战客/非战客
│   │   ├── 新客
│   │   └── 已客
```

### 5.2 跨产品线汇总需求

需要支持跨产品线（受托+投资）汇总客户信息的场景。

---

## 6. 约束条件

1. **暂不考虑数据迁移**：本次咨询仅关注数据设计规范
2. **保持业务连续性**：新设计需要支持现有业务流程
3. **数据来源**：资产规模数据来自 `business."规模明细"` 表

---

## 7. 期望输出

1. 推荐的客户数据表结构设计方案
2. 主键和索引设计建议
3. 状态管理和历史追踪的最佳实践
4. 数据更新流程设计建议
