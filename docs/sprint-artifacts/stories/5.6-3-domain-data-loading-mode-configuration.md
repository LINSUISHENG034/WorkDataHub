# Story 5.6.3: Domain Data Loading Mode Configuration

**Epic:** 5.6 - Post-MVP Optimizations
**Status:** Done
**Priority:** Medium
**Estimate:** 3 hours
**Actual:** 3 hours

---

## Story

**As a** data pipeline developer,
**I want** configurable data loading modes (REFRESH vs UPSERT) for each domain,
**So that** I can choose the appropriate loading strategy based on table type (detail vs aggregate).

---

## Background

### Problem Discovery

During Story 5.6.3 implementation review, we discovered that the original UPSERT approach was fundamentally incompatible with detail tables (`annuity_performance`, `annuity_income`):

- **Original Design:** UPSERT (ON CONFLICT DO UPDATE) requiring UNIQUE constraints
- **Problem:** Detail tables have multiple records per key combination - UNIQUE constraints would fail
- **Legacy Behavior:** DELETE + INSERT pattern (not UPSERT)

### Legacy Analysis

**Legacy `data_processor.py` mechanism:**
```python
def delete_existing_records(self, db, data, fields):
    field_list = fields.split("+")  # e.g., "月度+业务类型" → ["月度", "业务类型"]
    unique_combinations = get_unique_combinations(data, field_list)
    db.delete_rows_by_criteria(...)

def _import(self, db):
    if self.update_based_on_field:
        self.delete_existing_records(db, data, self.update_based_on_field)  # DELETE first
    db.import_data(...)  # Then INSERT
```

**Legacy `annuity_mapping` configuration:**

| Domain | `update_based_on_field` |
|--------|------------------------|
| 规模明细 | `月度+业务类型` |
| 收入明细 | `月度` |

### Solution

Implement dual loading mode support:
1. **REFRESH Mode** (DELETE + INSERT) - For detail tables
2. **UPSERT Mode** (ON CONFLICT DO UPDATE) - For aggregate tables (future use)

---

## Acceptance Criteria

### AC-1: WarehouseLoader supports REFRESH mode
- [x] New `load_with_refresh()` method added to `WarehouseLoader` class
- [x] Method accepts `refresh_keys` parameter defining DELETE scope
- [x] Extracts unique combinations from input DataFrame
- [x] Deletes matching records before inserting new ones
- [x] Returns `LoadResult` with rows_inserted and rows_deleted counts

### AC-2: Domain services support configurable loading mode
- [x] `ENABLE_UPSERT_MODE` flag controls loading strategy
- [x] `DEFAULT_REFRESH_KEYS` defines DELETE scope for REFRESH mode
- [x] `DEFAULT_UPSERT_KEYS` preserved for future UPSERT mode use
- [x] Service function selects appropriate loader method based on config

### AC-3: annuity_performance configured for REFRESH mode
- [x] `ENABLE_UPSERT_MODE = False`
- [x] `DEFAULT_REFRESH_KEYS = ["月度", "业务类型", "计划类型"]`
- [x] Clear documentation comments explaining the configuration

### AC-4: annuity_income configured for REFRESH mode
- [x] `ENABLE_UPSERT_MODE = False`
- [x] `DEFAULT_REFRESH_KEYS = ["月度", "业务类型", "计划类型"]`
- [x] Clear documentation comments explaining the configuration

### AC-5: Invalid UNIQUE constraint migration removed
- [x] `20251206_000001_add_upsert_constraints.py` deleted
- [x] No UNIQUE constraints required for detail tables

### AC-6: Documentation updated
- [x] `domain-development-guide.md` updated with "Data Loading Mode Configuration" section
- [x] Quick reference table for mode selection
- [x] Current domain configurations documented

---

## Technical Implementation

### Files Modified

| File | Change |
|------|--------|
| `io/loader/warehouse_loader.py` | Added `load_with_refresh()` method (~150 LOC) |
| `domain/annuity_performance/service.py` | Added loading mode configuration |
| `domain/annuity_income/service.py` | Added loading mode configuration |
| `domain/annuity_performance/schemas.py` | Removed Gold-layer aggregation/unique enforcement for detail data |
| `domain/annuity_income/schemas.py` | Disabled duplicate rejection; aligned Gold validation to allow detail rows |
| `docs/guides/domain-development-guide.md` | Added "Data Loading Mode Configuration" section |

### Additional files touched (transparency)

- `src/work_data_hub/config/settings.py` (config validation adjustments)
- `src/work_data_hub/io/readers/excel_reader.py`, `src/work_data_hub/utils/column_normalizer.py`
- `src/work_data_hub/infrastructure/transforms/projection_step.py`
- Tests under `tests/` and documentation indices (`docs/bmm-index.md`, `docs/guides/developer-guide.md`)

### Files Deleted

| File | Reason |
|------|--------|
| `io/schema/migrations/versions/20251206_000001_add_upsert_constraints.py` | UNIQUE constraints incompatible with detail tables |

### New API

```python
# WarehouseLoader.load_with_refresh()
def load_with_refresh(
    self,
    df: pd.DataFrame,
    table: str,
    schema: str = "public",
    refresh_keys: List[str],
) -> LoadResult:
    """
    Load DataFrame using DELETE + INSERT pattern (Legacy-compatible refresh mode).

    Suitable for detail tables where same key combination can have multiple records.
    Does NOT require UNIQUE constraints.
    """
```

### Configuration Pattern

```python
# service.py - Detail table configuration
ENABLE_UPSERT_MODE = False  # Use REFRESH mode
DEFAULT_UPSERT_KEYS: Optional[List[str]] = ["月度", "计划代码", "组合代码", "company_id"]
DEFAULT_REFRESH_KEYS = ["月度", "业务类型", "计划类型"]

# service.py - Aggregate table configuration (future)
ENABLE_UPSERT_MODE = True  # Use UPSERT mode
DEFAULT_UPSERT_KEYS = ["月度", "计划代码"]
DEFAULT_REFRESH_KEYS: Optional[List[str]] = None
```

---

## Testing

### Test Results

- **Domain unit tests:** 245 passed, 1 failed (pre-existing issue)
- **Warehouse loader tests:** 66 passed

### Manual Verification

- [x] `load_with_refresh()` correctly deletes matching records
- [x] New records inserted after deletion
- [x] Transaction rollback on error

---

## References

- [Sprint Change Proposal - Upsert Keys Redesign](../sprint-change-proposal/sprint-change-proposal-2025-12-06-upsert-keys-redesign.md)
- [Domain Development Guide - Data Loading Mode Configuration](../../guides/domain-development-guide.md#data-loading-mode-configuration)
- [Legacy data_processor.py](../../../legacy/annuity_hub/data_handler/data_processor.py)

---

## Completion Notes

**Completed:** 2025-12-06
**Implemented By:** Claude (AI Assistant)

### Key Decisions

1. **Renamed story** from "Domain Upsert Keys Configuration" to "Domain Data Loading Mode Configuration" to reflect the broader scope
2. **Preserved UPSERT capability** for future aggregate table domains
3. **Unified refresh_keys** for both domains: `["月度", "业务类型", "计划类型"]` (updated from Legacy's simpler keys per user requirement)

### Lessons Learned

- Always analyze Legacy implementation before designing new features
- DELETE + INSERT is fundamentally different from UPSERT
- Detail tables (明细数据) cannot use UNIQUE constraints
