# Story 5.6.2: Normalize Company Name Bracket Fix

Status: Done

## Story

As a **data engineer**,
I want **company names with abnormal bracket patterns at start/end to be cleaned correctly**,
so that **data quality is maintained**.

## Priority

**HIGH** - This is a bug fix that affects data quality.

## Background

During Epic 5.5 MVP validation, a bracket handling bug was discovered:
- Input: `"å…¬å¸(é›†å›¢)"`
- Expected: `"å…¬å¸"` (trailing bracket removed)
- Actual: `"å…¬å¸ï¼ˆé›†å›¢"` (missing closing bracket - **BUG**)

### Business Rule (ä¸šåŠ¡è§„åˆ™)

> å…¬å¸åç§°ä»¥ `(xx)` æˆ– `ï¼ˆxxï¼‰` ä¸º**å¼€å¤´æˆ–ç»“å°¾**éƒ½åº”å½’ç±»ä¸ºå¼‚å¸¸å­—ç¬¦ï¼Œæ­£å¸¸ä¼ä¸šåç§°ä¸å¯èƒ½å‡ºç°è¯¥æƒ…å†µï¼Œå¯ä»¥ç›´æ¥æ¸…é™¤ã€‚
>
> **é™åˆ¶ï¼š** åªå¤„ç†å¼€å¤´ã€ç»“å°¾çš„æƒ…å†µï¼Œä¸­é—´çš„æ‹¬å·å†…å®¹ä¸å¯ç›´æ¥æ¸…é™¤ã€‚

## Acceptance Criteria

1. **AC1**: Leading brackets `(xx)` or `ï¼ˆxxï¼‰` at the **start** of company name are removed
2. **AC2**: Trailing brackets `(xx)` or `ï¼ˆxxï¼‰` at the **end** of company name are removed
3. **AC3**: Brackets in the **middle** of company name are preserved unchanged
4. **AC4**: All existing unit tests for `normalize_company_name` continue to pass
5. **AC5**: New test cases cover the 5 scenarios defined in this story

## Tasks / Subtasks

- [x] Task 1: Fix `normalize_company_name` function (AC: #1, #2, #3)
  - [x] 1.1: Add regex to remove leading bracket pattern `^[ï¼ˆ\(][^ï¼‰\)]*[ï¼‰\)]`
  - [x] 1.2: Add regex to remove trailing bracket pattern `[ï¼ˆ\(][^ï¼‰\)]*[ï¼‰\)]$`
  - [x] 1.3: Ensure middle brackets are not affected
- [x] Task 2: Run existing tests (AC: #4)
  - [x] 2.1: Run `uv run pytest tests/unit/infrastructure/cleansing/ -v`
  - [x] 2.2: Fix any regressions (Note: Pre-existing test failure in test_rules.py unrelated to this story)
- [x] Task 3: Add new test cases (AC: #5)
  - [x] 3.1: Add 5 test cases from acceptance criteria table (10 tests total including edge cases)

## Dev Notes

### Implementation Approach

**File:** `src/work_data_hub/infrastructure/cleansing/rules/string_rules.py`

Add 2 regex substitutions to `normalize_company_name()` function:

```python
def normalize_company_name(value: Any) -> Any:
    """Normalize company name with bracket cleanup."""
    if value is None:
        return None

    if not isinstance(value, str):
        return value

    result = value.strip()

    # åŠè§’è½¬å…¨è§’æ‹¬å·ï¼ˆä¿æŒç°æœ‰é€»è¾‘ï¼‰
    result = result.replace("(", "ï¼ˆ").replace(")", "ï¼‰")

    # NEW: æ¸…ç†å¼€å¤´çš„æ‹¬å·å†…å®¹ (xx) æˆ– ï¼ˆxxï¼‰
    result = re.sub(r'^[ï¼ˆ\(][^ï¼‰\)]*[ï¼‰\)]', '', result)

    # NEW: æ¸…ç†ç»“å°¾çš„æ‹¬å·å†…å®¹ (xx) æˆ– ï¼ˆxxï¼‰
    result = re.sub(r'[ï¼ˆ\(][^ï¼‰\)]*[ï¼‰\)]$', '', result)

    # ... å…¶ä»–ç°æœ‰æ¸…æ´—é€»è¾‘ ...

    return result.strip()
```

### Current Code Analysis

Current implementation at `string_rules.py:58-97`:
- Line 69: Removes whitespace and decorative chars
- Line 74-84: Removes specific patterns and status markers
- Line 90-91: Converts full-width ASCII to half-width
- Line 95: Converts `(` to `ï¼ˆ` and `)` to `ï¼‰`

**Bug Location:** The bracket conversion at line 95 happens AFTER the suffix removal logic (lines 74-84), which means:
1. Input `"å…¬å¸(é›†å›¢)"`
2. After suffix removal: Still `"å…¬å¸(é›†å›¢)"` (not matched by existing patterns)
3. After bracket conversion: `"å…¬å¸ï¼ˆé›†å›¢ï¼‰"` â†’ But the closing `)` was already converted, leaving orphan

**Fix:** Add explicit start/end bracket removal BEFORE the existing suffix logic.

### Test Cases

| Input | Expected Output | Description |
|-------|-----------------|-------------|
| `"(é›†å›¢)ä¸­å›½æœºæ¢°å…¬å¸"` | `"ä¸­å›½æœºæ¢°å…¬å¸"` | Leading bracket removed |
| `"ä¸­å›½æœºæ¢°å…¬å¸(é›†å›¢)"` | `"ä¸­å›½æœºæ¢°å…¬å¸"` | Trailing bracket removed |
| `"ï¼ˆæµ‹è¯•ï¼‰å¹³å®‰é“¶è¡Œï¼ˆé›†å›¢ï¼‰"` | `"å¹³å®‰é“¶è¡Œ"` | Both leading and trailing removed |
| `"ä¸­å›½ï¼ˆåŒ—äº¬ï¼‰ç§‘æŠ€å…¬å¸"` | `"ä¸­å›½ï¼ˆåŒ—äº¬ï¼‰ç§‘æŠ€å…¬å¸"` | Middle bracket preserved |
| `"åä¸ºæŠ€æœ¯æœ‰é™å…¬å¸"` | `"åä¸ºæŠ€æœ¯æœ‰é™å…¬å¸"` | No brackets, unchanged |

### Project Structure Notes

- File location: `src/work_data_hub/infrastructure/cleansing/rules/string_rules.py`
- Test location: `tests/unit/infrastructure/cleansing/test_string_rules.py`
- Follows existing cleansing rule patterns
- Uses `@rule` decorator from cleansing registry

### Regex Explanation

```python
# Leading bracket pattern
r'^[ï¼ˆ\(][^ï¼‰\)]*[ï¼‰\)]'
# ^           - Start of string
# [ï¼ˆ\(]      - Opening bracket (full-width or half-width)
# [^ï¼‰\)]*    - Any characters except closing brackets (non-greedy)
# [ï¼‰\)]      - Closing bracket (full-width or half-width)

# Trailing bracket pattern
r'[ï¼ˆ\(][^ï¼‰\)]*[ï¼‰\)]$'
# Same pattern but with $ for end of string
```

### References

- [Source: docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-06-post-mvp-optimizations.md#OPT-002]
- [Source: src/work_data_hub/infrastructure/cleansing/rules/string_rules.py#L53-100]
- [Source: docs/cleansing-rules/] - Legacy cleansing documentation

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

### Completion Notes List

- âœ… Added 2 regex patterns to `normalize_company_name()` for leading/trailing bracket removal
- âœ… Patterns placed AFTER whitespace removal but BEFORE existing suffix logic
- âœ… Created new test file `tests/unit/infrastructure/cleansing/test_string_rules.py` with 18 tests
- âœ… All 10 bracket-specific tests pass (5 from AC + 5 edge cases)
- âš ï¸ Pre-existing test failure in `tests/unit/cleansing/test_rules.py::test_normalize_company_name_collapses_spaces` - NOT introduced by this story (verified via git stash)
- ğŸ”„ Optimized regex pattern sorting (moved to module constant) per code review
- ğŸ”„ Improved test assertion strictness for nested brackets per code review

### File List

- `src/work_data_hub/infrastructure/cleansing/rules/string_rules.py` (modified)
- `tests/unit/infrastructure/cleansing/__init__.py` (new)
- `tests/unit/infrastructure/cleansing/test_string_rules.py` (new)

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2025-12-06 | Story 5.6.2 implementation complete - bracket cleanup for company names | Claude Opus 4.5 |
| 2025-12-06 | Code Review fixes: Optimized sorting, stricter tests, added untracked files | Amelia (Dev Agent) |
