# Story 6.2-P7: Enterprise Schema Consolidation

**Epic:** 6.2 - Generic Reference Data Management
**Type:** Patch Story
**Priority:** High
**Status:** ready-for-dev

## Story

As a **data engineer**,
I want **the enterprise schema refactored to align `base_info` with the Legacy `archive_base_info` structure (37 columns) and properly structured `business_info`/`biz_label` tables**,
so that **EQC API data can be fully persisted with complete field coverage, enabling historical analysis and Legacy system parity**.

## Background & Business Context

### Current State
Story 6.2-P5 implemented EQC data persistence to `enterprise.base_info`, but validation against the Legacy system (`legacy/annuity_hub/crawler/run.py`) revealed significant gaps:

1. **base_info Field Gap**: Current table has ~6 columns vs Legacy `archive_base_info` with 37 columns
2. **Missing Tables**: `business_info` and `biz_label` tables exist but lack proper structure for EQC data
3. **Deprecated Table**: `company_master` is deprecated but still exists in the migration

### Gap Analysis (from Sprint Change Proposal)

| Comparison | Current Implementation | Legacy System | Gap |
|------------|----------------------|---------------|-----|
| API Endpoints | 1 (search) | 3 (search + findDepart + findLabels) | 2 missing |
| base_info Columns | 6 columns | 37 columns (archive_base_info) | 31 columns missing |
| Raw Data Storage | raw_data (search response) | MongoDB complete storage | 2 API responses not stored |

### Architecture Decision
**Refactor migration to consolidate schema** - Since the project is not yet deployed, we can directly refactor the migration to:
1. Remove deprecated `company_master` table
2. Expand `base_info` to match `archive_base_info` structure
3. Redesign `business_info` with normalized field formats
4. Create proper `biz_label` table structure

**Migration Strategy (Required):**
- This story **intentionally rewrites** `io/schema/migrations/versions/20251206_000001_create_enterprise_schema.py` (same revision id) to ensure a clean, consolidated Enterprise schema for all new environments.
- **Implication:** Alembic will not re-run this revision on databases that already applied it. Therefore, all validation for this story must be performed against a **fresh database** (new DB name / empty DB) or a fully rebuilt dev database.
- **Non-goal:** Provide incremental “ALTER TABLE” evolution for existing dev/shared databases. If a non-fresh DB must be supported, create a separate operational runbook (outside this story).

## Scope

### In Scope
- Refactor `20251206_000001_create_enterprise_schema.py` migration
- Remove `company_master` table definition (deprecated)
- Expand `base_info` table to 37+ columns (align with `archive_base_info`)
- Add raw response JSONB columns: `raw_business_info`, `raw_biz_label`
- Redesign `business_info` table with normalized field types
- Create `biz_label` table with proper structure
- Add appropriate indexes for query performance
- Update any code references to removed `company_master` table
- Make migrations runnable on a **fresh database from 0 → head** (this migration must create `enterprise.base_info`, `enterprise.business_info`, `enterprise.biz_label` so later migrations can safely `ALTER`/extend them)
- Define unambiguous **column naming & quoting rules** for legacy-aligned fields (camelCase vs snake_case, and duplicate/alias columns)

### Out of Scope
- API client changes (Story 6.2-P8)
- Data cleansing rules (Story 6.2-P9)
- Data migration from existing records (operational task)

## Acceptance Criteria

| AC | Description | Priority |
|----|-------------|----------|
| AC1 | Remove `company_master` table from migration (deprecated) | Required |
| AC2 | Expand `base_info` table to include all 37 `archive_base_info` columns | Required |
| AC3 | Add `raw_business_info` JSONB column to `base_info` for findDepart response | Required |
| AC4 | Add `raw_biz_label` JSONB column to `base_info` for findLabels response | Required |
| AC5 | Add `api_fetched_at` TIMESTAMP column to `base_info` for tracking | Required |
| AC6 | Redesign `business_info` table with normalized field types (DATE, NUMERIC) | Required |
| AC7 | Create `biz_label` table with proper structure and FK to `base_info` | Required |
| AC8 | Add appropriate indexes for query performance | Required |
| AC9 | Update code references that depend on `company_master` | Required |
| AC10 | Migration is idempotent (IF NOT EXISTS / IF EXISTS guards) | Required |
| AC11 | Downgrade migration properly reverses all changes | Required |
| AC12 | Unit tests verify schema structure | Required |

## Hard Constraints (Do Not Violate)

1. **Migration must be idempotent** - Use IF NOT EXISTS / IF EXISTS guards for all DDL
2. **Fresh DB validation is mandatory** - Because this story rewrites an existing revision, validate against a fresh database (or rebuilt dev DB) where `alembic upgrade head` runs from 0.
3. **Migrations must be self-contained** - On a fresh database, `alembic upgrade head` must create `enterprise.base_info`, `enterprise.business_info`, and `enterprise.biz_label` (later migrations may safely no-op if columns already exist).
4. **Preserve existing data patterns** - Keep `enrichment_index` and `company_mapping` tables unchanged
5. **No breaking changes to existing code** - Update all code references to removed tables
6. **Schema qualification required** - Always use `enterprise.table_name` in SQL
7. **Follow existing migration patterns** - Use `_table_exists()` and `_index_exists()` helper functions
8. **Column naming rules must be explicit** - For legacy-aligned fields with camelCase/snake_case duplicates (e.g., `"companyFullName"` vs `company_full_name`), define a single canonical column for new code and treat the other as compatibility-only.

## Tasks / Subtasks

### Phase 0: Pre-flight (Required)
- [ ] Task 0.1: Confirm migration strategy and validation environment
  - [ ] Validate this story on a **fresh Postgres database** (new DB name / empty DB)
  - [ ] Confirm `alembic upgrade head` runs from 0 without relying on pre-existing legacy tables
  - [ ] Capture the DB connection used for validation (env var / `.wdh_env` settings) in implementation notes

### Phase 1: Migration Refactoring
- [ ] Task 1.1: Remove `company_master` table definition (AC: #1)
  - [ ] Remove CREATE TABLE statement for `company_master`
  - [ ] Remove related indexes
  - [ ] Update downgrade to not drop `company_master`
- [ ] Task 1.1a: Update existing migration tests that assume `company_master` exists
  - [ ] Update `tests/integration/migrations/test_enterprise_schema_migration.py` to remove `company_master` assertions and replace with `base_info/business_info/biz_label` assertions
- [ ] Task 1.2: Expand `base_info` table structure (AC: #2, #3, #4, #5)
  - [ ] Add all 37 columns from `archive_base_info` schema
  - [ ] Add `raw_business_info` JSONB column
  - [ ] Add `raw_biz_label` JSONB column
  - [ ] Add `api_fetched_at` TIMESTAMP WITH TIME ZONE column
  - [ ] Preserve existing columns: `company_id`, `search_key_word`, `raw_data`, `updated_at`
  - [ ] Apply column naming & quoting rules (see Dev Notes) and document which columns are canonical vs compatibility-only
- [ ] Task 1.3: Redesign `business_info` table (AC: #6)
  - [ ] Create table with normalized field types
  - [ ] `registered_date` as DATE type
  - [ ] `registered_capital` as NUMERIC(20,2) type
  - [ ] Add FK reference to `base_info(company_id)`
  - [ ] Add `_cleansing_status` JSONB column
- [ ] Task 1.4: Create `biz_label` table (AC: #7)
  - [ ] Create table with proper structure
  - [ ] Add FK reference to `base_info(company_id)`
  - [ ] Add index on `company_id` for efficient lookups
  - [ ] Ensure migration order: `base_info` → `business_info`/`biz_label` (FK dependencies)

### Phase 2: Index Optimization
- [ ] Task 2.1: Add performance indexes (AC: #8)
  - [ ] Index on `base_info.unite_code` for lookup (EQC/credit-code style queries)
  - [ ] Index on `base_info.search_key_word` for search-key filtering
  - [ ] Index on `base_info.api_fetched_at` for freshness queries
  - [ ] Index on `biz_label.company_id` for FK lookups
  - [ ] (Optional) Composite index on `biz_label(company_id, type, lv1_name, lv2_name)` if label queries require filtering

### Phase 3: Code Updates
- [ ] Task 3.1: Update code references (AC: #9)
  - [ ] Search codebase for `company_master` references
  - [ ] Update or remove deprecated references
  - [ ] Verify no runtime dependencies on removed table
- [ ] Task 3.2: Update deprecation documentation
  - [ ] Update `docs/deprecations/company_master_table_deprecation.md`
  - [ ] Mark table as removed from migrations for fresh DBs (and clarify implications for older DBs)
- [ ] Task 3.3: Update “stale” comments that imply company_master is canonical
  - [ ] Fix `io/schema/migrations/versions/20251208_000001_create_enrichment_index.py` comment: “aligned with enterprise.company_master” → “aligned with enterprise.base_info/company_id”
  - [ ] Fix `src/work_data_hub/infrastructure/enrichment/types.py` comment reference (doc-only)

### Phase 4: Testing
- [ ] Task 4.1: Add migration tests (AC: #12)
  - [ ] Test upgrade creates all expected tables/columns
  - [ ] Test downgrade properly reverses changes
  - [ ] Test idempotency (run upgrade twice)
- [ ] Task 4.2: Verify existing tests pass
  - [ ] Run existing enrichment tests
  - [ ] Verify no regressions
- [ ] Task 4.3: Prove “fresh DB” correctness
  - [ ] Validate `alembic upgrade head` against an empty database and confirm the three tables exist with expected columns
  - [ ] Confirm later migrations (`20251214_000002`, `20251214_000003`) do not fail and are no-ops when columns already exist

## Dev Notes

### Column Naming & Compatibility Rules (Must Follow)

The legacy `archive_base_info` naming is not fully consistent (camelCase vs snake_case duplicates). To prevent ambiguity:

1. **Canonical columns for new code (must exist and be used):**
   - `company_id` (PK)
   - `search_key_word`
   - `unite_code`
   - `"companyFullName"` (quoted identifier)
   - `raw_data` (search response; already used by Story 6.2-P5)
   - `raw_business_info` (findDepart response)
   - `raw_biz_label` (findLabels response)
   - `api_fetched_at`, `updated_at`

2. **Compatibility-only columns (still created for legacy parity; do not depend on them in new code):**
   - `"companyId"` (legacy alias; treat as informational)
   - `company_full_name` (legacy alias; treat as informational)
   - `"registeredStatus"` (legacy alias; treat as informational; canonical is `registered_status`)

3. **Quoting rule:** any camelCase column **must** be created and referenced with quoted identifiers in PostgreSQL (e.g., `"companyFullName"`).

### Raw Payload Storage Policy (Must Follow)

To avoid ambiguity and duplicate storage:

1. `base_info.raw_data` stores the **search** API response payload (existing behavior from Story 6.2-P5).
2. `base_info.raw_business_info` stores the **findDepart** API response payload (entire response body).
3. `base_info.raw_biz_label` stores the **findLabels** API response payload (entire response body).
4. Never store headers, tokens, or URL parameters in any raw JSONB column.

### base_info Column Map (Types + Canonicality)

This table is the source of truth for the expected `enterprise.base_info` column names and types (legacy-aligned, with explicit canonical vs compatibility-only guidance).

| Column | Type (PostgreSQL) | Canonical? | Notes |
|--------|-------------------|------------|------|
| `company_id` | `VARCHAR(255)` | ✅ | PK; canonical company id |
| `search_key_word` | `VARCHAR(255)` | ✅ | Original search term |
| `name` | `VARCHAR(255)` | ✅ | Legacy field |
| `name_display` | `VARCHAR(255)` | ✅ | Legacy field |
| `symbol` | `VARCHAR(255)` | ✅ | Legacy field |
| `rank_score` | `DOUBLE PRECISION` | ✅ | Legacy field |
| `country` | `VARCHAR(255)` | ✅ | Legacy field |
| `company_en_name` | `VARCHAR(255)` | ✅ | Legacy field |
| `smdb_code` | `VARCHAR(255)` | ✅ | Legacy field |
| `is_hk` | `INTEGER` | ✅ | Legacy field |
| `coname` | `VARCHAR(255)` | ✅ | Legacy field |
| `is_list` | `INTEGER` | ✅ | Legacy field |
| `company_nature` | `VARCHAR(255)` | ✅ | Legacy field |
| `_score` | `DOUBLE PRECISION` | ✅ | Legacy field |
| `type` | `VARCHAR(255)` | ✅ | Legacy field |
| `"registeredStatus"` | `VARCHAR(255)` | ❌ | Compatibility-only; keep for parity |
| `organization_code` | `VARCHAR(255)` | ✅ | Legacy field |
| `le_rep` | `TEXT` | ✅ | Legacy field |
| `reg_cap` | `DOUBLE PRECISION` | ✅ | Legacy field |
| `is_pa_relatedparty` | `INTEGER` | ✅ | Legacy field |
| `province` | `VARCHAR(255)` | ✅ | Legacy field |
| `"companyFullName"` | `VARCHAR(255)` | ✅ | Canonical full name (quoted) |
| `est_date` | `VARCHAR(255)` | ✅ | Legacy field (raw string) |
| `company_short_name` | `VARCHAR(255)` | ✅ | Legacy field |
| `id` | `VARCHAR(255)` | ✅ | Legacy field |
| `is_debt` | `INTEGER` | ✅ | Legacy field |
| `unite_code` | `VARCHAR(255)` | ✅ | Canonical credit code (snake_case) |
| `registered_status` | `VARCHAR(255)` | ✅ | Canonical status (snake_case) |
| `cocode` | `VARCHAR(255)` | ✅ | Legacy field |
| `default_score` | `DOUBLE PRECISION` | ✅ | Legacy field |
| `company_former_name` | `VARCHAR(255)` | ✅ | Legacy field |
| `is_rank_list` | `INTEGER` | ✅ | Legacy field |
| `trade_register_code` | `VARCHAR(255)` | ✅ | Legacy field |
| `"companyId"` | `VARCHAR(255)` | ❌ | Compatibility-only; keep for parity |
| `is_normal` | `INTEGER` | ✅ | Legacy field |
| `company_full_name` | `VARCHAR(255)` | ❌ | Compatibility-only; keep for parity |
| `raw_data` | `JSONB` | ✅ | search payload (P5) |
| `raw_business_info` | `JSONB` | ✅ | findDepart payload |
| `raw_biz_label` | `JSONB` | ✅ | findLabels payload |
| `api_fetched_at` | `TIMESTAMPTZ` | ✅ | freshness tracking |
| `updated_at` | `TIMESTAMPTZ` | ✅ | freshness tracking (P5) |

### Schema Changes Detail

**base_info Table (Expanded):**
```sql
CREATE TABLE enterprise.base_info (
    -- Primary Key
    company_id VARCHAR(255) PRIMARY KEY,
    search_key_word VARCHAR(255),

    -- Archive base_info alignment (37 columns)
    name VARCHAR(255),
    name_display VARCHAR(255),
    symbol VARCHAR(255),
    rank_score DOUBLE PRECISION,
    country VARCHAR(255),
    company_en_name VARCHAR(255),
    smdb_code VARCHAR(255),
    is_hk INTEGER,
    coname VARCHAR(255),
    is_list INTEGER,
    company_nature VARCHAR(255),
    _score DOUBLE PRECISION,
    type VARCHAR(255),
    "registeredStatus" VARCHAR(255),
    organization_code VARCHAR(255),
    le_rep TEXT,
    reg_cap DOUBLE PRECISION,
    is_pa_relatedparty INTEGER,
    province VARCHAR(255),
    "companyFullName" VARCHAR(255),
    est_date VARCHAR(255),
    company_short_name VARCHAR(255),
    id VARCHAR(255),
    is_debt INTEGER,
    unite_code VARCHAR(255),
    registered_status VARCHAR(255),
    cocode VARCHAR(255),
    default_score DOUBLE PRECISION,
    company_former_name VARCHAR(255),
    is_rank_list INTEGER,
    trade_register_code VARCHAR(255),
    "companyId" VARCHAR(255),
    is_normal INTEGER,
    company_full_name VARCHAR(255),

    -- Raw API response storage
    raw_data JSONB,                    -- Original search response
    raw_business_info JSONB,           -- findDepart response
    raw_biz_label JSONB,               -- findLabels response

    -- Timestamps
    api_fetched_at TIMESTAMP WITH TIME ZONE,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**business_info Table (Normalized):**
```sql
CREATE TABLE enterprise.business_info (
    company_id VARCHAR(255) PRIMARY KEY REFERENCES enterprise.base_info(company_id),
    registered_date DATE,              -- Normalized DATE type
    registered_capital NUMERIC(20,2),  -- Normalized NUMERIC (unit: yuan)
    registered_status VARCHAR(100),
    legal_person_name VARCHAR(255),
    address TEXT,
    company_name VARCHAR(255),
    credit_code VARCHAR(50),
    company_type VARCHAR(100),
    industry_name VARCHAR(255),
    business_scope TEXT,
    _cleansing_status JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**biz_label Table:**
```sql
CREATE TABLE enterprise.biz_label (
    id SERIAL PRIMARY KEY,
    company_id VARCHAR(255) NOT NULL REFERENCES enterprise.base_info(company_id),
    type VARCHAR(100),
    lv1_name VARCHAR(255),
    lv2_name VARCHAR(255),
    lv3_name VARCHAR(255),
    lv4_name VARCHAR(255),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
CREATE INDEX idx_biz_label_company_id ON enterprise.biz_label(company_id);
```

### Key Files to Modify

| File | Change |
|------|--------|
| `io/schema/migrations/versions/20251206_000001_create_enterprise_schema.py` | Refactor migration |
| `io/schema/migrations/versions/20251208_000001_create_enrichment_index.py` | Update stale comment references (`company_master` → `base_info/company_id`) |
| `io/schema/migrations/versions/20251214_000002_add_raw_data_to_base_info.py` | Verify remains safe/idempotent after base_info is created in 20251206 |
| `io/schema/migrations/versions/20251214_000003_add_cleansing_status_to_business_info.py` | Verify remains safe/idempotent after business_info is created in 20251206 |
| `src/work_data_hub/infrastructure/enrichment/types.py` | Update stale comment reference (doc-only) |
| `docs/deprecations/company_master_table_deprecation.md` | Update to "removed" status |
| `tests/integration/migrations/test_enterprise_schema_migration.py` | Update/add tests |

### Critical Implementation Notes (Disaster Prevention)

1. **Preserve existing helper functions** - Keep `_table_exists()` and `_index_exists()` helpers
2. **Use quoted identifiers for camelCase columns** - PostgreSQL requires quotes for `"companyFullName"`
3. **FK constraints require base_info to exist first** - Create tables in correct order
4. **Downgrade must handle FK dependencies** - Drop dependent tables before base_info
5. **Test with fresh database** - Migration should work on empty database (and must be validated that way for this story)
6. **Do not assume legacy tables exist** - The migration set must create the required tables so later migrations can safely extend them

### Existing Code Patterns to Follow

**From existing migration (idempotency pattern):**
```python
def _table_exists(conn, table_name: str, schema: str) -> bool:
    """Check if a table exists in the given schema."""
    result = conn.execute(
        sa.text("""
            SELECT EXISTS (
                SELECT FROM information_schema.tables
                WHERE table_schema = :schema AND table_name = :table
            )
        """),
        {"schema": schema, "table": table_name},
    )
    return result.scalar()
```

### Previous Story Learnings (from 6.2-P5)

1. **Schema-qualified table names** - Always use `enterprise.table_name`
2. **Idempotent migrations** - Use IF NOT EXISTS / IF EXISTS guards
3. **Preserve existing columns** - Don't drop columns that have data
4. **Test migration both ways** - Verify upgrade AND downgrade work

### Legacy Reference: archive_base_info Columns

From Legacy PostgreSQL `enterprise.archive_base_info` table (37 columns):
- `company_id`, `search_key_word`, `name`, `name_display`, `symbol`
- `rank_score`, `country`, `company_en_name`, `smdb_code`, `is_hk`
- `coname`, `is_list`, `company_nature`, `_score`, `type`
- `registeredStatus`, `organization_code`, `le_rep`, `reg_cap`
- `is_pa_relatedparty`, `province`, `companyFullName`, `est_date`
- `company_short_name`, `id`, `is_debt`, `unite_code`, `registered_status`
- `cocode`, `default_score`, `company_former_name`, `is_rank_list`
- `trade_register_code`, `companyId`, `is_normal`, `company_full_name`

### Project Structure Notes

- Migrations: `io/schema/migrations/versions/`
- Follow Clean Architecture boundaries
- Use existing migration patterns from the codebase

## Testing / Validation

### Unit Tests (Must)

0. Update existing migration integration tests baseline:
   - Update `tests/integration/migrations/test_enterprise_schema_migration.py` to assert `base_info/business_info/biz_label` (and remove `company_master` assertions).

1. `test_migration_creates_base_info_with_all_columns`:
   - Verify all 37+ columns exist after upgrade
   - Verify column types are correct

2. `test_migration_creates_business_info`:
   - Verify table exists with correct structure
   - Verify FK constraint to base_info

3. `test_migration_creates_biz_label`:
   - Verify table exists with correct structure
   - Verify FK constraint to base_info
   - Verify index on company_id

4. `test_migration_removes_company_master`:
   - Verify company_master table does not exist after upgrade

5. `test_migration_idempotency`:
   - Run upgrade twice, verify no errors
   - Run downgrade twice, verify no errors

### Integration Validation (Must)

```bash
# Apply migration (fresh database required)
PYTHONPATH=src uv run --env-file .wdh_env alembic upgrade head

# Verify schema
PYTHONPATH=src uv run --env-file .wdh_env python -c "
from sqlalchemy import create_engine, inspect
from work_data_hub.config.settings import get_settings
settings = get_settings()
engine = create_engine(settings.database_uri)
inspector = inspect(engine)
print('Tables:', inspector.get_table_names(schema='enterprise'))
print('base_info columns:', [c['name'] for c in inspector.get_columns('base_info', schema='enterprise')])
"
```

## Definition of Done

- [ ] All REQUIRED ACs satisfied
- [ ] Migration refactored with expanded schema
- [ ] `company_master` table removed from migration
- [ ] `base_info` expanded to 37+ columns
- [ ] `business_info` redesigned with normalized types
- [ ] `biz_label` table created with proper structure
- [ ] All indexes created for performance
- [ ] Code references updated
- [ ] Unit tests added and passing
- [ ] Existing tests pass (no regressions)
- [ ] Migration tested both upgrade and downgrade
- [ ] `alembic upgrade head` validated on a fresh database from 0 (no reliance on pre-existing legacy tables)

## References

- Sprint Change Proposal: `docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-14-eqc-api-full-coverage.md`
- Previous Story: `docs/sprint-artifacts/stories/6.2-p5-eqc-data-persistence-legacy-integration.md`
- Legacy Crawler: `legacy/annuity_hub/crawler/eqc_crawler.py`
- Deprecation Notice: `docs/deprecations/company_master_table_deprecation.md`
- Existing Migration: `io/schema/migrations/versions/20251206_000001_create_enterprise_schema.py`

## Dev Agent Record

### Context Reference

- Sprint Change Proposal: `docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-14-eqc-api-full-coverage.md`

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

N/A

### Completion Notes List

(To be filled during implementation)

### File List

(To be filled during implementation)

---

## Change Log

| Date | Author | Change |
|------|--------|--------|
| 2025-12-14 | SM Agent (Claude Opus 4.5) | Initial story creation via create-story workflow |
