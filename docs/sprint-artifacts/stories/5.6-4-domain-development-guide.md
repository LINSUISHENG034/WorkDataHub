# Story 5.6.4: Domain Development Guide

Status: In Review (merge pending)

## Story

As a **developer**,
I want **a comprehensive domain development guide**,
so that **I can create new domains following established patterns**.

## Background

Epic 5.5 successfully validated the Infrastructure Layer architecture by implementing the `annuity_income` domain. The lessons learned and patterns established should be documented to enable future developers to independently create new domains.

## Acceptance Criteria

1. **AC1**: Document covers complete domain development lifecycle (from analysis to deployment)
2. **AC2**: Includes reusable code templates and configuration examples
3. **AC3**: Documents Epic 5.5 lessons learned and best practices
4. **AC4**: New developers can independently create domains using this guide
5. **AC5**: Document reviewed and merged to main branch

## Tasks / Subtasks

- [x] Task 1: Create domain development guide document (AC: #1, #2, #3)
  - [x] 1.1: Write overview and prerequisites section
  - [x] 1.2: Document 6-file standard domain structure
  - [x] 1.3: Create development checklist
  - [x] 1.4: Document key configuration patterns (upsert keys, schemas)
  - [x] 1.5: Document common issues and solutions (OPT-001, OPT-002)
  - [x] 1.6: Write testing strategy section
- [x] Task 2: Add code templates and examples (AC: #2)
  - [x] 2.1: Include model template (Pydantic)
  - [x] 2.2: Include schema template (Pandera)
  - [x] 2.3: Include service template
  - [x] 2.4: Include pipeline builder template
- [x] Task 3: Review and validation (AC: #4, #5)
  - [x] 3.1: Self-review against existing domains
  - [x] 3.2: Verify all referenced files exist
  - [x] 3.3: Update bmm-index.md with link to new guide

## Dev Notes

### Document Location

**File:** `docs/guides/domain-development-guide.md` (NEW)

### Document Outline

```markdown
# Domain Development Guide

## Overview
Guide for implementing new data domains in WorkDataHub, based on Epic 5.5 learnings.

## Prerequisites
- Understanding of Bronze-Silver-Gold architecture
- Familiarity with Pydantic and Pandera
- Access to legacy system for data analysis

## Domain Directory Structure (6-File Standard)

src/work_data_hub/domain/{domain_name}/
├── __init__.py          # Module exports
├── models.py            # Pydantic data models (Bronze/Silver/Gold)
├── schemas.py           # Pandera DataFrame schemas
├── helpers.py           # Data transformation helpers
├── service.py           # Business service layer
├── pipeline_builder.py  # Pipeline step configuration
└── assets/              # Dagster Assets (optional)
    └── __init__.py

## Development Checklist

### Phase 1: Analysis
- [ ] Analyze Legacy data source and cleansing logic
- [ ] Document column mappings (legacy → new)
- [ ] Identify validation rules and business constraints
- [ ] Document cleansing rules in docs/cleansing-rules/

### Phase 2: Implementation
- [ ] Define Pydantic models (models.py)
- [ ] Define Pandera schemas (schemas.py)
- [ ] Implement data transformation (helpers.py)
- [ ] Implement service layer (service.py)
- [ ] Configure pipeline steps (pipeline_builder.py)

### Phase 3: Configuration
- [ ] Configure upsert keys (DEFAULT_UPSERT_KEYS)
- [ ] Add data source configuration
- [ ] Create database migration (DDL + UNIQUE constraints)

### Phase 4: Testing & Validation
- [ ] Write unit tests (models, helpers, schemas)
- [ ] Write integration tests (service, pipeline)
- [ ] Legacy parity validation
- [ ] Performance baseline

### Phase 5: Documentation
- [ ] Update domain documentation (docs/domains/)
- [ ] Create runbook (docs/runbooks/)
- [ ] Update bmm-index.md

## Key Configuration Patterns

### UPSERT_KEYS
[Documentation of upsert configuration with examples...]

### Schema Validation Rules
[Best practices for Pandera schema design...]

### Cleansing Rules
[How to add domain-specific cleansing rules...]

## Common Issues & Solutions

### Bracket Handling (OPT-002)
[Document the bracket bug and fix pattern...]

### Failed Record Tracking (OPT-001)
[Document failed record export pattern...]

### Column Name Normalization
[Document Chinese column name handling...]

## Testing Strategy

### Unit Tests
- Test Pydantic model validation
- Test helper functions
- Test schema validation

### Integration Tests
- Test full pipeline execution
- Test database loading

### Legacy Parity Tests
- Compare output with legacy system
- Validate row counts and aggregates

## Reference Implementations

### annuity_performance
- Location: src/work_data_hub/domain/annuity_performance/
- Documentation: docs/domains/annuity_performance.md
- Runbook: docs/runbooks/annuity_performance.md

### annuity_income
- Location: src/work_data_hub/domain/annuity_income/
- Documentation: (not yet published; refer to source code)

## Code Templates

### models.py Template
[Pydantic model template with Bronze/Silver/Gold layers...]

### schemas.py Template
[Pandera schema template with validation rules...]

### service.py Template
[Service layer template with standard API contract...]

## References
- [Architecture Documentation](../architecture/index.md)
- [Cleansing Rules Documentation](../cleansing-rules/)
- [Legacy Parity Validation Guide](../runbooks/legacy-parity-validation.md)
```

### Content Sources

| Section | Source |
|---------|--------|
| Domain Structure | `src/work_data_hub/domain/annuity_performance/` |
| Development Checklist | Epic 5.5 stories (5.5.1-5.5.5) |
| Common Issues | Sprint Change Proposal OPT-001, OPT-002 |
| Testing Strategy | `tests/unit/domain/`, `tests/integration/` |
| Code Templates | Existing domain implementations |

### Project Structure Notes

- New file: `docs/guides/domain-development-guide.md`
- May need to create `docs/guides/` directory
- Update `docs/bmm-index.md` to include link to new guide
- Follows existing documentation patterns

### Estimated Effort

- Document writing: 2-3 hours
- Code template extraction: 30 minutes
- Review and validation: 30 minutes
- Total: ~3-4 hours

### References

- [Source: docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-06-post-mvp-optimizations.md#OPT-004]
- [Source: src/work_data_hub/domain/annuity_performance/]
- [Source: src/work_data_hub/domain/annuity_income/]
- [Source: docs/bmm-index.md]
- [Source: docs/domains/annuity_performance.md]

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - documentation-only story, no code execution required.

### Completion Notes List

1. **Task 1 Complete (2025-12-06)**: Created comprehensive domain development guide at `docs/guides/domain-development-guide.md` covering:
   - Overview and prerequisites section
   - 6-file standard domain structure documentation
   - 6-phase development checklist (Analysis, Implementation, Configuration, Testing, Documentation, Deployment & Merge)
   - Key configuration patterns (UPSERT_KEYS, Cleansing Registry, Schema Validation)
   - Common issues and solutions (OPT-001 failed record tracking, OPT-002 bracket handling)
   - Testing strategy (unit, integration, legacy parity)

2. **Task 2 Complete (2025-12-06)**: Added code templates for:
   - `models.py` - Pydantic Bronze/Silver/Gold layer models
   - `schemas.py` - Pandera DataFrame schemas
   - `service.py` - Business service layer with upsert support
   - `pipeline_builder.py` - Pipeline composition

3. **Task 3 Complete (2025-12-06)**: Validation completed:
   - Self-reviewed against `annuity_performance` and `annuity_income` domains
   - Verified both domains follow 7-file structure (6 core + constants.py)
   - Updated `docs/bmm-index.md` with link to new guide under "For Creating New Domains" section
   - Merge to main pending; PR and approvals required (AC5)

### Implementation Plan

Documentation-only story - no code implementation required. Created new guide document based on Epic 5.5 learnings and existing domain implementations.

### File List

- `docs/guides/domain-development-guide.md` (new - 450+ lines)
- `docs/bmm-index.md` (updated - added link to new guide)

## Change Log

- 2025-12-06: Story implementation complete - created Domain Development Guide based on Epic 5.5 learnings
