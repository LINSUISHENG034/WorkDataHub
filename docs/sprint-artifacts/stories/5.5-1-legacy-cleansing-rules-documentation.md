# Story 5.5.1: Legacy Cleansing Rules Documentation

Status: Done

## Story

As a **developer preparing for AnnuityIncome domain migration**,
I want **comprehensive documentation of all cleansing rules from the legacy `AnnuityIncomeCleaner`**,
so that **the new domain implementation can achieve 100% parity with legacy output and establish a documentation standard for future domains**.

## Acceptance Criteria

### 1. Column Mappings Documentation
- [x] AC1: All column rename operations documented in standard table format
- [x] AC2: Source column names (Chinese) mapped to target column names
- [x] AC3: Any derived/calculated columns identified

### 2. Cleansing Rules Catalogue
- [x] AC4: All cleansing rules catalogued with rule type, logic, and priority
- [x] AC5: Rule types properly classified (mapping, date_parse, default_value, regex_replace, conditional, normalize)
- [x] AC6: Dependencies between rules documented (execution order)

### 3. Company ID Resolution Strategy
- [x] AC7: Standard resolution priority chain documented (matching Epic 5 Infrastructure)
- [x] AC8: Deprecated legacy rules identified (specifically COMPANY_ID5_MAPPING fallback)
- [x] AC9: Alignment with AnnuityPerformance domain confirmed

### 4. Validation Rules
- [x] AC10: Required fields identified
- [x] AC11: Data type constraints documented
- [x] AC12: Business rules that affect data quality documented

### 5. Documentation Quality
- [x] AC13: Document follows `docs/templates/cleansing-rules-template.md` format
- [x] AC14: All edge cases and legacy quirks documented
- [x] AC15: Parity validation checklist includedï¼ˆå«å¯æ‰§è¡Œæ£€æŸ¥æ­¥éª¤ï¼‰
- [x] AC16: `clean_company_name` regex logic explicitly documentedï¼ˆæŒ‰ legacy è§„åˆ™åˆ†ç‚¹åˆ—å‡ºï¼‰

### Documentation & Template Requirementsï¼ˆæ‰§è¡Œå³å®Œæˆï¼‰
- è¾“å‡ºæ–‡ä»¶ï¼š`docs/cleansing-rules/annuity-income.md`ï¼ˆä¿æŒä¸ `docs/cleansing-rules/index.md` é“¾æ¥ä¸€è‡´ï¼‰
- æ¨¡æ¿ï¼šä¸¥æ ¼å¥—ç”¨ `docs/templates/cleansing-rules-template.md`ï¼Œå¡«æ»¡æ‰€æœ‰è¡¨æ ¼/æ®µè½ï¼›ä¸ä¿ç•™å ä½ç¬¦
- å¿…å¡«å†…å®¹ï¼š
  - 1) Domain Overviewï¼šç±»å `AnnuityIncomeCleaner`ï¼ŒExcel Sheet `æ”¶å…¥æ˜ç»†`ï¼Œç›®æ ‡è¡¨/Schema å†™æ˜ï¼ˆè‹¥ç¼ºè¯·æ ‡æ³¨ TODOï¼Œä½†ç•™å¯å¡«ä½ï¼‰
  - 2) Column Mappingsï¼šæŒ‰æ‰§è¡Œé¡ºåºåˆ— 1-11ï¼ˆè§ Cleansing Operations è¡¨ï¼‰ï¼Œå« Transformation/Notes
  - 3) Cleansing Rulesï¼šRule IDï¼ˆCR-001..ï¼‰ã€Fieldã€Rule Typeã€Logicã€Priorityã€Notesï¼›æ ‡æ³¨ä¼˜å…ˆçº§ï¼ˆæ‰§è¡Œåºï¼‰
  - 4) Company ID Resolution Strategyï¼šæ ‡å‡†ä¼˜å…ˆçº§é“¾ï¼›æ˜¾å¼æ ‡æ³¨ COMPANY_ID5_MAPPING â€œDropped in Migrationâ€
  - 5) Validation Rulesï¼šRequired fieldsã€æ•°æ®ç±»å‹ã€ä¸šåŠ¡è§„åˆ™ï¼ˆå« ç»„åˆä»£ç  æ¡ä»¶é»˜è®¤ã€å¿…å¡«é¡¹ã€æ—¥æœŸæ ¼å¼ï¼‰
  - 6) Special Processing Notesï¼šåˆ—å‡º edge casesã€legacy quirksã€å·²çŸ¥é—®é¢˜ï¼ˆå«æ‰‹å·¥æ˜ å°„è¦†ç›–ã€ID5 åºŸå¼ƒï¼‰
  - 7) Parity Validation Checklistï¼šå†™å…¥å¯æ‰§è¡Œæ¸…å•ï¼ˆè¡Œæ•°ã€åˆ—åã€æ•°æ®å€¼ã€æ—¥æœŸæ ¼å¼ã€null å¤„ç†ã€company_id ä¸€è‡´æ€§ã€ID5 ç¦ç”¨æ ¸æŸ¥ï¼‰
  - 8) Security / DB / Performanceï¼šç›®æ ‡è¡¨/Schemaã€ä¸»é”®/ç´¢å¼•ã€NULL/ç±»å‹è¦æ±‚ã€è®¿é—®æ§åˆ¶/å®¡è®¡è¦æ±‚ã€æ€§èƒ½ç›®æ ‡ï¼ˆè¡Œé‡ã€æ—¶å»¶ï¼‰ã€é›†æˆ/éƒ¨ç½²è·¯å¾„
  - 9) Debugging & Exception Casesï¼šå¸¸è§å¼‚å¸¸ç¤ºä¾‹ï¼ˆè®¡åˆ’å·ç¼ºå¤±ã€æœºæ„åç§°ç¼ºåŒ¹é…ã€ç»„åˆä»£ç å¼‚å¸¸ã€æ—¥æœŸå¼‚å¸¸ã€ID5 ç¦ç”¨éªŒè¯ï¼‰ã€æ’æŸ¥æ­¥éª¤ä¸ expected vs actual
  - 10) Compatibility Notesï¼špandas/pydantic ç‰ˆæœ¬æ³¨æ„äº‹é¡¹ï¼›è‹¥æ— å˜æ›´ï¼Œæ³¨æ˜ â€œno known breaking changesâ€ ä¸”å¼•ç”¨ `docs/architecture/technology-stack.md`
  - Changelogï¼šæ·»åŠ å½“å‰æ—¥æœŸä¸ä½œè€…
- è¯­è¨€ï¼šæ­£æ–‡ä½¿ç”¨ Englishï¼›ä½†å¯ä¿ç•™ä¸­æ–‡åˆ—å/ç¤ºä¾‹ï¼›ä¿æŒç®€æ´ bulletï¼Œçªå‡ºé«˜ä¿¡å·æç¤º
- å®Œæˆå®šä¹‰ï¼ˆDoDï¼‰ï¼šæ–‡æ¡£é€šè¿‡æ¨¡æ¿æ ¸å¯¹ã€AC å‹¾é€‰ã€Parity checklist å¯æ‰§è¡Œã€è·¯å¾„ä¸ç´¢å¼•ä¸€è‡´ã€è¯„å®¡äººç­¾å­—ä½é¢„ç•™

## Tasks / Subtasks

- [x] Task 1: Analyze Legacy AnnuityIncomeCleaner Code (AC: 1, 2, 3, 4, 5, 6)
  - [x] 1.1: Extract column renames from `data_cleaner.py:240-242`
  - [x] 1.2: Document cleansing operations in execution order (lines 243-274)
  - [x] 1.3: Identify all mapping tables (COMPANY_BRANCH_MAPPING, BUSINESS_TYPE_CODE_MAPPING, DEFAULT_PORTFOLIO_CODE_MAPPING)
  - [x] 1.4: Document conditional logic for ç»„åˆä»£ç  default
  - [x] 1.5: **Document Manual Overrides:** List all hardcoded overrides in `COMPANY_BRANCH_MAPPING` (e.g., 'å†…è’™': 'G31')

- [x] Task 2: Document Company ID Resolution Strategy (AC: 7, 8, 9)
  - [x] 2.1: Document `_update_company_id()` standard logic (matches Epic 5 Infrastructure)
  - [x] 2.2: **Document Deprecation:** Identify legacy lines 272-274 (COMPANY_ID5_MAPPING) as "Legacy Logic to Drop" to ensure consistency with AnnuityPerformance
  - [x] 2.3: Confirm no other deviations from standard `CompanyIdResolutionStep`

- [x] Task 3: Create Cleansing Rules Document (AC: 13, 14, 15, 16)
  - [x] 3.1: Create `docs/cleansing-rules/annuity-income.md` (directory already exists)
  - [x] 3.2: Fill Domain Overview section
  - [x] 3.3: Complete Column Mappings tableï¼ˆæ‰§è¡Œåºä¼˜å…ˆçº§ã€Transformation/Notes å¡«æ»¡ï¼‰
  - [x] 3.4: Complete Cleansing Rules tableï¼ˆCR-001..ï¼Œå«ä¼˜å…ˆçº§ï¼‰
  - [x] 3.5: Complete Company ID Resolution Strategy sectionï¼ˆæ ‡å‡†é“¾ + ID5 åºŸå¼ƒè¯´æ˜ï¼‰
  - [x] 3.6: Complete Validation Rules sectionï¼ˆå¿…å¡«ã€ç±»å‹ã€ä¸šåŠ¡è§„åˆ™ï¼‰
  - [x] 3.7: **Document Utility Logic:** Explicitly list `clean_company_name` regex patterns/rules
  - [x] 3.8: Include Parity Validation Checklistï¼ˆå¯æ‰§è¡Œæ­¥éª¤ï¼Œå« ID5 ç¦ç”¨æ ¸æŸ¥ï¼‰

- [x] Task 4: Cross-Reference with AnnuityPerformance (AC: 4, 5)
  - [x] 4.1: Compare with AnnuityPerformanceCleaner (lines 195-233)
  - [x] 4.2: Document shared rules (~70% overlap)
  - [x] 4.3: Document AnnuityIncome-specific differences

- [x] Task 5: Validation (AC: 10, 11, 12, 14, 15)
  - [x] 5.1: Verify all 11 rules from legacy code are documented
  - [x] 5.2: Ensure document matches template checklist
  - [x] 5.3: Add Security/DB/Performance + Deployment/Integration notes + Debugging/Exception cases + Compatibility notesï¼ˆä¸ Tech Stack å¯¹é½ï¼‰

## Dev Notes

### Architecture Context

**Epic 5.5 Goal:** Validate Infrastructure Layer by implementing AnnuityIncome domain, ensuring architecture generality.

**Story 5.5.1 Purpose:** Documentation-only story creating foundation for Story 5.5.2. No code changes - only documentation creation.

**Tech Stack Guardrailsï¼ˆArchitecture â†’ Technology Stackï¼‰**
- Python 3.10+, pandasï¼ˆlockedï¼‰ï¼ŒPydantic 2.11.7+ï¼Œpanderaï¼ˆschemaï¼‰ï¼ŒDagsterï¼ˆorchestrationï¼‰ï¼Œuvï¼ˆpkgï¼‰ï¼ŒRuff 0.12.12+ï¼Œmypy 1.17.1+ï¼ˆstrictï¼‰ï¼›éµå®ˆ Clean Architecture import è§„åˆ™ï¼ˆinfra/domain ä¸ä¾èµ– io/orchestrationï¼‰ã€‚
- å‚ç…§ `docs/architecture/infrastructure-layer.md`ï¼šCompanyIdResolverã€CleansingRegistryã€standard transforms/pipeline ä½œä¸ºè¿ç§»åŸºçº¿ï¼›ä¸å¼•å…¥æ–°ä¾èµ–ã€‚
- æ–‡ä»¶ä¸é…ç½®éµå¾ª 6-file standardï¼ˆé¢å‘åç»­ Story 5.5.2ï¼‰ã€‚

**Dependencies / Story Ordering**
- Epic 5.5 storiesï¼šæœ¬æ•…äº‹å…ˆè¡Œï¼›5.5.2ï¼ˆå®ç°ï¼‰ã€5.5.3ï¼ˆparity éªŒè¯ï¼‰ã€5.5.4ï¼ˆå¤šåŸŸé›†æˆï¼‰ä¾èµ–æ­¤æ–‡æ¡£ã€‚ä¿æŒä¸ Epic 5.5 æ¦‚è¦ä¸€è‡´ï¼ˆ`docs/epics/epic-5.5-pipeline-architecture-validation.md`ï¼‰ã€‚

### Legacy Code Reference

**Source File:** `legacy/annuity_hub/data_handler/data_cleaner.py`
**Class:** `AnnuityIncomeCleaner` (lines 237-274)
**Excel Sheet:** `æ”¶å…¥æ˜ç»†`

### æ”¶å…¥æ˜ç»† Sheet Fields (AnnuityIncome-specific)

| Field | Type | Notes |
|-------|------|-------|
| æœˆåº¦ | date | Requires parse_to_standard_date() |
| æœºæ„ | string | Renamed to æœºæ„ä»£ç  |
| æœºæ„åç§° | string | Used for COMPANY_BRANCH_MAPPING lookup |
| è®¡åˆ’å· | string | Used for company_id resolution |
| å®¢æˆ·åç§° | string | Normalized via clean_company_name() |
| ä¸šåŠ¡ç±»å‹ | string | Maps to äº§å“çº¿ä»£ç  |
| è®¡åˆ’ç±»å‹ | string | Used for DEFAULT_PORTFOLIO_CODE_MAPPING |
| ç»„åˆä»£ç  | string | Regex cleaned, conditional default |
| æ”¶å…¥é‡‘é¢ | numeric | Domain-specific field |
| å¹´é‡‘è´¦æˆ·å | string | **Derived:** Copy of å®¢æˆ·åç§° before normalization |

### Cleansing Operations (Execution Order)

| # | Operation | Field | Logic | Rule Type |
|---|-----------|-------|-------|-----------|
| 1 | Column rename | æœºæ„ â†’ æœºæ„ä»£ç  | `df.rename(columns={'æœºæ„': 'æœºæ„ä»£ç '})` | mapping |
| 2 | Mapping | æœºæ„ä»£ç  | `df['æœºæ„åç§°'].map(COMPANY_BRANCH_MAPPING)` | mapping |
| 3 | Date parse | æœˆåº¦ | `parse_to_standard_date()` | date_parse |
| 4 | Default value | æœºæ„ä»£ç  | Replace 'null' with 'G00', fillna('G00') | default_value |
| 5 | Regex replace | ç»„åˆä»£ç  | `str.replace('^F', '', regex=True)` | regex_replace |
| 6 | Conditional default | ç»„åˆä»£ç  | èŒå¹´å—æ‰˜/èŒå¹´æŠ•èµ„ â†’ 'QTAN003', else DEFAULT_PORTFOLIO_CODE_MAPPING | conditional |
| 7 | Mapping | äº§å“çº¿ä»£ç  | `df['ä¸šåŠ¡ç±»å‹'].map(BUSINESS_TYPE_CODE_MAPPING)` | mapping |
| 8 | Copy | å¹´é‡‘è´¦æˆ·å | `df['å¹´é‡‘è´¦æˆ·å'] = df['å®¢æˆ·åç§°']` (before normalization) | copy |
| 9 | Normalize | å®¢æˆ·åç§° | `clean_company_name()` | normalize |
| 10 | Company ID | company_id | `_update_company_id(plan_code_col='è®¡åˆ’å·', customer_name_col='å®¢æˆ·åç§°')` | resolution |
| 11 | Fallback | company_id | `df['å¹´é‡‘è´¦æˆ·å'].map(COMPANY_ID5_MAPPING)` when company_id is empty | fallback |

### Mapping Tables Reference

| Mapping Table | Purpose | Source | Shared? |
|---------------|---------|--------|---------|
| `COMPANY_BRANCH_MAPPING` | æœºæ„åç§° â†’ æœºæ„ä»£ç  | `mappings.py:88-110` (DB + manual overrides) | Yes |
| `BUSINESS_TYPE_CODE_MAPPING` | ä¸šåŠ¡ç±»å‹ â†’ äº§å“çº¿ä»£ç  | `mappings.py:11-23` (DB query) | Yes |
| `DEFAULT_PORTFOLIO_CODE_MAPPING` | è®¡åˆ’ç±»å‹ â†’ é»˜è®¤ç»„åˆä»£ç  | `mappings.py:71` (static) | Yes |
| `COMPANY_ID5_MAPPING` | **DEPRECATED** (Legacy only) | `mappings.py:180-194` | **Dropped** |

### âš ï¸ COMPANY_BRANCH_MAPPING Complete Values

**CRITICAL:** The mapping includes manual overrides not in the database. Full mapping from `mappings.py:101-110`:

```python
# Base mapping from DB: SELECT æœºæ„, æœºæ„ä»£ç  FROM ç»„ç»‡æ¶æ„
# Plus manual overrides:
COMPANY_BRANCH_MAPPING.update({
    'å†…è’™': 'G31',
    'æˆ˜ç•¥': 'G37',
    'ä¸­å›½': 'G37',
    'æµå—': 'G21',
    'åŒ—äº¬å…¶ä»–': 'G37',
    'åŒ—åˆ†': 'G37',
})
```

**Note:** `annuity_performance/constants.py` has a subset. Ensure AnnuityIncome includes ALL entries.

### ğŸš¨ DEPRECATION NOTICE: COMPANY_ID5_MAPPING

**DECISION:** The legacy fallback logic using `COMPANY_ID5_MAPPING` (lines 272-274) is **DEPRECATED** and will **NOT** be ported.
- **Reason:** Architecture alignment. `AnnuityIncome` must strictly follow the standard `CompanyIdResolutionStep` used by `AnnuityPerformance`.
- **Action:** Documentation should list this rule but explicitly mark it as "Dropped in Migration".

### Utility Functions Reference

#### `parse_to_standard_date()`
**Location:** `legacy/annuity_hub/common_utils/common_utils.py:264-305`

Handles Chinese date formats:
- `YYYYå¹´MMæœˆ` â†’ datetime (adds day 1)
- `YYYYå¹´MMæœˆDDæ—¥` â†’ datetime
- `YYYYMMDD` â†’ datetime
- `YYYYMM` â†’ datetime (adds day 01)
- `YYYY-MM` â†’ datetime (adds day -01)
- Other formats â†’ `dateutil.parser.parse()`

**Infrastructure equivalent:** Check if `infrastructure/utils/` has similar function or use CleansingRegistry.

#### `clean_company_name()`
**Location:** `legacy/annuity_hub/common_utils/common_utils.py:309-343`

Operations:
1. Remove all whitespace: `re.sub(r'\s+', '', name)`
2. Remove "åŠä¸‹å±å­ä¼ä¸š"
3. Remove suffixes: `(å›¢æ‰˜)`, `-[A-Za-z]+`, `-\d+`, `-å…»è€`, `-ç¦åˆ©`
4. Remove CORE_REPLACE_STRING patterns (start/end)
5. Clean trailing hyphens and brackets

**Infrastructure equivalent:** `CleansingRegistry.normalize_company_name` - verify parity.

### Comparison: AnnuityIncome vs AnnuityPerformance

| Aspect | AnnuityPerformance | AnnuityIncome |
|--------|-------------------|---------------|
| Excel Sheet | è§„æ¨¡æ˜ç»† | æ”¶å…¥æ˜ç»† |
| Plan Code Column | è®¡åˆ’ä»£ç  | è®¡åˆ’å· |
| Company ID Fallback | None | **None (Standard Only)** - Legacy ID5 dropped |
| ç»„åˆä»£ç  Processing | Default only | Regex '^F' removal + conditional default |
| å¹´é‡‘è´¦æˆ·å | Exists in data | **Derived** from å®¢æˆ·åç§° |

**Shared Operations (~80%):**
- æœºæ„ä»£ç  mapping via COMPANY_BRANCH_MAPPING
- Date parsing via parse_to_standard_date()
- Company name normalization via clean_company_name()
- Company ID resolution via _update_company_id() (Standard)
- äº§å“çº¿ä»£ç  mapping from ä¸šåŠ¡ç±»å‹

**AnnuityIncome-Specific:**
- ç»„åˆä»£ç  regex replacement (remove '^F' prefix)
- ç»„åˆä»£ç  conditional default based on ä¸šåŠ¡ç±»å‹
- å¹´é‡‘è´¦æˆ·å copy before normalization (preserved but not used for ID resolution)

### Security / DB / Performance / Deployment (to document in output)
- Target table: TODO - specify `<schema>.<table>` for AnnuityIncome cleaned output; include PK/index, unique keys, required columns, nullability, data types.
- Access & audit: follow platform standard (RBAC, audit logs); note if customer_name/plan_code classified as sensitiveâ€”document masking needs if any.
- Performance targets: state expected row volume per monthly file and target processing SLA (e.g., <3s per 1K rows; memory <200MB baseline per infra doc). Align with infra-layer performance table if available.
- Deployment/integration: documentation-only story; ensure `docs/cleansing-rules/index.md` link remains valid. For Story 5.5.2/5.5.3, reference `docs/runbooks/legacy-parity-validation.md` for validation outputs to `tests/fixtures/validation_results/`.

### Parity Validation Checklistï¼ˆæ‰§è¡Œç‰ˆï¼Œå†™å…¥æ–‡æ¡£ Section 7ï¼‰
- è¡Œ/åˆ—åŒ¹é…ï¼šè¡Œæ•°ä¸€è‡´ï¼›åˆ—å/é‡å‘½ååç­‰ä»·ï¼›æ’é™¤è®¾è®¡æ”¹è¿›åˆ—ï¼ˆè‹¥æœ‰éœ€è¯´æ˜ï¼‰ã€‚
- æ•°æ®å€¼åŒ¹é…ï¼šå­—æ®µå€¼ 100% ä¸€è‡´ï¼›æ—¥æœŸæ ¼å¼æ ‡å‡†åŒ–ï¼›null å¤„ç†ä¸ legacy ä¸€è‡´ï¼ˆå« 'null'â†’'G00'ï¼‰ã€‚
- Company IDï¼šæ ‡å‡†é“¾ `_update_company_id` ä¸€è‡´ï¼›æ˜ç¡® ID5 fallback è¢«ç¦ç”¨ä¸”ä¸åœ¨æ–°é“¾è·¯ï¼›å¯¹æ¯” AnnuityPerformance è¡Œä¸ºã€‚
- è§„åˆ™è¦†ç›–ï¼š11 ä¸ªæ¸…æ´—æ“ä½œå…¨éƒ¨æ˜ å°„åˆ° Cleansing Rules è¡¨ï¼›æ‰‹å·¥æ˜ å°„è¦†ç›–é¡¹å®Œæ•´ï¼›regex/conditional/default é¡ºåºä¸€è‡´ã€‚
- ç»“æœå½’æ¡£ï¼šéªŒè¯è„šæœ¬å‚è€ƒ `docs/runbooks/legacy-parity-validation.md`ï¼›è¾“å‡ºåˆ° `tests/fixtures/validation_results/`ï¼ŒæŠ¥å‘Šä¿å­˜å¹¶é“¾æ¥ã€‚

### cleansing_rules.yml Configuration Draft

```yaml
# Add to domains section in cleansing_rules.yml
annuity_income:
  å®¢æˆ·åç§°:
    - trim_whitespace
    - normalize_company_name
  è®¡åˆ’å·:
    - trim_whitespace
  company_id:
    - trim_whitespace
  æ”¶å…¥é‡‘é¢:
    - remove_currency_symbols
    - clean_comma_separated_number
  # Add other numeric fields as needed
```

### Output File

**Path:** `docs/cleansing-rules/annuity-income.md`

**Note:** Directory exists. File is pre-linked in `docs/cleansing-rules/index.md:21`.

### Test Data Acquisition

For Story 5.5.3 parity validation:
1. **Primary:** Real `æ”¶å…¥æ˜ç»†` data from `tests/fixtures/real_data/{YYYYMM}/æ”¶é›†æ•°æ®/æ•°æ®é‡‡é›†/*å¹´é‡‘ç»ˆç¨¿*.xlsx`
2. **Fallback:** Synthetic test data in `tests/fixtures/`

See Tech-Spec "Test Data Acquisition Plan" for details.

### Testing Standards

**No tests required** - documentation-only story.

**Validation:**
- Document completeness check against templateï¼ˆæ— å ä½ç¬¦ï¼‰
- Cross-reference with legacy codeï¼ˆ11 operations å…¨è¦†ç›–ï¼Œå« ID5 åºŸå¼ƒè¯´æ˜ï¼‰
- Verify output filename matches `index.md` link
- æ‰§è¡Œ Parity Validation Checklistï¼ˆè‡³å°‘ dry-run æ¸…å•ï¼Œè®°å½•åˆ°æ–‡æ¡£ï¼‰
- DoDï¼šæ–‡æ¡£å®¡é˜…ï¼ˆLink + å®¡é˜…äººç­¾å­—ä½é¢„ç•™ï¼‰ã€è·¯å¾„/é“¾æ¥éªŒè¯ã€ç‰ˆæœ¬/æ—¥æœŸæ›´æ–°
- Security/DB/Performanceï¼šåˆ—å‡ºç›®æ ‡è¡¨/çº¦æŸ/æ€§èƒ½ç›®æ ‡ï¼›è‹¥æœªçŸ¥ï¼Œæ ‡æ³¨ TODO ä»¥é˜²é—æ¼
- Compatibilityï¼šæ³¨æ˜ pandas/pydantic/uv/dagster æ— å·²çŸ¥ breaking changesï¼›è‹¥æœ‰ï¼Œå†™å‡ºè­¦å‘ŠåŠè¿ç§»æŒ‡å¼•
- Debugging/Exception casesï¼šåˆ—å‡ºå…¸å‹å¼‚å¸¸ï¼ˆç¼º plan_code/æœºæ„åç§°ä¸åŒ¹é…/ç»„åˆä»£ç å¼‚å¸¸/æ—¥æœŸ parse å¤±è´¥/company_id ä¸ºç©ºï¼‰ï¼Œæä¾›æ’æŸ¥æ­¥éª¤ä¸ expected vs actual ç¤ºä¾‹

### References

- [Source: legacy/annuity_hub/data_handler/data_cleaner.py:237-274]
- [Source: legacy/annuity_hub/data_handler/mappings.py]
- [Source: legacy/annuity_hub/common_utils/common_utils.py:264-343]
- [Source: docs/templates/cleansing-rules-template.md]
- [Source: docs/sprint-artifacts/tech-spec-epic-5.5-pipeline-architecture-validation.md]
- [Source: src/work_data_hub/domain/annuity_performance/constants.py]
- [Source: src/work_data_hub/infrastructure/cleansing/settings/cleansing_rules.yml]

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No debug issues encountered.

### Completion Notes List

- Story 5.5.1 is the first story in Epic 5.5 (Pipeline Architecture Validation)
- Documentation-only story - no code implementation required
- Output document serves as specification for Story 5.5.2
- Critical for establishing cleansing documentation standard
- âœ… Created comprehensive cleansing rules document at `docs/cleansing-rules/annuity-income.md`
- âœ… Documented all 11 cleansing operations (CR-001 to CR-011) with execution priority
- âœ… Documented COMPANY_ID5_MAPPING deprecation decision (lines 269-272 dropped)
- âœ… Documented `clean_company_name()` regex patterns in detail
- âœ… Identified gap: `annuity_performance/constants.py` missing 6 manual COMPANY_BRANCH_MAPPING overrides
- âœ… Added executable Parity Validation Checklist with ID5 fallback verification
- âœ… Added Security/DB/Performance, Debugging/Exception cases, Compatibility notes sections

### File List

**Files Created:**
- `docs/cleansing-rules/annuity-income.md` (NEW - 432 lines)

**Files Modified:**
- `docs/sprint-artifacts/stories/5.5-1-legacy-cleansing-rules-documentation.md` (this file)
- `docs/sprint-artifacts/sprint-status.yaml` (status update)
- `docs/sprint-artifacts/code-reviews/validation-report-5.5-1-20251204.md` (validation report, staged)
- `docs/sprint-artifacts/code-reviews/validation-report-2025-12-05T01-00-05+08-00.md` (validation report, staged)

**Files Referenced (read-only):**
- `legacy/annuity_hub/data_handler/data_cleaner.py` (lines 237-274)
- `legacy/annuity_hub/data_handler/mappings.py` (full file for mapping details)
- `legacy/annuity_hub/common_utils/common_utils.py` (lines 264-343)
- `docs/templates/cleansing-rules-template.md`
- `src/work_data_hub/domain/annuity_performance/constants.py` (reference for shared mappings)
- `docs/cleansing-rules/index.md` (verified link consistency)

### Change Log

| Date | Change |
|------|--------|
| 2025-12-04 | Story created via create-story workflow |
| 2025-12-04 | Enhanced via validate-create-story: Added complete mapping details, utility function specs, COMPANY_ID5_MAPPING decision point, cleansing_rules.yml draft |
| 2025-12-05 | Added template enforcement, parity checklist (executable), tech stack guardrails, DoD/validation expectations, Security/DB/Performance/compatibility/debugging requirements |
| 2025-12-05 | Implementation complete: Created annuity-income.md with all 11 cleansing rules, ID5 deprecation, gap analysis for COMPANY_BRANCH_MAPPING |
