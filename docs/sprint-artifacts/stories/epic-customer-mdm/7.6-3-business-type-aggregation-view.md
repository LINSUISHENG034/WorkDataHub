# Story 7.6-3: Business Type Aggregation View

Status: ready-for-dev

## Story

As a **BI Analyst**,
I want a **pre-aggregated view that groups customer data by business type (受托/投资)**,
so that **I can quickly analyze award/loss patterns across different product lines without writing complex SQL joins**.

## Acceptance Criteria

1. **AC-1**: Create `v_customer_business_monthly_status_by_type` view in `customer` schema
   - Aggregates `customer.当年中标` and `customer.当年流失` by `业务类型`
   - Groups into 受托 (企年受托) and 投资 (企年投资) categories
   - Includes monthly aggregation with `上报月份` dimension

2. **AC-2**: View provides key metrics per business type per month:
   - `award_count`: Number of awards (中标客户数)
   - `award_company_ids`: Distinct awarded company_ids
   - `loss_count`: Number of losses (流失客户数)
   - `loss_company_ids`: Distinct lost company_ids
   - `net_change`: `award_count - loss_count`

3. **AC-3**: View handles NULL `company_id` gracefully
   - NULL company_ids are excluded from distinct counts
   - Count metrics include all records regardless of company_id

4. **AC-4**: Alembic migration created as `006_create_business_type_view.py`
   - Follows existing migration pattern (004, 005)
   - Includes proper `upgrade()` and `downgrade()` functions

5. **AC-5**: View is query-able via standard SQL and accessible by Power BI
   - No additional dependencies required
   - Compatible with existing BI connection patterns

## Tasks / Subtasks

- [ ] Task 1: Create Alembic migration (AC: 4)
  - [ ] Create `io/schema/migrations/versions/006_create_business_type_view.py`
  - [ ] Define `upgrade()` with CREATE VIEW statement
  - [ ] Define `downgrade()` with DROP VIEW statement
  - [ ] Set proper revision chain (depends on 005)

- [ ] Task 2: Design and implement the view SQL (AC: 1, 2, 3)
  - [ ] Write CTE or UNION for combining 当年中标 and 当年流失 data
  - [ ] Implement business type grouping (受托/投资)
  - [ ] Add monthly aggregation with proper GROUP BY
  - [ ] Handle NULL company_id exclusion for distinct counts

- [ ] Task 3: Run migration and verify (AC: 5)
  - [ ] Execute `alembic upgrade head`
  - [ ] Query view to verify correct aggregation
  - [ ] Test with sample data from existing tables

- [ ] Task 4: Documentation
  - [ ] Update `docs/database-schema-panorama.md` with new view definition
  - [ ] Add view to Sprint Change Proposal success criteria

## Dev Notes

### Architecture Compliance

- **Schema Location**: `customer` schema (consistent with 当年中标, 当年流失 tables)
- **Migration Pattern**: Follow `004_create_annual_award.py` structure
- **Naming Convention**: View prefix `v_` per PostgreSQL best practices

### Existing Table Structure Reference

From `004_create_annual_award.py` and `005_create_annual_loss.py`:

```sql
-- customer.当年中标 (Annual Award)
"上报月份" DATE NOT NULL,           -- Report month
"业务类型" VARCHAR(20) NOT NULL,    -- 企年受托/企年投资
"产品线代码" VARCHAR(10),           -- QN01/QN02
company_id VARCHAR(50),             -- Enriched company ID (nullable)

-- customer.当年流失 (Annual Loss) - Same structure
```

### View Implementation Strategy

**Option A: Simple UNION ALL with CTE** (Recommended)
```sql
CREATE VIEW customer.v_customer_business_monthly_status_by_type AS
WITH combined AS (
    SELECT "上报月份", "业务类型", company_id, 'award' AS record_type
    FROM customer."当年中标"
    UNION ALL
    SELECT "上报月份", "业务类型", company_id, 'loss' AS record_type
    FROM customer."当年流失"
)
SELECT 
    "上报月份",
    "业务类型",
    COUNT(*) FILTER (WHERE record_type = 'award') AS award_count,
    COUNT(DISTINCT company_id) FILTER (WHERE record_type = 'award' AND company_id IS NOT NULL) AS award_distinct_companies,
    COUNT(*) FILTER (WHERE record_type = 'loss') AS loss_count,
    COUNT(DISTINCT company_id) FILTER (WHERE record_type = 'loss' AND company_id IS NOT NULL) AS loss_distinct_companies,
    COUNT(*) FILTER (WHERE record_type = 'award') - COUNT(*) FILTER (WHERE record_type = 'loss') AS net_change
FROM combined
GROUP BY "上报月份", "业务类型"
ORDER BY "上报月份" DESC, "业务类型";
```

### Project Structure Notes

- **Migration Directory**: `io/schema/migrations/versions/`
- **Existing Migrations**:
  - `001_initial_infrastructure.py` - Base schemas
  - `002_initial_domains.py` - Business tables
  - `003_seed_static_data.py` - Reference data
  - `004_create_annual_award.py` - 当年中标 table
  - `005_create_annual_loss.py` - 当年流失 table
  - `006_create_business_type_view.py` - **THIS STORY**

### Testing Approach

```bash
# Run migration
uv run --env-file .wdh_env alembic upgrade head

# Verify view exists
# In psql or DBeaver:
SELECT * FROM customer.v_customer_business_monthly_status_by_type LIMIT 10;

# Check aggregation correctness
SELECT "业务类型", SUM(award_count), SUM(loss_count)
FROM customer.v_customer_business_monthly_status_by_type
GROUP BY "业务类型";
```

### References

- [Source: docs/project-planning-artifacts/sprint-change-proposal-2026-01-10.md#Story 7.3]
- [Source: io/schema/migrations/versions/004_create_annual_award.py]
- [Source: io/schema/migrations/versions/005_create_annual_loss.py]
- [Source: docs/project-context.md#Database Architecture]

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List
