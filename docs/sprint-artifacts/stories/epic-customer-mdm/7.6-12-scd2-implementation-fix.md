# Story 7.6-12: SCD Type 2 Implementation Fix

Status: done

## At a Glance

| Attribute | Value |
|-----------|-------|
| **Goal** | Implement complete SCD Type 2 versioning for `customer_plan_contract` table |
| **Impact** | Enables accurate historical status tracking and BI report accuracy |
| **Risk** | Low (mature pattern, clear implementation path) |
| **Dependencies** | Story 7.6-6 (completed) |
| **Effort** | 1-2 days |
| **Rollback** | Revert to `ON CONFLICT DO NOTHING` if needed |

## Story

As a **BI Analyst**,
I want **customer contract status changes to be properly versioned with SCD Type 2**,
So that **I can query accurate historical status at any point in time**.

## Background

Story 7.6-6 implemented contract status sync with `ON CONFLICT DO NOTHING`, which only captures the first occurrence of each contract. Status changes (e.g., 正常→停缴) are not recorded, violating the SCD Type 2 design intent specified in `customer-plan-contract-specification.md` §5.3.

**Gap Analysis**: See [customer-plan-contract-scd2-implementation-gap.md](../../specific/customer-mdm/customer-plan-contract-scd2-implementation-gap.md)

## Acceptance Criteria

### AC-1: Status Change Detection

- Detect changes in: `contract_status`, `is_strategic`, `is_existing`
- Only create new version when at least one tracked field changes
- No action when status unchanged (idempotent)

### AC-2: Version Creation

- When status changes: close old record (`valid_to = snapshot_date - 1 day`)
- Insert new record with updated status (`valid_from = snapshot_date`, `valid_to = 9999-12-31`)
- Maintain referential integrity

### AC-3: Historical Query Support

- Query `WHERE valid_from <= :date AND valid_to >= :date` returns correct status
- Current records queryable via `WHERE valid_to = '9999-12-31'`

### AC-4: Idempotency

- Multiple runs on same data produce identical results
- No duplicate records created
- Safe to re-run after failures

### AC-5: Data Quality

- All existing validations from Story 7.6-6 still pass
- No orphaned records (old version without new version)

## Tasks / Subtasks

- [x] Task 1: Refactor `contract_sync.py` with SCD Type 2 logic (AC: 1, 2)
  - [x] Add `has_status_changed()` detection function
  - [x] Implement "close old record" UPDATE statement
  - [x] Modify INSERT to exclude unchanged records
  - [x] Maintain transaction safety

- [x] Task 2: Add unit tests for status change scenarios (AC: 1, 2, 3, 4)
  - [x] `test_status_change_creates_new_version()`
  - [x] `test_status_unchanged_no_new_version()`
  - [x] `test_historical_query_returns_correct_status()`
  - [x] `test_idempotency_with_status_changes()`

- [x] Task 3: Historical data assessment (AC: 5)
  - [x] Analyze if existing data needs repair
  - [x] Create repair script if needed
  - [x] Document data state before/after

- [x] Task 4: Update documentation (AC: all)
  - [x] Update specification document §5.3
  - [x] Close Story 7.6-6 review follow-up item

## Dev Notes

### Status Change Detection Fields

```python
def has_status_changed(old: Record, new: Record) -> bool:
    """Detect fields that trigger version creation."""
    return (
        old.contract_status != new.contract_status or
        old.is_strategic != new.is_strategic or
        old.is_existing != new.is_existing
    )
```

### SQL Implementation Pattern

```sql
-- Step 1: Close records with changed status
UPDATE customer.customer_plan_contract AS old
SET valid_to = :snapshot_date - INTERVAL '1 day',
    updated_at = CURRENT_TIMESTAMP
FROM (
    -- New status calculation subquery
    SELECT company_id, plan_code, product_line_code,
           contract_status, is_strategic, is_existing
    FROM ... -- existing status calculation
) AS new
WHERE old.company_id = new.company_id
  AND old.plan_code = new.plan_code
  AND old.product_line_code = new.product_line_code
  AND old.valid_to = '9999-12-31'
  AND (
      old.contract_status != new.contract_status OR
      old.is_strategic != new.is_strategic OR
      old.is_existing != new.is_existing
  );

-- Step 2: Insert new/changed records
INSERT INTO customer.customer_plan_contract (...)
SELECT ...
WHERE NOT EXISTS (
    SELECT 1 FROM customer.customer_plan_contract existing
    WHERE existing.company_id = new.company_id
      AND existing.plan_code = new.plan_code
      AND existing.product_line_code = new.product_line_code
      AND existing.valid_to = '9999-12-31'
      AND existing.contract_status = new.contract_status
      AND existing.is_strategic = new.is_strategic
      AND existing.is_existing = new.is_existing
);
```

### File Changes

| File | Change |
|------|--------|
| `src/work_data_hub/customer_mdm/contract_sync.py` | Refactor sync logic |
| `tests/unit/customer_mdm/test_contract_sync.py` | Add test cases |
| `docs/specific/customer-mdm/customer-plan-contract-specification.md` | Update §5.3 |

### Validation Queries

```sql
-- Verify version history exists
SELECT company_id, plan_code, product_line_code,
       contract_status, valid_from, valid_to
FROM customer.customer_plan_contract
WHERE company_id = 'TEST_COMPANY'
ORDER BY valid_from;

-- Count records with history (should be > 0 after status changes)
SELECT COUNT(*) FROM customer.customer_plan_contract
WHERE valid_to != '9999-12-31';
```

## References

- [Sprint Change Proposal](../sprint-change-proposal/sprint-change-proposal-2026-02-03-scd2-fix.md)
- [Gap Analysis](../../specific/customer-mdm/customer-plan-contract-scd2-implementation-gap.md)
- [Specification](../../specific/customer-mdm/customer-plan-contract-specification.md)
- [Story 7.6-6](./7.6-6-contract-status-sync-post-etl-hook.md)

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes

**Implementation Date:** 2026-02-03

**Key Deliverables:**
- Refactored `contract_sync.py` with proper SCD Type 2 versioning
- Added `has_status_changed()` function for status change detection
- Added `_build_close_old_records_sql()` for UPDATE statement (close old records)
- Modified `_build_sync_sql()` with NOT EXISTS clause (skip unchanged records)
- Updated `sync_contract_status()` to execute two-step SCD Type 2 process

**Test Results:**
- ✅ 7 unit tests for `has_status_changed()` function (all passing)
- ✅ 4 integration tests for SCD Type 2 versioning (all passing)
- ✅ Total: 20 tests passing across customer_mdm test suite
- ✅ Code quality checks passing for modified files

**SCD Type 2 Implementation:**
- Step 1: UPDATE closes old records when status changes (`valid_to = snapshot_date - 1 day`)
- Step 2: INSERT creates new records only for new/changed status
- Status change detection fields: `contract_status`, `is_strategic`, `is_existing`
- Uses `IS DISTINCT FROM` for NULL-safe comparison

**Historical Data Assessment:**
- No separate repair script needed
- Running new sync logic automatically repairs data by:
  - Closing stale records with outdated status
  - Inserting current status as new version

### File List

**Created:**
- `tests/unit/customer_mdm/test_contract_sync.py` - Unit tests for status change detection
- `src/work_data_hub/customer_mdm/sql/__init__.py` - SQL loader module
- `src/work_data_hub/customer_mdm/sql/common_ctes.sql` - Shared CTEs for SCD Type 2
- `src/work_data_hub/customer_mdm/sql/close_old_records.sql` - SCD Type 2 Step 1 SQL
- `src/work_data_hub/customer_mdm/sql/sync_insert.sql` - SCD Type 2 Step 2 SQL

**Modified:**
- `src/work_data_hub/customer_mdm/contract_sync.py` - Core SCD Type 2 implementation (refactored to load SQL from files)
- `tests/integration/customer_mdm/test_status_fields.py` - Added SCD Type 2 integration tests, fixed weak assertion
- `docs/specific/customer-mdm/customer-plan-contract-specification.md` - Updated §5.3 with status change detection
- `docs/sprint-artifacts/stories/epic-customer-mdm/7.6-6-contract-status-sync-post-etl-hook.md` - Closed review follow-up items

### Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-02-03 | Story implementation complete, status → review | Claude Opus 4.5 |
| 2026-02-05 | Code review fixes: extracted SQL to files, added NULL tests, fixed weak assertion | Claude Opus 4.5 |
