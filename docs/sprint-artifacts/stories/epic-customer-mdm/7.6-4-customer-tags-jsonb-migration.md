# Story 7.6-4: Customer Tags JSONB Migration

Status: done

## At a Glance

| Attribute | Value |
|-----------|-------|
| **Goal** | Migrate `年金客户标签` VARCHAR → JSONB for multi-dimensional tag support |
| **Impact** | ~10,997 rows in `mapping.年金客户` table |
| **Risk** | Low (additive column, no breaking changes) |
| **Dependencies** | None (can run independently) |
| **Rollback** | DROP COLUMN tags (loses new tags data if any) |

## Story

As a **Data Analyst**,
I want the **customer tags field (年金客户标签) migrated from VARCHAR to JSONB format**,
so that **I can support multi-dimensional tag management and enable flexible querying and filtering of customer attributes**.

## Acceptance Criteria

### Schema Changes (AC-1, AC-2, AC-3)

**AC-1**: Add new `tags` JSONB column to `mapping.年金客户` table
- Column should have default value of `'[]'::jsonb` (empty array)
- Column should be nullable (to allow gradual population)
- **Create GIN index on tags column for query performance** (critical for `@>`, `?` operators)

**AC-2**: Migrate existing `年金客户标签` VARCHAR data to `tags` JSONB column
- Empty or NULL `年金客户标签` → `'[]'::jsonb`
- Non-empty `年金客户标签` → `jsonb_build_array(年金客户标签)`
- Preserve original string value as first element in array

**AC-3**: Mark deprecated column with comment
- Add SQL comment to `年金客户标签` column: `'DEPRECATED: Use tags JSONB column instead'`
- > **⚠️ CRITICAL: Never drop the original column**
> > Backward compatibility requires keeping `年金客户标签` even after `tags` is populated.

### Migration Implementation (AC-4)

**AC-4**: Create Alembic migration `007_add_customer_tags_jsonb.py`
- Follow existing migration pattern (006_create_business_type_view)
- Include proper `upgrade()` and `downgrade()` functions
- **Migration order for efficiency**: Add column → Migrate data → Create GIN index → Add comment
- **Downgrade warning**: Will lose all tags data added after migration. Only run if no one has started using tags column yet.

### Verification (AC-5)

**AC-5**: Verify migration succeeds with data integrity
- All ~10,997 rows should have `tags` column populated
- Original `年金客户标签` values preserved in both columns
- GIN index exists: `idx_年金客户_tags_gin`
- JSONB column queryable via PostgreSQL operators (`@>`, `?`, `->`)
- **Business scenario validation**:
  - Query customers with specific tag (e.g., "战客")
  - Count customers by tag value
  - Verify array operators work correctly

## Tasks / Subtasks

- [x] Task 1: Create Alembic migration file (AC: 4)
  - [x] Create `io/schema/migrations/versions/007_add_customer_tags_jsonb.py`
  - [x] Set revision chain: `Revises: 20260115_000006` (depends on 006)
  - [x] Define `upgrade()` with proper execution order
  - [x] Define `downgrade()` with data loss warning comment

- [x] Task 2: Implement migration logic (AC: 1, 2, 3)
  - [x] Add `tags` JSONB column with default value
  - [x] Write UPDATE statement to migrate existing data (runs in single transaction by default)
  - [x] Create GIN index `idx_年金客户_tags_gin` (after data populated for efficiency)
  - [x] Add deprecation comment to `年金客户标签` column

- [x] Task 3: Run migration and verify (AC: 5)
  - [x] Execute `uv run --env-file .wdh_env alembic upgrade head`
  - [x] Verify column exists
  - [x] Verify GIN index exists
  - [x] Verify data migration: All rows have tags populated
  - [x] Test business scenario queries
  - [x] Test downgrade/upgrade cycle

- [x] Task 4: Update documentation (Required)
  - [x] Update `docs/database-schema-panorama.md` with new tags column
  - [x] Update `年金客户` table section with tags field documentation
  - [x] Mark Sprint Change Proposal success criteria

## Dev Notes

### Architecture Compliance

- **Schema Location**: `mapping` schema (existing `年金客户` table)
- **Migration Pattern**: Follow `006_create_business_type_view.py` structure
- **Data Safety**: Add column first, migrate data, never drop original column
- **Transaction Management**: Alembic runs migrations in single transaction by default (ensures atomicity)

### Migration SQL Implementation (Optimized Order)

> **Note**: Create GIN index AFTER data migration for efficiency. Indexing default `[]` values is unnecessary work.

```sql
-- Step 1: Add JSONB column (metadata only, fast)
ALTER TABLE mapping."年金客户"
ADD COLUMN tags JSONB DEFAULT '[]'::jsonb;

-- Step 2: Migrate existing data (single UPDATE, ~10,997 rows)
UPDATE mapping."年金客户"
SET tags = CASE
    WHEN "年金客户标签" IS NULL OR "年金客户标签" = '' THEN '[]'::jsonb
    ELSE jsonb_build_array("年金客户标签")
END;

-- Step 3: Create GIN index (after data populated, more efficient)
CREATE INDEX idx_年金客户_tags_gin
ON mapping."年金客户"
USING GIN (tags);

-- Step 4: Add deprecation comment
COMMENT ON COLUMN mapping."年金客户"."年金客户标签"
IS 'DEPRECATED: Use tags JSONB column instead';
```

### Transaction Safety

Alembic wraps the entire `upgrade()` function in a single transaction by default. This ensures:
- If migration fails midway, all changes roll back automatically
- Data consistency is maintained (no partial migrations)
- For ~10,997 rows, single UPDATE is safe and efficient

**Note**: For future scalability (million+ rows), consider batched updates with explicit commit points.

### JSONB Query Examples (Business Scenarios)

```sql
-- Query 1: Find customers with specific tag (uses GIN index)
SELECT company_id, "客户名称", "年金客户标签", tags
FROM mapping."年金客户"
WHERE tags @> '["战客"]'
LIMIT 10;

-- Query 2: Count customers by tag value (business analytics)
SELECT
    jsonb_array_elements(tags)->>0 AS tag_value,
    COUNT(*) AS customer_count
FROM mapping."年金客户"
WHERE jsonb_array_length(tags) > 0
GROUP BY tag_value
ORDER BY customer_count DESC;

-- Query 3: Check existence of any tag (uses GIN index)
SELECT COUNT(*)
FROM mapping."年金客户"
WHERE tags ? '战客';
```

### Future Extensibility

The JSONB format enables multi-dimensional tag management:

```jsonb
-- Current: Single tag
["战客"]

-- Future: Multiple tags
["战客", "高价值", "年金VIP"]

-- Future: Structured tags (advanced use case)
[{"type": "客户类型", "value": "战客"}, {"type": "价值分类", "value": "高价值"}]
```

### ETL Pipeline Integration Note

When implementing multi-tag ETL writes (future stories):
- Use PostgreSQL JSONB array operations: `tags || '["新标签"]'::jsonb`
- Avoid string concatenation (may break JSONB format)
- Consider adding validation layer to ensure tags array format
- GIN index enables efficient filtering in BI queries

### Downgrade Strategy

```python
def downgrade() -> None:
    """WARNING: This will lose all tags data that was added after migration.

    Only run downgrade if no one has started using the tags column yet.
    If tags have been populated with new data, export it before downgrading.
    """
    conn = op.get_bind()

    # Drop GIN index first
    conn.execute(sa.text("DROP INDEX IF EXISTS mapping.idx_年金客户_tags_gin"))

    # Drop tags column (irreversible data loss)
    conn.execute(sa.text("ALTER TABLE mapping.\"年金客户\" DROP COLUMN tags"))

    # Remove deprecation comment
    conn.execute(sa.text("COMMENT ON COLUMN mapping.\"年金客户\".\"年金客户标签\" IS NULL"))
```

### Testing Approach

```bash
# Run migration
uv run --env-file .wdh_env alembic upgrade head

# Verify column and index existence
psql -c "
SELECT
    column_name, data_type,
    (SELECT COUNT(*) FROM pg_indexes WHERE tablename = '年金客户' AND indexname = 'idx_年金客户_tags_gin') AS index_exists
FROM information_schema.columns
WHERE table_schema = 'mapping' AND table_name = '年金客户' AND column_name = 'tags';
"

# Verify data migration completeness
psql -c "
SELECT
    COUNT(*) AS total_rows,
    COUNT(CASE WHEN tags IS NOT NULL THEN 1 END) AS tags_populated,
    COUNT(CASE WHEN jsonb_array_length(tags) > 0 THEN 1 END) AS has_non_empty_tags
FROM mapping.\"年金客户\";
"

# Test business scenario queries
psql -c "
SELECT \"年金客户标签\", COUNT(*) AS count
FROM mapping.\"年金客户\"
WHERE tags @> '[\"战客\"]'
GROUP BY \"年金客户标签\";
"

# Test downgrade/upgrade cycle
uv run --env-file .wdh_env alembic downgrade -1
uv run --env-file .wdh_env alembic upgrade head
```

### Previous Story Intelligence (Story 7.6-3)

**Learnings from previous story:**
- Use idempotent `IF NOT EXISTS` patterns where applicable
- View migration pattern is simpler than table alteration
- Code Review found: Removed unused helper functions

**Code patterns established:**
- Migration revision ID format: `20260115_000007`
- Follows `down_revision` chain from 006 (`20260115_000006`)

### References

- [Source: docs/project-planning-artifacts/sprint-change-proposal-2026-01-10.md#Story 7.4 说明]
- [Source: io/schema/migrations/versions/001_initial_infrastructure.py#L629-L682]
- [Source: io/schema/migrations/versions/006_create_business_type_view.py]
- [Source: docs/sprint-artifacts/stories/epic-customer-mdm/7.6-3-business-type-aggregation-view.md]
- [Source: docs/database-schema-panorama.md#4.4 年金客户]

## Dev Agent Record

### Agent Model Used

Gemini 2.5 Pro (Code Review: 2026-01-16)

### Debug Log References

- Alembic history verified: `20260115_000007 (head)`
- Migration applied successfully to database

### Completion Notes List

- All 5 Acceptance Criteria verified and implemented
- Migration follows 006 pattern with proper execution order
- Documentation updated in `database-schema-panorama.md` (Section 4.4)
- Code Review identified and fixed idempotency issue (M-2)

### File List

- [NEW] `io/schema/migrations/versions/007_add_customer_tags_jsonb.py` - Alembic migration
- [MODIFIED] `docs/database-schema-panorama.md` - Added tags column documentation (Section 4.4)
