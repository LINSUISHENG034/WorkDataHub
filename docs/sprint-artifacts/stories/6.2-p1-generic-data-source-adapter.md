# Story 6.2-P1: Generic Data Source Adapter Architecture

**Epic:** 6.2 - Generic Reference Data Management
**Type:** Patch Story (fixes Story 6.2-4)
**Priority:** High (Blocker)
**Status:** done

---

## Story

As a **data engineer**,
I want **a generic data source adapter architecture that supports multiple database types**,
So that **reference sync can connect to PostgreSQL, MySQL, or other databases based on configuration without code changes**.

---

## Background

Story 6.2-4 (Pre-load Reference Sync Service) was implemented assuming Legacy data resides in MySQL, but the actual infrastructure has migrated Legacy data to PostgreSQL. This patch story implements a generic adapter architecture that:

1. Resolves the immediate blocker (PostgreSQL connectivity)
2. Provides future extensibility for multiple database types
3. Treats external databases as data sources, not project dependencies

**Reference:** `docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-13-generic-data-source-adapter.md`

---

## Acceptance Criteria

### AC1: PostgresSourceAdapter Implementation
**Given** the Legacy data is in PostgreSQL `legacy` database
**When** I create `PostgresSourceAdapter`
**Then** it should:
- Implement `DataSourceAdapter` protocol
- Connect to PostgreSQL using `psycopg2` or SQLAlchemy
- Support schema-qualified table access (`schema.table`)
- Read connection config from environment variables (`WDH_LEGACY_*`)
- Successfully fetch data from `enterprise`, `business`, `mapping` schemas

### AC2: MySQLSourceAdapter Preservation
**Given** some environments may still use MySQL
**When** I refactor `LegacyMySQLConnector` to `MySQLSourceAdapter`
**Then** it should:
- Retain all existing MySQL connection logic
- Implement same `DataSourceAdapter` protocol interface
- Be selectable via `source_type: "mysql"` configuration

### AC3: AdapterFactory Implementation
**Given** configuration specifies `source_type`
**When** `AdapterFactory.create(source_type)` is called
**Then** it should:
- Return `PostgresSourceAdapter` for `source_type: "postgres"`
- Return `MySQLSourceAdapter` for `source_type: "mysql"` or `"legacy_mysql"`
- Return `ConfigFileAdapter` for `source_type: "config_file"`
- Raise `ValueError` for unknown source types

### AC4: Configuration Update
**Given** current `data_sources.yml` uses `source_type: "legacy_mysql"`
**When** I update configuration
**Then** it should:
- Change to `source_type: "postgres"` for PostgreSQL sources
- Add `connection_env_prefix` for environment variable mapping
- Add `schema` field for schema-qualified access

### AC5: Reference Sync Verification
**Given** updated configuration and new adapters
**When** reference sync service runs
**Then** it should:
- Successfully connect to PostgreSQL `legacy` database
- Fetch data from configured tables (年金计划, 组合计划, 组织架构)
- Data matches expected schema and content
- No regression in existing functionality

### AC6: Test Coverage
**Given** new adapter implementations
**When** tests are executed
**Then** it should:
- Include unit tests for `PostgresSourceAdapter`
- Include unit tests for `MySQLSourceAdapter`
- Include unit tests for `AdapterFactory`
- All existing tests pass

---

## Technical Notes

### Architecture

```
┌─────────────────────────────────────────────────────────┐
│                  ReferenceSyncService                    │
│              (Existing, adapter-agnostic)                │
└─────────────────────────┬───────────────────────────────┘
                          │ uses
                          ▼
┌─────────────────────────────────────────────────────────┐
│              DataSourceAdapter Protocol                  │
│  - fetch_data(table_config, state) -> DataFrame         │
└─────────────────────────┬───────────────────────────────┘
                          │ implements
          ┌───────────────┼───────────────┬───────────────┐
          ▼               ▼               ▼               ▼
    ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐
    │ Postgres │   │  MySQL   │   │  Config  │   │  Future  │
    │ Adapter  │   │ Adapter  │   │  File    │   │ Adapters │
    └──────────┘   └──────────┘   └──────────┘   └──────────┘
```

### File Changes

| File | Action | Description |
|------|--------|-------------|
| `io/connectors/postgres_source_adapter.py` | NEW | PostgreSQL adapter |
| `io/connectors/mysql_source_adapter.py` | RENAME+REFACTOR | From `legacy_mysql_connector.py` |
| `io/connectors/adapter_factory.py` | NEW | Factory for adapter creation |
| `config/data_sources.yml` | UPDATE | Change `source_type` to `"postgres"` |
| `io/loader/company_mapping_loader.py` | UPDATE | Use generic adapter |

### Environment Variables

```bash
# Legacy PostgreSQL Database
WDH_LEGACY_HOST=localhost
WDH_LEGACY_PORT=5432
WDH_LEGACY_DATABASE=legacy
WDH_LEGACY_USER=postgres
WDH_LEGACY_PASSWORD=***
```

### Configuration Example

```yaml
reference_sync:
  tables:
    - name: "年金计划"
      source_type: "postgres"
      source_config:
        connection_env_prefix: "WDH_LEGACY"
        schema: "enterprise"
        table: "annuity_plan"
        columns:
          - source: "plan_code"
            target: "年金计划号"
```

---

## Dependencies

- Epic 6.2 Story 6.2-4 (Pre-load Reference Sync Service) - fixes
- `DataSourceAdapter` Protocol (already exists in `sync_service.py`)

---

## Definition of Done

- [x] `PostgresSourceAdapter` implemented and tested
- [x] `MySQLSourceAdapter` refactored and tested
- [x] `AdapterFactory` implemented and tested
- [x] `data_sources.yml` updated with `source_type: "postgres"`
- [x] Reference sync successfully fetches from PostgreSQL
- [x] All existing tests pass
- [x] Code review completed
- [x] Documentation updated (AD-0XX if needed)

### Validation Notes
- Tests run: `uv run pytest tests/io/connectors/test_adapters.py -q`, `uv run pytest tests/io/loader/test_company_mapping_loader.py -q`.
