# Story 7.1-3: Fix Test Collection Errors

Status: done

## Story

As a **Data Engineer**,
I want to **fix test files with import errors from `work_data_hub.scripts`**,
so that **the test suite can run without collection errors and CI pipelines are unblocked**.

## Context

**Priority:** P0 (BLOCKING) - Must complete before Epic 8
**Effort:** 1 hour
**Epic:** 7.1 - Pre-Epic 8 Bug Fixes & Improvements

### Problem Statement

During test execution, pytest reports **2 collection errors** for files attempting to import from `work_data_hub.scripts`:

```bash
$ PYTHONPATH=src uv run --env-file .wdh_env pytest tests/ --collect-only
ERROR tests/integration/scripts/test_legacy_migration_integration.py
ERROR tests/unit/scripts/test_migrate_legacy_to_enrichment_index.py
!!!!!!!!!!!!!!!!!!! Interrupted: 2 errors during collection !!!!!!!!!!!!!!!!!!!
=================== 2263 tests collected, 2 errors in 6.17s ===================
```

| File | Line | Error |
|------|------|-------|
| `tests/unit/scripts/test_migrate_legacy_to_enrichment_index.py` | 18 | `ModuleNotFoundError: No module named 'work_data_hub.scripts'` |
| `tests/integration/scripts/test_legacy_migration_integration.py` | 22 | `ModuleNotFoundError: No module named 'work_data_hub.scripts'` |

### Root Cause

Both test files use an incorrect import path:

```python
# WRONG - module does not exist
from work_data_hub.scripts.migrate_legacy_to_enrichment_index import (...)

# CORRECT - module exists at src/migrations/
from migrations.migrate_legacy_to_enrichment_index import (...)
```

**Key Discovery:** The migration module already exists at `src/migrations/migrate_legacy_to_enrichment_index.py` with full implementation (LegacyMigrationConfig, MigrationReport, etc.). Only the import path needs fixing.

### Success Impact

- Test suite runs without collection errors (2263+ tests collected, 0 errors)
- CI pipelines can execute full test suite
- Epic 8 readiness improved (clean test baseline)

## Acceptance Criteria

### AC-1: Fix `test_migrate_legacy_to_enrichment_index.py`
**GIVEN** the test file `tests/unit/scripts/test_migrate_legacy_to_enrichment_index.py` exists
**WHEN** pytest collection runs
**THEN** no ImportError is raised

**Fix:** Change line 18 import from `work_data_hub.scripts.migrate_legacy_to_enrichment_index` to `migrations.migrate_legacy_to_enrichment_index`

**Verification:**
```bash
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/unit/scripts/test_migrate_legacy_to_enrichment_index.py --collect-only
```

### AC-2: Fix `test_legacy_migration_integration.py`
**GIVEN** the test file `tests/integration/scripts/test_legacy_migration_integration.py` exists
**WHEN** pytest collection runs
**THEN** no ImportError is raised

**Fix:** Change line 22 import from `work_data_hub.scripts.migrate_legacy_to_enrichment_index` to `migrations.migrate_legacy_to_enrichment_index`

**Verification:**
```bash
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/integration/scripts/test_legacy_migration_integration.py --collect-only
```

### AC-3: Full Test Suite Passes Collection
**GIVEN** all test files are fixed
**WHEN** running full test collection
**THEN** zero collection errors reported

**Verification:**
```bash
# Should show 0 errors
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/ --collect-only 2>&1 | grep -E "(ERROR|collected)"
# Expected: =================== 2263+ tests collected in X.XXs ===================
```

## Tasks / Subtasks

- [x] **Task 1: Fix Unit Test Import** (AC-1)
  - [x] 1.1 Open `tests/unit/scripts/test_migrate_legacy_to_enrichment_index.py`
  - [x] 1.2 Change line 18: `from work_data_hub.scripts.migrate_legacy_to_enrichment_index` → `from migrations.migrate_legacy_to_enrichment_index`
  - [x] 1.3 Verify collection: `PYTHONPATH=src uv run --env-file .wdh_env pytest tests/unit/scripts/test_migrate_legacy_to_enrichment_index.py --collect-only`

- [x] **Task 2: Fix Integration Test Import** (AC-2)
  - [x] 2.1 Open `tests/integration/scripts/test_legacy_migration_integration.py`
  - [x] 2.2 Change line 22: `from work_data_hub.scripts.migrate_legacy_to_enrichment_index` → `from migrations.migrate_legacy_to_enrichment_index`
  - [x] 2.3 Verify collection: `PYTHONPATH=src uv run --env-file .wdh_env pytest tests/integration/scripts/test_legacy_migration_integration.py --collect-only`

- [x] **Task 3: Validate Full Test Suite** (AC-3)
  - [x] 3.1 Run full collection: `PYTHONPATH=src uv run --env-file .wdh_env pytest tests/ --collect-only`
  - [x] 3.2 Verify zero collection errors
  - [x] 3.3 Update sprint-status.yaml

## Dev Notes

### Critical Implementation Details

> [!IMPORTANT]
> **DO NOT DELETE THESE TEST FILES**
> 
> The migration module exists at `src/migrations/migrate_legacy_to_enrichment_index.py` and is fully functional.
> Only the import path in the test files is wrong.

**Correct Import Path:**
```python
# In test files, use:
from migrations.migrate_legacy_to_enrichment_index import (
    LegacyMigrationConfig,
    MigrationReport,
    FullMigrationReport,
    migrate_company_id_mapping,
    migrate_eqc_search_result,
)
```

**Module Location Verified:**
```
src/
├── migrations/
│   ├── __init__.py
│   └── migrate_legacy_to_enrichment_index.py  # ← Full implementation exists here
└── work_data_hub/
    └── ...  # Main package (no scripts/ submodule)
```

### Files to Modify

| File | Line | Change |
|------|------|--------|
| `tests/unit/scripts/test_migrate_legacy_to_enrichment_index.py` | 18 | `work_data_hub.scripts.` → `migrations.` |
| `tests/integration/scripts/test_legacy_migration_integration.py` | 22 | `work_data_hub.scripts.` → `migrations.` |

### Pre/Post Verification Commands

```bash
# BEFORE fix (should show 2 errors)
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/ --collect-only 2>&1 | tail -5

# AFTER fix (should show 0 errors)
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/ --collect-only 2>&1 | tail -5
# Expected output:
# =================== 2263+ tests collected in X.XXs ===================
```

### Related Context

**Note on `tests/e2e/test_company_mapping_migration.py`:**
- This file uses `src.work_data_hub` prefix but **successfully collects 11 tests**
- It tests deprecated `company_mapping` functionality (to be removed in Story 7.1-4)
- **No action needed in this story** - it will be addressed in Story 7.1-4

**Dependencies:**
- Story 7.1-4: Remove company_mapping Legacy - Will handle `test_company_mapping_migration.py`

**Blocks:** Epic 8 (cannot start with broken test suite)

## References

- [Sprint Change Proposal: Epic 7.1](../sprint-change-proposal/sprint-change-proposal-2025-12-23-epic-7.1-pre-epic8-fixes.md)
- [Project Context: Python Execution](../../project-context.md#-tooling--environment-standards)
- `src/migrations/migrate_legacy_to_enrichment_index.py` - Correct module location

## Validation Record

**Validated:** 2025-12-25
**Validator:** Claude Opus 4.5 (Scrum Master Agent)

**Critical Fixes Applied:**
1. Corrected affected file list (was 2 wrong files, now 2 correct files)
2. Changed resolution from DELETE to FIX IMPORT (module exists)
3. Added third affected file: `tests/integration/scripts/test_legacy_migration_integration.py`
4. Removed incorrect AC-2 (test_company_mapping_migration.py collects successfully)
5. Simplified tasks to direct import path fixes

## Dev Agent Record

### Implementation Plan

**Story:** 7.1-3 - Fix Test Collection Errors
**Approach:** Simple import path correction

**Changes Made:**

1. **tests/unit/scripts/test_migrate_legacy_to_enrichment_index.py**
   - Changed all imports from `work_data_hub.scripts.migrate_legacy_to_enrichment_index` to `migrations.migrate_legacy_to_enrichment_index`
   - Updated all `@patch` decorators to use new module path
   - **Result:** 37 tests collected successfully

2. **tests/integration/scripts/test_legacy_migration_integration.py**
   - **Challenge:** `tests/integration/migrations/` directory causes namespace collision
   - **Solution:** Implemented `importlib.util` to load module directly from `src/migrations/`
   - Added `_load_migration_module()` function that:
     - Calculates project root path (`tests/integration/scripts/` → 4 levels up)
     - Loads `src/migrations/migrate_legacy_to_enrichment_index.py` directly
     - Registers module in `sys.modules` to avoid import conflicts
   - **Result:** 9 tests collected successfully

**Validation:**
- ✅ Full test suite: 2309 tests collected, **0 errors**
- ✅ Before fix: 2263 tests collected, **2 errors**
- ✅ Tests added: 46 new tests now collectable (37 unit + 9 integration)

### Completion Notes

**Status:** ✅ COMPLETE

**All Acceptance Criteria Met:**
- ✅ AC-1: `test_migrate_legacy_to_enrichment_index.py` collects without ImportError
- ✅ AC-2: `test_legacy_migration_integration.py` collects without ImportError
- ✅ AC-3: Full test suite collects with zero errors (2309 tests)

**Technical Notes:**
- The integration test fix required a workaround for namespace collision between `src/migrations/` and `tests/integration/migrations/`
- Used `importlib.util.spec_from_file_location()` to bypass Python's normal import mechanism
- This is a minimal, targeted fix that doesn't require renaming directories or restructuring the test suite

**Test Results:**
```bash
# Unit tests
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/unit/scripts/test_migrate_legacy_to_enrichment_index.py --collect-only
# Result: 37 tests collected

# Integration tests
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/integration/scripts/test_legacy_migration_integration.py --collect-only
# Result: 9 tests collected

# Full suite
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/ --collect-only
# Result: 2309 tests collected, 0 errors
```

## File List

**Modified Files:**
- `tests/unit/scripts/test_migrate_legacy_to_enrichment_index.py` - Changed import path from `work_data_hub.scripts.` to `migrations.`
- `tests/integration/scripts/test_legacy_migration_integration.py` - Added `importlib.util` workaround for namespace collision

**Files Referenced (Not Modified):**
- `src/migrations/migrate_legacy_to_enrichment_index.py` - Verified location of migration module
- `tests/integration/migrations/` - Directory causing namespace collision (not modified)

## Change Log

**2025-12-25**
- Fixed import paths in 2 test files to use `migrations.migrate_legacy_to_enrichment_index`
- Implemented `importlib.util` workaround for integration tests
- Verified full test suite collection: 2309 tests, 0 errors
- All acceptance criteria met

## Status

**Status:** done
**Completed:** 2025-12-25
**Code Review:** PASSED 2025-12-25

---

## Senior Developer Review (AI)

**Reviewer:** Claude (Adversarial Code Review)
**Date:** 2025-12-25
**Outcome:** ✅ APPROVED

### Verification Results

| AC | Status | Evidence |
|----|--------|----------|
| AC-1 | ✅ PASS | 37 unit tests collected |
| AC-2 | ✅ PASS | 9 integration tests collected |
| AC-3 | ✅ PASS | 2309 tests, 0 errors |

### Issues Found & Fixed

| ID | Severity | Issue | Fix Applied |
|----|----------|-------|-------------|
| M1 | MEDIUM | `importlib.util` workaround lacked documentation | ✅ Added detailed comments explaining namespace collision |
| M2 | MEDIUM | Story header status mismatch ("ready-for-dev" vs "review") | ✅ Synced to "done" |
| M3 | MEDIUM | Sprint-status.yaml status sync | ✅ Updated |
| M4 | MEDIUM | `sys.modules` caching undocumented | ✅ Added comment explaining intentional caching |
| L2 | LOW | Missing type hint on `_load_migration_module()` | ✅ Added `-> ModuleType` return type |

### Files Modified During Review

- `tests/integration/scripts/test_legacy_migration_integration.py` - Added code review documentation
- `docs/sprint-artifacts/stories/7.1-3-fix-test-collection-errors.md` - Status sync + review notes
