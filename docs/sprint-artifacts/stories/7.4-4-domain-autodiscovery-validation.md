# Story 7.4-4: Domain Autodiscovery Validation

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a **Developer**,
I want **the system to validate that all configured domains have corresponding job definitions at startup**,
so that **I am warned about missing job implementations or configuration typos before attempting runtime execution, preventing silent runtime failures and reducing debugging time**.

## Acceptance Criteria

1.  **Registry Validation Logic**: Implement a validation function `validate_domain_registry()` in `cli/etl/domain_validation.py` that compares domains defined in `data_sources.yml` against keys in `JOB_REGISTRY`.
2.  **Missing Job Warning**: If a domain exists in `data_sources.yml` but is missing from `JOB_REGISTRY`, emit a `UserWarning`: `Domains in data_sources.yml without jobs: {missing_domains}`. **CRITICAL:** Exclude `SPECIAL_DOMAINS` (`company_lookup_queue`, `reference_sync`) which intentionally have no job definitions.
3.  **Startup Integration**: Integrate this validation into `cli/etl/main.py` AFTER argument parsing but BEFORE domain processing, following the `_validate_and_refresh_token()` call pattern (line 246).
4.  **No Crash on Warning**: The validation must NOT crash the application; it should only warn, allowing incomplete configurations during development.
5.  **Test Coverage**: Unit tests must verify that:
    - Matching config and registry produces no warning.
    - Missing job produces correct warning with `UserWarning` category.
    - SPECIAL_DOMAINS are excluded from mismatch detection.
    - Validation is resilient to config loading errors.
    - Multiple missing domains are all reported in a single warning.

## Tasks / Subtasks

- [x] **Task 1: Implement Validation Logic** (AC1, AC2)

  - [x] 1.1 Add `validate_domain_registry()` function to `src/work_data_hub/cli/etl/domain_validation.py` (colocate with existing `_load_configured_domains()` and `SPECIAL_DOMAINS`).
  - [x] 1.2 **REUSE** `_load_configured_domains()` from the SAME FILE - DO NOT reimplement config loading logic.
  - [x] 1.3 Import `JOB_REGISTRY` from `work_data_hub.orchestration.jobs`.
  - [x] 1.4 Compute `missing = configured_domains - SPECIAL_DOMAINS - JOB_REGISTRY.keys()`.
  - [x] 1.5 If `missing` is non-empty, emit `warnings.warn(..., category=UserWarning)`.

- [x] **Task 2: Integrate with CLI** (AC3, AC4)

  - [x] 2.1 Import `validate_domain_registry` in `cli/etl/main.py`.
  - [x] 2.2 Call `validate_domain_registry()` after argument parsing, before domain processing (near line 246, after token validation).
  - [x] 2.3 Ensure validation runs for both `--domains` and `--all-domains` paths.

- [x] **Task 3: Add Unit Tests** (AC5)

  - [x] 3.1 Create `tests/cli/test_domain_validation.py` (or add to existing test file).
  - [x] 3.2 Test case: All configured domains have jobs → no warning.
  - [x] 3.3 Test case: One domain missing from JOB_REGISTRY → warning emitted.
  - [x] 3.4 Test case: SPECIAL_DOMAINS in config → no warning (excluded).
  - [x] 3.5 Test case: Config loading fails → graceful handling (no crash).
  - [x] 3.6 Verify warning message format and `UserWarning` category.

- [x] **Task 4: Verify & Regression Test** (AC5)
  - [x] 4.1 Run `pytest tests/cli/` - all tests pass.
  - [x] 4.2 Run full test suite - no regressions.
  - [x] 4.3 Manual verification with commands in Dev Notes.

## Dev Notes

### Architecture Patterns

- **Registry Pattern**: We are enforcing the integrity of the Registry pattern introduced in Story 7.4-1.
- **Fail Soft**: For configuration/registry mismatches during development, we prefer Warnings over Errors to allow iterative work (e.g., adding config before job).
- **Single Source of Truth**: `data_sources.yml` is the truth for "What domains exist". `JOB_REGISTRY` is the truth for "What domains are executable".
- **Code Reuse**: Leverage existing `_load_configured_domains()` and `SPECIAL_DOMAINS` from `domain_validation.py` - DO NOT reinvent.

### Registry Scope Clarification

This story validates **JOB_REGISTRY** (job dispatch) only. The **DOMAIN_SERVICE_REGISTRY** (service layer) introduced in Story 7.4-3 is validated by its own registration tests.

The relationship:

- `JOB_REGISTRY`: Maps domain → Dagster JobDefinition (orchestration layer, `jobs.py`)
- `DOMAIN_SERVICE_REGISTRY`: Maps domain → Domain Service function (ops layer, `pipeline_ops.py`)

Both should be consistent, but this story focuses on JOB_REGISTRY for CLI-level validation.

### SPECIAL_DOMAINS Handling

**CRITICAL:** The following domains are intentionally NOT in `JOB_REGISTRY` and must be EXCLUDED from mismatch warnings:

- `company_lookup_queue` - Special orchestration domain with dedicated handler
- `reference_sync` - Special orchestration domain with dedicated handler

These are already defined in `cli/etl/domain_validation.py:49`:

```python
SPECIAL_DOMAINS = {"company_lookup_queue", "reference_sync"}
```

### Project Structure Notes

- `src/work_data_hub/cli/etl/domain_validation.py`: **Target file** - add `validate_domain_registry()` here (colocated with `_load_configured_domains()` and `SPECIAL_DOMAINS`).
- `src/work_data_hub/orchestration/jobs.py`: Source of `JOB_REGISTRY` (Story 7.4-1).
- `src/work_data_hub/config/data_sources.yml`: Source of domain configuration.
- `src/work_data_hub/cli/etl/main.py`: CLI entry point for integration (line ~246).

### Target Code Pattern

**File: `cli/etl/domain_validation.py` (add to existing file after `_validate_domains()`):**

```python
import warnings
from typing import Set

from work_data_hub.orchestration.jobs import JOB_REGISTRY

# SPECIAL_DOMAINS already defined at line 49

def validate_domain_registry() -> None:
    """Validate that configured domains have corresponding job definitions.

    Emits UserWarning for domains in data_sources.yml that lack JOB_REGISTRY entries.
    Excludes SPECIAL_DOMAINS which intentionally have no jobs.

    This validation runs at CLI startup to catch configuration/implementation
    mismatches early, preventing silent runtime failures.
    """
    try:
        configured_domains: Set[str] = set(_load_configured_domains())
    except Exception:
        # Config loading failed - already warned by _load_configured_domains()
        return

    registry_domains: Set[str] = set(JOB_REGISTRY.keys())

    # Exclude special domains that intentionally lack job definitions
    domains_to_check = configured_domains - SPECIAL_DOMAINS

    missing = domains_to_check - registry_domains
    if missing:
        warnings.warn(
            f"Domains in data_sources.yml without jobs: {sorted(missing)}",
            category=UserWarning,
        )
```

**File: `cli/etl/main.py` (add import and call):**

```python
# Add import at top
from .domain_validation import validate_domain_registry

# Add call after line 246 (after token validation, before domain processing)
# Around line 247:
validate_domain_registry()
```

### Manual Verification Commands

```bash
# Test normal operation (should show no warnings for valid domains)
PYTHONPATH=src uv run --env-file .wdh_env python -m work_data_hub.cli etl --domains annuity_performance --dry-run

# Test with intentionally invalid domain (should show "Unknown domain" error, not registry warning)
PYTHONPATH=src uv run --env-file .wdh_env python -m work_data_hub.cli etl --domains fake_domain --dry-run

# Test all-domains mode (should validate all configured domains)
PYTHONPATH=src uv run --env-file .wdh_env python -m work_data_hub.cli etl --all-domains --dry-run

# Programmatic registry check
python -c "from work_data_hub.orchestration.jobs import JOB_REGISTRY; print('JOB_REGISTRY domains:', sorted(JOB_REGISTRY.keys()))"
```

### Testing Strategy

1. **Unit Tests**: Add tests to `tests/cli/test_domain_validation.py`

   - Mock `_load_configured_domains()` to return controlled domain lists
   - Mock `JOB_REGISTRY` to test various scenarios
   - Use `pytest.warns(UserWarning)` to verify warning emission
   - Use `warnings.catch_warnings()` to verify NO warning in success case

2. **Integration Test**: Verify CLI startup calls validation
   - Test that `main()` invokes `validate_domain_registry()`
   - Verify warning appears in stderr for mismatched configs

### References

- [Sprint Change Proposal: Domain Registry Architecture](docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-30-domain-registry-architecture.md)
- [Story 7.4-1: JOB_REGISTRY pattern](7.4-1-job-registry-pattern.md) - Registry structure reference
- [Story 7.4-3: DOMAIN_SERVICE_REGISTRY](7.4-3-generic-process-domain-op.md) - Related registry (out of scope)
- `src/work_data_hub/cli/etl/domain_validation.py` - Target file with existing utilities
- `src/work_data_hub/orchestration/jobs.py` - JOB_REGISTRY definition

### Files to Modify

| File                                  | Change Type | Description                                         |
| ------------------------------------- | ----------- | --------------------------------------------------- |
| `cli/etl/domain_validation.py`        | Modify      | Add `validate_domain_registry()` function           |
| `cli/etl/main.py`                     | Modify      | Import and call `validate_domain_registry()`        |
| `cli/etl/__init__.py`                 | Modify      | Add `validate_domain_registry` to `__all__` exports |
| `tests/cli/test_domain_validation.py` | New         | Unit tests for registry validation                  |

### Issues Addressed

| Issue ID | Description                                 | Status    |
| -------- | ------------------------------------------- | --------- |
| MD-005   | No validation that config domains have jobs | ✅ Fixing |

### Scope Boundaries

> **IN SCOPE:**
>
> - Validate `JOB_REGISTRY` completeness against `data_sources.yml`
> - Exclude SPECIAL_DOMAINS from validation
> - Emit warnings (not errors) for mismatches
> - Integrate into CLI startup

> **OUT OF SCOPE:**
>
> - Validating `DOMAIN_SERVICE_REGISTRY` (Story 7.4-3 scope)
> - Validating that JOB_REGISTRY domains exist in config (reverse check)
> - Auto-registering missing domains
> - Blocking execution on warnings

## Dev Agent Record

### Agent Model Used

glm-4.7 (via Claude Code)

### Debug Log References

None - straightforward implementation with no issues.

### Completion Notes List

✅ **Story 7.4-4 Implementation Complete**

**Key Changes:**

1. Added `validate_domain_registry()` function to `cli/etl/domain_validation.py`
2. Moved `SPECIAL_DOMAINS` from local constant in `_validate_domains()` to module-level constant for reuse
3. Integrated validation call into `cli/etl/main.py` after token validation
4. Updated `cli/etl/__init__.py` to export `SPECIAL_DOMAINS` and `validate_domain_registry`
5. Added comprehensive unit tests in `tests/unit/cli/test_domain_validation.py`

**Testing Results:**

- 6/6 new unit tests passing
- 11/11 CLI unit tests passing (no regressions)
- Manual CLI verification successful (no warnings for valid domains)

**Design Decision:**

- Exposed `SPECIAL_DOMAINS` as module-level constant instead of keeping it local to `_validate_domains()`
- This allows both `_validate_domains()` and `validate_domain_registry()` to share the same definition
- Also allows `main.py` to import and reuse the constant instead of redefining it

**Acceptance Criteria Status:**

- ✅ AC1: Registry validation logic implemented
- ✅ AC2: Missing job warning with SPECIAL_DOMAINS exclusion
- ✅ AC3: Startup integration after argument parsing
- ✅ AC4: No crash on warning (warnings.warn only)
- ✅ AC5: Comprehensive test coverage (6 test cases)

### File List

**Modified Files:**

- `src/work_data_hub/cli/etl/domain_validation.py` - Added `validate_domain_registry()` and module-level `SPECIAL_DOMAINS`
- `src/work_data_hub/cli/etl/main.py` - Added import and validation call
- `src/work_data_hub/cli/etl/__init__.py` - Added exports for `SPECIAL_DOMAINS` and `validate_domain_registry`
- `docs/sprint-artifacts/sprint-status.yaml` - Updated 7.4-4 status to review

**New Files:**

- `tests/unit/cli/test_domain_validation.py` - Unit tests for registry validation (6 test cases)
