# Story 7.1-15: Fix TID251 Clean Architecture Violations

Status: backlog

## Story

As a **Software Architect**,
I want **TID251 (banned imports) violations to be fixed**,
so that **Clean Architecture boundaries are enforced and the codebase remains maintainable**.

## Context

**Priority:** P0 (CRITICAL - Blocking Epic 8)
**Effort:** 2-3 hours
**Epic:** 7.1 - Pre-Epic 8 Bug Fixes & Improvements
**Source:** [Ruff Warning Triage Analysis](../reviews/ruff-warning-triage-7.1-10.md)

### Problem Statement

**11 TID251 violations** exist where layers violate Clean Architecture boundaries:

| File | Location | Violation | Impact |
|------|----------|-----------|--------|
| `src/work_data_hub/auth/eqc_auth_handler.py:6` | Domain â†’ IO | `from work_data_hub.io.auth.eqc_auth_handler` | ðŸ”´ Critical |
| `src/work_data_hub/cli/auth.py` | CLI â†’ IO | `work_data_hub.io` import | ðŸŸ¡ Acceptable (CLI is outermost) |
| `src/work_data_hub/cli/etl/auth.py` | CLI â†’ IO | `work_data_hub.io` import | ðŸŸ¡ Acceptable |
| `src/work_data_hub/cli/etl/executors.py` | CLI â†’ IO | `work_data_hub.io` import | ðŸŸ¡ Acceptable |
| `src/work_data_hub/infrastructure/enrichment/data_refresh_service.py` | Infra â†’ IO | `work_data_hub.io` import | ðŸ”´ Critical |
| `src/work_data_hub/infrastructure/enrichment/eqc_provider.py` | Infra â†’ IO | `work_data_hub.io` import | ðŸ”´ Critical |

### Why This Matters

**Clean Architecture Violation:**
- Domain layer importing from IO layer breaks dependency inversion
- Infrastructure importing from IO creates tight coupling
- Violates Story 1.6's Clean Architecture enforcement

**Epic 8 Readiness:**
- Epic 8 (Classification-Based Validation) requires clean architecture
- TID251 violations complicate testing and modularity

## Acceptance Criteria

### AC-1: Fix Domain Layer TID251 Violations

**GIVEN** `src/work_data_hub/auth/eqc_auth_handler.py` imports from IO layer
**WHEN** refactored to use protocol/dependency injection
**THEN** domain layer has no IO dependencies

**Fix Strategy:**

```python
# âŒ WRONG: Domain â†’ IO dependency
# src/work_data_hub/auth/eqc_auth_handler.py
from work_data_hub.io.auth.eqc_auth_handler import *  # TID251 violation

# âœ… CORRECT: Use protocol/dependency injection
from work_data_hub.infrastructure.enrichment import EnterpriseInfoProvider

class EQCAuthHandler:
    def __init__(self, provider: EnterpriseInfoProvider):
        self._provider = provider
```

**Deliverable:** Domain layer TID251 violations eliminated

---

### AC-2: Fix Infrastructure Layer TID251 Violations

**GIVEN** infrastructure services import from IO layer
**WHEN** refactored to accept protocols as constructor parameters
**THEN** infrastructure layer respects layer boundaries

**Affected Files:**
- `src/work_data_hub/infrastructure/enrichment/data_refresh_service.py`
- `src/work_data_hub/infrastructure/enrichment/eqc_provider.py`

**Fix Strategy:**

```python
# âŒ WRONG: Infrastructure â†’ IO dependency
from work_data_hub.io.connectors.eqc import EQCClient

# âœ… CORRECT: Accept protocol/interface
from work_data_hub.io.connectors.eqc.protocols import EQCClientProtocol

class EQCProvider:
    def __init__(self, client: EQCClientProtocol):
        self._client = client
```

**Deliverable:** Infrastructure layer TID251 violations eliminated

---

### AC-3: Add TODO Comments for CLI Layer

**GIVEN** CLI layer imports from IO layer
**WHEN** TID251 violations are acceptable for CLI
**THEN** add `# noqa: TID251` with TODO for future refactoring

**Fix Strategy:**

```python
# CLI layer can import from IO (acceptable, as CLI is outermost layer)
from work_data_hub.io.connectors.eqc import EQCClient  # noqa: TID251
# TODO: Refactor to use dependency injection in future CLI modularization
```

**Deliverable:** CLI layer violations suppressed with TODO comments

---

### AC-4: Update pyproject.toml Per-File Ignores

**GIVEN** CLI layer has acceptable TID251 violations
**WHEN** per-file ignores are documented
**THEN** future developers understand the rationale

**Configuration Update:**

```toml
[tool.ruff.lint.per-file-ignores]
# CLI layer can import from IO (outermost layer) - Track in Story 7.1-15
"src/work_data_hub/cli/**/*.py" = ["TID251"]
"src/work_data_hub/infrastructure/**/*.py" = []  # TODO: Remove infra TID251
"src/work_data_hub/domain/**/*.py" = []  # CRITICAL: No domain TID251 allowed
```

**Deliverable:** `pyproject.toml` updated with documented ignores

---

### AC-5: Verify No Regressions

**GIVEN** TID251 fixes are applied
**WHEN** `ruff check src/` is run
**THEN** 0 TID251 violations in domain/infrastructure layers

**Verification Command:**

```bash
# Check for remaining TID251 violations
PYTHONPATH=src uv run --env-file .wdh_env ruff check src/ --select TID251

# Expected: Only CLI layer violations (suppressed with noqa)
```

**Deliverable:** `ruff check --select TID251` shows 0 domain/infra violations

---

## Tasks / Subtasks

- [ ] **Task 1: Fix Domain Layer TID251 Violation** (AC-1)
  - [ ] 1.1 Review `src/work_data_hub/auth/eqc_auth_handler.py`
  - [ ] 1.2 Replace `from work_data_hub.io.auth` with protocol import
  - [ ] 1.3 Update constructor to accept `EnterpriseInfoProvider`
  - [ ] 1.4 Verify domain layer has no IO dependencies

- [ ] **Task 2: Fix Infrastructure Layer TID251 Violations** (AC-2)
  - [ ] 2.1 Review `data_refresh_service.py` and `eqc_provider.py`
  - [ ] 2.2 Extract EQCClient protocol from `io.connectors.eqc`
  - [ ] 2.3 Update constructors to accept protocol parameter
  - [ ] 2.4 Update call sites to inject dependencies

- [ ] **Task 3: Add TODO Comments for CLI Layer** (AC-3)
  - [ ] 3.1 Add `# noqa: TID251` to CLI violations
  - [ ] 3.2 Add TODO comment for future refactoring
  - [ ] 3.3 Document CLI layer exception in code comments

- [ ] **Task 4: Update pyproject.toml** (AC-4)
  - [ ] 4.1 Review current per-file-ignores
  - [ ] 4.2 Add CLI layer TID251 ignore with rationale
  - [ ] 4.3 Remove any infra/domain ignores (must be fixed)

- [ ] **Task 5: Verification** (AC-5)
  - [ ] 5.1 Run `ruff check src/ --select TID251`
  - [ ] 5.2 Verify domain layer has 0 violations
  - [ ] 5.3 Verify infra layer has 0 violations
  - [ ] 5.4 Run test suite to verify no regressions

## Dev Notes

### Architecture Patterns to Follow

**Story 1.6 Clean Architecture Reference:**
- Domain layer â†’ Infrastructure layer â†’ IO layer
- No reverse dependencies (Domain âŒâ†’ IO)
- Use protocols/interfaces for cross-layer communication

**Protocol Pattern:**

```python
# Define protocol in io/connectors/eqc/protocols.py
from typing import Protocol

class EQCClientProtocol(Protocol):
    def get_company_info(self, company_name: str) -> dict: ...

# Use protocol in infrastructure
class EQCProvider:
    def __init__(self, client: EQCClientProtocol):
        self._client = client
```

### Testing Standards

**After Fixes:**
```bash
# Verify TID251 violations eliminated
PYTHONPATH=src uv run --env-file .wdh_env ruff check src/ --select TID251

# Run full test suite
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/ -v
```

### References

- [Ruff Warning Triage](../reviews/ruff-warning-triage-7.1-10.md) - Section P0 Critical
- [Story 1.6: Clean Architecture](./1-6-clean-architecture-boundaries-enforcement.md)
- [Project Context](../project-context.md) - Section 1: Hard Constraints

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes List

**Story Created:** 2025-12-26
**Context Source:** Ruff Warning Triage Analysis (Story 7.1-10)

**Story Approach:**
- **Critical Priority:** P0 - Must complete before Epic 8
- **Architecture Fix:** Enforce Clean Story 1.6 boundaries
- **Layer-Specific Strategy:**
  - Domain: 0 violations (hard requirement)
  - Infrastructure: 0 violations (refactor to protocols)
  - CLI: Suppress with TODO (acceptable exception)

### File List

**Files to Modify:**
- `src/work_data_hub/auth/eqc_auth_handler.py` (Domain layer)
- `src/work_data_hub/infrastructure/enrichment/data_refresh_service.py` (Infra layer)
- `src/work_data_hub/infrastructure/enrichment/eqc_provider.py` (Infra layer)
- `src/work_data_hub/cli/auth.py` (CLI layer - add noqa)
- `src/work_data_hub/cli/etl/auth.py` (CLI layer - add noqa)
- `src/work_data_hub/cli/etl/executors.py` (CLI layer - add noqa)
- `pyproject.toml` (Update per-file-ignores)

**Tests to Update:**
- `tests/infrastructure/enrichment/test_eqc_provider.py` (If constructor signature changes)
- `tests/infrastructure/enrichment/test_data_refresh_service.py` (If constructor signature changes)

---

## Validation Record

**Validated:** 2025-12-26
**Validator:** Dev Agent (Story 7.1-10 Analysis)
**Validation Source:** Ruff Warning Triage - TID251 Analysis

**Criteria Met:**
- âœ… 11 TID251 violations > 3 threshold (story creation triggered)
- âœ… Critical priority (P0) identified
- âœ… Effort estimate: 2-3 hours
- âœ… Fix strategy documented per layer
