# Story 5.5.2: AnnuityIncome Domain Implementation

Status: Done

## Story

As a **developer implementing the second domain for architecture validation**,
I want **to implement the AnnuityIncome domain using the Infrastructure Layer established in Epic 5**,
so that **we validate architecture generality, identify code reuse opportunities, and establish patterns for future domain migrations**.

## Acceptance Criteria

### 1. Domain Structure (6-File Standard)
- [x] AC1: Domain follows 6-file standard: `__init__.py`, `constants.py`, `helpers.py`, `models.py`, `schemas.py`, `pipeline_builder.py`, `service.py`
- [x] AC2: All imports and exports properly configured in `__init__.py`
- [x] AC3: Directory created at `src/work_data_hub/domain/annuity_income/`

### 2. Infrastructure Component Reuse
- [x] AC4: Uses `CompanyIdResolutionStep` from infrastructure layer
- [x] AC5: Uses `CleansingStep` with domain="annuity_income"
- [x] AC6: Uses standard pipeline steps (`MappingStep`, `CalculationStep`, `DropStep`, `ReplacementStep`)
- [x] AC7: Follows same patterns as `annuity_performance` domain

### 3. Configuration Integration
- [x] AC8: Domain configuration added to `config/data_sources.yml`
- [x] AC9: Cleansing rules added to `infrastructure/cleansing/settings/cleansing_rules.yml`

### 4. Testing Requirements
- [x] AC10: Unit tests with >85% coverage
- [x] AC11: Tests located in `tests/unit/domain/annuity_income/` (58 tests passing)

### 5. Code Reuse Tracking (Phased Optimization)
- [x] AC12: All duplicate code marked with `TODO(5.5.4)` comments per Tech Spec format
- [x] AC13: Shared mappings identified for extraction in Story 5.5.4

### 6. Interfaces & Contracts
- [x] AC14: Service API contract documented for `process_annuity_income()` / `process_with_enrichment()` including parameters, expected inputs/outputs, and failure modes
- [x] AC15: Pipeline I/O contract documented (bronze columns â†’ gold columns, required/nullable, primary key, expected dtypes)
- [x] AC16: Integration points clarified for `FileDiscoveryProtocol`, warehouse loader, and optional enrichment service (inputs, outputs, side effects)

### 7. Quality & Regression Gates
- [x] AC17: Regression gates defined: unit (>85% coverage), schema validation (bronze/gold), parity gate for 5.5.3, and lint/type (Ruff/mypy) checks
- [x] AC18: Data quality acceptance: non-null required gold fields, composite PK uniqueness (æœˆåº¦, è®¡åˆ’å·, company_id), and cleansing completeness

### 8. Security, Performance, Deployment
- [x] AC19: Security/PII guidance captured (logging scrubs, avoid persisting raw PII outside warehouse, config-driven paths)
- [x] AC20: Performance expectations stated (target dataset size, acceptable runtime and memory for bronzeâ†’gold pipeline; reuse vectorized pandas ops)
- [x] AC21: Deployment/runtime requirements captured (Python 3.10+, config paths, env vars, local/CI commands to run story tests)

## Tasks / Subtasks

### Task 1: Create Domain Directory Structure (AC: 1, 2, 3)
- [x] 1.1: Create `src/work_data_hub/domain/annuity_income/` directory
- [x] 1.2: Create all 7 files with proper module structure
- [x] 1.3: Configure `__init__.py` with proper exports (lazy loading to avoid circular imports)

### Task 2: Implement `constants.py` (AC: 7, 12, 13)
- [x] 2.1: Copy shared mappings from `annuity_performance/constants.py` **with TODO(5.5.4) markers**:
  - `COMPANY_BRANCH_MAPPING` (add missing legacy overrides - see Dev Notes)
  - `BUSINESS_TYPE_CODE_MAPPING`
  - `DEFAULT_PORTFOLIO_CODE_MAPPING`
  - `PORTFOLIO_QTAN003_BUSINESS_TYPES`
- [x] 2.2: Add AnnuityIncome-specific constants:
  - `COLUMN_ALIAS_MAPPING` for æ”¶å…¥æ˜Žç»† sheet (æœºæž„ â†’ æœºæž„ä»£ç )
  - `LEGACY_COLUMNS_TO_DELETE` specific to this domain
  - `COMPANY_ID5_MAPPING` (AnnuityIncome-specific, **DEPRECATED - do NOT implement fallback**)
  - `DEFAULT_ALLOWED_GOLD_COLUMNS` for AnnuityIncome output
- [x] 2.3: Add `DEFAULT_INSTITUTION_CODE = "G00"`

### Task 3: Implement `models.py` (AC: 7)
- [x] 3.1: Create `AnnuityIncomeIn` (permissive input model):
  - Fields: æœˆåº¦, æœºæž„, æœºæž„åç§°, è®¡åˆ’å·, å®¢æˆ·åç§°, ä¸šåŠ¡ç±»åž‹, è®¡åˆ’ç±»åž‹, ç»„åˆä»£ç , æ”¶å…¥é‡‘é¢
  - `model_config = ConfigDict(extra="allow", str_strip_whitespace=True)`
- [x] 3.2: Create `AnnuityIncomeOut` (strict output model):
  - Required: æœˆåº¦, è®¡åˆ’å·, company_id, å®¢æˆ·åç§°, äº§å“çº¿ä»£ç , æœºæž„ä»£ç , æ”¶å…¥é‡‘é¢
  - `model_config = ConfigDict(extra="forbid")`
- [x] 3.3: Create `EnrichmentStats` dataclass (or reuse from annuity_performance)
- [x] 3.4: Add `apply_domain_rules()` function using CleansingRegistry
  - Import: `from src.work_data_hub.infrastructure.cleansing.registry import CleansingRegistry`

### Task 4: Implement `schemas.py` (AC: 7)
- [x] 4.1: Create `BronzeAnnuityIncomeSchema(pa.DataFrameModel)`:
  - Minimal validation, nullable fields, coercion enabled
  - Fields and Types:
    - æœˆåº¦: `pa.DateTime` (nullable=True)
    - æœºæž„ä»£ç : `pa.String`
    - è®¡åˆ’å·: `pa.String`
    - å®¢æˆ·åç§°: `pa.String`
    - ä¸šåŠ¡ç±»åž‹: `pa.String` (nullable=True)
    - æ”¶å…¥é‡‘é¢: `pa.Float64`
- [x] 4.2: Create `GoldAnnuityIncomeSchema(pa.DataFrameModel)`:
  - Strict validation, non-nullable required fields
  - Composite primary key: (æœˆåº¦, è®¡åˆ’å·, company_id)
  - Fields and Types:
    - æœˆåº¦: `pa.DateTime`
    - è®¡åˆ’å·: `pa.String`
    - company_id: `pa.String`
    - å®¢æˆ·åç§°: `pa.String`
    - äº§å“çº¿ä»£ç : `pa.String`
    - æœºæž„ä»£ç : `pa.String`
    - æ”¶å…¥é‡‘é¢: `pa.Float64`
- [x] 4.3: Add `validate_bronze_dataframe()`, `validate_gold_dataframe()` functions

### Task 5: Implement `helpers.py` (AC: 7, 12)
- [x] 5.1: Copy `normalize_month()` from annuity_performance **with TODO(5.5.4) marker**
- [x] 5.2: Add `convert_dataframe_to_models()` for AnnuityIncome **with TODO(5.5.4) marker if similar**
- [x] 5.3: Add any domain-specific helper functions

### Task 6: Implement `pipeline_builder.py` (AC: 4, 5, 6, 7) - **CRITICAL**
- [x] 6.1: Create `build_bronze_to_silver_pipeline()` with steps:
  - Imports:
    - `from src.work_data_hub.infrastructure.transforms.pipeline import Pipeline`
    - `from src.work_data_hub.infrastructure.transforms.steps.core import MappingStep, CalculationStep, DropStep, ReplacementStep`
    - `from src.work_data_hub.infrastructure.transforms.steps.cleansing import CleansingStep`
    - `from src.work_data_hub.infrastructure.transforms.steps.domain import CompanyIdResolutionStep`
  ```
  Step 1:  MappingStep({'æœºæž„': 'æœºæž„ä»£ç '})  # Column rename
  Step 2:  CalculationStep: æœºæž„ä»£ç  from æœºæž„åç§° via COMPANY_BRANCH_MAPPING
  Step 3:  CalculationStep: Date parsing for æœˆåº¦ (parse_chinese_date)
  Step 4:  CalculationStep: æœºæž„ä»£ç  default to 'G00' (replace 'null' string + fillna)
  Step 5:  CalculationStep: ç»„åˆä»£ç  regex replace '^F' â†’ ''
  Step 6:  CalculationStep: ç»„åˆä»£ç  conditional default (èŒå¹´å—æ‰˜/èŒå¹´æŠ•èµ„ â†’ QTAN003, else DEFAULT_PORTFOLIO_CODE_MAPPING)
  Step 7:  CalculationStep: äº§å“çº¿ä»£ç  from ä¸šåŠ¡ç±»åž‹ via BUSINESS_TYPE_CODE_MAPPING
  Step 8:  CalculationStep: Preserve å¹´é‡‘è´¦æˆ·å = å®¢æˆ·åç§° (BEFORE normalization)
  Step 9:  CleansingStep(domain="annuity_income")  # Normalizes å®¢æˆ·åç§°
  Step 10: CompanyIdResolutionStep(plan_code_col='è®¡åˆ’å·', customer_name_col='å®¢æˆ·åç§°')
  Step 11: DropStep(LEGACY_COLUMNS_TO_DELETE)
  ```
- [x] 6.2: **DO NOT implement COMPANY_ID5_MAPPING fallback** - architecture decision per Tech Spec
- [x] 6.3: Add helper functions `_apply_portfolio_code_defaults()` for conditional logic

### Task 7: Implement `service.py` (AC: 7)
- [x] 7.1: Create `process_annuity_income()` following same pattern as `process_annuity_performance()`
- [x] 7.2: Create `process_with_enrichment()` with standard enrichment flow
- [x] 7.3: Add `_records_to_dataframe()` helper
- [x] 7.4: Document service API contract: parameters (`month`, `file_discovery`, `warehouse_loader`, optional `enrichment_service`), expected inputs (bronze dataframe), outputs (`DomainPipelineResult` shape), and error handling/logging expectations
  - Imports:
    - `from src.work_data_hub.io.files.discovery import FileDiscoveryProtocol`
    - `from src.work_data_hub.domain.company_enrichment.service import CompanyEnrichmentService` (optional)

### Task 8: Update Configuration Files (AC: 8, 9)
- [x] 8.1: Add to `config/data_sources.yml`:
  ```yaml
  annuity_income:
    base_path: "tests/fixtures/real_data/{YYYYMM}/æ”¶é›†æ•°æ®/æ•°æ®é‡‡é›†"
    file_patterns:
      - "*å¹´é‡‘ç»ˆç¨¿*.xlsx"
    exclude_patterns:
      - "~$*"
      - "*å›žå¤*"
      - "*.eml"
    sheet_name: "æ”¶å…¥æ˜Žç»†"
    version_strategy: "highest_number"
    fallback: "error"
  ```
- [x] 8.2: Add to `cleansing_rules.yml`:
  ```yaml
  annuity_income:
    å®¢æˆ·åç§°:
      - trim_whitespace
      - normalize_company_name
    è®¡åˆ’å·:
      - trim_whitespace
    company_id:
      - trim_whitespace
    æ”¶å…¥é‡‘é¢:
      - remove_currency_symbols
      - clean_comma_separated_number
  ```

### Task 9: Write Unit Tests (AC: 10, 11)
- [x] 9.1: Create `tests/unit/domain/annuity_income/test_models.py`
- [x] 9.2: Create `tests/unit/domain/annuity_income/test_pipeline.py`
- [x] 9.3: Create `tests/unit/domain/annuity_income/test_service.py`
- [x] 9.4: Ensure >85% coverage (58 tests passing)
- [x] 9.5: Add regression gates: schema validation for bronze/gold, composite PK uniqueness, and parity harness hooks for Story 5.5.3
- [x] 9.6: Add lint/type gates (Ruff, mypy strict) to CI checklist for this story scope

## Dev Notes

### Architecture Context

**Epic 5.5 Goal:** Validate Infrastructure Layer by implementing AnnuityIncome domain, ensuring architecture generality.

**Development Strategy:** Phased Optimization (æ–¹æ¡ˆ C)
- Phase 1 (5.5.1-5.5.3): å®žçŽ°å¹¶éªŒè¯ - å…è®¸ä»£ç å¤åˆ¶ï¼Œæ ‡è®°é‡å¤
- Phase 2 (5.5.4): é›†ä¸­é‡æž„ - æå–å…±äº«ä»£ç åˆ° Infrastructure

**Tech Stack Guardrails:**
- Python 3.10+, pandas (locked), Pydantic 2.11.7+, pandera, Dagster, uv, Ruff 0.12.12+, mypy 1.17.1+ (strict)
- Clean Architecture: infrastructure/domain ä¸ä¾èµ– io/orchestration
- 6-file standard per Epic 5

### ðŸš¨ CRITICAL: COMPANY_BRANCH_MAPPING Gap

**Story 5.5-1 identified missing legacy overrides in `annuity_performance/constants.py`:**

```python
# These 6 entries are in legacy mappings.py but MISSING from annuity_performance/constants.py:
'å†…è’™': 'G31',      # Missing
'æˆ˜ç•¥': 'G37',      # Missing
'ä¸­å›½': 'G37',      # Missing
'æµŽå—': 'G21',      # Present as 'å±±ä¸œ': 'G21' (different key!)
'åŒ—äº¬å…¶ä»–': 'G37',  # Missing
'åŒ—åˆ†': 'G37',      # Missing
```

**Action:** AnnuityIncome `constants.py` MUST include ALL legacy entries. Mark with TODO(5.5.4) for extraction to shared infrastructure.

### ðŸš¨ CRITICAL: COMPANY_ID5_MAPPING Decision

**Canonical Decision (conflict resolved):** The legacy `COMPANY_ID5_MAPPING` fallback (lines 269-272 in legacy code) remains **DEPRECATED** and will **NOT** be implemented in this story. This supersedes the fallback mention in Tech Spec Task 2.6; align with architecture parity across domains.

**Reason:** Maintain single-responsibility `CompanyIdResolutionStep` and enforce shared architecture parity with `annuity_performance`. Fallbacks are deferred to architecture-wide decisions, not per-domain exceptions.

**Impact:** Rows that previously resolved via ID5 may remain NULL. Document this as an intentional difference with counts in Story 5.5.3 parity validation.

### Reference Implementation: AnnuityPerformance

**Directory:** `src/work_data_hub/domain/annuity_performance/`

**6-File Structure:**
```
â”œâ”€â”€ __init__.py              # Module exports
â”œâ”€â”€ constants.py             # Mappings, defaults, magic strings
â”œâ”€â”€ helpers.py               # Utility functions, protocols
â”œâ”€â”€ models.py                # Pydantic models (In/Out)
â”œâ”€â”€ schemas.py               # Pandera validation schemas (Bronze/Gold)
â”œâ”€â”€ pipeline_builder.py      # Pipeline composition
â””â”€â”€ service.py               # Lightweight service orchestrator
```

**Pipeline Pattern (from `pipeline_builder.py:136-191`):**
```python
def build_bronze_to_silver_pipeline(...) -> Pipeline:
    steps: list[TransformStep] = [
        MappingStep({...}),           # Column renames
        CalculationStep({...}),       # Derived fields
        ReplacementStep({...}),       # Value corrections
        CleansingStep(domain="..."),  # Registry-based cleansing
        CompanyIdResolutionStep(...), # Standard ID resolution
        DropStep([...]),              # Remove legacy columns
    ]
    return Pipeline(steps)
```

### AnnuityIncome vs AnnuityPerformance Comparison

| Aspect | AnnuityPerformance | AnnuityIncome |
|--------|-------------------|---------------|
| Excel Sheet | è§„æ¨¡æ˜Žç»† | æ”¶å…¥æ˜Žç»† |
| Plan Code Column | è®¡åˆ’ä»£ç  | è®¡åˆ’å· |
| Company ID Fallback | None | **None (Standard Only)** - Legacy ID5 dropped |
| ç»„åˆä»£ç  Processing | Default only | Regex '^F' removal + conditional default |
| å¹´é‡‘è´¦æˆ·å | Exists in data | **Derived** from å®¢æˆ·åç§° |
| Primary Key | (æœˆåº¦, è®¡åˆ’ä»£ç , company_id) | (æœˆåº¦, è®¡åˆ’å·, company_id) |

**Shared Operations (~80%):**
- æœºæž„ä»£ç  mapping via COMPANY_BRANCH_MAPPING
- Date parsing via parse_chinese_date()
- Company name normalization via CleansingRegistry
- Company ID resolution via CompanyIdResolutionStep (Standard)
- äº§å“çº¿ä»£ç  mapping from ä¸šåŠ¡ç±»åž‹

**AnnuityIncome-Specific:**
- ç»„åˆä»£ç  regex replacement (remove '^F' prefix)
- ç»„åˆä»£ç  conditional default based on ä¸šåŠ¡ç±»åž‹
- å¹´é‡‘è´¦æˆ·å copy before normalization (preserved for audit trail)

### TODO(5.5.4) Marker Format

All duplicate code must use this format:
```python
# TODO(5.5.4): Extract to infrastructure/mappings/shared.py
# Duplicated from: annuity_performance/constants.py
# Reuse potential: HIGH (used by 2+ domains)
COMPANY_BRANCH_MAPPING = {
    "æ€»éƒ¨": "G00",
    # ...
}
```

### Cleansing Rules (11 Operations from Legacy)

| # | Operation | Field | Rule Type | Notes |
|---|-----------|-------|-----------|-------|
| 1 | Column rename | æœºæž„ â†’ æœºæž„ä»£ç  | mapping | Initial rename |
| 2 | Mapping | æœºæž„ä»£ç  | mapping | From æœºæž„åç§° via COMPANY_BRANCH_MAPPING |
| 3 | Date parse | æœˆåº¦ | date_parse | parse_chinese_date() |
| 4 | Default value | æœºæž„ä»£ç  | default_value | Replace 'null' with 'G00', fillna('G00') |
| 5 | Regex replace | ç»„åˆä»£ç  | regex_replace | `str.replace('^F', '', regex=True)` |
| 6 | Conditional default | ç»„åˆä»£ç  | conditional | èŒå¹´å—æ‰˜/èŒå¹´æŠ•èµ„ â†’ 'QTAN003', else DEFAULT_PORTFOLIO_CODE_MAPPING |
| 7 | Mapping | äº§å“çº¿ä»£ç  | mapping | From ä¸šåŠ¡ç±»åž‹ via BUSINESS_TYPE_CODE_MAPPING |
| 8 | Copy | å¹´é‡‘è´¦æˆ·å | copy | `df['å¹´é‡‘è´¦æˆ·å'] = df['å®¢æˆ·åç§°']` (before normalization) |
| 9 | Normalize | å®¢æˆ·åç§° | normalize | Via CleansingStep(domain="annuity_income") |
| 10 | Company ID | company_id | resolution | Via CompanyIdResolutionStep (standard chain) |
| 11 | **DEPRECATED** | company_id | fallback | ~~COMPANY_ID5_MAPPING~~ - **DO NOT IMPLEMENT** |

### Project Structure Notes

**New Files to Create:**
```
src/work_data_hub/domain/annuity_income/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ constants.py
â”œâ”€â”€ helpers.py
â”œâ”€â”€ models.py
â”œâ”€â”€ schemas.py
â”œâ”€â”€ pipeline_builder.py
â””â”€â”€ service.py

tests/unit/domain/
â”œâ”€â”€ test_annuity_income_models.py
â”œâ”€â”€ test_annuity_income_pipeline.py
â””â”€â”€ test_annuity_income_service.py
```

**Files to Modify:**
- `config/data_sources.yml` - Add annuity_income domain config
- `src/work_data_hub/infrastructure/cleansing/settings/cleansing_rules.yml` - Add annuity_income rules
- `docs/runbooks/legacy-parity-validation.md` - Ensure parity gate notes include the intentional omission of COMPANY_ID5_MAPPING fallback

### Testing Standards

**Coverage Target:** >85%

**Test Categories:**
1. **Model Tests:** Validation, serialization, edge cases
2. **Pipeline Tests:** Step execution, data transformation, error handling
3. **Service Tests:** End-to-end processing, enrichment integration

**Test Data:** Use synthetic data in `tests/fixtures/` for unit tests. Real data validation in Story 5.5.3.

### Previous Story Learnings (5.5-1)

**Key Outputs:**
- Created `docs/cleansing-rules/annuity-income.md` (432 lines)
- Documented all 11 cleansing operations with execution priority
- Identified COMPANY_BRANCH_MAPPING gap (6 missing entries)
- Documented COMPANY_ID5_MAPPING deprecation decision
- Created executable Parity Validation Checklist

**Gap Analysis Finding:**
`annuity_performance/constants.py` is missing 6 legacy COMPANY_BRANCH_MAPPING overrides. This must be addressed in this story.

### Interfaces & Contracts

- Service API (service.py): `process_annuity_income(month: str, *, file_discovery: FileDiscoveryProtocol, warehouse_loader: Any, enrichment_service: Optional[CompanyEnrichmentService] = None) -> DomainPipelineResult`; `process_with_enrichment(...)` wraps enrichment then pipeline. Inputs: bronze dataframe from discovered file; Outputs: silver/gold dataframe persisted via `warehouse_loader`, plus metrics. Failures: raise domain exceptions; log with domain tag `annuity_income` and scrub PII (å®¢æˆ·åç§°) outside debug.
- Pipeline I/O: Bronze expected columns â€” æœˆåº¦, æœºæž„, æœºæž„åç§°, è®¡åˆ’å·, å®¢æˆ·åç§°, ä¸šåŠ¡ç±»åž‹, è®¡åˆ’ç±»åž‹, ç»„åˆä»£ç , æ”¶å…¥é‡‘é¢. Gold required â€” æœˆåº¦, è®¡åˆ’å·, company_id, å®¢æˆ·åç§°, äº§å“çº¿ä»£ç , æœºæž„ä»£ç , æ”¶å…¥é‡‘é¢. PK: (æœˆåº¦, è®¡åˆ’å·, company_id). Nullable only where legacy allowed; dtypes mirror `annuity_performance`.
- Integration points: `FileDiscoveryProtocol` supplies month-scoped Excel (sheet æ”¶å…¥æ˜Žç»†); `warehouse_loader` persists silver/gold; optional `enrichment_service` parity with annuity_performance; no new side effects.

### Security & Performance

- Security/PII: Avoid persisting raw å®¢æˆ·åç§° outside cleansing outputs; scrub PII in logs; use config-driven paths; no inline secrets.
- Performance: Use vectorized pandas ops; expect dataset scale similar to annuity_performance; runtime and memory should be same order; minimize regex overhead; avoid unnecessary copies.

### Deployment & Environments

- Runtime: Python 3.10+, uv env. Commands: `uv run pytest tests/unit/domain/test_annuity_income_*.py`; `uv run ruff check src/work_data_hub/domain/annuity_income`; `uv run mypy src/work_data_hub/domain/annuity_income`.
- Config: `config/data_sources.yml` and cleansing settings updated; paths under `{project-root}/tests/fixtures/real_data/{YYYYMM}/æ”¶é›†æ•°æ®/æ•°æ®é‡‡é›†`; no new env vars beyond existing infra.

### Regression & Data Quality Gates

- Regression: Unit >85% plus schema validation (bronze/gold), composite PK uniqueness, and parity harness (Story 5.5.3) before release.
- Data quality: Gold required fields non-null; PK uniqueness enforced; cleansing completeness tracked (counts of resolved company_id vs NULL); intentional NULLs from removed ID5 fallback documented.

### Git & Research Notes

- Review recent commits touching `annuity_performance` and `infrastructure/transforms` for patterns to mirror (naming, validation, logging); follow same dependency versions already locked (pandas, pandera, Pydantic 2.11.7+, Ruff 0.12.12+, mypy 1.17.1+).
- If adding new dependencies, confirm no breaking changes/security advisories; otherwise, reuse existing stack only.

### References

- [Source: docs/cleansing-rules/annuity-income.md] - Complete cleansing rules documentation
- [Source: docs/epics/epic-5.5-pipeline-architecture-validation.md] - Epic definition
- [Source: docs/sprint-artifacts/tech-spec/tech-spec-epic-5.5-pipeline-architecture-validation.md] - Tech Spec with detailed implementation plan
- [Source: src/work_data_hub/domain/annuity_performance/] - Reference implementation (6-file standard)
- [Source: legacy/annuity_hub/data_handler/data_cleaner.py:237-274] - Legacy AnnuityIncomeCleaner
- [Source: legacy/annuity_hub/data_handler/mappings.py] - Legacy mapping tables
- [Source: config/data_sources.yml] - Domain configuration pattern
- [Source: src/work_data_hub/infrastructure/cleansing/settings/cleansing_rules.yml] - Cleansing rules pattern

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

### Completion Notes List

- Story 5.5.2 is the second story in Epic 5.5 (Pipeline Architecture Validation)
- Depends on Story 5.5.1 (Legacy Cleansing Rules Documentation) - COMPLETED
- Output serves as input for Story 5.5.3 (Legacy Parity Validation)
- Critical for validating Infrastructure Layer architecture generality
- COMPANY_ID5_MAPPING fallback intentionally NOT implemented per architecture decision

### File List

**Files to Create:**
- `src/work_data_hub/domain/annuity_income/__init__.py`
- `src/work_data_hub/domain/annuity_income/constants.py`
- `src/work_data_hub/domain/annuity_income/helpers.py`
- `src/work_data_hub/domain/annuity_income/models.py`
- `src/work_data_hub/domain/annuity_income/schemas.py`
- `src/work_data_hub/domain/annuity_income/pipeline_builder.py`
- `src/work_data_hub/domain/annuity_income/service.py`
- `tests/unit/domain/test_annuity_income_models.py`
- `tests/unit/domain/test_annuity_income_pipeline.py`
- `tests/unit/domain/test_annuity_income_service.py`

**Files to Modify:**
- `config/data_sources.yml`
- `src/work_data_hub/infrastructure/cleansing/settings/cleansing_rules.yml`
- `docs/runbooks/legacy-parity-validation.md` (note intentional omission of COMPANY_ID5_MAPPING fallback)

### Change Log

| Date | Change |
|------|--------|
| 2025-12-05 | Story created via create-story workflow with comprehensive context from Epic 5.5, Tech Spec, and Story 5.5-1 learnings |