# Story 6.2-P17: EQC Lookup Configuration Unification (Zero Legacy Refactor)

**Epic:** Epic 6.2 - Generic Reference Data Management
**Type:** Technical Debt
**Priority:** High
**Status:** done
**Created:** 2025-12-20
**Sprint Change Proposal:** `docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-20-eqc-lookup-config.md`

---

## Story

As a **data engineer running ETL pipelines**,
I want **the `--no-enrichment` flag to completely disable all EQC API calls**,
so that **I can run pipelines without external API dependencies when needed**.

---

## Background & Problem

The `--no-enrichment` CLI flag does not fully disable EQC lookups due to a 6-layer parameter propagation issue where "enrichment enabled" status is lost or ignored by lower layers.

**Root Cause:**
`CompanyIdResolver` currently contains "magic" logic to auto-create an `EqcProvider` whenever a `mapping_repository` is present, ignoring upper-layer intent.

**Zero Legacy Policy Violation:**
Previous attempts to fix this maintained backward compatibility by adding "implicit fallbacks" (loading global settings if config was missing). This violates the project's **Zero Legacy Policy**, which mandates explicit refactoring over backward compatibility wrappers.

**Proposed Solution:**
We will implement `EqcLookupConfig` as the Single Source of Truth and **fearlessly refactor** all consumers to pass this config explicitly. No hidden defaults.

---

## Acceptance Criteria

### AC-1: EqcLookupConfig Dataclass
- [x] Create `infrastructure/enrichment/eqc_lookup_config.py`
- [x] Implement frozen dataclass with: `enabled`, `sync_budget`, `auto_create_provider`, `export_unknown_names`, `auto_refresh_token`
- [x] Implement `disabled()` factory method (default state)
- [x] Implement `from_cli_args(args)` factory
- [x] Implement `from_settings()` factory (for explicit legacy domain migration)
- [x] Implement `from_dict(data)` factory (Dagster config rehydration)
- [x] Implement `to_dict()` method (Dagster config serialization)
- [x] Implement `should_auto_create_provider` property

### AC-2: CompanyIdResolver Refactoring (Zero Legacy)
- [x] **BREAKING CHANGE:** Modify `CompanyIdResolver.__init__`
    - [x] Add `eqc_config: EqcLookupConfig` as a **REQUIRED** parameter (no hidden defaults).
    - [x] **REMOVE** logic that auto-creates `EqcProvider` solely based on `mapping_repository` existence.
    - [x] Logic: Only use EQC if `eqc_config.enabled` is True AND `eqc_config.should_auto_create_provider` (or explicit provider passed).
    - [x] Warn if legacy params (`enrichment_service`) contradict config.

### AC-3: Update Upstream Consumers (Refactor Call Sites)
- [x] **Annuity Performance Domain:**
    - [x] Update `pipeline_builder.py`: `CompanyIdResolutionStep` accepts `eqc_config`.
    - [x] Update `service.py`: `process_with_enrichment` accepts `eqc_config`.
    - [x] Update `ops.py`: Rehydrate `EqcLookupConfig` from run_config and pass to service.
- [x] **Annuity Income Domain:**
    - [x] Update `pipeline_builder.py`: Inject `eqc_config` (default usage: `disabled()` for domains that don't run EQC).
    - [x] Refactor `CompanyIdResolutionStep` usage to avoid undefined legacy fields.
- [x] **Sandbox Trustee Domain:**
    - [x] N/A: `sandbox_trustee_performance` domain does not use `CompanyIdResolver` / EQC lookups in current codebase.

### AC-4: CLI & Orchestration
- [x] Update `cli/etl.py`:
    - [x] Use `EqcLookupConfig.from_cli_args()` to build config.
    - [x] Store in run_config under key `eqc_lookup_config`.
- [x] Update `ops.py` (generic): Rehydrate config from dict.

### AC-5: Testing & Verification
- [x] Fix all unit tests broken by `CompanyIdResolver` signature change.
- [x] Add unit tests for `EqcLookupConfig`:
    - [x] Test `disabled()` factory returns correct defaults.
    - [x] Test `from_cli_args()` semantic enforcement (`--no-enrichment` → all flags disabled).
    - [x] Test `from_dict()`/`to_dict()` roundtrip serialization.
    - [x] Test `should_auto_create_provider` property logic.
- [x] Integration Test: Verify `--no-enrichment` results in **zero** EQC provider initializations.

---

## Tasks / Subtasks

### Task 1: Core Infrastructure (AC 1 & 2)
- [x] 1.1: Create `EqcLookupConfig` dataclass.
- [x] 1.2: Refactor `CompanyIdResolver.__init__` (Remove auto-create magic, enforce config).
- [x] 1.3: Update `CompanyIdResolver.resolve_batch` to use config flags.

### Task 2: Update Annuity Performance (AC 3)
- [x] 2.1: Update `pipeline_builder.py` (`CompanyIdResolutionStep`).
- [x] 2.2: Update `service.py` (`process_with_enrichment`).
- [x] 2.3: Update `ops.py` (`process_annuity_performance_op`).

### Task 3: Update Other Domains (AC 3 - Zero Legacy)
- [x] 3.1: Update `AnnuityIncome` pipeline builder to construct/accept `EqcLookupConfig` (explicit config).
- [x] 3.2: N/A (no `CompanyIdResolver` usage in `sandbox_trustee_performance`).

### Task 4: CLI Integration (AC 4)
- [x] 4.1: Update `cli/etl.py` `build_run_config`.

### Task 5: Testing (AC 5)
- [x] 5.1: Update `tests/unit/infrastructure/enrichment/test_company_id_resolver.py` (Fix instantiation + semantics).
- [x] 5.2: Update `tests/unit/infrastructure/enrichment/test_company_id_resolver_eqc_integration.py`.
- [x] 5.3: New tests for `EqcLookupConfig`:
    - [x] 5.3.1: Test `disabled()` factory.
    - [x] 5.3.2: Test `from_cli_args()` semantic enforcement.
    - [x] 5.3.3: Test `from_dict()`/`to_dict()` roundtrip (Dagster serialization).
    - [x] 5.3.4: Test `should_auto_create_provider` property.
- [x] 5.4: Manual regression test (run ETL with `--no-enrichment`).

---

## Dev Notes

**Strict Zero Legacy Policy Application:**
- We are **not** preserving the old `CompanyIdResolver(enrichment_service=...)` behavior as valid.
- All 15+ usages of `CompanyIdResolver` in the codebase (including tests) must be updated to pass `eqc_config`.
- This ensures compile-time safety and no hidden "magic" behavior.

**Refactoring Guide:**
```python
# OLD
resolver = CompanyIdResolver(mapping_repository=repo)

# NEW (If you want legacy behavior)
config = EqcLookupConfig.from_settings()
resolver = CompanyIdResolver(mapping_repository=repo, eqc_config=config)

# NEW (If you want it disabled - e.g. most tests)
config = EqcLookupConfig.disabled()
resolver = CompanyIdResolver(mapping_repository=repo, eqc_config=config)
```

**Testing Commands:**
```bash
# Verify no broken tests left behind
PYTHONPATH=src uv run pytest tests/ -k "CompanyIdResolver"
```

---

## Dev Agent Record

**Context Reference:** Story 6.2-P17 (EQC config SSOT)  
**Completion Notes:**
- Fixed a critical bug where `CompanyIdResolver` still used `ResolutionStrategy.sync_lookup_budget` internally, which made `EqcLookupConfig` ineffective.
- Updated CLI and orchestration to pass serialized `eqc_lookup_config` and rehydrate via `EqcLookupConfig.from_dict`.
- Fixed all enrichment unit tests and added an integration-style test to ensure disabled config does not initialize an EQC provider.
- Manual regression completed (per user confirmation) on 2025-12-21.

### File List

- `src/work_data_hub/infrastructure/enrichment/eqc_lookup_config.py`
- `src/work_data_hub/infrastructure/enrichment/company_id_resolver.py`
- `src/work_data_hub/orchestration/ops.py`
- `src/work_data_hub/cli/etl.py`
- `src/work_data_hub/orchestration/jobs.py`
- `src/work_data_hub/domain/annuity_income/pipeline_builder.py`
- `src/work_data_hub/domain/annuity_performance/pipeline_builder.py`
- `src/work_data_hub/domain/annuity_performance/service.py`
- `tests/unit/infrastructure/enrichment/test_company_id_resolver.py`
- `tests/unit/infrastructure/enrichment/test_company_id_resolver_eqc_integration.py`
- `tests/unit/infrastructure/enrichment/test_eqc_lookup_config.py`

### Test Evidence

```bash
PYTHONPATH=src uv run --env-file .wdh_env -m pytest tests/unit/infrastructure/enrichment
# Result: 254 passed, 17 warnings
```

---

## Senior Developer Review (AI)

**Result:** Approved.  
**Key Fixes Applied:**
- `CompanyIdResolver` enrichment budget is now controlled by `EqcLookupConfig.sync_budget` (SSOT) end-to-end.
- `AnnuityIncome` pipeline builder no longer references undefined legacy fields.
- CLI and orchestration now propagate `eqc_lookup_config` explicitly (no silent parameter loss).

---

## Change Log

- 2025-12-20 – Implemented EqcLookupConfig propagation + resolver refactor; fixed unit tests; added integration-style guard test; set status to `in-progress` pending manual regression.
- 2025-12-21 – Manual regression confirmed; status set to `done`.
