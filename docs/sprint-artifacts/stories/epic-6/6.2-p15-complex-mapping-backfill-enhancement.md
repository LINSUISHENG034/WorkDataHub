# Story 6.2-P15: Complex Mapping Backfill Enhancement

**Epic:** Epic 6.2 - Generic Reference Data Management
**Type:** Enhancement / Feature
**Priority:** Medium
**Status:** done
**Created:** 2025-12-20
**Sprint Change Proposal:** `docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-20-complex-mapping-backfill-enhancement.md`

---

## Story

As a **data engineer processing 年金计划 (Annuity Plan) reference table backfill**,
I want **the GenericBackfillService to support complex aggregation strategies (max_by and concat_distinct) in addition to the current simple "first" strategy**,
so that **主拓代码/主拓机构 fields can be populated from records with maximum 期末资产规模, and 管理资格 field can concatenate distinct business types, achieving 100% FK mapping coverage**.

---

## Background & Problem

During validation of `年金计划` reference table backfill (Epic 6.2-P14 Code Review, 2025-12-20), a technical limitation was discovered:

**Current State:**
- `GenericBackfillService.derive_candidates()` uses `groupby.first()` - only supports simple 1:1 field mapping
- Takes the first non-blank value for each group, ignoring any aggregation requirements

**Required Behavior for 年金计划 table:**

1. **主拓代码/主拓机构 (Primary Agent Code/Name):**
   - Must select `机构代码` and `机构名称` from the record with **maximum** `期末资产规模`
   - SQL equivalent: `WHERE (计划代码, 期末资产规模) IN (SELECT 计划代码, MAX(期末资产规模) ...)`

2. **管理资格 (Management Qualification):**
   - Must concatenate distinct `业务类型` values with `+` separator
   - SQL equivalent: `GROUP_CONCAT(DISTINCT 业务类型 ORDER BY 业务类型 SEPARATOR '+')`

**Impact:** Without this enhancement, `年金计划` table data remains incomplete - critical columns not populated correctly.

---

## Acceptance Criteria

### AC-1: Configuration Schema Extension
- [x] `aggregation` field added to `BackfillColumnMapping` model
- [x] New `AggregationConfig` dataclass with type, order_column, separator, sort fields
- [x] `AggregationType` enum with values: "first", "max_by", "concat_distinct"
- [x] Config validation: `max_by` type MUST have `order_column` defined

### AC-2: Service Implementation
- [x] `derive_candidates()` refactored to support aggregation strategies per column
- [x] `_aggregate_max_by()` method implemented with defensive fallback to 'first'
- [x] `_aggregate_concat_distinct()` method implemented with sorted unique values
- [x] **Graceful Fallback:** When `order_column` missing or all NULL → fallback to 'first' with WARNING log

### AC-3: Edge Case Handling
- [x] `max_by`: Handle all-NULL order_column values (fallback to first)
- [x] `max_by`: Handle missing order_column in DataFrame (defensive check)
- [x] `max_by`: Use `skipna=True` explicitly in `idxmax()`
- [x] `concat_distinct`: Handle empty values gracefully (return "")
- [x] `concat_distinct`: Ensure string conversion before joining

### AC-4: FK Configuration Update
- [x] `config/foreign_keys.yml` updated for `annuity_performance` domain
- [x] `主拓代码`: aggregation type "max_by" with order_column "期末资产规模"
- [x] `主拓机构`: aggregation type "max_by" with order_column "期末资产规模"
- [x] `管理资格`: aggregation type "concat_distinct" with separator "+" and sort: true

### AC-5: Testing
- [x] Unit tests for new aggregation strategies (max_by, concat_distinct)
- [x] Edge case tests: all-NULL, empty DataFrame, mixed NULL/non-NULL
- [x] Configuration validation tests
- [x] Existing tests pass (no regression)

### AC-6: Documentation
- [x] `docs/guides/infrastructure/backfill-mechanism-guide.md` updated with new aggregation syntax
- [x] Examples for both aggregation types included
- [x] Edge case behavior documented

---

## Tasks / Subtasks

### Task 1: Configuration Schema Extension (AC: 1)
- [x] Subtask 1.1: Add `AggregationType` enum in `models.py`
- [x] Subtask 1.2: Create `AggregationConfig` dataclass
- [x] Subtask 1.3: Update `BackfillColumnMapping` with optional aggregation field
- [x] Subtask 1.4: Add config validation for max_by requiring order_column

### Task 2: Service Implementation (AC: 2, 3)
- [x] Subtask 2.1: Refactor `derive_candidates()` to check aggregation type per column
- [x] Subtask 2.2: Implement `_aggregate_max_by()` with defensive checks
- [x] Subtask 2.3: Implement `_aggregate_concat_distinct()` with string handling
- [x] Subtask 2.4: Add logging for fallback scenarios

### Task 3: FK Configuration Update (AC: 4)
- [x] Subtask 3.1: Update `config/foreign_keys.yml` for annuity_performance
- [x] Subtask 3.2: Add aggregation configs for 主拓代码, 主拓机构, 管理资格
- [x] Subtask 3.3: Validate YAML structure

### Task 4: Testing (AC: 5)
- [x] Subtask 4.1: Write unit tests for max_by aggregation
- [x] Subtask 4.2: Write unit tests for concat_distinct aggregation
- [x] Subtask 4.3: Write edge case tests (all-NULL, empty, mixed)
- [x] Subtask 4.4: Run full regression test suite

### Task 5: Documentation (AC: 6)
- [x] Subtask 5.1: Update backfill-mechanism-guide.md
- [x] Subtask 5.2: Add configuration examples
- [x] Subtask 5.3: Document edge case behavior

---

## Dev Notes

### Architecture Compliance

**File Locations (per Clean Architecture):**
- Models: `src/work_data_hub/domain/reference_backfill/models.py`
- Service: `src/work_data_hub/domain/reference_backfill/generic_service.py`
- Config: `config/foreign_keys.yml`
- Tests: `tests/unit/domain/reference_backfill/test_generic_backfill_service.py`
- Docs: `docs/guides/infrastructure/backfill-mechanism-guide.md`

**Design Patterns:**
- **Strategy Pattern** for aggregation types (extensible for future aggregations)
- **Defensive Programming** with graceful fallbacks
- **Configuration-Driven** approach aligns with project principles

### Critical Implementation Details

#### 1. Aggregation Type Safety
```python
from enum import Enum

class AggregationType(str, Enum):
    """Supported aggregation types with config-time validation."""
    FIRST = "first"
    MAX_BY = "max_by"
    CONCAT_DISTINCT = "concat_distinct"
```

#### 2. Defensive max_by Implementation
```python
def _aggregate_max_by(self, df: pd.DataFrame, group_col: str, mapping: BackfillColumnMapping) -> pd.Series:
    """
    CRITICAL: Must handle edge cases gracefully:
    1. order_column doesn't exist → fallback to 'first'
    2. All values in order_column are NULL → fallback to 'first'
    3. Use skipna=True explicitly
    """
```

#### 3. Performance Considerations
- `groupby` operations are already optimized in pandas
- No nested loops or N+1 query patterns
- Batch processing maintained (no row-by-row operations)

### Project Context Alignment

**KISS Principle:**
- Simple aggregation strategies, not a complex DSL
- Direct pandas operations, no custom query engines

**YAGNI Principle:**
- Only implementing the 2 needed aggregations (not a generic framework)
- No speculative features for future aggregations

**Zero Legacy Policy:**
- New feature is additive (opt-in via config)
- Default behavior unchanged (backward compatible by design)

### Testing Commands (Project Standard)

```bash
# Unit tests for backfill
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/unit/domain/reference_backfill/test_generic_backfill_service.py -v -k "aggregation"

# Full regression
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/unit/domain/reference_backfill -v

# Verify configuration loading
PYTHONPATH=src uv run --env-file .wdh_env python -c "
from work_data_hub.domain.reference_backfill.config_loader import load_foreign_keys_config
config = load_foreign_keys_config(domain='annuity_performance')
for fk in config:
    agg_cols = [c.target for c in fk.backfill_columns if c.aggregation]
    if agg_cols:
        print(f'{fk.name}: aggregation columns = {agg_cols}')
"
```

### Git Intelligence (Recent Related Work)

| Commit | Description | Relevance |
|--------|-------------|-----------|
| `c09eba3` | feat(story-6.2-p14): config file modularization | FK config now in `foreign_keys.yml` |
| `3acaf1d` | feat(story-6.2-p13): unified domain schema management | Domain registry patterns |
| `a3c56c6` | feat(story-6.2-p12): domain comparison framework | Config-driven patterns |

**Key Patterns from Recent Stories:**
- Config-driven architecture (6.2-P12, 6.2-P14)
- Enum types for validation (6.2-P13)
- Graceful error handling with logging (6.2-P11)

### Team Review Integration

Per the Sprint Change Proposal (Party Mode review 2025-12-20):

| Enhancement | Implementation |
|-------------|----------------|
| Dual-layer validation | Config-time check + runtime fallback |
| `skipna=True` handling | Explicit parameter in `idxmax()` |
| Edge case tests | 3 specific scenarios added to AC |
| Type safety | `AggregationType` enum |

### Risk Assessment & Mitigation

| Risk | Level | Mitigation |
|------|-------|------------|
| Breaking existing backfill | Low | New features are opt-in; default unchanged |
| Complex SQL generation | Medium | Use pandas built-in; avoid raw SQL |
| Performance degradation | Low | Aggregation adds minimal overhead |
| Missing order_column data | Low | Dual-layer validation + runtime fallback |

### Pre-Implementation Verification

```bash
# 1. Verify current FK config structure
cat config/foreign_keys.yml | grep -A20 "annuity_performance"

# 2. Check current derive_candidates implementation
grep -n "grouped_first" src/work_data_hub/domain/reference_backfill/generic_service.py

# 3. Verify test structure
ls tests/unit/domain/reference_backfill/test_generic_backfill_service.py
```

---

## References

- [Sprint Change Proposal](file:///e:/Projects/WorkDataHub/docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-20-complex-mapping-backfill-enhancement.md) - Detailed problem analysis and team review
- [Complex Mapping Requirements](file:///e:/Projects/WorkDataHub/docs/specific/backfill-mechanism/complex-mapping-requirements-analysis.md) - Original technical analysis
- [Architecture Decision #11](file:///e:/Projects/WorkDataHub/docs/architecture/architectural-decisions.md#decision-11-hybrid-reference-data-management-strategy) - Hybrid reference strategy
- [PRD FR-4.1](file:///e:/Projects/WorkDataHub/docs/prd/functional-requirements.md#fr-41-transactional-bulk-loading) - Transactional loading requirements
- [Epic 6.2 Proposal](file:///e:/Projects/WorkDataHub/docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-12-generic-reference-management.md) - Epic creation and context
- [Backfill Guide](file:///e:/Projects/WorkDataHub/docs/guides/infrastructure/backfill-mechanism-guide.md) - Current mechanism documentation

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101-thinking)

### Debug Log References

- All 2128 tests passed with 0 failures
- 15 new aggregation tests added (4 config validation, 4 max_by, 4 concat_distinct, 3 edge cases)
- Full regression suite: 129 reference_backfill tests, 2128 total tests

### Completion Notes List

- **Task 1**: Added `AggregationType` enum and `AggregationConfig` dataclass with Pydantic validation
- **Task 2**: Implemented `_aggregate_max_by()` and `_aggregate_concat_distinct()` methods with graceful fallbacks
- **Task 3**: Updated `config/foreign_keys.yml` with aggregation configs for 年金计划 backfill
- **Task 4**: Added 15 comprehensive unit tests covering all aggregation strategies and edge cases
- **Task 5**: Updated backfill-mechanism-guide.md with aggregation syntax documentation

### File List

**Modified:**
- `src/work_data_hub/domain/reference_backfill/models.py` - Added AggregationType enum, AggregationConfig dataclass, updated BackfillColumnMapping
- `src/work_data_hub/domain/reference_backfill/generic_service.py` - Added _aggregate_max_by(), _aggregate_concat_distinct(), refactored derive_candidates()
- `config/foreign_keys.yml` - Updated schema version to 1.1, added aggregation configs for fk_plan
- `tests/unit/domain/reference_backfill/test_generic_backfill_service.py` - Added 15 new test cases for aggregation
- `docs/guides/infrastructure/backfill-mechanism-guide.md` - Added aggregation strategy documentation
- `docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-20-complex-mapping-backfill-enhancement.md` - Sprint change proposal document
- `docs/sprint-artifacts/sprint-status.yaml` - Updated sprint status

### Change Log

| Date | Change | Author |
|------|--------|--------|
| 2025-12-20 | Code review fixes: Fixed concat_distinct empty handling, type annotation, updated file list | Claude (Code Review) |
| 2025-12-20 | Story implementation complete - all 5 tasks done | Claude Opus 4.5 |