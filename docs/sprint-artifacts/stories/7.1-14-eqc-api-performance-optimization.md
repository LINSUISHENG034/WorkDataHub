# Story 7.1-14: EQC API Performance Optimization

Status: backlog

## Story

As a **Data Engineer**,
I want to **optimize EQC API call performance and implement batch processing**,
so that **large domain datasets can be processed in reasonable time without blocking production workflows**.

## Context

**Priority:** P1 (High)  
**Effort:** 8 hours  
**Epic:** 7.1 - Pre-Epic 8 Bug Fixes & Improvements  
**Source:** Tech Debt discovered in Story 7.1-2 (TD-4)

### Problem Statement

During Story 7.1-2 multi-domain execution validation, severe EQC API performance issues were discovered:

- **每次 EQC API 调用耗时 20-60 秒**
- **30,986 行 annuity_performance 数据需要 ~16 小时执行**
- 当前只能通过 `--no-enrichment` 跳过 EQC 调用

### Current Data

| Metric | Value |
|--------|-------|
| EQC API latency | 20-60 seconds/call |
| annuity_performance rows | 30,986 |
| Estimated full enrichment time | ~16 hours |
| Workaround | `--no-enrichment` flag |

### Impact

- 生产级数据处理被阻塞
- 无法在合理时间内完成带 enrichment 的 ETL
- Epic 8 Golden Dataset 验证可能受影响

## Acceptance Criteria

### AC-1: Performance Baseline
**GIVEN** a performance test with 1000 unique company names  
**WHEN** measuring EQC API call timing  
**THEN** baseline metrics should be documented

### AC-2: Batch Processing Implementation
**GIVEN** multiple EQC lookups needed  
**WHEN** processing a domain batch  
**THEN** API calls should be batched/pooled to reduce total time

### AC-3: Caching Optimization
**GIVEN** the enrichment_index cache  
**WHEN** processing repeated company names  
**THEN** cache hit rate should be maximized before EQC calls

### AC-4: Progress Reporting
**GIVEN** a long-running EQC enrichment operation  
**WHEN** processing large datasets  
**THEN** progress should be reported to user with ETA

## Tasks / Subtasks

- [ ] **Task 1: Performance Analysis**
  - [ ] 1.1 Profile current EQC API call patterns
  - [ ] 1.2 Identify bottlenecks (network, API limits, serialization)
  - [ ] 1.3 Document baseline metrics

- [ ] **Task 2: Cache Optimization**
  - [ ] 2.1 Analyze enrichment_index cache hit rate
  - [ ] 2.2 Implement pre-batch cache warming
  - [ ] 2.3 Add cache statistics logging

- [ ] **Task 3: Batch Processing** (if applicable)
  - [ ] 3.1 Investigate EQC API batch endpoints
  - [ ] 3.2 Implement concurrent API calls (if rate limit allows)
  - [ ] 3.3 Add retry logic with exponential backoff

- [ ] **Task 4: Progress Reporting**
  - [ ] 4.1 Add progress bar for EQC enrichment
  - [ ] 4.2 Display ETA based on current rate
  - [ ] 4.3 Add `--verbose` mode for detailed timing

## Dev Notes

### Key Files

- `src/work_data_hub/io/connectors/eqc/` - EQC Client Package
- `src/work_data_hub/infrastructure/enrichment/` - Enrichment Service
- `src/work_data_hub/infrastructure/enrichment/repository/enrichment_index_ops.py`

### Potential Approaches

1. **并行调用**: 多线程/异步并发 EQC 请求
2. **预热缓存**: 批量预加载 enrichment_index
3. **批量 API**: 检查 EQC 是否支持批量查询接口
4. **渐进式处理**: 分批处理，每批保存进度

### References

- [Story 7.1-2 Dev Agent Record](file:///E:/Projects/WorkDataHub/docs/sprint-artifacts/stories/7.1-2-etl-execute-mode-validation.md#dev-agent-record) - EQC Performance Investigation
- [EQC Client Package](file:///E:/Projects/WorkDataHub/src/work_data_hub/io/connectors/eqc/) - Current implementation
