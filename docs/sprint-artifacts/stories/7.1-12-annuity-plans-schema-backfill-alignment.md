# Story 7.1-12: Fix Annuity Plans Schema and Backfill Config Alignment

Status: backlog

## Story

As a **Data Engineer**,
I want to **fix the schema definition and backfill configuration mismatch for annuity_plans**,
so that **FK backfill operations can use ON CONFLICT correctly without errors**.

## Context

**Priority:** P1 (High)  
**Effort:** 2 hours  
**Epic:** 7.1 - Pre-Epic 8 Bug Fixes & Improvements  
**Source:** Tech Debt discovered in Story 7.1-2 (TD-1, TD-3)

### Problem Statement

During Story 7.1-2 testing approach investigation, the following issues were discovered:

1. **TD-1:** `annuity_plans` 的 `年金计划号` 应设为 UNIQUE 约束，但当前只是索引
2. **TD-3:** FK backfill 配置使用 `年金计划号` 作为 `ON CONFLICT` 键，但该字段不是唯一约束

### Root Cause

```python
# src/work_data_hub/infrastructure/schema/definitions/annuity_plans.py
DomainSchema(
    domain_name="annuity_plans",
    primary_key="annuity_plans_id",  # ← 自增主键
    composite_key=["年金计划号", "company_id"],  # ← 复合键
    indexes=[
        IndexDef(["年金计划号"]),  # ← 只是索引，不是 UNIQUE
    ]
)
```

### Impact

- `generic_backfill_refs_op` 执行 `ON CONFLICT ("年金计划号")` 时报错
- 阻塞自动化集成测试的创建
- 影响 FK backfill 操作的正确性

## Acceptance Criteria

### AC-1: Schema Definition Fix
**GIVEN** the `annuity_plans` domain schema  
**WHEN** the `年金计划号` field is defined  
**THEN** it should have a UNIQUE constraint (not just an index)

### AC-2: Backfill Config Verification
**GIVEN** the FK backfill configuration in `config/foreign_keys.yml`  
**WHEN** `annuity_plans` is used as a reference table  
**THEN** the ON CONFLICT key should match the actual UNIQUE constraint

### AC-3: Migration Compatibility
**GIVEN** active Alembic migrations  
**WHEN** schema changes are applied  
**THEN** existing data should not be corrupted or lost

## Tasks / Subtasks

- [ ] **Task 1: Schema Analysis**
  - [ ] 1.1 Review current `annuity_plans` schema definition
  - [ ] 1.2 Identify all FK backfill configurations referencing this table
  - [ ] 1.3 Document the gap between schema and config

- [ ] **Task 2: Schema Fix**
  - [ ] 2.1 Update `DomainSchema` to add UNIQUE constraint on `年金计划号`
  - [ ] 2.2 Create Alembic migration for constraint addition
  - [ ] 2.3 Test migration against existing data

- [ ] **Task 3: Config Alignment**
  - [ ] 3.1 Verify `config/foreign_keys.yml` uses correct ON CONFLICT key
  - [ ] 3.2 Update config if needed
  - [ ] 3.3 Test FK backfill with corrected config

## Dev Notes

### Related Files

- `src/work_data_hub/infrastructure/schema/definitions/annuity_plans.py`
- `config/foreign_keys.yml`
- `src/work_data_hub/infrastructure/etl/ops/generic_backfill_refs_op.py`

### References

- [Story 7.1-2 Testing Approach Decision](file:///E:/Projects/WorkDataHub/docs/sprint-artifacts/reviews/story-7.1-2-testing-approach-decision.md) - Section 2.3
