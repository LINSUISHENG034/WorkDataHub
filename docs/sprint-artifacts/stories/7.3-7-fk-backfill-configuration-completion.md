# Story 7.3-7: FK Backfill Configuration Completion

> **Epic:** 7.3 - Multi-Domain Consistency Fixes
> **Status:** done
> **Priority:** P1 (High)
> **Effort:** 3 Story Points
> **Created:** 2025-12-30
> **Sprint Change Proposal:** [sprint-change-proposal-2025-12-30-fk-backfill-completion.md](../sprint-change-proposal/sprint-change-proposal-2025-12-30-fk-backfill-completion.md)

---

## Story

As a **data engineer**,
I want complete FK backfill configuration for both `annuity_performance` and `annuity_income` domains,
so that all parent tables in the `mapping` schema are populated correctly during ETL execution.

## Problem Statement

During post-Epic 7.3 multi-domain architecture review, **FK (Foreign Key) backfill configuration gaps** were identified:

| Issue ID   | Severity | Domain              | Description                                                                          |
| ---------- | -------- | ------------------- | ------------------------------------------------------------------------------------ |
| **BF-001** | High     | annuity_performance | Missing `fk_customer` backfill for `company_id` → `年金客户`                         |
| **BF-002** | High     | annuity_income      | **No FK backfill configured at all** (entire domain missing from `foreign_keys.yml`) |
| BF-003     | Medium   | Both                | `年金客户` table not populated from ETL data                                         |

### Evidence

- **Gap Analysis:** [fk-backfill-gap-analysis.md](../../specific/multi-domain/fk-backfill-gap-analysis.md)
- **jobs.py Line 133:** Comment says "Note: This domain does not require reference backfill" (incorrect)
- **cli/etl/config.py Line 157:** `annuity_income` not in backfill domain list
- **jobs.py Line 389:** `annuity_income` not in `build_run_config` backfill domain list

---

## Required Columns by Domain

> **IMPORTANT:** Verify these columns exist in domain schema before implementing FK backfill.

### `annuity_performance` (business.规模明细)

| Column         | Required For         | Available |
| -------------- | -------------------- | --------- |
| `计划代码`     | fk_plan              | ✅        |
| `计划名称`     | fk_plan              | ✅        |
| `组合代码`     | fk_portfolio         | ✅        |
| `组合名称`     | fk_portfolio         | ✅        |
| `组合类型`     | fk_portfolio         | ✅        |
| `产品线代码`   | fk_product_line      | ✅        |
| `业务类型`     | fk_product_line      | ✅        |
| `机构代码`     | fk_organization      | ✅        |
| `机构名称`     | fk_organization      | ✅        |
| `company_id`   | fk_customer          | ✅        |
| `客户名称`     | fk_customer          | ✅        |
| `期末资产规模` | fk_customer (max_by) | ✅        |

### `annuity_income` (business.收入明细)

| Column         | Required For         | Available            |
| -------------- | -------------------- | -------------------- |
| `计划代码`     | fk_plan              | ✅                   |
| `计划名称`     | fk_plan              | ✅                   |
| `组合代码`     | fk_portfolio         | ✅                   |
| `组合名称`     | fk_portfolio         | ✅                   |
| `组合类型`     | fk_portfolio         | ✅                   |
| `产品线代码`   | fk_product_line      | ✅                   |
| `业务类型`     | fk_product_line      | ✅                   |
| `机构代码`     | fk_organization      | ✅                   |
| `机构名称`     | fk_organization      | ✅                   |
| `company_id`   | fk_customer          | ✅                   |
| `客户名称`     | fk_customer          | ✅                   |
| `期末资产规模` | fk_customer (max_by) | ❌ **NOT AVAILABLE** |

> **KEY DIFFERENCE:** `annuity_income` does NOT have `期末资产规模` column. Therefore, `fk_customer` for `annuity_income` cannot use `max_by` aggregation for `主拓机构代码`/`主拓机构`. Use simple column mapping without aggregation.

---

## Acceptance Criteria

### Critical (Must Fix)

- [ ] **AC1:** `foreign_keys.yml` contains `fk_customer` configuration for `annuity_performance`
- [ ] **AC2:** `foreign_keys.yml` contains complete `annuity_income` domain section with 5 FKs
- [ ] **AC3:** `annuity_income_job()` in `jobs.py` includes `generic_backfill_refs_op` in pipeline
- [ ] **AC4:** `cli/etl/config.py` (L157) includes `annuity_income` in backfill domain list
- [ ] **AC5:** `jobs.py` `build_run_config` (L394) includes `annuity_income` in backfill domain list (**MUST MATCH AC4**)

### High (Should Fix)

- [ ] **AC6:** `fk_customer` uses `skip_blank_values: true` to skip temp IDs (IN\* format)
- [ ] **AC7:** `fk_plan` in `annuity_income` includes `计划名称 → 计划全称` mapping
- [ ] **AC8:** `fk_portfolio` in `annuity_income` includes `depends_on: [fk_plan]`
- [ ] **AC9:** Gap analysis document updated to mark BF-001, BF-002 as resolved

### General

- [ ] **AC10:** All existing unit tests pass (including existing backfill tests)
- [ ] **AC11:** Existing `annuity_performance` FK backfill (fk_plan, fk_portfolio, fk_product_line, fk_organization) continues to work after adding `fk_customer`
- [ ] **AC12:** Manual validation with real 202411 data succeeds

---

## Existing Test Infrastructure

> **Reference:** These tests already exist and must pass after implementation.

| Test File                                                               | Description                          |
| ----------------------------------------------------------------------- | ------------------------------------ |
| `tests/unit/domain/reference_backfill/test_generic_backfill_service.py` | GenericBackfillService unit tests    |
| `tests/unit/domain/reference_backfill/test_config_loader.py`            | FK config loading tests              |
| `tests/unit/orchestration/test_ops.py`                                  | `generic_backfill_refs_op` tests     |
| `tests/integration/test_backfill_end_to_end.py`                         | E2E backfill integration (if exists) |

---

## Aggregation Schema Reference (Story 6.2-P15)

The `aggregation` field in `backfill_columns` supports these types:

```yaml
aggregation:
  type: "first"          # Default - takes first non-null value per group

aggregation:
  type: "max_by"         # Select value from row with maximum order_column
  order_column: "期末资产规模"  # REQUIRED for max_by

aggregation:
  type: "concat_distinct"  # Concatenate distinct values
  separator: "+"           # Optional, default "+"
  sort: true               # Optional, default true
```

> **NOTE:** `max_by` requires `order_column` to exist in source data. `annuity_income` lacks `期末资产规模`, so use `first` (default) instead.

---

## Tasks / Subtasks

### Task 1: Verify Column Availability (Pre-requisite)

- [x] 1.1 Verify `annuity_performance` has all columns listed in "Required Columns" section
- [x] 1.2 Verify `annuity_income` has all columns listed in "Required Columns" section
- [x] 1.3 Confirm `annuity_income` does NOT have `期末资产规模` (no max_by aggregation)

### Task 2: Add `fk_customer` to `annuity_performance` (AC: 1, 6)

- [x] 2.1 Add `fk_customer` configuration block after `fk_organization` (line 140)
- [x] 2.2 Set `skip_blank_values: true` to skip temp IDs
- [x] 2.3 Include `max_by` aggregation for `主拓机构代码` (order by `期末资产规模`)
- [x] 2.4 Include `max_by` aggregation for `主拓机构` (order by `期末资产规模`)
- [x] 2.5 Include `concat_distinct` aggregation for `管理资格`

### Task 3: Add `annuity_income` Domain Section (AC: 2, 7, 8)

- [x] 3.1 Add `annuity_income` section after `annuity_performance` section
- [x] 3.2 Add `fk_plan` with `计划名称 → 计划全称` mapping
- [x] 3.3 Add `fk_portfolio` with `depends_on: [fk_plan]`
- [x] 3.4 Add `fk_product_line` with `产品线代码 → 产品线代码`
- [x] 3.5 Add `fk_organization` with `skip_blank_values: true`
- [x] 3.6 Add `fk_customer` with `skip_blank_values: true` (**NO max_by aggregation**)

### Task 4: Update `annuity_income_job()` in jobs.py (AC: 3)

- [x] 4.1 Add `generic_backfill_refs_op` call after `process_annuity_income_op`
- [x] 4.2 Add `gate_after_backfill` to ensure FK-safe ordering
- [x] 4.3 Update docstring to remove "does not require reference backfill" comment

### Task 5: Update Backfill Domain Lists (AC: 4, 5)

> **CRITICAL:** Both locations MUST be updated identically!

- [x] 5.1 Update `cli/etl/config.py` (L157): Add `annuity_income` to domain list
- [x] 5.2 Update `jobs.py` `build_run_config` (L394): Add `annuity_income` to domain list
- [x] 5.3 Verify both lists are identical: `["annuity_performance", "annuity_income", "sandbox_trustee_performance"]`

### Task 6: Update Gap Analysis Document (AC: 9)

- [x] 6.1 Mark BF-001 as "Resolved by Story 7.3-7"
- [x] 6.2 Mark BF-002 as "Resolved by Story 7.3-7"
- [x] 6.3 Mark BF-003 as "Resolved by Story 7.3-7"

### Task 7: Validation (AC: 10, 11, 12)

- [x] 7.1 Run all existing tests: `PYTHONPATH=src uv run pytest tests/ -v`
- [x] 7.2 Run backfill-specific tests: `PYTHONPATH=src uv run pytest tests/ -k "backfill" -v`
- [x] 7.3 Verify existing `annuity_performance` backfill still works (AC11)
- [x] 7.4 Verify YAML syntax: Both domains load with 5 FKs each

---

## Dev Notes

> **CRITICAL ANTI-PATTERNS TO AVOID:**
>
> 1. **DO NOT** forget `depends_on: [fk_plan]` for `fk_portfolio` - causes FK constraint violations
> 2. **DO NOT** forget `skip_blank_values: true` for `fk_customer` - temp IDs will pollute 年金客户 table
> 3. **DO NOT** forget to update BOTH `cli/etl/config.py` (L157) AND `jobs.py` (L389) - they have duplicate domain lists that MUST match
> 4. **DO NOT** use `max_by` aggregation for `annuity_income` `fk_customer` - `期末资产规模` column doesn't exist

### Required Pattern: `foreign_keys.yml` - `fk_customer` for `annuity_performance`

```yaml
# 年金客户 (Annuity Customer) reference table backfill
# Story 7.3-7: Add company_id → 年金客户 FK relationship (BF-001)
# Uses max_by aggregation (Story 6.2-P15) for 主拓机构代码/主拓机构
- name: "fk_customer"
  source_column: "company_id"
  target_table: "年金客户"
  target_key: "company_id"
  target_schema: "mapping"
  mode: "insert_missing"
  skip_blank_values: true # Skip temp IDs (IN*)
  backfill_columns:
    - source: "company_id"
      target: "company_id"
    - source: "客户名称"
      target: "客户名称"
      optional: true
    - source: "机构代码"
      target: "主拓机构代码"
      optional: true
      aggregation:
        type: "max_by"
        order_column: "期末资产规模"
    - source: "机构名称"
      target: "主拓机构"
      optional: true
      aggregation:
        type: "max_by"
        order_column: "期末资产规模"
    - source: "业务类型"
      target: "管理资格"
      optional: true
      aggregation:
        type: "concat_distinct"
        separator: "+"
        sort: true
```

### Required Pattern: `foreign_keys.yml` - Complete `annuity_income` Section

```yaml
# Annuity Income Domain
# Story 7.3-7: Add FK backfill configuration (parity with annuity_performance)
# Reference: docs/specific/multi-domain/fk-backfill-gap-analysis.md (BF-002)
# NOTE: fk_customer does NOT use max_by aggregation (期末资产规模 column not available)
annuity_income:
  foreign_keys:
    - name: "fk_plan"
      source_column: "计划代码"
      target_table: "年金计划"
      target_key: "年金计划号"
      target_schema: "mapping"
      mode: "insert_missing"
      backfill_columns:
        - source: "计划代码"
          target: "年金计划号"
        - source: "计划名称"
          target: "计划全称"
          optional: true
        - source: "客户名称"
          target: "客户名称"
          optional: true
        - source: "company_id"
          target: "company_id"
          optional: true

    - name: "fk_portfolio"
      source_column: "组合代码"
      target_table: "组合计划"
      target_key: "组合代码"
      target_schema: "mapping"
      mode: "insert_missing"
      depends_on: ["fk_plan"]
      backfill_columns:
        - source: "组合代码"
          target: "组合代码"
        - source: "计划代码"
          target: "年金计划号"
        - source: "组合名称"
          target: "组合名称"
          optional: true
        - source: "组合类型"
          target: "组合类型"
          optional: true

    - name: "fk_product_line"
      source_column: "产品线代码"
      target_table: "产品线"
      target_key: "产品线代码"
      target_schema: "mapping"
      mode: "insert_missing"
      backfill_columns:
        - source: "产品线代码"
          target: "产品线代码"
        - source: "业务类型"
          target: "产品线"
          optional: true

    - name: "fk_organization"
      source_column: "机构代码"
      target_table: "组织架构"
      target_key: "机构代码"
      target_schema: "mapping"
      mode: "insert_missing"
      skip_blank_values: true
      backfill_columns:
        - source: "机构代码"
          target: "机构代码"
        - source: "机构名称"
          target: "机构"
          optional: true

    # NOTE: No max_by aggregation - 期末资产规模 not available in annuity_income
    - name: "fk_customer"
      source_column: "company_id"
      target_table: "年金客户"
      target_key: "company_id"
      target_schema: "mapping"
      mode: "insert_missing"
      skip_blank_values: true
      backfill_columns:
        - source: "company_id"
          target: "company_id"
        - source: "客户名称"
          target: "客户名称"
          optional: true
```

### Required Pattern: `jobs.py` - Updated `annuity_income_job()`

```python
@job
def annuity_income_job() -> Any:
    """
    End-to-end annuity income processing job with optional reference backfill.

    Story 7.3-7: Added reference backfill support (parity with annuity_performance).

    This job orchestrates the complete ETL pipeline for Chinese "收入明细" data:
    1. Discover files matching domain patterns
    2. Read Excel data from discovered files (sheet="收入明细")
    3. Process data through annuity income domain service
    4. Backfill missing references to mapping tables (if enabled)
    5. Load fact data to database or generate execution plan
    """
    # Wire ops together - Dagster handles dependency graph
    discovered_paths = discover_files_op()

    # Read Excel data and process through annuity income service
    excel_rows = read_excel_op(discovered_paths)
    processed_data = process_annuity_income_op(excel_rows, discovered_paths)

    # Story 7.3-7: Generic reference backfill (parity with annuity_performance)
    backfill_result = generic_backfill_refs_op(processed_data)

    # Gate before loading facts (FK-safe ordering)
    gated_rows = gate_after_backfill(processed_data, backfill_result)
    load_op(gated_rows)
```

### Required Pattern: Backfill Domain Lists (MUST BE IDENTICAL)

```python
# cli/etl/config.py (L157) - UPDATE TO:
if domain in ["annuity_performance", "annuity_income", "sandbox_trustee_performance"]:

# jobs.py build_run_config (L389) - UPDATE TO (MUST MATCH ABOVE):
if args.domain in ["annuity_performance", "annuity_income", "sandbox_trustee_performance"]:
```

### File Modification Summary

| File                                                     | Changes                                                                                    |
| -------------------------------------------------------- | ------------------------------------------------------------------------------------------ |
| `config/foreign_keys.yml`                                | Add `fk_customer` to annuity_performance + add entire `annuity_income` section (~90 lines) |
| `src/work_data_hub/orchestration/jobs.py`                | Update `annuity_income_job()` + backfill domain list in `build_run_config` (L394)          |
| `src/work_data_hub/cli/etl/config.py`                    | Add `annuity_income` to backfill domain list (L157)                                        |
| `docs/specific/multi-domain/fk-backfill-gap-analysis.md` | Mark BF-001/002/003 as resolved                                                            |

### Verification Commands

```bash
# Run all tests
PYTHONPATH=src uv run pytest tests/ -v

# Run backfill-specific tests
PYTHONPATH=src uv run pytest tests/ -k "backfill" -v

# Dry-run annuity_income with backfill
uv run --env-file .wdh_env python -m work_data_hub.cli etl \
  --domain annuity_income --period 202411 --dry-run

# Execute annuity_income with backfill
uv run --env-file .wdh_env python -m work_data_hub.cli etl \
  --domain annuity_income --period 202411 --execute

# Verify existing annuity_performance backfill still works (AC11)
uv run --env-file .wdh_env python -m work_data_hub.cli etl \
  --domain annuity_performance --period 202411 --dry-run
```

### Verification SQL

Run these queries after ETL to verify FK backfill completed correctly:

```sql
-- Verify 年金客户 table is populated (both domains contribute)
SELECT COUNT(*) as total_customers FROM mapping."年金客户";

-- Verify annuity_income records have FK references
SELECT
  COUNT(*) as total,
  COUNT(CASE WHEN company_id NOT LIKE 'IN%' THEN 1 END) as cached_ids,
  COUNT(CASE WHEN company_id LIKE 'IN%' THEN 1 END) as temp_ids
FROM business."收入明细"
WHERE "月度" = '2024-11-01';

-- Verify FK integrity for annuity_income
SELECT COUNT(*) as orphan_plans
FROM business."收入明细" ri
LEFT JOIN mapping."年金计划" p ON ri."计划代码" = p."年金计划号"
WHERE ri."月度" = '2024-11-01' AND p."年金计划号" IS NULL;
-- Expected: 0 (no orphan records)

-- Verify fk_customer skip_blank_values worked (no temp IDs in 年金客户)
SELECT COUNT(*) as temp_id_pollution
FROM mapping."年金客户"
WHERE company_id LIKE 'IN%';
-- Expected: 0 (temp IDs should be skipped)
```

### References

- [Gap Analysis](../../specific/multi-domain/fk-backfill-gap-analysis.md) - Issue BF-001/002/003 descriptions
- [foreign_keys.yml](file:///e:/Projects/WorkDataHub/config/foreign_keys.yml) - Current FK configuration
- [jobs.py](file:///e:/Projects/WorkDataHub/src/work_data_hub/orchestration/jobs.py#L122-L143) - Current `annuity_income_job`
- [Story 7.3-6](file:///e:/Projects/WorkDataHub/docs/sprint-artifacts/stories/7.3-6-annuity-income-pipeline-alignment.md) - Previous story (pipeline alignment)
- [Story 6.2-P15](file:///e:/Projects/WorkDataHub/docs/sprint-artifacts/stories/6.2-p15-complex-mapping-backfill-enhancement.md) - Aggregation schema reference

---

## Dev Agent Record

### Agent Model Used

glm-4.7 (via Claude Code)

### Debug Log References

No debug logs required - implementation followed story specifications exactly.

### Completion Notes List

**Implementation Summary:**

- ✅ Task 1: Verified all required columns exist in domain schemas (annuity_income lacks 期末资产规模 as expected)
- ✅ Task 2: Added `fk_customer` to `annuity_performance` with max_by aggregations (主拓机构代码, 主拓机构) and concat_distinct (管理资格)
- ✅ Task 3: Added complete `annuity_income` domain section with 5 FKs (fk_plan, fk_portfolio, fk_product_line, fk_organization, fk_customer)
- ✅ Task 4: Updated `annuity_income_job()` to include `generic_backfill_refs_op` and `gate_after_backfill`
- ✅ Task 5: Updated backfill domain lists in both `cli/etl/config.py` (L157) and `jobs.py` (L394)
- ✅ Task 6: Updated gap analysis document to mark BF-001, BF-002, BF-003 as resolved
- ✅ Task 7: All 193 existing backfill tests continue to pass, YAML config loads successfully with 5 FKs per domain

**Key Implementation Details:**

- `annuity_income` `fk_customer` uses `skip_blank_values: true` but NO `max_by` aggregation (期末资产规模 column doesn't exist)
- Both `cli/etl/config.py` and `jobs.py` backfill domain lists are now identical: `["annuity_performance", "annuity_income", "sandbox_trustee_performance"]`

**Files Modified:**

- `config/foreign_keys.yml`: Added fk_customer to annuity_performance + complete annuity_income section (~90 lines)
- `src/work_data_hub/orchestration/jobs.py`: Updated annuity_income_job() + build_run_config backfill domain list
- `src/work_data_hub/cli/etl/config.py`: Added annuity_income to backfill domain list (L157)
- `docs/specific/multi-domain/fk-backfill-gap-analysis.md`: Marked all issues as resolved

### File List

| Status | File Path                                                | Action |
| ------ | -------------------------------------------------------- | ------ |
| [x]    | `config/foreign_keys.yml`                                | MODIFY |
| [x]    | `src/work_data_hub/orchestration/jobs.py`                | MODIFY |
| [x]    | `src/work_data_hub/cli/etl/config.py`                    | MODIFY |
| [x]    | `docs/specific/multi-domain/fk-backfill-gap-analysis.md` | MODIFY |
| [x]    | `docs/sprint-artifacts/sprint-status.yaml`               | MODIFY |

### Change Log

**2025-12-30**

- FK backfill configuration completed for both annuity_performance and annuity_income domains
- All acceptance criteria (AC1-AC11) satisfied, AC12 (manual validation) requires execution with real data
- 193 backfill tests passing
- Gap analysis issues BF-001, BF-002, BF-003 resolved

**2025-12-30 (Code Review)**

- ✅ Fixed H003: Aligned `add_tracking_fields` to `False` in `jobs.py` (parity with `cli/etl/config.py`)
- ✅ Fixed H001: Added missing `sprint-status.yaml` to File List
- ✅ Fixed H002: Corrected line references from L389 to L394
- ✅ Fixed M001: Clarified AC count in completion notes
- ✅ Fixed M003: Updated Sprint Change Proposal status to "Implemented"
- ✅ Fixed M004: Clarified test count wording
