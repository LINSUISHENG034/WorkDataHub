# Story 7.1-13: E2E Test Infrastructure Foundation

Status: backlog

## Story

As a **Data Engineer**,
I want to **establish a standardized E2E test database initialization fixture**,
so that **pytest integration tests can be created for ETL execute mode and other E2E scenarios**.

## Context

**Priority:** P2 (Medium)  
**Effort:** 4 hours  
**Epic:** 7.1 - Pre-Epic 8 Bug Fixes & Improvements  
**Source:** Tech Debt discovered in Story 7.1-2 (TD-2, TD-5)

### Problem Statement

Story 7.1-2 attempted to create pytest integration tests for `--execute` mode validation but encountered multiple blockers:

1. **TD-2:** 缺少统一的 E2E 测试数据库初始化 fixture
2. **TD-5:** Task 5 (Regression Test Suite) 因依赖复杂度过高被 DEFERRED

### Current Gap

当前 `postgres_db_with_migrations` fixture 只运行 Alembic migrations，但不创建：
- Domain tables (`business.规模明细`, `business.收入明细`)
- Mapping tables (`mapping.年金计划`, `mapping.组合计划`)
- Required constraints for FK backfill

### Impact

- 无法创建真正的 E2E 集成测试
- ETL execute mode 只能通过手动验证
- 缺少回归测试保护

## Acceptance Criteria

### AC-1: Domain Table Creation Fixture
**GIVEN** a test database with migrations applied  
**WHEN** requesting domain tables for a specific domain  
**THEN** the domain tables should be created with correct schema

### AC-2: Mapping Table Creation Fixture
**GIVEN** a test database with domain tables  
**WHEN** FK backfill requires mapping tables  
**THEN** mapping tables should be pre-created with required constraints

### AC-3: Execute Mode Integration Test
**GIVEN** the new test fixtures  
**WHEN** running `--execute` mode test  
**THEN** data should be written and verifiable via SQL queries

### AC-4: Dry-Run Mode Isolation Test
**GIVEN** the new test fixtures  
**WHEN** running `--dry-run` mode test  
**THEN** no data should be written to database

## Tasks / Subtasks

- [ ] **Task 1: Fixture Design**
  - [ ] 1.1 Design `create_domain_tables(conn, domains)` helper
  - [ ] 1.2 Design `create_mapping_tables(conn)` helper
  - [ ] 1.3 Integrate with existing `postgres_db_with_migrations` fixture

- [ ] **Task 2: Fixture Implementation**
  - [ ] 2.1 Implement domain table creation using `generate_create_table_sql()`
  - [ ] 2.2 Implement mapping table creation with UNIQUE constraints
  - [ ] 2.3 Add cleanup logic to fixtures

- [ ] **Task 3: Integration Tests (Story 7.1-2 Task 5)**
  - [ ] 3.1 Create `tests/integration/test_cli_execute_validation.py`
  - [ ] 3.2 Implement execute mode test
  - [ ] 3.3 Implement dry-run mode test
  - [ ] 3.4 Implement multi-domain test

## Dev Notes

### Existing References

- [test_cli_multi_domain.py](file:///E:/Projects/WorkDataHub/tests/integration/test_cli_multi_domain.py) - CLI test patterns
- [Story 7.1-2 Testing Approach Decision](file:///E:/Projects/WorkDataHub/docs/sprint-artifacts/reviews/story-7.1-2-testing-approach-decision.md) - Section 8.1

### Helper Code Draft

```python
def _create_domain_tables(conn_str: str, domains: list[str]) -> None:
    """Create domain tables for testing."""
    conn = psycopg2.connect(conn_str)
    conn.autocommit = True
    
    with conn.cursor() as cur:
        cur.execute("CREATE SCHEMA IF NOT EXISTS business")
        cur.execute("CREATE SCHEMA IF NOT EXISTS mapping")
        
        for domain in domains:
            create_sql = generate_create_table_sql(domain)
            cur.execute(create_sql)
    conn.close()
```

### Dependencies

- Story 7.1-12: Fix annuity_plans schema (PREREQUISITE - need UNIQUE constraint)
