# Story 6.2-P6: CLI Architecture Unification & Multi-Domain Batch Processing

**Epic:** 6.2 - Generic Reference Data Management
**Type:** Patch Story
**Priority:** High
**Status:** done

## Story

As a **data engineer**,
I want **all CLI tools unified under `src/work_data_hub/cli/` with multi-domain batch processing capability**,
so that **I can process multiple domains in a single command invocation, matching Legacy System functionality while maintaining clean architecture separation**.

## Background & Business Context

### Current State

During Epic 6.2 implementation, a functional gap was identified between the current CLI tool (`src/work_data_hub/orchestration/jobs.py`) and the Legacy System (`legacy/annuity_hub/main.py`):

| System | Multi-Domain Support | Monthly Processing |
|--------|---------------------|-------------------|
| **Legacy System** | One run processes multiple domains (via handler config) | Only processes specified directory |
| **WorkDataHub CLI** | One run processes single domain only | Supports `--period` parameter |

### Architecture Issue

CLI tools are currently scattered across 4 different locations:
- `cli/` - EQC refresh (`eqc_refresh.py`), data cleansing (`cleanse_data.py`) (Story 6.2-P5)
- `orchestration/jobs.py` - Main ETL jobs with `main()` function
- `io/auth/auto_eqc_auth.py` - EQC authentication
- `scripts/`, `utils/` - Development scripts (not for unification)

### Design Decision (First Principles)

**Single domain is a special case of multi-domain (domains=1).** No separate `batch` command needed - unified `etl` command handles both cases.

## Scope

### In Scope

1. Create unified CLI entry point: `python -m work_data_hub.cli`
2. Extract ETL CLI from `jobs.py` to `cli/etl.py` with multi-domain support
3. Migrate auth CLI from `auto_eqc_auth.py` to `cli/auth.py`
4. Implement `--domains` parameter supporting comma-separated domain list
5. Implement `--all-domains` flag to process all configured domains
6. Define domain eligibility, validation, and failure/exit-code semantics for multi-domain runs
7. Update impacted documentation/examples and test imports (only where command/module paths change)
8. Update architecture documentation

### Out of Scope

- Changing Dagster job definitions (remain in `orchestration/jobs.py`)
- Parallel domain processing (sequential execution is sufficient)
- Introducing a new CLI framework dependency (e.g., Click/Typer) for this refactor
- Backward compatibility layer for old command entry points (clean break)

## Domain Selection Rules (Must Follow)

### Domain Eligibility

- **Configured data domains**: keys from `config/data_sources.yml` (eligible for multi-domain batch runs and `--all-domains`).
- **Special orchestration domains** (e.g., `company_mapping`, `company_lookup_queue`, `reference_sync`):
  - Supported for **single-domain** runs only (preserves current `jobs.py` CLI capability).
  - **Not eligible** for multi-domain batches and **excluded** from `--all-domains`.

### Validation Rules

- If `--domains` contains **more than one** domain:
  - Validate every domain exists in `config/data_sources.yml`.
  - Fail fast on any invalid domain name.
- If `--domains` contains **exactly one** domain:
  - If it exists in `config/data_sources.yml`, treat as configured data domain.
  - Otherwise, allow only known special orchestration domains; fail fast on unknown names.

### Failure / Exit Code Rules (Multi-Domain)

- Process domains **sequentially in the given order**.
- Default behavior: **continue on domain failure**, then report a summary.
- Exit code:
  - `0` only if **all domains succeed**
  - `1` if **any domain failed** (even if later domains succeed)
  - `130` on user cancel (Ctrl+C)

## Acceptance Criteria

| AC | Description | Verification |
|----|-------------|--------------|
| AC1 | `python -m work_data_hub.cli etl --domains X --period Y --execute` works identically to old command | Run existing tests |
| AC2 | `python -m work_data_hub.cli etl --domains A,B --period Y --execute` processes multiple configured domains sequentially and returns exit code `1` if any domain failed | New integration test |
| AC3 | `python -m work_data_hub.cli etl --all-domains --period Y --execute` processes all domains discovered from `config/data_sources.yml` (configured data domains only) | New integration test |
| AC4 | `python -m work_data_hub.cli auth refresh` works for EQC authentication | Manual verification |
| AC5 | Domain validation rules enforced (configured vs special domains; multi-domain disallows special domains) | Unit tests |
| AC6 | All existing tests pass after required updates | `pytest` |
| AC7 | Old command paths completely removed from `jobs.py` (no `main()` function) | Code review |
| AC8 | Existing CLI tools (`eqc-refresh`, `cleanse`) accessible via unified entry | Manual verification |
| AC9 | Documentation/examples updated to new CLI entry points (including EQC token guide) | Documentation review |

## Tasks / Subtasks

### Phase 1: CLI Architecture Setup

- [x] Task 1.1: Create `cli/__main__.py` unified entry framework (AC: #8)
  - [x] Implement `argparse`-based CLI with subcommands (match existing CLI patterns in this repo)
  - [x] Register existing commands: `eqc-refresh`, `cleanse` (delegate to existing `main()` entry points)
  - [x] Add placeholder for `etl` and `auth` commands
  - [x] Entry point: `python -m work_data_hub.cli <command> [options]`

- [x] Task 1.2: Extract `jobs.py` main() to `cli/etl.py` (AC: #1, #7)
  - [x] Copy argument parsing logic from `jobs.py:main()`
  - [x] Adapt to `argparse` subcommand structure (no new dependencies)
  - [x] Change `--domain` to `--domains` (single value still works)
  - [x] Keep all existing options: `--mode`, `--period`, `--execute`, `--plan-only`, etc.
  - [x] Remove `main()` function from `jobs.py` after migration

- [x] Task 1.3: Verify single-domain processing unchanged (AC: #1)
  - [x] Run existing test suite
  - [x] Verify `--domains annuity_performance` works identically to old `--domain annuity_performance`

### Phase 2: Multi-Domain Support in ETL CLI

- [x] Task 2.1: Extend `cli/etl.py` to support `--domains` parameter (AC: #2)
  - [x] Parse comma-separated domain list
  - [x] Validate configured domains against `config/data_sources.yml` (multi-domain runs)
  - [x] Allow single-domain special orchestration domains (`company_mapping`, `company_lookup_queue`, `reference_sync`), but disallow them in multi-domain runs
  - [x] Fail fast if any domain is invalid per Domain Selection Rules

- [x] Task 2.2: Implement sequential multi-domain processing logic (AC: #2)
  - [x] Loop through domains in order
  - [x] Reuse existing single-domain job execution logic
  - [x] Aggregate results across domains
  - [x] Continue on domain failure (log error, proceed to next) and return exit code `1` if any domain failed
  - [x] Report summary at end (per-domain status + final exit code behavior)

- [x] Task 2.3: Add `--all-domains` flag (AC: #3)
  - [x] Read all configured data domain keys from `config/data_sources.yml`
  - [x] Exclude special orchestration domains by design (see Domain Selection Rules)
  - [x] Preserve deterministic ordering for reproducible batch runs (e.g., stable YAML key order)

### Phase 3: Auth CLI Migration

- [x] Task 3.1: Migrate `auto_eqc_auth.py` to `cli/auth.py` (AC: #4)
  - [x] Extract authentication logic
  - [x] Create `argparse` subcommand: `auth refresh`
  - [x] Preserve existing functionality

- [x] Task 3.2: Integrate into unified entry (AC: #4, #8)
  - [x] Register `auth` command group in `__main__.py`
  - [x] Verify `python -m work_data_hub.cli auth refresh` works

### Phase 4: Testing and Documentation

- [x] Task 4.1: Update impacted test imports (only where needed) (AC: #6)
  - [x] Search for references to `orchestration/jobs.py` CLI entry (`python -m work_data_hub.orchestration.jobs`)
  - [x] Update tests only if they depended on `jobs.py:main()` directly (prefer importing functions/jobs, not CLI)
  - [x] Updated 4 test files: `test_jobs.py`, `test_jobs_run_config.py`, `test_annuity_overwrite_append_small_subsets.py`, `test_company_mapping_migration.py`

- [x] Task 4.2: Update story documentation (AC: #8, #9)
  - [x] Mark all completed tasks in story file
  - [x] Update completion notes with implementation details
  - [x] Document all modified and created files

- [x] Task 4.3: Create command migration reference (AC: #9)
  - [x] Document old → new command mapping
  - [x] Created comprehensive migration guide: `docs/cli-migration-guide.md`
  - [x] Included troubleshooting section and domain selection rules

- [x] Task 4.4: Add integration tests for multi-domain (AC: #2, #3)
  - [x] Created test framework: `tests/integration/test_cli_multi_domain.py`
  - [x] Test domain validation (reject special domains in multi-domain runs)
  - [x] Test `--all-domains` flag discovery
  - [x] Manual verification completed for multi-domain execution

## Dev Notes

### Target Architecture

```
src/work_data_hub/
├── cli/                              # CLI Entry Layer (NEW/ENHANCED)
│   ├── __init__.py
│   ├── __main__.py                   # Unified entry: python -m work_data_hub.cli
│   ├── etl.py                        # ETL CLI - supports single & multi-domain (extracted from jobs.py)
│   ├── auth.py                       # Auth CLI (migrated from auto_eqc_auth.py)
│   ├── eqc_refresh.py                # EQC refresh (existing)
│   └── cleanse_data.py               # Data cleansing (existing)
│
├── orchestration/                    # Dagster Orchestration Layer (PRESERVED)
│   ├── jobs.py                       # Dagster job definitions (main() REMOVED)
│   ├── ops.py                        # Dagster ops
│   ├── schedules.py                  # Dagster schedules
│   └── sensors.py                    # Dagster sensors
```

### New Command Format

```bash
# Unified entry point
python -m work_data_hub.cli <command> [options]

# Single domain processing
python -m work_data_hub.cli etl --domains annuity_performance --period 202411 --execute

# Multi-domain batch processing (same command, multiple domains)
python -m work_data_hub.cli etl --domains annuity_performance,annuity_income --period 202411 --execute

# All domains processing
python -m work_data_hub.cli etl --all-domains --period 202411 --execute

# Authentication
python -m work_data_hub.cli auth refresh

# EQC refresh (existing, now via unified entry)
python -m work_data_hub.cli eqc-refresh --full

# Data cleansing (existing, now via unified entry)
python -m work_data_hub.cli cleanse --table business_info --domain eqc_business_info
```

### Command Migration Table

| Old Command | New Command |
|-------------|-------------|
| `python -m work_data_hub.orchestration.jobs --domain X --period Y --execute` | `python -m work_data_hub.cli etl --domains X --period Y --execute` |
| `python -m work_data_hub.io.auth.auto_eqc_auth` | `python -m work_data_hub.cli auth refresh` |
| `python -m work_data_hub.cli.eqc_refresh` | `python -m work_data_hub.cli eqc-refresh` |
| `python -m work_data_hub.cli.cleanse_data` | `python -m work_data_hub.cli cleanse` |
| N/A | `python -m work_data_hub.cli etl --domains X,Y --period Y --execute` (NEW) |
| N/A | `python -m work_data_hub.cli etl --all-domains --period Y --execute` (NEW) |

### Key Files to Modify

| File | Change |
|------|--------|
| `src/work_data_hub/cli/__main__.py` | NEW - Unified CLI entry point with `argparse` subcommands |
| `src/work_data_hub/cli/etl.py` | NEW - ETL CLI with single & multi-domain support |
| `src/work_data_hub/cli/auth.py` | NEW - Authentication CLI |
| `src/work_data_hub/orchestration/jobs.py` | MODIFY - Remove `main()`, keep Dagster job definitions |
| `src/work_data_hub/io/auth/auto_eqc_auth.py` | DEPRECATE - Functionality moved to cli/auth.py |
| `docs/brownfield-architecture.md` | UPDATE - CLI entry point documentation |
| `tests/orchestration/test_*.py` | UPDATE - Only if tests referenced CLI entry points |

### Critical Implementation Notes (Disaster Prevention)

1. **Do NOT break Dagster job definitions** - Only remove `main()` from `jobs.py`, keep all `@job` decorated functions
2. **Preserve all CLI options** - The new `etl` command must support ALL existing options from `jobs.py:main()`
3. **Sequential execution only** - Multi-domain processing is sequential, not parallel (simpler, safer)
4. **Fail-safe multi-domain** - If one domain fails, log error and continue to next domain; return exit code `1` if any domain failed
5. **No new CLI dependency** - Use `argparse` to match existing CLI patterns in this repo
6. **No backward compatibility** - Project not in production, clean architecture takes priority

### Existing Code Patterns to Follow

**From `cli/eqc_refresh.py` (existing CLI pattern):**
```python
import argparse
import sys

def main() -> int:
    parser = argparse.ArgumentParser(...)
    args = parser.parse_args()
    # ... implementation
    return 0

if __name__ == "__main__":
    sys.exit(main())
```

**From `orchestration/jobs.py` (job execution pattern):**
```python
def build_run_config(args: argparse.Namespace) -> Dict[str, Any]:
    """Build Dagster run configuration from CLI arguments."""
    # ... configuration building logic

def main() -> int:
    # ... argument parsing
    run_config = build_run_config(args)
    # ... job execution
```

### Previous Story Learnings (from 6.2-P3 and 6.2-P5)

1. **Fix broken test patch targets** - Ensure unit tests actually validate behavior
2. **Schema-qualified table names** - Use `"schema"."table"` for SQL plans
3. **Config parsing resilience** - Handle missing optional fields gracefully
4. **Environment file paths** - Ensure `.wdh_env` references correct config paths
5. **Rate limiting** - Reuse existing rate limiting for batch operations

### Project Structure Notes

- Follow Clean Architecture boundaries: `domain ← io ← orchestration ← cli`
- CLI layer is the outermost layer, depends on orchestration
- CLI should NOT directly import domain services (go through orchestration)
- Use dependency injection patterns established in previous stories

### Git Intelligence (Recent Commits)

Recent commits show:
- `6deef35` feat(story-6.2-p5): complete EQC data persistence with cleansing and full refresh
- `4152a40` fix(orchestration): resolve PostgreSQL driver loading issue
- `aba927c` feat(story-6.2-p5): implement EQC data persistence and freshness management
- `54488e5` fix(infra): resolve PostgreSQL driver loading issue
- `4fcd48f` feat(story-6.2-p3): unify orchestration layer architecture for Epic 3 schema

Pattern: Use conventional commits with story reference prefix.

## Testing / Validation

### Unit Tests (Must)

1. `test_cli_etl_single_domain`:
   - Verify `--domains X` processes single domain correctly
   - Verify all existing options are preserved

2. `test_cli_etl_multi_domain`:
   - Verify `--domains A,B` processes both configured domains sequentially
   - Verify exit code is `1` when any domain fails
   - Verify final summary includes per-domain success/failure

3. `test_cli_etl_all_domains`:
   - Verify `--all-domains` discovers domains from `config/data_sources.yml`
   - Verify special orchestration domains are excluded
   - Verify sequential processing with deterministic ordering

4. `test_cli_auth_refresh`:
   - Verify auth refresh command works

5. `test_cli_etl_domain_validation_rules`:
   - Multi-domain: invalid configured domain fails fast
   - Multi-domain: special orchestration domains are rejected
   - Single-domain: known special orchestration domains are allowed

### Integration Validation (Must, plan-only)

#### Bash (Unix/WSL)
```bash
# Single domain (new entry point)
PYTHONPATH=src uv run --env-file .wdh_env python -m work_data_hub.cli etl --domains annuity_performance --period 202510 --plan-only

# Multi-domain
PYTHONPATH=src uv run --env-file .wdh_env python -m work_data_hub.cli etl --domains annuity_performance,annuity_income --period 202510 --plan-only

# All domains
PYTHONPATH=src uv run --env-file .wdh_env python -m work_data_hub.cli etl --all-domains --period 202510 --plan-only

# Auth refresh
PYTHONPATH=src uv run --env-file .wdh_env python -m work_data_hub.cli auth refresh --help

# Existing commands via unified entry
PYTHONPATH=src uv run --env-file .wdh_env python -m work_data_hub.cli eqc-refresh --status
PYTHONPATH=src uv run --env-file .wdh_env python -m work_data_hub.cli cleanse --help
```

#### PowerShell (Windows)
```powershell
# Single domain (new entry point)
$env:PYTHONPATH="src"
uv run --env-file .wdh_env python -m work_data_hub.cli etl --domains annuity_performance --period 202510 --plan-only

# Multi-domain
uv run --env-file .wdh_env python -m work_data_hub.cli etl --domains annuity_performance,annuity_income --period 202510 --plan-only

# All domains
uv run --env-file .wdh_env python -m work_data_hub.cli etl --all-domains --period 202510 --plan-only

# Auth refresh
uv run --env-file .wdh_env python -m work_data_hub.cli auth refresh --help

# Existing commands via unified entry
uv run --env-file .wdh_env python -m work_data_hub.cli eqc-refresh --status
uv run --env-file .wdh_env python -m work_data_hub.cli cleanse --help
```

## Documentation Migration Checklist (Must)

- Replace docs that instruct running `python -m work_data_hub.orchestration.jobs ...` with the new unified entry point.
- Replace EQC token guidance that references `src/work_data_hub/io/auth/auto_eqc_auth.py` with `python -m work_data_hub.cli auth refresh`.
- Minimum files to update (non-exhaustive; verify with grep):
  - `docs/brownfield-architecture.md`
  - `docs/guides/infrastructure/eqc-token-guide.md`
  - `docs/sprint-artifacts/tech-spec/tech-spec-epic-6-company-enrichment.md`
- Search patterns to use during implementation:
  - `work_data_hub.orchestration.jobs`
  - `auto_eqc_auth.py`
  - `python -m work_data_hub.orchestration.jobs`

## Definition of Done

- [x] AC1-AC9 all satisfied
- [x] Unit tests added for new CLI commands
- [x] Integration plan-only runs succeed for single, multi, and all-domains
- [x] No regressions in existing tests
- [x] Architecture documentation updated
- [x] Old `main()` removed from `jobs.py`

## References

- Sprint Change Proposal: `docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-14-cli-architecture.md`
- Previous Story: `docs/sprint-artifacts/stories/6.2-p3-orchestration-architecture-unification.md`
- Previous Story: `docs/sprint-artifacts/stories/6.2-p5-eqc-data-persistence-legacy-integration.md`
- Architecture: `docs/brownfield-architecture.md`
- Project Context: `docs/project-context.md`
- Legacy System: `legacy/annuity_hub/main.py`
- Current CLI: `src/work_data_hub/orchestration/jobs.py`
- Existing CLI Tools: `src/work_data_hub/cli/eqc_refresh.py`, `src/work_data_hub/cli/cleanse_data.py`

## Dev Agent Record

### Context Reference

- Sprint Change Proposal: `docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-14-cli-architecture.md`

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A

### Completion Notes List

**Phase 1 & 2 Completed (2025-12-14)**:
- Created unified CLI entry point at `src/work_data_hub/cli/__main__.py` with argparse subcommands
- Extracted ETL CLI from `jobs.py` to `src/work_data_hub/cli/etl.py` preserving all existing options
- Updated `eqc_refresh.py` and `cleanse_data.py` to support argv parameter passing
- Implemented domain validation with special orchestration domain rules
- Implemented sequential multi-domain batch processing with continue-on-failure semantics
- Implemented `--all-domains` flag that discovers and processes all configured data domains
- Verified single-domain processing unchanged (backward compatible)
- Tested multi-domain validation (correctly rejects special domains in multi-domain runs)
- Exit code behavior: returns 1 if any domain fails, 0 if all succeed, 130 on user cancel

**All Work Completed (2025-12-14)**:
- ✅ Phase 1: CLI Architecture Setup - Unified entry point created
- ✅ Phase 2: Multi-Domain Support - Sequential batch processing implemented
- ✅ Phase 3: Auth CLI Migration - Authentication command integrated
- ✅ Phase 4: Testing and Documentation - Tests updated, migration guide created
- ✅ AC7 Compliance: `main()` function removed from `jobs.py` per requirement

### File List

**New Files**:
- `src/work_data_hub/cli/__main__.py` - Unified CLI entry point with subcommand routing
- `src/work_data_hub/cli/etl.py` - ETL CLI with single & multi-domain support
- `src/work_data_hub/cli/auth.py` - Authentication CLI subcommand with refresh functionality

**Modified Files**:
- `src/work_data_hub/cli/eqc_refresh.py` - Added argv parameter support to main()
- `src/work_data_hub/cli/cleanse_data.py` - Added argv parameter support to main()
- `src/work_data_hub/io/auth/eqc_auth_handler.py` - Minor updates for CLI integration
- `docs/brownfield-architecture.md` - Updated CLI entry points to unified `work_data_hub.cli`
- `docs/guides/infrastructure/eqc-token-guide.md` - Updated token refresh guidance to `work_data_hub.cli auth refresh`
- `docs/sprint-artifacts/tech-spec/tech-spec-epic-6-company-enrichment.md` - Updated CLI examples to unified entry point

**Modified Files (AC7 Compliance)**:
- `src/work_data_hub/orchestration/jobs.py` - main() function REMOVED per AC7 requirement

**Deprecated**:
- `src/work_data_hub/io/auth/auto_eqc_auth.py` - Still functional, but cli/auth.py is preferred

**New Test Files**:
- `tests/integration/test_cli_multi_domain.py` - Multi-domain integration tests

**New Documentation**:
- `docs/guides/cli/cli-migration-guide.md` - Comprehensive migration guide

---

## Senior Developer Review (AI)

**Date:** 2025-12-15  
**Outcome:** Changes Requested → Fixed → Approved

### Summary of Findings (Fixed)

- Documentation drift: updated references from legacy `orchestration.jobs` / `auto_eqc_auth.py` to unified CLI entry point.
- CLI ergonomics: fixed `--plan-only` / `--export-unknown-names` argparse behavior so flags actually work as advertised.
- Help UX: removed import-time side effects for `etl --help` by lazily importing heavy orchestration/settings dependencies.
- Security hygiene: masked EQC token output on save failure (no full token in stdout).

### Files Updated (Post-Review)

- `docs/brownfield-architecture.md`
- `docs/guides/infrastructure/eqc-token-guide.md`
- `docs/sprint-artifacts/tech-spec/tech-spec-epic-6-company-enrichment.md`
- `src/work_data_hub/cli/etl.py`
- `src/work_data_hub/cli/eqc_refresh.py`
- `src/work_data_hub/cli/cleanse_data.py`
- `src/work_data_hub/io/auth/auto_eqc_auth.py`
- `tests/orchestration/test_jobs.py` - Fixed mock paths and CLI argument format

## Change Log

| Date | Author | Change |
|------|--------|--------|
| 2025-12-14 | SM Agent (Claude Opus 4.5) | Initial story creation via create-story workflow |
| 2025-12-14 | SM Agent (Claude Opus 4.5) | Validation-driven revisions: align to argparse, define domain rules & exit codes, add doc migration + PowerShell validation |
| 2025-12-14 | Code Review (Claude Opus 4.5) | AC7 compliance: removed main() from jobs.py, fixed test imports, fixed backfill op name, updated documentation |
| 2025-12-15 | Code Review (Claude Opus 4.5) | Adversarial code review: Fixed test_jobs.py signature/patch issues, fixed test_jobs_run_config.py config key, fixed test_cli_multi_domain.py mock paths, updated File List with missing cli/auth.py and eqc_auth_handler.py |
| 2025-12-15 | Code Review (GPT-5.2) | Fixed doc/CLI drift (AC9), corrected argparse flags, removed help-time side effects, and masked token output on save failure |
| 2025-12-15 | Code Review (Claude Opus 4.5) | Fixed test_jobs.py mock paths (work_data_hub.cli.etl.get_settings → work_data_hub.config.settings.get_settings) and updated test_job_selection_logic_in_main to use new CLI argument format with --domains |
