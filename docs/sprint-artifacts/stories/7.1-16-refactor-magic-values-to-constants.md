# Story 7.1-16: Refactor Magic Values to Constants

Status: backlog

## Story

As a **Software Engineer**,
I want **magic values in code replaced with named constants**,
so that **code is more maintainable and intent is clear**.

## Context

**Priority:** P1 (HIGH - Code Quality)
**Effort:** 1-2 hours
**Epic:** 7.1 - Pre-Epic 8 Bug Fixes & Improvements
**Source:** [Ruff Warning Triage Analysis](../reviews/ruff-warning-triage-7.1-10.md)

### Problem Statement

**66 PLR2004 violations** exist where magic values (hardcoded numbers/strings) are used in comparisons and operations.

**Sample Violations:**

```python
# ❌ WRONG: Magic value
# src/migrations/migrate_legacy_to_enrichment_index.py:165, 215
if len(report.sample_records) < 10:
    report.sample_records.append(...)

# ❌ WRONG: Magic value in domain logic
if confidence > 0.8:
    process_record(record)
```

### Why This Matters

**Code Maintainability:**
- Magic values obscure intent (why 10? why 0.8?)
- Hard to update consistently across codebase
- Difficult to understand without context

**Configuration-Driven Pattern:**
- Project favors YAML configuration over hardcoded values
- Aligns with Story 7.1-8 (EQC Confidence config pattern)

**Epic 8 Readiness:**
- Cleaner codebase easier to validate
- Constants can be moved to config files

## Acceptance Criteria

### AC-1: Identify and Categorize Magic Values

**GIVEN** 66 PLR2004 violations exist
**WHEN** violations are analyzed by category
**THEN** magic values are grouped by purpose

**Categories:**

| Category | Example | Count | Naming Pattern |
|----------|---------|-------|----------------|
| **Limits/Thresholds** | `if len(x) < 10` | ~20 | `MAX_...`, `MIN_...` |
| **Ratios/Confidence** | `if confidence > 0.8` | ~15 | `..._THRESHOLD`, `..._RATIO` |
| **Offsets/Indices** | `data[0]`, `range(10)` | ~10 | `..._INDEX`, `..._COUNT` |
| **Time Durations** | `sleep(30)` | ~5 | `..._SECONDS`, `..._TIMEOUT` |
| **Other** | Various | ~16 | Context-dependent |

**Deliverable:** Categorized list of magic value types

---

### AC-2: Replace Magic Values with Constants

**GIVEN** magic values are categorized
**WHEN** replaced with named constants
**THEN** code uses descriptive constant names

**Fix Pattern:**

```python
# ❌ WRONG: Magic value
if len(batch) > 10:
    process_batch(batch)

# ✅ CORRECT: Named constant
BATCH_SIZE_LIMIT = 10  # Max batch size for processing

if len(batch) > BATCH_SIZE_LIMIT:
    process_batch(batch)
```

**Constant Naming Conventions:**

| Purpose | Pattern | Example |
|---------|---------|---------|
| Maximum | `MAX_...` | `MAX_RETRY_COUNT`, `MAX_BATCH_SIZE` |
| Minimum | `MIN_...` | `MIN_CONFIDENCE_SCORE` |
| Threshold | `..._THRESHOLD` | `CONFIDENCE_THRESHOLD` |
| Default | `DEFAULT_...` | `DEFAULT_TIMEOUT` |
| Count | `..._COUNT` | `SAMPLE_RECORDS_LIMIT` |

**Deliverable:** All 66 magic values replaced with constants

---

### AC-3: Document Constants with Docstrings

**GIVEN** constants are defined
**WHEN** constants include descriptive docstrings
**THEN** future developers understand the rationale

**Documentation Pattern:**

```python
"""Domain constants for annuity performance processing."""

# Sample limit for migration debugging (Story 7.1-16)
SAMPLE_RECORDS_LIMIT = 10

# Minimum confidence score for caching EQC results (Story 7.1-8)
MIN_CONFIDENCE_FOR_CACHE = 0.60

# Maximum retry attempts for API calls (Epic 6)
MAX_API_RETRY_COUNT = 3
```

**Deliverable:** All constants have inline documentation

---

### AC-4: Run Ruff Verification

**GIVEN** magic values are refactored
**WHEN** `ruff check --select PLR2004` is run
**THEN** 0 PLR2004 violations remain

**Verification Command:**

```bash
# Check for remaining PLR2004 violations
PYTHONPATH=src uv run --env-file .wdh_env ruff check src/ --select PLR2004

# Expected: 0 violations
```

**Deliverable:** `ruff check --select PLR2004` passes

---

### AC-5: Verify No Regressions

**GIVEN** constants replace magic values
**WHEN** test suite is run
**THEN** all tests pass (no behavior changes)

**Verification:**

```bash
# Run full test suite
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/ -v

# Expected: All tests pass (constants preserve original values)
```

**Deliverable:** Test suite passes with no failures

---

## Tasks / Subtasks

- [ ] **Task 1: Analyze and Categorize Magic Values** (AC-1)
  - [ ] 1.1 Run `ruff check src/ --select PLR2004 --output-format=json > plr2004_analysis.json`
  - [ ] 1.2 Parse JSON and group magic values by file
  - [ ] 1.3 Categorize magic values by purpose (limits, ratios, etc.)
  - [ ] 1.4 Document naming pattern for each category

- [ ] **Task 2: Refactor Magic Values in Migrations** (AC-2)
  - [ ] 2.1 Fix `src/migrations/migrate_legacy_to_enrichment_index.py` (2 violations)
  - [ ] 2.2 Replace magic value `10` with `SAMPLE_RECORDS_LIMIT`
  - [ ] 2.3 Add constant with docstring at module level
  - [ ] 2.4 Verify migration logic still works

- [ ] **Task 3: Refactor Magic Values in Domain Layer** (AC-2)
  - [ ] 3.1 Scan domain service files for PLR2004 violations
  - [ ] 3.2 Replace magic values with domain constants
  - [ ] 3.3 Use `MAX_...`, `MIN_...`, `..._THRESHOLD` naming
  - [ ] 3.4 Document constants with story references

- [ ] **Task 4: Refactor Magic Values in Infrastructure** (AC-2)
  - [ ] 4.1 Scan infrastructure files for PLR2004 violations
  - [ ] 4.2 Replace magic values with infrastructure constants
  - [ ] 4.3 Add docstrings explaining rationale
  - [ ] 4.4 Move frequently-used constants to config if applicable

- [ ] **Task 5: Refactor Magic Values in IO Layer** (AC-2)
  - [ ] 5.1 Scan IO layer files for PLR2004 violations
  - [ ] 5.2 Replace magic values with constants
  - [ ] 5.3 Use descriptive names for connector-specific values
  - [ ] 5.4 Add inline documentation

- [ ] **Task 6: Verification** (AC-4, AC-5)
  - [ ] 6.1 Run `ruff check src/ --select PLR2004`
  - [ ] 6.2 Verify 0 violations remain
  - [ ] 6.3 Run full test suite
  - [ ] 6.4 Verify no behavior changes (all tests pass)

## Dev Notes

### Refactoring Strategy

**Phase 1: Analysis (15 minutes)**
- Parse PLR2004 JSON output
- Group violations by file and category
- Create constant naming plan

**Phase 2: Refactoring (45-60 minutes)**
- Start with migrations (simplest)
- Move to domain layer (highest impact)
- Finish with infrastructure/IO layers

**Phase 3: Verification (15 minutes)**
- Ruff check for PLR2004
- Run full test suite
- Spot-check critical paths

### Constant Placement Rules

**Module-Level Constants:**
- Place at top of file after imports
- Group by category (limits, thresholds, etc.)
- Add docstring section for each group

**Config File Candidates:**
- Constants used across multiple files → Move to `config/*.yml`
- Environment-specific values → Already in `.wdh_env`
- User-configurable thresholds → Already in feature configs

### Testing Standards

**After Refactoring:**
```bash
# Verify PLR2004 eliminated
PYTHONPATH=src uv run --env-file .wdh_env ruff check src/ --select PLR2004

# Run full test suite
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/ -v

# Verify no behavior changes
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/integration/ -v
```

### References

- [Ruff Warning Triage](../reviews/ruff-warning-triage-7.1-10.md) - Section P1 High: PLR2004
- [Story 7.1-8: EQC Confidence](./7.1-8-eqc-confidence-dynamic-adjustment.md) - Config pattern reference
- [Project Context](../project-context.md) - Section 4: Design Principles

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes List

**Story Created:** 2025-12-26
**Context Source:** Ruff Warning Triage Analysis (Story 7.1-10)

**Story Approach:**
- **Code Quality:** P1 - High priority for maintainability
- **Config-Driven:** Align with project's YAML config pattern
- **Incremental Refactor:** 66 violations across 3 phases (migrations, domain, infra/IO)

### File List

**Files to Analyze:**
- All files with PLR2004 violations (from `ruff check --select PLR2004`)

**Files to Modify (Estimated):**
- `src/migrations/migrate_legacy_to_enrichment_index.py` (2 violations)
- Multiple domain service files (~30 violations)
- Multiple infrastructure files (~20 violations)
- Multiple IO layer files (~14 violations)

**Analysis Artifacts:**
- `plr2004_analysis.json` (temporary, for categorization)

---

## Validation Record

**Validated:** 2025-12-26
**Validator:** Dev Agent (Story 7.1-10 Analysis)
**Validation Source:** Ruff Warning Triage - PLR2004 Analysis

**Criteria Met:**
- ✅ 66 PLR2004 violations > 30 threshold (story creation triggered)
- ✅ High priority (P1) identified
- ✅ Effort estimate: 1-2 hours
- ✅ Refactoring strategy documented
