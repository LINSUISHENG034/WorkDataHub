# Story 7.4-6: Plan/Portfolio Code Handling Consolidation

Status: done

## Story

As a **Developer**,
I want **plan code and portfolio code handling logic consolidated in the infrastructure layer**,
so that **both domains share the same implementation, reducing code duplication and maintenance risk**.

## Acceptance Criteria

1. **AC-1: Plan Code Constants Extracted**

   - `PLAN_CODE_CORRECTIONS` moved to `infrastructure/mappings/shared.py`
   - `PLAN_CODE_DEFAULTS` moved to `infrastructure/mappings/shared.py`
   - Both domain `constants.py` files import from infrastructure (no local definitions)
   - Domain `constants.py` re-exports for backward compatibility

2. **AC-2: Shared Transform Helpers Created**

   - New file: `infrastructure/transforms/plan_portfolio_helpers.py`
   - Contains `apply_plan_code_defaults()` function
   - Contains `apply_portfolio_code_defaults()` function
   - Contains `_clean_portfolio_code()` helper function
   - Functions exported via `infrastructure/transforms/__init__.py`

3. **AC-3: Domain Pipeline Builders Updated**

   - `annuity_performance/pipeline_builder.py`: Deleted local `_apply_plan_code_defaults()`, `_apply_portfolio_code_defaults()`, and `_clean_portfolio_code()`
   - `annuity_income/pipeline_builder.py`: Deleted local `_apply_plan_code_defaults()` and `_apply_portfolio_code_defaults()`
   - Both files import and use shared functions from infrastructure

4. **AC-4: Unit Tests Added**

   - New test file: `tests/unit/infrastructure/transforms/test_plan_portfolio_helpers.py`
   - Tests cover plan code defaults (empty → AN001/AN002)
   - Tests cover portfolio code defaults (F prefix removal, QTAN003 for 职年)
   - Tests cover `clean_portfolio_code()` helper (numeric preservation, prefix removal)
   - Behavioral parity tests verify output matches original domain-specific functions

5. **AC-5: No Regression**
   - All existing domain pipeline tests pass
   - Multi-domain integration test passes
   - ETL dry-run succeeds for both domains

## Tasks / Subtasks

- [x] **Task 1: Extract Plan Code Constants** (AC-1)

  - [x] 1.1 Add `PLAN_CODE_CORRECTIONS` to `infrastructure/mappings/shared.py`
  - [x] 1.2 Add `PLAN_CODE_DEFAULTS` to `infrastructure/mappings/shared.py`
  - [x] 1.3 Export constants in `infrastructure/mappings/__init__.py`
  - [x] 1.4 Update `annuity_performance/constants.py` to import from infrastructure
  - [x] 1.5 Update `annuity_income/constants.py` to import from infrastructure
  - [x] 1.6 Delete local constant definitions from both domains
  - [x] 1.7 Add re-exports in domain `constants.py` `__all__` for backward compatibility

- [x] **Task 2: Create Shared Transform Helpers** (AC-2)

  - [x] 2.1 Create `infrastructure/transforms/plan_portfolio_helpers.py`
  - [x] 2.2 Implement `apply_plan_code_defaults()` function
  - [x] 2.3 Implement `apply_portfolio_code_defaults()` function (use annuity_performance approach)
  - [x] 2.4 Extract `clean_portfolio_code()` helper from annuity_performance (robust type handling)
  - [x] 2.5 Export functions in `infrastructure/transforms/__init__.py`

- [x] **Task 3: Update Domain Pipeline Builders** (AC-3)

  - [x] 3.1 Update `annuity_performance/pipeline_builder.py` imports
  - [x] 3.2 Delete `_apply_plan_code_defaults()` from annuity_performance
  - [x] 3.3 Delete `_apply_portfolio_code_defaults()` from annuity_performance
  - [x] 3.4 Delete `_clean_portfolio_code()` from annuity_performance
  - [x] 3.5 Update `annuity_income/pipeline_builder.py` imports
  - [x] 3.6 Delete `_apply_plan_code_defaults()` from annuity_income
  - [x] 3.7 Delete `_apply_portfolio_code_defaults()` from annuity_income

- [x] **Task 4: Add Unit Tests** (AC-4)

  - [x] 4.1 Create `tests/unit/infrastructure/transforms/test_plan_portfolio_helpers.py`
  - [x] 4.2 Add parameterized tests for `apply_plan_code_defaults()` (empty/集合计划/单一计划)
  - [x] 4.3 Add parameterized tests for `apply_portfolio_code_defaults()` (F prefix, QTAN003, defaults)
  - [x] 4.4 Add tests for `clean_portfolio_code()` helper (None, numeric, string, F prefix)
  - [x] 4.5 Add behavioral parity test: verify shared function output matches original function output

- [x] **Task 5: Verification** (AC-5)
  - [x] 5.1 Run existing domain pipeline tests
  - [x] 5.2 Run multi-domain integration test
  - [x] 5.3 ETL dry-run for both domains

## Dev Notes

### Decision Points

| Decision                             | Choice                     | Rationale                                                                     |
| ------------------------------------ | -------------------------- | ----------------------------------------------------------------------------- |
| Which portfolio code implementation? | **annuity_performance**    | More robust type handling via `_clean_portfolio_code()` helper                |
| Extract `_clean_portfolio_code()`?   | **Yes**                    | Required by `apply_portfolio_code_defaults()`, prevents partial consolidation |
| Empty mask behavior?                 | `isna() \| (result == "")` | Matches annuity_performance; more defensive than AI's `isna()` only           |
| 职业年金 loop handling?              | **Skip in loop**           | AP skips `职业年金` since QTAN003 already handled; prevents double-processing |
| Backward compatibility exports?      | **Yes**                    | Re-export from domain `constants.py` to prevent import breakage               |

### Implementation Differences (Resolved)

The two domains implemented `_apply_portfolio_code_defaults()` differently:

| Aspect             | annuity_performance (CHOSEN)        | annuity_income               |
| ------------------ | ----------------------------------- | ---------------------------- |
| Value cleaning     | `_clean_portfolio_code()` helper    | Inline `str.replace()`       |
| Empty mask         | `isna() \| (result == "")`          | `isna()` only                |
| Data type handling | Preserves numeric (12345 → "12345") | Converts all to string dtype |
| 职业年金 handling  | Skips in loop (already QTAN003)     | Processes all plan_types     |

**Canonical implementation:** Use `annuity_performance` approach for robustness.

### Anti-Patterns to Avoid

- ❌ Don't copy constants to both domains (current problem being fixed)
- ❌ Don't skip `_clean_portfolio_code()` extraction (causes partial consolidation)
- ❌ Don't remove domain-level `__all__` exports without checking downstream imports
- ❌ Don't use inline string operations when helper exists (less robust for mixed types)
- ❌ Don't skip behavioral parity test (could cause silent regression)

### Problem Context

This story addresses code duplication discovered during Epic 7.4 validation:

| Component                          | Duplication Location                                          | Lines |
| ---------------------------------- | ------------------------------------------------------------- | ----- |
| `PLAN_CODE_CORRECTIONS`            | annuity_performance/constants.py, annuity_income/constants.py | 2×2   |
| `PLAN_CODE_DEFAULTS`               | annuity_performance/constants.py, annuity_income/constants.py | 2×2   |
| `_apply_plan_code_defaults()`      | Both pipeline_builder.py (identical logic)                    | ~36   |
| `_apply_portfolio_code_defaults()` | Both pipeline_builder.py (similar logic, different approach)  | ~72   |
| `_clean_portfolio_code()`          | annuity_performance/pipeline_builder.py only                  | ~38   |

**Total duplicated/consolidatable code**: ~150 lines

### Precedent: Story 5.5.4

This follows the same pattern as Story 5.5.4 which extracted `DEFAULT_PORTFOLIO_CODE_MAPPING` and `PORTFOLIO_QTAN003_BUSINESS_TYPES` to `infrastructure/mappings/shared.py`.

### Performance Note

The chosen `annuity_performance` approach uses `.apply()` with a helper function, which may be slightly slower than pandas vectorized `str.replace()`. However, the robustness for mixed data types (numeric portfolio codes like 12345) outweighs the minor performance difference for typical dataset sizes.

### References

- [Analysis Document](docs/specific/multi-domain/plan-portfolio-code-consistency-analysis.md)
- [Sprint Change Proposal](docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2026-01-02-plan-code-consistency.md)

### Command Reference

```bash
# Run new unit tests
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/unit/infrastructure/transforms/test_plan_portfolio_helpers.py -v

# Run domain pipeline tests (regression)
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/unit/domain/annuity_performance/test_pipeline_builder.py -v
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/unit/domain/annuity_income/test_pipeline.py -v

# Run multi-domain integration test
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/integration/test_multi_domain_pipeline.py -v

# ETL dry-run verification
PYTHONPATH=src uv run --env-file .wdh_env python -m work_data_hub.cli.etl \
  --domains annuity_performance annuity_income --period 202510 --dry-run
```

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

- **Code Review 2026-01-02**: All 5 ACs verified implemented. 87 tests pass (31 new + 56 domain).
- Fixed pre-existing test assertion: `集团企业客户号` is an update field that should be preserved, not dropped.
- Fixed sprint-status.yaml status mismatch (drafted → ready-for-dev).
- Updated AC-2 documentation: `_clean_portfolio_code()` (with underscore prefix).

### File List

**New Files:**

- `src/work_data_hub/infrastructure/transforms/plan_portfolio_helpers.py`
- `tests/unit/infrastructure/transforms/test_plan_portfolio_helpers.py`

**Modified Files:**

- `src/work_data_hub/infrastructure/mappings/shared.py`
- `src/work_data_hub/infrastructure/mappings/__init__.py`
- `src/work_data_hub/infrastructure/transforms/__init__.py`
- `src/work_data_hub/domain/annuity_performance/constants.py`
- `src/work_data_hub/domain/annuity_income/constants.py`
- `src/work_data_hub/domain/annuity_performance/pipeline_builder.py`
- `src/work_data_hub/domain/annuity_income/pipeline_builder.py`
- `tests/unit/domain/annuity_income/test_pipeline.py` (Code Review: imports updated)
- `tests/unit/domain/annuity_performance/test_pipeline_builder.py` (Code Review: test assertion fix)
- `docs/specific/multi-domain/multi-domain-check-list.md` (documentation update)

## Change Log

**2026-01-02** - Story drafted via Correct Course workflow
**2026-01-02** - Story validated and enhanced: added implementation decisions, helper function extraction, behavioral parity tests, anti-patterns guidance
**2026-01-02** - Code Review PASSED: 87 tests pass, pre-existing test assertion fixed
**2026-01-02** - Code Review #2: Fixed 3 issues (H1: task checkboxes, M1: unused import, L1: line length)
