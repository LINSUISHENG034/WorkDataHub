# Story 7.5-1: Backflow Plan Code Support

Status: ready-for-dev

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a **Data Engineer**,
I want **the backflow mechanism to support plan_code → company_id mappings**,
so that **subsequent ETL executions can hit the enrichment_index cache for plan_code lookups, reducing EQC API calls and improving resolution consistency**.

## Acceptance Criteria

1. **AC-1: plan_code Backflow Addition**

   - `backflow_fields` list in `backflow_new_mappings()` includes `(strategy.plan_code_column, "plan", 1, False)` as the first entry (P1 priority)
   - plan_code mappings are written to `enrichment_index` with `source='pipeline_backflow'` and `lookup_type='plan_code'`

2. **AC-2: Existing Behavior Preserved**

   - P2 (account_number), P4 (customer_name), P5 (account_name) backflow behavior unchanged
   - Temporary IDs (starting with "IN") are still skipped for all lookup types
   - Empty/null plan_code values are skipped (no exception raised)

3. **AC-3: Unit Tests**
   - New test `test_backflow_plan_code_mapping()` verifies P1 backflow
   - Test confirms plan_code → company_id written with correct `match_type="plan"`, `priority=1`
   - Test verifies temp ID skip behavior applies to plan_code records

## Tasks / Subtasks

- [ ] **Task 1: Modify backflow.py** (AC-1, AC-2)

  - [ ] 1.1 Add plan_code to `backflow_fields` at priority position P1
  - [ ] 1.2 Verify `strategy.plan_code_column` exists (types.py:76 confirms "计划代码")
  - [ ] 1.3 Confirm temp ID skip logic at line 67-68 still applies

- [ ] **Task 2: Create Unit Tests** (AC-3)

  - [ ] 2.1 Create test file `tests/infrastructure/enrichment/resolver/test_backflow.py` if not exists
  - [ ] 2.2 Implement `test_backflow_plan_code_mapping()`
  - [ ] 2.3 Implement `test_backflow_skips_temp_id_for_plan_code()`
  - [ ] 2.4 Ensure tests use mocked `CompanyMappingRepository`

- [ ] **Task 3: Integration Verification** (AC-1)
  - [ ] 3.1 Verify pipeline execution writes plan_code to enrichment_index
  - [ ] 3.2 Validate with SQL: `SELECT * FROM enterprise.enrichment_index WHERE lookup_type='plan_code' AND source='pipeline_backflow'`

## Dev Notes

### Problem Context (BF-001)

**Issue ID:** BF-001 - Backflow mechanism doesn't support plan_code mapping

**Impact Statistics (from 202510 ETL run):**

- 552 plan codes eligible for backflow (single-plan with empty customer name)
- 534 already in enrichment_index from legacy_migration (96.74%)
- **18 missing due to this defect** (including S6544, S6548, XNP707, etc.)

**Root Cause:** `backflow_new_mappings()` at lines 56-60 only includes P2, P4, P5 lookup types, missing P1 (plan_code).

### Exact Code Change

**File:** `src/work_data_hub/infrastructure/enrichment/resolver/backflow.py`
**Lines:** 56-60

```python
# BEFORE (lines 56-60):
backflow_fields = [
    (strategy.account_number_column, "account", 2, False),  # P2: RAW
    (strategy.customer_name_column, "name", 4, True),  # P4: NORMALIZED
    (strategy.account_name_column, "account_name", 5, False),  # P5: RAW
]

# AFTER (lines 56-61):
backflow_fields = [
    (strategy.plan_code_column, "plan", 1, False),  # P1: RAW (plan_code)
    (strategy.account_number_column, "account", 2, False),  # P2: RAW
    (strategy.customer_name_column, "name", 4, True),  # P4: NORMALIZED
    (strategy.account_name_column, "account_name", 5, False),  # P5: RAW
]
```

### Resolution Strategy Verification

**Confirmed:** `strategy.plan_code_column` is defined in `types.py:76`:

```python
plan_code_column: str = "计划代码"
```

Both `annuity_performance` and `annuity_income` pipelines pass this column in their `ResolutionStrategy`:

- `domain/annuity_performance/pipeline_builder.py:187`: `plan_code_column="计划代码"`
- `domain/annuity_income/pipeline_builder.py:155`: `plan_code_column="计划代码"`

### Test Pattern

Follow the pattern from `tests/infrastructure/enrichment/resolver/test_*.py`:

```python
def test_backflow_plan_code_mapping():
    """Verify plan_code mappings are written to enrichment_index."""
    # Setup: DataFrame with plan_code and resolved company_id
    df = pd.DataFrame({
        "计划代码": ["S6544"],
        "company_id": ["600093406"],
        # ... other columns
    })

    # Mock repository
    mock_repo = MagicMock(spec=CompanyMappingRepository)
    mock_repo.insert_batch_with_conflict_check.return_value = InsertResult(
        inserted_count=1, skipped_count=0, conflicts=[]
    )

    # Execute backflow
    result = backflow_new_mappings(df, [0], strategy, mock_repo)

    # Assert plan_code mapping was included
    call_args = mock_repo.insert_batch_with_conflict_check.call_args[0][0]
    plan_mapping = next(m for m in call_args if m["match_type"] == "plan")
    assert plan_mapping["alias_name"] == "S6544"
    assert plan_mapping["priority"] == 1
    assert plan_mapping["source"] == "pipeline_backflow"
```

### Project Structure Notes

- **Test Location:** `tests/infrastructure/enrichment/resolver/test_backflow.py`
- **Naming Convention:** `test_backflow_*.py` for backflow-specific tests
- **Mock Pattern:** Use `MagicMock(spec=CompanyMappingRepository)` for type safety

### References

- [Sprint Change Proposal](../sprint-change-proposal/sprint-change-proposal-2026-01-01-empty-customer-name-handling.md#story-751) - Story specification
- [Problem Analysis](../../specific/customer/plan-code-backflow-missing.md) - Detailed root cause analysis
- [Company Enrichment Architecture](../../project-context.md#7--company-enrichment-公司-id-解析) - 5-layer resolution architecture
- [types.py](file:///e:/Projects/WorkDataHub/src/work_data_hub/infrastructure/enrichment/types.py#L76) - `ResolutionStrategy.plan_code_column`

### Done When (Verification Criteria)

Before marking this story as complete, verify:

1. **Code Change Applied:**

   - [ ] `backflow.py` lines 56-60 updated to include plan_code as P1
   - [ ] No other changes to backflow logic

2. **Tests Pass:**

   - [ ] `pytest tests/infrastructure/enrichment/resolver/test_backflow.py -v` passes
   - [ ] All existing tests remain passing

3. **Integration Verified:**
   - [ ] ETL dry-run shows plan_code mappings in backflow output
   - [ ] OR: Developer confirms via code review that the change is correct

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

**Modified:**

- `src/work_data_hub/infrastructure/enrichment/resolver/backflow.py` - Add plan_code to backflow_fields

**New:**

- `tests/infrastructure/enrichment/resolver/test_backflow.py` - Unit tests for backflow plan_code support
