# Story 7.5-1: Backflow Plan Code Support

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a **Data Engineer**,
I want **the backflow mechanism to support plan_code → company_id mappings**,
so that **subsequent ETL executions can hit the enrichment_index cache for plan_code lookups, reducing EQC API calls and improving resolution consistency**.

## Acceptance Criteria

1. **AC-1: plan_code Backflow Addition**

   - `backflow_fields` list in `backflow_new_mappings()` includes `(strategy.plan_code_column, "plan", 1, False)` as the first entry (P1 priority)
   - plan_code mappings are written to `enrichment_index` with `source='pipeline_backflow'` and `lookup_type='plan_code'`

2. **AC-2: Existing Behavior Preserved**

   - P2 (account_number), P4 (customer_name), P5 (account_name) backflow behavior unchanged
   - Temporary IDs (starting with "IN") are still skipped for all lookup types
   - Empty/null plan_code values are skipped (no exception raised)

3. **AC-3: Unit Tests**
   - New test `test_backflow_plan_code_mapping()` verifies P1 backflow
   - Test confirms plan_code → company_id written with correct `match_type="plan"`, `priority=1`
   - Test verifies temp ID skip behavior applies to plan_code records

## Tasks / Subtasks

- [x] **Task 1: Modify backflow.py** (AC-1, AC-2)

  - [x] 1.1 Add plan_code to `backflow_fields` at priority position P1
  - [x] 1.2 Verify `strategy.plan_code_column` exists (types.py:76 confirms "计划代码")
  - [x] 1.3 Confirm temp ID skip logic at line 67-68 still applies

- [x] **Task 2: Create Unit Tests** (AC-3)

  - [x] 2.1 Create test file `tests/infrastructure/enrichment/resolver/test_backflow.py` if not exists
  - [x] 2.2 Implement `test_backflow_plan_code_mapping()`
  - [x] 2.3 Implement `test_backflow_skips_temp_id_for_plan_code()`
  - [x] 2.4 Ensure tests use mocked `CompanyMappingRepository`

- [x] **Task 3: Integration Verification** (AC-1)
  - [x] 3.1 Verify pipeline execution writes plan_code to enrichment_index
  - [x] 3.2 Validate with SQL: `SELECT * FROM enterprise.enrichment_index WHERE lookup_type='plan_code' AND source='pipeline_backflow'`

## Dev Notes

### Problem Context (BF-001)

**Issue ID:** BF-001 - Backflow mechanism doesn't support plan_code mapping

**Impact Statistics (from 202510 ETL run):**

- 552 plan codes eligible for backflow (single-plan with empty customer name)
- 534 already in enrichment_index from legacy_migration (96.74%)
- **18 missing due to this defect** (including S6544, S6548, XNP707, etc.)

**Root Cause:** `backflow_new_mappings()` at lines 56-60 only includes P2, P4, P5 lookup types, missing P1 (plan_code).

### Exact Code Change

**File:** `src/work_data_hub/infrastructure/enrichment/resolver/backflow.py`
**Lines:** 56-60

```python
# BEFORE (lines 56-60):
backflow_fields = [
    (strategy.account_number_column, "account", 2, False),  # P2: RAW
    (strategy.customer_name_column, "name", 4, True),  # P4: NORMALIZED
    (strategy.account_name_column, "account_name", 5, False),  # P5: RAW
]

# AFTER (lines 56-61):
backflow_fields = [
    (strategy.plan_code_column, "plan", 1, False),  # P1: RAW (plan_code)
    (strategy.account_number_column, "account", 2, False),  # P2: RAW
    (strategy.customer_name_column, "name", 4, True),  # P4: NORMALIZED
    (strategy.account_name_column, "account_name", 5, False),  # P5: RAW
]
```

### Resolution Strategy Verification

✅ `strategy.plan_code_column` = `"计划代码"` (types.py:76) - Used by both domain pipelines.

### Test Pattern

Follow the pattern from `tests/infrastructure/enrichment/resolver/test_*.py`:

```python
"""Tests for backflow plan_code support (Story 7.5-1)."""

import pandas as pd
import pytest
from unittest.mock import MagicMock

from work_data_hub.infrastructure.enrichment.resolver.backflow import backflow_new_mappings
from work_data_hub.infrastructure.enrichment.mapping_repository import (
    CompanyMappingRepository,
    InsertBatchResult,
)
from work_data_hub.infrastructure.enrichment.types import ResolutionStrategy


@pytest.fixture
def mock_repository():
    """Create mock CompanyMappingRepository."""
    mock = MagicMock(spec=CompanyMappingRepository)
    mock.insert_batch_with_conflict_check.return_value = InsertBatchResult(
        inserted_count=1, skipped_count=0, conflicts=[]
    )
    return mock


@pytest.fixture
def default_strategy():
    """Create default ResolutionStrategy."""
    return ResolutionStrategy()


def test_backflow_plan_code_mapping(mock_repository, default_strategy):
    """Verify plan_code mappings are written to enrichment_index."""
    df = pd.DataFrame({
        "计划代码": ["S6544"],
        "年金账户号": ["ACC001"],
        "客户名称": ["中关村发展集团"],
        "年金账户名": ["中关村年金账户"],
        "company_id": ["600093406"],
    })

    result = backflow_new_mappings(df, [0], default_strategy, mock_repository)

    # Assert insert was called
    mock_repository.insert_batch_with_conflict_check.assert_called_once()
    call_args = mock_repository.insert_batch_with_conflict_check.call_args[0][0]

    # Find plan_code mapping (P1)
    plan_mapping = next(m for m in call_args if m["match_type"] == "plan")
    assert plan_mapping["alias_name"] == "S6544"
    assert plan_mapping["priority"] == 1
    assert plan_mapping["source"] == "pipeline_backflow"
    assert plan_mapping["canonical_id"] == "600093406"


def test_backflow_skips_temp_id_for_plan_code(mock_repository, default_strategy):
    """Verify temp IDs (starting with IN) are skipped for plan_code."""
    df = pd.DataFrame({
        "计划代码": ["S6544"],
        "年金账户号": ["ACC001"],
        "客户名称": [""],
        "年金账户名": [""],
        "company_id": ["IN7KZNPWPCVQXJ6AY7"],  # Temp ID
    })

    result = backflow_new_mappings(df, [0], default_strategy, mock_repository)

    # Assert insert was NOT called (temp ID skipped)
    mock_repository.insert_batch_with_conflict_check.assert_not_called()
    assert result == {"inserted": 0, "skipped": 0, "conflicts": 0}


def test_backflow_skips_empty_plan_code(mock_repository, default_strategy):
    """Verify empty/null plan_code values are skipped without exception."""
    df = pd.DataFrame({
        "计划代码": ["", None, "  "],
        "年金账户号": ["ACC001", "ACC002", "ACC003"],
        "客户名称": ["公司A", "公司B", "公司C"],
        "年金账户名": ["账户A", "账户B", "账户C"],
        "company_id": ["600001", "600002", "600003"],
    })

    # Should not raise exception
    result = backflow_new_mappings(df, [0, 1, 2], default_strategy, mock_repository)

    # Other fields (account, name, account_name) should still be backflowed
    mock_repository.insert_batch_with_conflict_check.assert_called_once()
    call_args = mock_repository.insert_batch_with_conflict_check.call_args[0][0]

    # No plan_code mappings should exist
    plan_mappings = [m for m in call_args if m["match_type"] == "plan"]
    assert len(plan_mappings) == 0
```

### Project Structure Notes

- **Test Location:** `tests/infrastructure/enrichment/resolver/test_backflow.py` _(NEW FILE - create this)_
- **Naming Convention:** `test_backflow_*.py` for backflow-specific tests
- **Mock Pattern:** Use `MagicMock(spec=CompanyMappingRepository)` for type safety

### References

- [Sprint Change Proposal](../sprint-change-proposal/sprint-change-proposal-2026-01-01-empty-customer-name-handling.md#story-751) - Story specification
- [Problem Analysis](../../specific/customer/plan-code-backflow-missing.md) - Detailed root cause analysis
- [Company Enrichment Architecture](../../project-context.md#7--company-enrichment-公司-id-解析) - 5-layer resolution architecture
- [types.py](file:///e:/Projects/WorkDataHub/src/work_data_hub/infrastructure/enrichment/types.py#L76) - `ResolutionStrategy.plan_code_column`

### Done When (Verification Criteria)

Before marking this story as complete, verify:

1. **Code Change Applied:**

   - [ ] `backflow.py` lines 56-60 updated to include plan_code as P1
   - [ ] No other changes to backflow logic

2. **Tests Pass:**

   - [ ] `pytest tests/infrastructure/enrichment/resolver/test_backflow.py -v` passes
   - [ ] All existing tests remain passing

3. **Integration Verified:**
   - [ ] ETL dry-run shows plan_code mappings in backflow output
   - [ ] OR: Developer confirms via code review that the change is correct

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (model ID: 'claude-opus-4-5-20251101')

### Debug Log References

No issues encountered during implementation.

### Completion Notes List

**Implementation Summary:**

1. **RED Phase:** Created failing tests first to validate plan_code backflow behavior

   - test_backflow_plan_code_mapping: Verified P1 priority and match_type="plan"
   - test_backflow_skips_temp_id_for_plan_code: Confirmed temp ID filtering
   - test_backflow_skips_empty_plan_code: Validated empty/null handling

2. **GREEN Phase:** Implemented minimal code change to backflow.py

   - Added plan_code to backflow_fields at P1 priority (lines 56-62)
   - Used strategy.plan_code_column ("计划代码") from types.py:76
   - Preserved existing temp ID skip logic (lines 67-68)

3. **REFACTOR Phase:** Code quality verified
   - All 3 new tests pass (test_backflow.py)
   - All 8 existing backflow tests pass (test_company_id_resolver.py)
   - All 216 enrichment unit tests pass (no regressions)
   - Updated integration test to reflect new behavior (4 backflow entries vs 3)

**Acceptance Criteria Verification:**

- ✅ AC-1: plan_code mappings written with priority=1, match_type="plan", source="pipeline_backflow"
- ✅ AC-2: P2, P4, P5 behavior unchanged; temp IDs skipped; empty plan_codes skipped
- ✅ AC-3: All 3 unit tests implemented and passing

**Test Results:**

- New tests: 3/3 passing (test_backflow.py)
- Existing backflow tests: 8/8 passing
- Full enrichment suite: 216/216 passing

### File List

**Modified:**

- `src/work_data_hub/infrastructure/enrichment/resolver/backflow.py` - Added plan_code to backflow_fields at P1 priority
- `tests/unit/infrastructure/enrichment/test_company_id_resolver_eqc_integration.py` - Updated test assertion for 4 backflow entries (was 3)

**New:**

- `tests/infrastructure/enrichment/resolver/test_backflow.py` - Unit tests for backflow plan_code support (3 test cases)

### Change Log

**2026-01-01 - Story 7.5-1 Implementation Complete**

- Added plan_code to backflow_fields at P1 priority (backflow.py:56-62)
- Created comprehensive unit tests (test_backflow.py) - 3/3 tests passing
- Updated integration test for new backflow behavior (4 entries vs 3)
- All acceptance criteria verified (AC-1, AC-2, AC-3)
- All 216 enrichment unit tests passing (no regressions)

**2026-01-01 - Code Review Fixes Applied**

- M002: Added `spec=CompanyMappingRepository` to MagicMock for type safety
- L001: Updated docstring in `backflow.py` to document Story 7.5-1 changes
- M003: This story template fixed to use `InsertBatchResult` (documentation only)

**Impact:**

- Fixes BF-001: 18 missing plan_code mappings from 202510 ETL run will now backflow correctly
- Enables subsequent ETL executions to hit enrichment_index cache for plan_code lookups
- Reduces EQC API calls and improves resolution consistency
