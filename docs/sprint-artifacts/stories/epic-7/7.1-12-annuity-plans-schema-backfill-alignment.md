# Story 7.1-12: Fix Annuity Plans Schema Definition Alignment

Status: done

## Quick Start (TL;DR)

1. âœ… **å·²éªŒè¯:** ç”Ÿäº§æ•°æ®åº“ `å¹´é‡‘è®¡åˆ’å·` å·²æ˜¯ PRIMARY KEYï¼ˆè‡ªå¸¦å”¯ä¸€æ€§ï¼‰
2. ğŸ”§ **ä¿®å¤:** `annuity_plans.py` Line 39: `IndexDef(["å¹´é‡‘è®¡åˆ’å·"], unique=True)`
3. â­ï¸ **è·³è¿‡:** æ— éœ€ Alembic è¿ç§»ï¼ˆç”Ÿäº§å·²æ­£ç¡®ï¼‰
4. âœ… **éªŒè¯:** DDL ç”Ÿæˆå™¨è¾“å‡º `CREATE UNIQUE INDEX`

## Story

As a **Data Engineer**,
I want to **align the schema definition file with production database structure for annuity_plans**,
so that **new test/dev environments have consistent schema and FK backfill ON CONFLICT works correctly**.

## Context

**Priority:** P1 (High)
**Effort:** 30 minutes (reduced from 2h - no migration needed)
**Epic:** 7.1 - Pre-Epic 8 Bug Fixes & Improvements
**Source:** Tech Debt discovered in Story 7.1-2 (TD-1, TD-3)
**Downstream Dependency:** Story 7.1-13 (E2E Test Infrastructure) depends on this fix

### Problem Statement

Schema å®šä¹‰æ–‡ä»¶ä¸ç”Ÿäº§æ•°æ®åº“ä¸ä¸€è‡´ï¼š

| å¯¹æ¯”é¡¹ | Schema å®šä¹‰ (ä»£ç ) | ç”Ÿäº§æ•°æ®åº“ |
|--------|-------------------|------------|
| `å¹´é‡‘è®¡åˆ’å·` çº¦æŸ | `IndexDef(["å¹´é‡‘è®¡åˆ’å·"])` æ™®é€šç´¢å¼• | **PRIMARY KEY** (å·²å”¯ä¸€) |

å½“ä½¿ç”¨ `generate_create_table_sql()` åˆ›å»ºæ–°çš„æµ‹è¯•/å¼€å‘ç¯å¢ƒæ—¶ï¼Œç”Ÿæˆçš„ DDL ç¼ºå°‘ UNIQUE çº¦æŸï¼Œå¯¼è‡´ ON CONFLICT æ“ä½œå¤±è´¥ã€‚

### Root Cause Analysis

```python
# src/work_data_hub/infrastructure/schema/definitions/annuity_plans.py (Line 39)
indexes=[
    IndexDef(["å¹´é‡‘è®¡åˆ’å·"]),  # â† Schemaå®šä¹‰: æ™®é€šç´¢å¼•
]
```

**ç”Ÿäº§æ•°æ®åº“éªŒè¯ç»“æœ (2025-12-26):**
```sql
-- æŸ¥è¯¢ç»“æœ: å¹´é‡‘è®¡åˆ’å· å·²æ˜¯ PRIMARY KEY
SELECT constraint_name, constraint_type
FROM information_schema.table_constraints
WHERE table_schema = 'mapping' AND table_name = 'å¹´é‡‘è®¡åˆ’';
-- ç»“æœ: å¹´é‡‘è®¡åˆ’_pkey | PRIMARY KEY

-- æ— é‡å¤æ•°æ®
SELECT "å¹´é‡‘è®¡åˆ’å·", COUNT(*) FROM mapping."å¹´é‡‘è®¡åˆ’"
GROUP BY "å¹´é‡‘è®¡åˆ’å·" HAVING COUNT(*) > 1;
-- ç»“æœ: [] (ç©º)
```

### Solution

ä¿®æ”¹ Schema å®šä¹‰ä»¥åŒ¹é…ç”Ÿäº§ï¼š

```diff
# annuity_plans.py Line 39
-IndexDef(["å¹´é‡‘è®¡åˆ’å·"]),
+IndexDef(["å¹´é‡‘è®¡åˆ’å·"], unique=True),
```

**æ³¨æ„:** æ— éœ€ Alembic è¿ç§»ï¼Œç”Ÿäº§æ•°æ®åº“å·²æ­£ç¡®ã€‚æ­¤ä¿®æ”¹ä»…å½±å“ DDL ç”Ÿæˆå™¨è¾“å‡ºã€‚

### Impact

- æ–°ç¯å¢ƒä½¿ç”¨ `generate_create_table_sql()` æ—¶ä¼šç”Ÿæˆæ­£ç¡®çš„ UNIQUE INDEX
- è§£é™¤ Story 7.1-13 (E2E Test Infrastructure) çš„é˜»å¡

## Acceptance Criteria

### AC-1: Schema Definition Fix
**GIVEN** the `annuity_plans` domain schema definition
**WHEN** the `å¹´é‡‘è®¡åˆ’å·` index is defined
**THEN** it should have `unique=True` via `IndexDef(["å¹´é‡‘è®¡åˆ’å·"], unique=True)`

### AC-2: DDL Generation Verification
**GIVEN** the updated schema definition
**WHEN** `generate_create_table_sql("annuity_plans")` is called
**THEN** the output contains `CREATE UNIQUE INDEX` for `å¹´é‡‘è®¡åˆ’å·`

### AC-3: FK Backfill Config Compatibility
**GIVEN** the FK backfill configuration in `config/foreign_keys.yml`
**WHEN** `annuity_plans` is used as a reference table
**THEN** the ON CONFLICT key (`å¹´é‡‘è®¡åˆ’å·`) matches the UNIQUE constraint in schema definition

## Tasks / Subtasks

- [x] **Task 1: Schema Definition Fix**
  - [x] 1.1 Update `src/work_data_hub/infrastructure/schema/definitions/annuity_plans.py`:
    ```python
    # Change Line 39 from:
    IndexDef(["å¹´é‡‘è®¡åˆ’å·"]),
    # To:
    IndexDef(["å¹´é‡‘è®¡åˆ’å·"], unique=True),
    ```

- [x] **Task 2: Verify DDL Output**
  - [x] 2.1 Run verification:
    ```python
    from work_data_hub.infrastructure.schema.ddl_generator import generate_create_table_sql
    ddl = generate_create_table_sql("annuity_plans")
    assert "CREATE UNIQUE INDEX" in ddl and "å¹´é‡‘è®¡åˆ’å·" in ddl
    print(ddl)
    ```
  - [x] 2.2 Confirm output includes `CREATE UNIQUE INDEX IF NOT EXISTS "idx_å¹´é‡‘è®¡åˆ’_å¹´é‡‘è®¡åˆ’å·"`

- [x] **Task 3: Update Sprint Status**
  - [x] 3.1 Update `sprint-status.yaml` to mark 7.1-12 as done
  - [x] 3.2 Unblock Story 7.1-13 (E2E Test Infrastructure)

## Dev Notes

### Key Architecture References

| File | Purpose | Relevant Lines |
|------|---------|----------------|
| `infrastructure/schema/core.py` | `IndexDef` type with `unique: bool` | Lines 40-48 |
| `infrastructure/schema/definitions/annuity_plans.py` | Domain schema to modify | Line 39 |
| `infrastructure/schema/ddl_generator.py` | DDL generation with UNIQUE INDEX | Lines 71-83 |
| `config/foreign_keys.yml` | FK backfill config (target_key) | Lines 39-84 |

### Production vs Schema Definition

**é‡è¦:** ç”Ÿäº§æ•°æ®åº“ä¸ Schema å®šä¹‰æœ‰ç»“æ„å·®å¼‚ï¼ˆå†å²é—ç•™ï¼‰ï¼š

| å¯¹æ¯”é¡¹ | Schema å®šä¹‰ | ç”Ÿäº§æ•°æ®åº“ |
|--------|-------------|------------|
| ä¸»é”®å­—æ®µ | `annuity_plans_id` | `å¹´é‡‘è®¡åˆ’å·` (PRIMARY KEY) |
| è‡ªå¢ID | `annuity_plans_id` | `id` |

æœ¬ Story ä»…ä¿®æ”¹ `unique=True`ï¼Œä¸æ¶‰åŠä¸»é”®/è‡ªå¢å­—æ®µè°ƒæ•´ã€‚ç»“æ„å·®å¼‚ä½œä¸ºæŠ€æœ¯å€ºåŠ¡è®°å½•ï¼Œåç»­ç»Ÿä¸€å¤„ç†ã€‚

### Related Stories

- Story 7.1-2 Testing Approach Decision - Section 2.3 (source of TD-1/TD-3)
- Story 7.1-13 (E2E Test Infrastructure) - Downstream dependency

## Dev Agent Record

### Implementation Plan

**Approach:**
1. Single-line fix to add `unique=True` parameter to `IndexDef(["å¹´é‡‘è®¡åˆ’å·"])`
2. DDL generator already supports UNIQUE INDEX (line 77 in ddl_generator.py)
3. No Alembic migration needed - production database already has PRIMARY KEY on `å¹´é‡‘è®¡åˆ’å·`

**Technical Decisions:**
- Minimal change: Only modified the `unique=True` flag, no structural changes
- Preserved existing composite index on `["å¹´é‡‘è®¡åˆ’å·", "company_id"]`
- DDL generator output now matches production database structure

### Completion Notes

**Date:** 2025-12-26

**Story Status:** âœ… COMPLETED

**All Acceptance Criteria Verified:**
- âœ… AC-1: Schema definition updated with `unique=True`
- âœ… AC-2: DDL generation outputs `CREATE UNIQUE INDEX IF NOT EXISTS "idx_å¹´é‡‘è®¡åˆ’_å¹´é‡‘è®¡åˆ’å·"`
- âœ… AC-3: FK backfill config target_key (`å¹´é‡‘è®¡åˆ’å·`) matches UNIQUE constraint

**Files Modified:**
- `src/work_data_hub/infrastructure/schema/definitions/annuity_plans.py` (Line 39)
- `docs/sprint-artifacts/sprint-status.yaml` (Story 7.1-12 marked as done)
- `docs/sprint-artifacts/stories/7.1-12-annuity-plans-schema-backfill-alignment.md` (Status updated)

**Impact:**
- New test/dev environments will have correct UNIQUE constraint when using DDL generator
- Story 7.1-13 (E2E Test Infrastructure) now unblocked
- No production migration needed (PRIMARY KEY already exists)

**Verification:**
```bash
# Verification command executed
PYTHONPATH=src uv run --env-file .wdh_env python -c "
from work_data_hub.infrastructure.schema.ddl_generator import generate_create_table_sql
ddl = generate_create_table_sql('annuity_plans')
assert 'CREATE UNIQUE INDEX' in ddl and 'å¹´é‡‘è®¡åˆ’å·' in ddl
print('âœ… AC-2 PASSED')
"
```

**Next Steps:**
- Story 7.1-13 (E2E Test Infrastructure) can now proceed
- Consider addressing structural differences (primary key field) as separate tech debt

## File List

### Modified
- `src/work_data_hub/infrastructure/schema/definitions/annuity_plans.py`
- `docs/sprint-artifacts/sprint-status.yaml`
- `docs/sprint-artifacts/stories/7.1-12-annuity-plans-schema-backfill-alignment.md`

## Change Log

### 2025-12-26
- **Story Completed:** Schema definition fix for annuity_plans UNIQUE constraint
- **Change:** Added `unique=True` to `IndexDef(["å¹´é‡‘è®¡åˆ’å·"])`
- **Verification:** DDL generator now outputs `CREATE UNIQUE INDEX IF NOT EXISTS "idx_å¹´é‡‘è®¡åˆ’_å¹´é‡‘è®¡åˆ’å·"`
- **Impact:** New environments will have correct schema; Story 7.1-13 unblocked

