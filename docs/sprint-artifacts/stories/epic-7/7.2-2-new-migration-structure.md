# Story 7.2.2: New Migration Structure

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a **Senior Python Architect**,
I want **to create three new Alembic migration files with a clean linear chain**,
so that **we establish a reliable migration baseline for Epic 8 (Testing & Validation Infrastructure)**.

## Acceptance Criteria

1. ✅ Create `001_initial_infrastructure.py` with **17 infrastructure tables** (including 年金客户, 产品明细, 利润指标)
2. ✅ Create `002_initial_domains.py` with **4 registered domain tables** (using `ddl_generator`)
3. ✅ Create `003_seed_static_data.py` with ~1,350 rows of static reference data
4. ✅ Use idempotent migration pattern (`IF NOT EXISTS`) for all tables
5. ✅ Verify `alembic history` shows linear chain (no branches)
6. ✅ Verify `alembic upgrade head` succeeds on clean database
7. ✅ Domain tables use `ddl_generator.generate_create_table_sql()` for consistency
8. ✅ Seed data loaded from CSV files (large datasets) or embedded (small datasets)
9. ✅ Create `config/seeds/` directory with CSV files for large datasets

## Tasks / Subtasks

- [x] **Task 0: Prerequisites (Story 7.2-3 Completed)**
  - [x] Subtask 0.1: Verify Story 7.2-3 is complete (Domain Registry `id` unification)
  - [x] Subtask 0.2: Create `config/seeds/` directory
  - [x] Subtask 0.3: Export `company_types_classification` data to CSV (104 rows)
  - [x] Subtask 0.4: Export `industrial_classification` data to CSV (1,183 rows)

- [x] Task 1: Create `001_initial_infrastructure.py` (AC: #1) - **17 tables**
  - [x] Subtask 1.1: Create migration file with revision `20251228_000001`
  - [x] Subtask 1.2: Define public schema tables (pipeline_executions, data_quality_metrics)
  - [x] Subtask 1.3: Define enterprise schema tables (base_info, business_info, biz_label, enrichment_requests, enrichment_index, validation_results)
  - [x] Subtask 1.4: Define enterprise classification tables (company_types_classification, industrial_classification) - structure only
  - [x] Subtask 1.5: Define mapping schema seed tables (产品线, 组织架构, 计划层规模)
  - [x] Subtask 1.6: Define mapping reference tables (年金客户, 产品明细, 利润指标) - **手动 DDL，未注册域**
  - [x] Subtask 1.7: Define system schema table (sync_state)
  - [x] Subtask 1.8: Add idempotent table existence checks (`IF NOT EXISTS`)

- [x] Task 2: Create `002_initial_domains.py` (AC: #2, #7) - **4 registered domains only**
  - [x] Subtask 2.1: Create migration file with revision `20251228_000002`, down_revision to `20251228_000001`
  - [x] Subtask 2.2: Use `ddl_generator.generate_create_table_sql("annuity_performance")` for business.规模明细
  - [x] Subtask 2.3: Use `ddl_generator.generate_create_table_sql("annuity_income")` for business.收入明细
  - [x] Subtask 2.4: Use `ddl_generator.generate_create_table_sql("annuity_plans")` for mapping.年金计划
  - [x] Subtask 2.5: Use `ddl_generator.generate_create_table_sql("portfolio_plans")` for mapping.组合计划
  - [x] Subtask 2.6: Add idempotent table existence checks

- [x] Task 3: Create `003_seed_static_data.py` (AC: #3, #8)
  - [x] Subtask 3.1: Create migration file with revision `20251228_000003`, down_revision to `20251228_000002`
  - [x] Subtask 3.2: Load company_types_classification from CSV (104 rows)
  - [x] Subtask 3.3: Load industrial_classification from CSV (1,183 rows)
  - [x] Subtask 3.4: Embed seed data for 产品线 (14 rows)
  - [x] Subtask 3.5: Embed seed data for 组织架构 (38 rows)
  - [x] Subtask 3.6: Embed seed data for 计划层规模 (7 rows)
  - [x] Subtask 3.7: Load 产品明细 from CSV (18 rows)
  - [x] Subtask 3.8: Embed seed data for 利润指标 (12 rows)
  - [x] Subtask 3.9: Use `INSERT ... ON CONFLICT DO NOTHING` for idempotency

- [x] Task 4: Verification and validation (AC: #4, #5, #6)
  - [x] Subtask 4.1: Run `alembic history` - verify linear chain with 3 migrations
  - [x] Subtask 4.2: Run `alembic upgrade head` on clean test database
  - [x] Subtask 4.3: Verify all 21 tables created (17 infrastructure + 4 domains)
  - [x] Subtask 4.4: Verify seed data populated (~1,350 rows total)
  - [x] Subtask 4.5: Verify no migration heads (single linear chain)

- [x] Task 5: Cross-validation with Domain Registry (AC: #7)
  - [x] Subtask 5.1: Compare `ddl_generator` output with migration table definitions
  - [x] Subtask 5.2: Verify annuity_performance table: columns, indexes, primary_key=`id`
  - [x] Subtask 5.3: Verify annuity_income table: columns, indexes, primary_key=`id`
  - [x] Subtask 5.4: Verify annuity_plans table: columns, indexes, primary_key=`id`
  - [x] Subtask 5.5: Verify portfolio_plans table: columns, indexes, primary_key=`id`

## Dev Notes

### Context from Sprint Change Proposal

**Epic 7.2: Alembic Migration Refactoring** - Full reset approach to establish clean linear migration chain.

**Phase 2 Goal**: Create 3 new migration files that establish a clean baseline:
1. `001_initial_infrastructure.py` - Infrastructure + reference tables (**17 tables**, 手动 DDL)
2. `002_initial_domains.py` - Registered domain tables (**4 tables**, using `ddl_generator`)
3. `003_seed_static_data.py` - Seed data (~1,350 rows)

**Critical Design Principle**: **Single Source of Truth** - Domain Schema definitions drive both ETL validation and migration DDL generation.

### Migration File Structure

```
io/schema/migrations/versions/
├── _archived/                    # Story 7.2-1 completed
│   └── [10 archived migrations]
├── 001_initial_infrastructure.py # THIS STORY
├── 002_initial_domains.py         # THIS STORY
└── 003_seed_static_data.py        # THIS STORY
```

### Infrastructure Tables (14 tables) - Phase 1

**Public Schema (2 tables)**:
- `pipeline_executions` - ETL execution tracking
- `data_quality_metrics` - Data quality metrics

**Enterprise Schema (9 tables)**:
- `base_info` - Company base information (41 columns)
- `business_info` - Company business details (43 columns)
- `biz_label` - Company classification labels
- `enrichment_requests` - Async enrichment queue
- `enrichment_index` - Company ID resolution cache
- `validation_results` - Validation tracking
- `company_types_classification` - Static reference (structure only)
- `industrial_classification` - Static reference (structure only)

**Mapping Schema (3 tables)**:
- `产品线` - Product lines (seed data)
- `组织架构` - Organization structure (seed data)
- `计划层规模` - Plan scale levels (seed data)

**System Schema (1 table)**:
- `sync_state` - Incremental sync state tracking

### Domain Tables (7 tables) - Phase 2

**Business Schema (2 tables)**:
- `规模明细` (annuity_performance) - 625,126 rows in production
- `收入明细` (annuity_income) - 158,480 rows in production

**Mapping Schema (5 tables)**:
- `年金计划` (annuity_plans) - 1,159 rows
- `组合计划` (portfolio_plans) - 1,338 rows
- `年金客户` - 10,997 rows
- `产品明细` - 18 rows (seed data)
- `利润指标` - 12 rows (seed data)

> **CRITICAL**: Domain tables MUST use `ddl_generator.generate_create_table_sql()` to ensure consistency with Domain Registry definitions.

### Seed Data (~36,926 rows) - Phase 3

**All seed data loaded from CSV files** (extracted from legacy PostgreSQL database):

| Table | Schema | Rows | Source | Notes |
|-------|--------|------|--------|-------|
| `company_types_classification` | enterprise | 104 | `config/seeds/company_types_classification.csv` | 国标分类 |
| `industrial_classification` | enterprise | 1,183 | `config/seeds/industrial_classification.csv` | 行业分类 |
| `enrichment_index` | enterprise | 32,052 | `config/seeds/enrichment_index.csv` | 公司ID缓存 |
| `产品线` | mapping | 12 | `config/seeds/产品线.csv` | - |
| `组织架构` | mapping | 38 | `config/seeds/组织架构.csv` | - |
| `计划层规模` | mapping | 7 | `config/seeds/计划层规模.csv` | - |
| `产品明细` | mapping | 18 | `config/seeds/产品明细.csv` | - |
| `利润指标` | mapping | 12 | `config/seeds/利润指标.csv` | - |
| `年金计划` | mapping | 1,128 | `config/seeds/年金计划.csv` | base table, company_id NOT LIKE 'IN%' |
| `年金客户` | mapping | 985 | `config/seeds/年金客户.csv` | cascade from 年金计划.company_id |
| `组合计划` | mapping | 1,315 | `config/seeds/组合计划.csv` | cascade from 年金计划.年金计划号 |

> **CRITICAL**: All seed data must be version-controlled in code repository. CSV files extracted from legacy PostgreSQL via `psql \COPY` command.

### Project Structure Notes

**Domain Registry Location**: `src/work_data_hub/infrastructure/schema/`

**DDL Generator**: `infrastructure/schema/ddl_generator.py`
```python
from work_data_hub.infrastructure.schema import ddl_generator

# Generate DDL for a domain
sql = ddl_generator.generate_create_table_sql("annuity_performance")
```

**Seed Data Location**: `config/seeds/` (to be created in this story)

**Migration Location**: `io/schema/migrations/versions/`

### Technical Requirements

**Idempotent Migration Pattern**:
```python
def _table_exists(conn, table_name: str, schema: str) -> bool:
    result = conn.execute(sa.text("""
        SELECT EXISTS (
            SELECT FROM information_schema.tables
            WHERE table_schema = :schema AND table_name = :table
        )
    """), {"schema": schema, "table": table_name})
    return result.scalar()

def upgrade():
    conn = op.get_bind()
    if not _table_exists(conn, "年金计划", "mapping"):
        op.create_table(...)
```

**DDL Generator Usage**:
```python
from work_data_hub.infrastructure.schema import ddl_generator
import sqlalchemy as sa

def upgrade():
    conn = op.get_bind()
    if not _table_exists(conn, "规模明细", "business"):
        sql = ddl_generator.generate_create_table_sql("annuity_performance")
        conn.execute(sa.text(sql))
```

**CSV Data Loading**:
```python
import csv
from pathlib import Path

def upgrade():
    conn = op.get_bind()
    seed_file = Path(__file__).parent.parent.parent.parent / 'config' / 'seeds' / 'industrial_classification.csv'
    with open(seed_file, 'r', encoding='utf-8') as f:
        reader = csv.DictReader(f)
        for row in reader:
            conn.execute(sa.text("""
                INSERT INTO enterprise.industrial_classification (类别代码, 门类名称, 大类名称, ...)
                VALUES (:code, :menlei, :dalei, ...)
                ON CONFLICT DO NOTHING;
            """), row)
```

### Testing Standards

**Verification Commands**:
```bash
# Check migration history
uv run alembic history

# Verify linear chain
uv run alembic heads  # Should show single head: 20251228_000003

# Test upgrade on clean database
uv run alembic upgrade head

# Verify table count
psql -c "\dt"  # Should show 21 tables

# Verify seed data
psql -c "SELECT COUNT(*) FROM enterprise.industrial_classification"  # Should be 1183
```

**No Regression Tests**: This story creates new migrations. Existing integration tests will be updated in Story 7.2-4 (Test Script Cleanup).

### Architecture Compliance

**Zero Legacy Policy**: No wrappers or backward compatibility. Clean new migration chain.

**KISS Principle**: Simple linear migration chain. No branching, no merge migrations.

**YAGNI Principle**: Only P0 tables included. Additional domains will be added incrementally.

**Single Source of Truth**: Domain Registry definitions drive both ETL validation and migration DDL.

### Dependencies

**Blocked By**:
- Story 7.2-1 (Migration Backup and Archive) - **COMPLETED**
- Story 7.2-3 (Domain Registry ID Unification) - **MUST COMPLETE FIRST** (ensures `ddl_generator` uses `id`)

**Blocking**: This story **blocks** all subsequent Epic 7.2 stories (7.2-4 through 7.2-6).

**Epic 8 Dependency**: Epic 8 (Testing & Validation Infrastructure) is **blocked** by Epic 7.2 completion.

### Risk Assessment

**Risk Level**: **Medium**

**Rationale**:
- Creating new migration structure from scratch
- Must ensure exact alignment with Domain Registry definitions
- Seed data file paths and CSV formats must be correct

**Mitigation**:
- Use `ddl_generator` for domain tables to ensure consistency
- Cross-reference with `table-structure-reference.md` for exact column definitions
- Test on clean database before marking story complete
- Verify `alembic history` shows clean linear chain

### Success Criteria

1. All 3 migration files created with proper revision chain (001 → 002 → 003)
2. `alembic history` shows linear chain with no branches
3. `alembic upgrade head` succeeds on clean database
4. All 21 tables created (**17 infrastructure + 4 domains**)
5. Seed data loaded correctly (~1,350 rows total)
6. Domain table definitions match `ddl_generator` output (primary_key = `id`)
7. `config/seeds/` directory created with CSV files
8. No test failures (no functional code changes)

## Dev Agent Record

### Agent Model Used

claude-opus-4-5-20251101

### Debug Log References

None

### Completion Notes List

1. All 3 migration files created with proper linear chain (001 → 002 → 003)
2. DDL Generator integration verified - 002_initial_domains.py uses `_execute_domain_ddl()` function
3. Idempotent pattern (`_table_exists()` + `IF NOT EXISTS`) implemented in all migrations
4. Seed data loaded: 104 + 1,183 (CSV) + 14 + 38 + 7 + 18 + 12 (embedded/CSV) = ~1,386 rows total
5. Updated `alembic.ini` with `version_locations` to support archived migrations directory

### File List

**Story Completed**: 2025-12-28
**Status**: done

**Created/Modified Files**:
- [NEW] `io/schema/migrations/versions/001_initial_infrastructure.py` (564 lines, 17 tables)
- [NEW] `io/schema/migrations/versions/002_initial_domains.py` (142 lines, 4 domain tables via DDL Generator)
- [NEW] `io/schema/migrations/versions/003_seed_static_data.py` (220 lines, 11 tables CSV loading)
- [NEW] `config/seeds/company_types_classification.csv` (104 rows)
- [NEW] `config/seeds/industrial_classification.csv` (1,183 rows)
- [NEW] `config/seeds/enrichment_index.csv` (32,052 rows, aggregated from legacy)
- [NEW] `config/seeds/产品线.csv` (12 rows)
- [NEW] `config/seeds/组织架构.csv` (38 rows)
- [NEW] `config/seeds/计划层规模.csv` (7 rows)
- [NEW] `config/seeds/产品明细.csv` (18 rows)
- [NEW] `config/seeds/利润指标.csv` (12 rows)
- [NEW] `config/seeds/年金计划.csv` (1,128 rows, base table)
- [NEW] `config/seeds/年金客户.csv` (985 rows, cascade filtered)
- [NEW] `config/seeds/组合计划.csv` (1,315 rows, cascade filtered)
- [MODIFY] `alembic.ini` - Added `version_locations` for archive support

## Change Log

**2025-12-28** - Story 7.2-2 Created via create-story workflow:
- Comprehensive story context created from Sprint Change Proposal
- All 3 migration phases documented with acceptance criteria
- Task breakdown includes 5 main tasks with 33 subtasks
- Technical requirements include idempotent pattern, DDL generator usage, CSV loading
- References to migration documentation and Domain Registry architecture
- Ready for dev-story execution

**2025-12-28** - Story 7.2-2 Implementation completed:
- All Tasks and Subtasks marked complete
- File List updated with actual created artifacts
- Code Review PASSED with fixes applied

**2025-12-28** - Seed data expanded:
- Added 年金客户, 年金计划, 组合计划 with FK cascade filtering
- Added enrichment_index (32,052 rows) from legacy aggregation
- Total seed data: 11 tables, ~36,926 rows
- Removed dependency on legacy database for new environment setup
