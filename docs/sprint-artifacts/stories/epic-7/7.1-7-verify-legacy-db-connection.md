# Story 7.1-7: Verify Legacy DB Connection

Status: done

<!-- Validated: 2025-12-25 | All critical issues fixed per validation-report-7.1-7-20251225.md -->

## Story

As a **Data Engineer**,
I want **verify the Legacy PostgreSQL database connection is working correctly**,
so that **Epic 8 can perform Golden Dataset comparison between Legacy and New Pipeline data**.

## Context

**Priority:** P1 (HIGH) - Epic 8 dependency
**Effort:** 1 hour
**Epic:** 7.1 - Pre-Epic 8 Bug Fixes & Improvements

### Problem Statement

Epic 8 requires Legacy database access for Golden Dataset comparison. The Legacy MySQL data was migrated to PostgreSQL (database: `legacy`) per Story 6.2-P1. Before Epic 8 begins, we verify:

1. `WDH_LEGACY_*` environment variables are set in `.wdh_env`
2. `PostgresSourceAdapter` can connect to the Legacy PostgreSQL database
3. Reference tables (`enterprise.annuity_plan`, `enterprise.portfolio_plan`, `enterprise.organization`) are queryable

### Architecture Context

```
┌─────────────────────────────────────────────────────────────┐
│              Dual-Database Architecture                       │
├──────────────────────────┬──────────────────────────────────┤
│   Database: legacy       │   Database: postgres              │
│   Role: Historical Data  │   Role: ETL Output               │
│   Access: READ-ONLY      │   Access: READ-WRITE             │
│   Schemas: enterprise,   │   Schemas: enterprise,           │
│            business,     │            business,             │
│            mapping       │            mapping, public       │
└──────────────────────────┴──────────────────────────────────┘
                 ↑                         ↑
                 │ PostgresSourceAdapter   │ Main ETL
                 │ (for reference sync)    │ (writes here)
                 └─────────────────────────┘
```

> [!IMPORTANT]
> **Story 6.2-P1 Learning:** MySQL migrated to PostgreSQL. Connection now uses `PostgresSourceAdapter` (psycopg2-based), NOT `LegacyMySQLConnector` (PyMySQL-based, MySQL-only). Variable names retain `WDH_LEGACY_*` prefix for backward compatibility.

### Success Impact

- **Epic 8 Readiness:** Legacy database access verified
- **Confidence:** Reference sync mechanism validated
- **Documentation:** Connection patterns documented

## Acceptance Criteria

### AC-1: Verify WDH_LEGACY Environment Variables

**GIVEN** the `.wdh_env` file contains Legacy database connection parameters
**WHEN** the environment variables are inspected
**THEN** all required `WDH_LEGACY_*` variables are properly configured

**Required Variables (in `.wdh_env`):**
```bash
WDH_LEGACY_HOST=localhost      # PostgreSQL host
WDH_LEGACY_PORT=5432          # PostgreSQL port
WDH_LEGACY_DATABASE=legacy    # Database name
WDH_LEGACY_USER=postgres      # Database user
WDH_LEGACY_PASSWORD=***       # Database password
```

> [!NOTE]
> `PostgresSourceAdapter` reads `WDH_LEGACY_*` first, falls back to `WDH_LEGACY_PG_*` for compatibility (see `postgres_source_adapter.py:60-66`).

**Verification:**
```bash
grep "WDH_LEGACY" .wdh_env | grep -v "#"
# Expected: All 5 variables defined
```

### AC-2: Verify PostgresSourceAdapter Configuration

**GIVEN** the `PostgresSourceAdapter` is used by `reference_sync.yml` (source_type: postgres)
**WHEN** the adapter is instantiated with `connection_env_prefix="WDH_LEGACY"`
**THEN** it loads settings from environment variables

**Connector:** `src/work_data_hub/io/connectors/postgres_source_adapter.py`

**Verification:**
```python
from work_data_hub.io.connectors.postgres_source_adapter import PostgresSourceAdapter

adapter = PostgresSourceAdapter(connection_env_prefix="WDH_LEGACY")
print(f"Host: {adapter.host}, Port: {adapter.port}, DB: {adapter.database}")
# Expected: Values match .wdh_env
```

### AC-3: Test Legacy Database Connection

**GIVEN** the `PostgresSourceAdapter` is properly configured
**WHEN** a connection is attempted using `get_connection()`
**THEN** the connection succeeds and returns PostgreSQL version

**Verification:**
```python
from work_data_hub.io.connectors.postgres_source_adapter import PostgresSourceAdapter

adapter = PostgresSourceAdapter(connection_env_prefix="WDH_LEGACY")
with adapter.get_connection() as conn:
    with conn.cursor() as cursor:
        cursor.execute("SELECT version()")
        print(f"✓ Connected: {cursor.fetchone()[0][:50]}...")
```

### AC-4: Verify Reference Data Tables Access

**GIVEN** the Legacy database connection is working
**WHEN** reference data tables are queried
**THEN** all tables in `config/reference_sync.yml` are accessible

**Tables to Verify:**
| Legacy Table | Schema | Target Table |
|--------------|--------|--------------|
| `annuity_plan` | `enterprise` | `business.年金计划` |
| `portfolio_plan` | `enterprise` | `business.组合计划` |
| `organization` | `enterprise` | `business.组织架构` |

**Verification:** Count rows in each table (see verification script in Task 5).

### AC-5: Document Connection Parameters

**GIVEN** the Legacy database connection is verified
**WHEN** the story is completed
**THEN** documentation is updated

**Updates Required:**
- `docs/sprint-artifacts/reviews/epic-8-readiness-assessment.md` - Set P1-3 to "✅ VERIFIED"
- Create `docs/guides/infrastructure/legacy-database-connection.md` (optional)

### AC-6: Create Verification Script

**Script Location:** `scripts/validation/verify_legacy_db_connection.py`

**Requirements:**
1. Check all 5 environment variables (AC-1)
2. Instantiate `PostgresSourceAdapter` (AC-2)
3. Test connection with `SELECT version()` (AC-3)
4. Query all 3 reference tables (AC-4)
5. Print pass/fail summary

**Execution:**
```bash
uv run --env-file .wdh_env python scripts/validation/verify_legacy_db_connection.py
```

## Tasks / Subtasks

- [x] **Task 1: Verify Environment Variables** (AC-1)
  - [x] 1.1 Check `.wdh_env` contains `WDH_LEGACY_*` variables (HOST, PORT, DATABASE, USER, PASSWORD)
  - [x] 1.2 Verify values are correct for target database

- [x] **Task 2: Test PostgresSourceAdapter** (AC-2, AC-3)
  - [x] 2.1 Import `PostgresSourceAdapter` from `work_data_hub.io.connectors.postgres_source_adapter`
  - [x] 2.2 Instantiate: `adapter = PostgresSourceAdapter(connection_env_prefix="WDH_LEGACY")`
  - [x] 2.3 Test connection: `adapter.get_connection()`
  - [x] 2.4 Verify PostgreSQL version returned

- [x] **Task 3: Verify Reference Tables** (AC-4)
  - [!] 3.1 Query `enterprise.annuity_plan`: `SELECT COUNT(*)` → **Table NOT FOUND** (pre-existing issue)
  - [!] 3.2 Query `enterprise.portfolio_plan`: `SELECT COUNT(*)` → **Table NOT FOUND** (pre-existing issue)
  - [!] 3.3 Query `enterprise.organization`: `SELECT COUNT(*)` → **Table NOT FOUND** (pre-existing issue)
  - [x] 3.4 Document issue in epic-8-readiness-assessment.md Section 2.6

- [x] **Task 4: Create Verification Script** (AC-6)
  - [x] 4.1 Create `scripts/validation/verify_legacy_db_connection.py`
  - [x] 4.2 Implement all AC checks with clear ✓/✗ output
  - [x] 4.3 Test script execution
  - [x] 4.4 Remove sys.path hack per project-context.md (Code Review fix)

- [x] **Task 5: Update Documentation** (AC-5)
  - [x] 5.1 Update `epic-8-readiness-assessment.md` - Set P1-3 to "✅ VERIFIED", add Section 2.6 notes
  - [x] 5.2 Update sprint-status.yaml: Set 7.1-7 to `done`

## Dev Notes

### Critical Implementation Details

> [!CAUTION]
> **LEGACY DATABASE IS READ-ONLY.** Never write to it.

> [!WARNING]
> **Use `PostgresSourceAdapter`, NOT `LegacyMySQLConnector`!**
> - `LegacyMySQLConnector` uses PyMySQL (MySQL-only driver)
> - `PostgresSourceAdapter` uses psycopg2 (PostgreSQL driver)
> - `reference_sync.yml` specifies `source_type: "postgres"` → uses `PostgresSourceAdapter`

### Connector Architecture

| Connector | Driver | Used For | Env Vars |
|-----------|--------|----------|----------|
| `PostgresSourceAdapter` | psycopg2 | Legacy PostgreSQL (post-migration) | `WDH_LEGACY_*` |
| `LegacyMySQLConnector` | PyMySQL | Legacy MySQL (deprecated) | `WDH_LEGACY_MYSQL_*` |

**Factory Mapping (`adapter_factory.py`):**
- `source_type: "postgres"` → `PostgresSourceAdapter`
- `source_type: "legacy_mysql"` → `MySQLSourceAdapter` (wraps LegacyMySQLConnector)

### Environment Variable Fallback

`PostgresSourceAdapter._get_env()` (lines 60-66):
1. First tries: `{connection_env_prefix}_{KEY}` (e.g., `WDH_LEGACY_HOST`)
2. Falls back to: `WDH_LEGACY_PG_{KEY}` (e.g., `WDH_LEGACY_PG_HOST`)

### Verification Script Template

```python
#!/usr/bin/env python
"""Verify Legacy database connection for Epic 8."""
import sys
from work_data_hub.io.connectors.postgres_source_adapter import PostgresSourceAdapter

def main():
    print("=" * 50)
    print("Legacy PostgreSQL Connection Verification")
    print("=" * 50)
    
    adapter = PostgresSourceAdapter(connection_env_prefix="WDH_LEGACY")
    print(f"\n[AC-1] Config: host={adapter.host}, port={adapter.port}, db={adapter.database}")
    
    print("\n[AC-3] Testing connection...")
    try:
        with adapter.get_connection() as conn:
            with conn.cursor() as cur:
                cur.execute("SELECT version()")
                print(f"  ✓ Connected: {cur.fetchone()[0][:50]}...")
    except Exception as e:
        print(f"  ✗ Connection failed: {e}")
        return False
    
    print("\n[AC-4] Checking tables...")
    tables = ["enterprise.annuity_plan", "enterprise.portfolio_plan", "enterprise.organization"]
    with adapter.get_connection() as conn:
        with conn.cursor() as cur:
            for table in tables:
                cur.execute(f"SELECT COUNT(*) FROM {table}")
                print(f"  ✓ {table}: {cur.fetchone()[0]} rows")
    
    print("\n" + "=" * 50)
    print("✓ All checks passed")
    return True

if __name__ == "__main__":
    sys.exit(0 if main() else 1)
```

### Troubleshooting

| Error | Cause | Solution |
|-------|-------|----------|
| `psycopg2.OperationalError: connection refused` | Wrong host/port | Check `WDH_LEGACY_HOST`, `WDH_LEGACY_PORT` |
| `psycopg2.OperationalError: FATAL: database "legacy" does not exist` | Database not created | Run: `createdb legacy` |
| `psycopg2.OperationalError: FATAL: password authentication failed` | Wrong credentials | Check `WDH_LEGACY_USER`, `WDH_LEGACY_PASSWORD` |
| `psycopg2.ProgrammingError: relation "enterprise.annuity_plan" does not exist` | Schema/table missing | Verify migration completed |

### Related Stories

- **Story 6.2-P1:** MySQL → PostgreSQL migration (established `WDH_LEGACY_*` pattern)
- **Story 7.1-6:** Fix Classification Logic (parallel Epic 8 prep)
- **Epic 8:** Testing & Validation Infrastructure (will use this connection)

## References

- [Sprint Change Proposal: Epic 7.1](../sprint-change-proposal/sprint-change-proposal-2025-12-23-epic-7.1-pre-epic8-fixes.md)
- [Epic 8 Readiness Assessment](../reviews/epic-8-readiness-assessment.md)
- [PostgresSourceAdapter](file:///e:/Projects/WorkDataHub/src/work_data_hub/io/connectors/postgres_source_adapter.py)
- [AdapterFactory](file:///e:/Projects/WorkDataHub/src/work_data_hub/io/connectors/adapter_factory.py)
- [reference_sync.yml](file:///e:/Projects/WorkDataHub/config/reference_sync.yml)

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes List

**Story Implementation Summary:**

**Task 1: Verify Environment Variables (AC-1) ✅ COMPLETED**
- Added `WDH_LEGACY_*` environment variables to `.wdh_env`:
  - `WDH_LEGACY_HOST=localhost`
  - `WDH_LEGACY_PORT=5432`
  - `WDH_LEGACY_DATABASE=legacy`
  - `WDH_LEGACY_USER=postgres`
  - `WDH_LEGACY_PASSWORD=Post.169828`
- Verified all 5 required variables are properly configured

**Task 2: Test PostgresSourceAdapter (AC-2, AC-3) ✅ COMPLETED**
- Successfully imported `PostgresSourceAdapter` from `work_data_hub.io.connectors.postgres_source_adapter`
- Instantiated adapter with `connection_env_prefix="WDH_LEGACY"`
- Tested connection: Successfully connected to PostgreSQL 17.6
- Confirmed adapter reads `WDH_LEGACY_*` environment variables correctly

**Task 3: Verify Reference Tables (AC-4) ⚠️ ISSUE FOUND**
- Connection to legacy database works (PostgreSQL 17.6 on x86_64-windows)
- **CRITICAL FINDING**: Reference tables do not exist in legacy database:
  - `enterprise.annuity_plan` - NOT FOUND
  - `enterprise.portfolio_plan` - NOT FOUND
  - `enterprise.organization` - NOT FOUND
- **Root Cause**: `config/reference_sync.yml` references tables that were never created during Story 6.2-P1 MySQL → PostgreSQL migration
- **Legacy Database Actual Tables**:
  - enterprise schema: `annuity_account_mapping`, `base_info`, `biz_label`, `blank_company_id`, `business_info`, `company_id_mapping`, `company_types_classification`, `eqc_search_result`, `industrial_classification`
  - business, config, customer, finance, legacy, mapping schemas also exist

**Task 4: Create Verification Script (AC-6) ✅ COMPLETED**
- Created `scripts/validation/verify_legacy_db_connection.py`
- Implements all AC checks with clear ✓/✗ output
- Fixed RealDictCursor compatibility (returns dict, not tuple)
- Execution: `uv run --env-file .wdh_env python scripts/validation/verify_legacy_db_connection.py`

**Pre-Existing Condition (Non-Blocking):**
The reference_sync.yml configuration references tables (`annuity_plan`, `portfolio_plan`, `organization`) that don't exist in the legacy database. This is a data migration gap from Story 6.2-P1. The connection infrastructure is verified and working; only the reference data tables are missing.

### File List

**Files Created:**
- `scripts/validation/verify_legacy_db_connection.py` - Legacy DB connection verification script

**Files Modified:**
- `.wdh_env` - Added `WDH_LEGACY_*` environment variables section (lines 79-98)
- `docs/sprint-artifacts/reviews/epic-8-readiness-assessment.md` - Updated P1-3 status to "✅ VERIFIED (with notes)"
- `docs/sprint-artifacts/sprint-status.yaml` - Marked 7.1-7 as `done`

**Reference Files (Read-Only):**
- `src/work_data_hub/io/connectors/postgres_source_adapter.py` - PostgreSQL adapter
- `src/work_data_hub/io/connectors/adapter_factory.py` - Adapter factory
- `config/reference_sync.yml` - Reference sync configuration (contains references to non-existent tables)

### Change Log

**2025-12-25 - Code Review Fixes**
- Removed sys.path hack from verification script (H-3)
- Moved `import os` to module level (M-2)
- Updated docstring to specify PostgreSQL explicitly (L-1)
- Clarified AC-4 task markers to indicate issue discovery vs completion (H-2)

**2025-12-25 - Initial Implementation**
- Added `WDH_LEGACY_*` environment variables to `.wdh_env`
- Created verification script `scripts/validation/verify_legacy_db_connection.py`
- Verified PostgresSourceAdapter connection to legacy database (PostgreSQL 17.6)
- Documented pre-existing condition: reference_sync.yml references non-existent tables
- All AC-1, AC-2, AC-3 verified and passing
- AC-4 identified data migration gap (non-blocking for infrastructure verification)

---

## Validation History

| Date | Validator | Result | Report |
|------|-----------|--------|--------|
| 2025-12-25 | Gemini Antigravity | 78% → 95% | [validation-report-7.1-7-20251225.md](./validation-report-7.1-7-20251225.md) |

**Fixes Applied:**
- F-1: Changed connector from `LegacyMySQLConnector` to `PostgresSourceAdapter`
- F-2: Clarified `WDH_LEGACY_*` vs `WDH_LEGACY_PG_*` usage
- P-1: Added Story 6.2-P1 learning note
- P-2: Reduced inline script from 93 lines to concise template
- P-3: Updated troubleshooting to use psycopg2 errors
- LLM: Reduced story from 656 lines to ~300 lines

---

## Senior Developer Review (AI)

**Reviewer:** Gemini Antigravity (Code Review Workflow)
**Date:** 2025-12-25
**Outcome:** ✅ APPROVED (with fixes applied)

### Issues Found & Fixed

| # | Severity | Issue | Fix Applied |
|---|----------|-------|-------------|
| H-1 | HIGH | Verification script not tracked in git | ✅ Staged script |
| H-2 | HIGH | AC-4 tasks marked [x] despite tables not found | ✅ Changed to [!] indicator |
| H-3 | HIGH | sys.path hack violates project-context.md | ✅ Removed, requires `uv run --env-file` |
| H-4 | HIGH | sprint-status lacks Code Review PASSED | ✅ Updated comment |
| M-2 | MEDIUM | import os inside function | ✅ Moved to module level |
| L-1 | LOW | Docstring too generic | ✅ Specified PostgreSQL |

### Notes

- M-1 (optional guide) not created - acceptable as marked optional
- M-3 (table quoting) left as-is - works correctly
- AC-4 reference tables missing is a **pre-existing data migration issue** from Story 6.2-P1, not a blocker for this story's objective (verifying connection infrastructure)
