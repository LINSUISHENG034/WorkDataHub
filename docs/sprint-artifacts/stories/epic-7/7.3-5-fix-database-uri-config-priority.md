# Story 7.3-5: Fix Database URI Configuration Priority

> **Epic:** 7.3 - Multi-Domain Consistency Fixes  
> **Status:** done  
> **Priority:** P1 (High)  
> **Effort:** 2 Story Points  
> **Created:** 2025-12-29  
> **Completed:** 2025-12-29  
> **Sprint Change Proposal:** [sprint-change-proposal-2025-12-29-config-priority-fix.md](../sprint-change-proposal/sprint-change-proposal-2025-12-29-config-priority-fix.md)

---

## Problem Statement

During multi-domain testing (Story 7.3-4 validation), Alembic migrations connected to the wrong database (`wdh_migration_test`) instead of the `.wdh_env` configured database (`postgres`).

### Root Cause

PowerShell session contained `$env:WDH_DATABASE__URI = wdh_migration_test`. Per pydantic-settings default priority, system environment variables override `.wdh_env` file configuration.

### Design Expectation

`.wdh_env` should be the **single source of truth** for configuration, preventing accidental overrides from lingering environment variables.

---

## Acceptance Criteria

- [x] **AC1:** `get_database_connection_string()` ignores system environment variables
- [x] **AC2:** Configuration is read exclusively from `.wdh_env` file
- [x] **AC3:** Clear error message when no database URI found in `.wdh_env`
- [x] **AC4:** All existing unit tests pass
- [x] **AC5:** Integration verification: Settings loads correctly from .wdh_env

---

## Tasks

1. [x] Modify `get_database_connection_string()` to read only from file
2. [x] Update docstring to reflect new behavior
3. [x] Verified config unit tests pass
4. [ ] Update `.wdh_env.example` with warning comment (optional - future)
5. [x] Verified settings load correctly from .wdh_env

---

## Technical Details

### File to Modify

- `src/work_data_hub/config/settings.py` (lines 352-379)

### Implementation Approach

Replace `os.getenv()` calls with direct file reading from `SETTINGS_ENV_FILE`:

```python
def get_database_connection_string(self) -> str:
    """Get PostgreSQL connection string from .wdh_env file ONLY."""
    final_uri: str | None = None

    # Step 1: Read ONLY from .wdh_env file (ignore system environment variables)
    if isinstance(SETTINGS_ENV_FILE, Path) and SETTINGS_ENV_FILE.exists():
        for line in SETTINGS_ENV_FILE.read_text(encoding="utf-8").splitlines():
            line = line.strip()
            if not line or line.startswith("#"):
                continue
            if line.startswith("WDH_DATABASE__URI="):
                final_uri = line.split("=", 1)[1].strip()
                break
            if line.startswith("WDH_DATABASE_URI="):
                final_uri = line.split("=", 1)[1].strip()
                # Continue looking for WDH_DATABASE__URI (higher priority)

    # Step 2: Fallback to constructed URI from components
    if not final_uri:
        if self.database_uri:
            final_uri = self.database_uri
        else:
            final_uri = self.database.get_connection_string()

    # Step 3: Validate we have a URI
    if not final_uri:
        raise ValueError(
            f"No database configuration found. "
            f"Please set WDH_DATABASE__URI in {SETTINGS_ENV_FILE}"
        )

    # Step 4: Fix for SQLAlchemy compatibility
    if final_uri.startswith("postgres://"):
        final_uri = final_uri.replace("postgres://", "postgresql://", 1)

    return final_uri
```

---

## Verification Steps

```powershell
# Step 1: Set conflicting environment variable
$env:WDH_DATABASE__URI = "wdh_wrong_database"

# Step 2: Verify .wdh_env has correct configuration
cat .wdh_env | Select-String "WDH_DATABASE__URI"

# Step 3: Run migration and verify correct database
uv run --env-file .wdh_env alembic upgrade head

# Step 4: Cleanup
Remove-Item Env:WDH_DATABASE__URI
```

---

## Related Documents

- [config-priority-issue.md](../../specific/multi-domain/config-priority-issue.md)
- [settings.py](../../../src/work_data_hub/config/settings.py)

---

## Completion Notes

_To be filled after implementation_
