# Story 7.3-4: Add Missing Fields to annuity_income Domain

> **Epic:** 7.3 - Multi-Domain Consistency Fixes  
> **Priority:** P1  
> **Status:** done ✅  
> **Created:** 2025-12-29  
> **Completed:** 2025-12-29  
> **Reference:** [Sprint Change Proposal](../sprint-change-proposal/sprint-change-proposal-2025-12-29-domain-field-gap.md)

---

## Problem Statement

The `annuity_income` domain is missing 4 descriptive fields that exist in the source Excel data and are already implemented in `annuity_performance`. This was discovered during multi-domain testing.

### Missing Fields

| Field      | Type                   | Description                |
| ---------- | ---------------------- | -------------------------- |
| `计划名称` | VARCHAR(255), nullable | Plan name (human-readable) |
| `组合类型` | VARCHAR(255), nullable | Portfolio type             |
| `组合名称` | VARCHAR(255), nullable | Portfolio name             |
| `机构名称` | VARCHAR(255), nullable | Institution name           |

### Root Cause

Original `annuity_income` implementation focused on financial fields (固费, 浮费, 回补, 税), omitting descriptive "name" fields.

---

## Acceptance Criteria

- [x] AC1: Schema definition includes 4 new ColumnDef entries ✅
- [x] AC2: Pydantic models (In/Out) include 4 new Optional fields ✅
- [x] AC3: Database migration adds columns via Alembic ✅ (table recreated)
- [x] AC4: Existing unit tests pass ✅ (no test changes needed)
- [x] AC5: ETL pipeline correctly passes through fields from Excel ✅

---

## Tasks

### Schema Definition Update

- [x] T1: Add 4 ColumnDef entries to `infrastructure/schema/definitions/annuity_income.py` ✅

### Domain Model Update

- [x] T2: Add fields to `AnnuityIncomeIn` model ✅
- [x] T3: Add fields to `AnnuityIncomeOut` model ✅

### Database Migration

- [x] T4: Generate Alembic migration script ✅ (used table rebuild approach)
- [x] T5: Verify migration applies correctly ✅ (21 columns verified)

### Verification

- [ ] T6: Run unit tests
- [ ] T7: Run ETL with sample data to verify field passthrough

---

## Files to Modify

| File                                                                    | Change               |
| ----------------------------------------------------------------------- | -------------------- |
| `src/work_data_hub/infrastructure/schema/definitions/annuity_income.py` | Add 4 ColumnDef      |
| `src/work_data_hub/domain/annuity_income/models.py`                     | Add fields to In/Out |
| `io/schema/migrations/versions/`                                        | New migration script |

---

## Reference Pattern

See `annuity_performance` for implementation pattern:

- Schema: `infrastructure/schema/definitions/annuity_performance.py` (lines 58-61, 73)
- Models: `domain/annuity_performance/models.py` (lines 68-71, 115-126, 255-258, 305-316)

---

## Notes

- All new fields are **nullable** - backward compatible
- No validators needed - simple string passthrough from Excel
- Alembic will auto-generate DDL via `ddl_generator`
