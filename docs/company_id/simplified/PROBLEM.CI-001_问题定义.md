# Company ID 问题定义与解决方案（基于第一性原理）

本文件是“company_id”全流程的主指导文档，统一问题定义、业务目标、约束条件与推荐方案。与之配套的执行细化请参考 docs/company_id/INITIAL.CI-002* 系列文档。

## 一、问题定义
- 识别目标：为每条业务事实（如规模明细）确定“稳定、唯一、可追溯”的客户主体标识（company_id）。
- 背景症结：内部“客户名称”质量不佳（新旧名称、别名、异常字符、错别字），仅靠名称无法稳定锁定客户身份。
- 两阶段思路：先进行一轮“内部规则映射”（尊重历史、尽量不改变既有语义），再利用外部企业信息平台（企查/EQC）的模糊匹配与曾用名能力获取权威 company_id，并反哺内部。

## 二、业务目标
- 统一口径：跨批次/跨域共享同一规范 company_id（以 EQC 的 company_id 为权威主键）。
- 可回溯性：明确记录来源（内部/外部）、证据（匹配字段/相似度/曾用名）、更新时间线。
- 渐进收敛：主流程不中断；未解析可后续异步回填，逐步提高命中率。
- 历史尊重：内部规则优先，兼顾既有数据的连续性与可解释性。

## 三、数据输入与信号
- 内部信号：计划代码、年金计划、年金账户名/号、现有客户名称（含清洗/规范化）。
- 外部信号：企查/EQC 搜索返回的官方名、统一社会信用代码、公司别名/曾用名、权威 company_id；支持模糊匹配与历史名命中。

## 四、处理原则
- 内部优先：覆盖映射/计划表/账户映射/内部名称索引命中则直接采用，不再外呼。
- 外部补全：内部未命中时，基于名称关键词调用 EQC 搜索；利用官方名/曾用名/统一代码判定主体。
- 可分离时序：外部查询作为独立异步模块运行（不耦合主导入时序）；主流程只产出待回填清单。
- 成本与鲁棒：外部服务波动不影响主流程；允许队列/CSV/NDJSON 中间产物与重试；可配置小额度同步查询（如确有需要）。

## 五、输出与状态
- 事实侧：为每条记录确定一个 company_id（可先是临时占位，后续统一映射到规范ID）。
- 元数据：保存解析来源（internal/external）、匹配方式（exact/alias/fuzzy）、置信度、证据要点、更新时间。
- 待处理：未命中样本进入“待回填”集合（请求队列或标准化文件），供异步模块消费。

## 六、约束条件（环境与治理）
- 技术环境：Postgres 可新增字段/表/索引/视图；CLI-first；可接受查询 JOIN。
- 外部接入：认证凭据通过环境变量管理；日志不泄露密钥；当前速率/预算无严格限制但需可控策略。
- 时效要求：导入批次无严格 SLA；外部回填可 T+N 完成。
- 合规与审计：支持审计（来源、证据、置信度、变更历史）；可配置人工复核阈值。
- 设计准则：KISS / YAGNI；先跑通最小闭环，后续再做复杂化（如智能规则引擎）。

## 七、成功标准（量化）
- 命中率：内部命中率、外部回填后总命中率显著提升；未知样本占比持续下降。
- 稳定性：主流程对外部故障/抖动免疫；异步回填可重试、可观测。
- 一致性：同一客户在不同批次/域下映射到同一规范 company_id；冲突案例可追溯并有处置路径。
- 可观测：输出命中来源分布、待回填规模、回填成功率、低置信度待审数量；导出未解析 CSV 便于核查。

## 八、非目标（本阶段不做）
- 不构建复杂 UI 或审批工作流（可用 CSV+脚本/SQL 支持人审）。
- 不引入重量级调度/服务面部署（除非未来触发门槛）。
- 不一次性重写历史事实数据（除非明确需要并有可控窗口）。

## 九、关键边界与取舍
- 可靠性优先于实时性：主流程先落地、后回填；避免因外部依赖阻塞导入。
- 一致性优先于“就地改键”：更倾向通过映射/视图实现规范化聚合，避免频繁批量改写事实主键。
- 透明与简单：所有决策都要有来源/证据/置信度记录；流程拆分清晰、易于验证与回滚。

---

## 十、解决方案（建议与默认配置）

### 10.1 临时ID策略（最佳实践）
- 别名形态：使用“别名ID”承载未确认主体，避免日后批量改写事实主键。
- ID 格式：`IN_<16位Base32>`，其中 `<16位Base32>` 来自 `HMAC_SHA1(alias_salt, business_key)` 的前 128 bit（稳定、脱敏、短且可读）。
- business_key 拼接（稳定可复现，按优先级）：
  - 规范化客户名（去空白/标点/企业后缀/全角半角/大小写）
  - 若有则追加 `计划代码`、`年金账户号/名` 等强信号，分隔符 `|`
- 稳定性：相同业务键多次导入生成同一 `IN_`；业务键变化才产生新 `IN_`（避免碰撞/漂移）。
- 命名空间：`IN_` 专属前缀与真实 `company_id` 严格区分。
- 元数据：在映射表保留 `source/internal_rule`、`generated_at/updated_at`、`alias_version` 以支持未来算法升级。
- 配置：盐值通过环境变量 `WDH_ALIAS_SALT` 管理。

### 10.2 人审阈值（后置审核，不阻塞主流程）
- 评分分层：
  - 高置信度 ≥ 0.90：直接采纳并更新映射（alias→canonical）
  - 中置信度 0.60–0.90：标记 `needs_review=1`，先采纳但进入“待复核队列”
  - 低置信度 < 0.60：不采纳，保持 `IN_`，进入“待回填队列”
- 审计要素：记录 `confidence`、`match_type(exact/alias/fuzzy)`、`evidence(统一社会信用代码/曾用名命中等)`、`review_status`。
- 审核机制：周期性（如每周）抽查中置信度项；人工确认后设置 `review_lock=1`，防止后续自动覆盖。

### 10.3 内部映射清单与定时维护
- 数据模型（建议 enterprise schema）：
  - `plan_company_map(plan_code -> company_id)`：来自历史规则与业务共识
  - `account_company_map(account_no/name -> company_id)`：年金账户映射
  - `name_company_index(norm_name -> company_id, match_type=internal|alias)`：内部名称索引
  - `company_id_xref(alias_id -> canonical_id, source, confidence, needs_review, updated_at)`：别名归并（承接 IN_ 与真实ID）
- 维护策略（定时任务/CLI）：
  - 清洗与入库：从业务数据周期性抽取→规范化→去重→Upsert 到上述表
  - 变更控制：保留 `updated_at`（必要时引入 `valid_from/valid_to` 做简化型 SCD）
  - 质量规则：唯一约束（plan_code、account_no/name、norm_name）；空值拦截；异常行导出 CSV 供修正
- 作用优先级（严格内部优先）：覆盖/计划/账户/名称索引 命中即用，不外呼；未命中才进入外部搜索与回填。

### 10.4 对接方式（最佳实践）
- 首选：查询期统一口径（JOIN/视图层）
  - 不改历史事实 `company_id`；通过 `company_id_xref` 在查询/视图层聚合到规范ID
  - 提供标准视图 `enterprise.v_<fact>_with_canonical`：`canonical_company_id = COALESCE(xref.canonical_id, fact.company_id)`
  - 性能保障：对 `xref.alias_id`、`xref.canonical_id` 建索引；重报表可用物化视图（并发刷新）
- 可选硬化（运维动作）：
  - 当某 `IN_` 稳定归并为 canonical 一段时间后，可分片批量改写事实以降低 Join 成本（有窗口/审计再做）
  - 统一脚本：校验覆盖/冲突 → 小批量更新；保留回滚脚本
- 下游一致性：
  - 下游统一走视图或标准查询模版（带 Join xref），避免直接消费裸 `IN_`
  - 初期不施加 FK 到 canonical（避免导入期阻塞），数据成熟后再评估

### 10.5 推荐默认值
- 临时ID：`IN_` + Base32(HMAC_SHA1) 前 16 字符；盐 `WDH_ALIAS_SALT`
- 置信阈值：0.90（高）/ 0.60（中），可在 `.env` 配置
- 维护频率：内部映射每日刷新；外部回填队列按小时/按需运行
- 视图路径：统一提供 `enterprise.v_<fact>_with_canonical` 给报表/下游使用

### 10.6 最小落地动作（执行清单）
- 建表与索引：`plan_company_map`/`account_company_map`/`name_company_index`/`company_id_xref`
- 导入与清洗：把现有业务规则抽取→规范化→Upsert 到内部映射三表
- 主流程：未命中生成 `IN_`，写 `xref` 自映射（alias=canonical=IN_），输出待回填清单
- 异步回填：外部查询→命中则 Upsert 主数据/名称索引，更新 `xref.canonical_id`；记录证据与置信度
- 统一查询：对下游提供标准视图或查询模版（带 Join xref）

---

## 十一、与实施文档的关系
- 总蓝图：docs/company_id/INITIAL.CI-002_企业信息查询集成与客户ID富化闭环.md
- 子任务：CI-002A/B/C/D/E/F/G/H（Provider/Gateway、缓存/索引/队列、同步与异步集成、可观测、真实 Provider、legacy 适配、存量迁移）。

