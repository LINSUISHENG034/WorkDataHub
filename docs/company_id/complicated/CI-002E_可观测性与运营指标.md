# CI-002E — 可观测性与运营指标（命中率提升验证）

## 背景与定位
- 目标：统一输出命中来源分布、预算消耗、队列规模/处理率与 unknown 收敛，支撑迭代评估与运维。
- 关系：覆盖 C/D 两条路径的统计口径，便于对比“仅异步”与“同步+异步”的收益差异。

## 依赖与前置
- 依赖：A/B/D 完成更具代表性；可在 C 关闭情况下先行落地基础 Summary。

## 相关文档
- 主文：`docs/company_id/PROBLEM.CI-000_问题定义与解决方案.md`
- 蓝图：`docs/company_id/CI-002_企业信息查询集成与客户ID富化闭环_蓝图.md`

目的：提供跨运行对比与运营指标，验证“同步小预算 + 异步回填”带来的实际命中率提升与未解析收敛。

## FEATURE
- 增加统计输出：
  - 命中来源分布（overrides/plan_ref/account/name/sync/unknown）
  - 同步预算消耗/溢出入队数
  - 队列规模变化、回填成功率、缓存命中新增量
- 导出审计文件：`unresolved_company_ids.csv`（附最近月度与出现次数）。

## SCOPE
- In-scope：统一日志键/格式；运行结束打印“CompanyId Enrichment Summary”；审计 CSV 字段规范。
- Non-goals：不接入外部 APM/Tracing；不做长期留存仓（仅本地或目标库统计表可选）。

## VALIDATION
```bash
uv run pytest -v -k enrichment_summary

# 流程示例：
# 1) 首次执行主作业（开启富化，使用 stub），记录 unknown 与命中分布
# 2) 执行回填作业（消费队列，更新缓存）
# 3) 二次执行主作业，对比 unknown 下降与命中上升
```

## ACCEPTANCE CRITERIA
- Summary 结构稳定（字段/顺序固定），便于测试断言；二次运行 unknown 显著下降；CSV 内容字段正确且可复核样本。

## RISKS
- 样本波动：在测试中固定输入数据集；指标以相对变化为主。
