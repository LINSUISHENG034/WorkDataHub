# CI-002D — 异步回填作业与队列消费者（CLI）

## 背景与定位
- 目标：消费 `enterprise.enrichment_requests` 队列，批量调用 Provider/Gateway，命中后落库缓存并更新映射，形成闭环。
- 核心：不阻塞主流程；对外部服务异常具备重试与可观测性；与同步小预算互补。
- 关系：建立在 CI-002A（接口）与 CI-002B（队列/缓存）之上，是提升总体命中率的主路径。

## 依赖与前置
- 依赖：A/B 完成；建议有基础 fixtures 或 stub 以便无网络验证。
- 配置：`WDH_ENTERPRISE_PROVIDER`、`WDH_PROVIDER_EQC_TOKEN`（如使用 eqc）。

## 相关文档
- 主文：`docs/company_id/PROBLEM.CI-000_问题定义与解决方案.md`
- 蓝图：`docs/company_id/CI-002_企业信息查询集成与客户ID富化闭环_蓝图.md`
- 配置：`docs/company_id/CONFIG.CI-ENV.md`

目的：实现独立 CLI 消费 `enterprise.enrichment_requests` 队列，调用 Provider/Gateway 批量查询并更新缓存，形成闭环。

## FEATURE
- 新增 CLI 入口（作业或独立模块）：消费 pending→processing→done/failed；失败累计 attempts，记录 last_error。
- 与 Gateway 对接：命中后 upsert `company_master` 与 `company_name_index`。
- 输出回填报告：处理数、成功/失败、命中新增量、错误摘要。

## SCOPE
- In-scope：消费者循环、批量拉取与限速、幂等 upsert；最小日志与退出码。
- Non-goals：不实现复杂调度；不涉及 UI/守护进程部署。

## VALIDATION
```bash
uv run ruff check src/ --fix
uv run mypy src/
uv run pytest -v -k enrich_async

export WDH_DATABASE__URI=postgresql://user:pwd@host:5432/db
export WDH_ENTERPRISE_PROVIDER=stub
uv run python -m src.work_data_hub.orchestration.jobs \
  --execute \
  --job enrich_company_master \
  --debug
```

## ACCEPTANCE CRITERIA
- 可消费并更新缓存；失败可重试；报告指标完整；对后续主作业命中率有提升（验证见 CI-002E）。

## RISKS
- 锁与并发：单实例消费者；多实例场景后续再议，先保持 KISS。
