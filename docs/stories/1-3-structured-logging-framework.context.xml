<story-context id="bmad/bmm/workflows/4-implementation/story-context" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>Structured Logging Framework</title>
    <status>drafted</status>
    <generatedAt>2025-11-10T01:44:35Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-3-structured-logging-framework.md</sourceStoryPath>
  </metadata>

  <story>
    <asA><![CDATA[data engineer]]></asA>
    <iWant><![CDATA[a centralized structured logging system configured from the start]]></iWant>
    <soThat><![CDATA[all subsequent stories use consistent logging and I can debug issues with rich context]]></soThat>
    <tasks><![CDATA[- **Task 1: Implement logging utility module** (AC: 1,2)
  - Subtask 1.1: Create `src/work_data_hub/utils/logging.py` with configurable `structlog` initialization and environment-driven log level.
  - Subtask 1.2: Provide `get_logger(name: str)` plus helper functions (`bind_context`, `sanitize_for_logging`) returning `structlog.BoundLogger`.

- **Task 2: Add sanitization rules and verification** (AC: 3)
  - Subtask 2.1: Implement redaction for sensitive keys (password, token, api_key, secret, DATABASE_URL, `WDH_*_SALT`).
  - Subtask 2.2: Validate sanitization via targeted unit tests ensuring no raw secrets appear in emitted logs.

- **Task 3: Support stdout + rotating file outputs** (AC: 4)
  - Subtask 3.1: Wire stdout logging (always on) using structlog stdlib adapter.
  - Subtask 3.2: Add optional TimedRotatingFileHandler (daily rotation, 30-day retention) gated by `LOG_TO_FILE`; ensure files land in `logs/`.

- **Task 4: Demonstrate context binding pattern** (AC: 5)
  - Subtask 4.1: Document example usage showing `.bind(domain="annuity", execution_id="exec_123")` and resulting JSON payload.
  - Subtask 4.2: Add unit test ensuring bound context persists across log statements.

- **Task 5: Wire CI coverage and tests** (AC: 6)
  - Subtask 5.1: Create `tests/unit/utils/test_logging.py` validating structure, sanitization, and context binding; mark as `@pytest.mark.unit`.
  - Subtask 5.2: Update `pyproject.toml` / `uv.lock` only if new dependencies are required (e.g., structlog), ensuring `uv run mypy` and `uv run pytest` remain green.]]></tasks>
  </story>

  <acceptanceCriteria><![CDATA[1. **Structlog Logger Module Delivered** – `src/work_data_hub/utils/logging.py` exposes `get_logger(name: str) -> structlog.BoundLogger` plus helpers for binding context (domain, execution_id, step). [Source: docs/tech-spec-epic-1.md#story-13-structured-logging-framework]
2. **Configuration Matches Decision #8** – structlog configured on import with ISO-8601 timestamps, logger name, log level, and JSON renderer processors. [Source: docs/architecture.md#decision-8-structlog-with-sanitization]
3. **Sanitization Guards Sensitive Fields** – helper redacts values for keys containing `password`, `token`, `api_key`, `secret`, `DATABASE_URL`, or `WDH_*_SALT`, with unit tests covering each variant. [Source: docs/tech-spec-epic-1.md#story-13-structured-logging-framework]
4. **Dual Output Targets Supported** – stdout logging always on; optional file logging to `logs/workdatahub-YYYYMMDD.log` with TimedRotatingFileHandler (daily rotation, 30-day retention) gated by `LOG_TO_FILE`. [Source: docs/epics.md#story-13-structured-logging-framework]
5. **Context Binding Demonstrated** – Dev Notes include usage example showing `.bind(domain="annuity", execution_id="exec_123")` and resulting JSON payload with context fields. [Source: docs/tech-spec-epic-1.md#story-13-structured-logging-framework]
6. **Tests Enforced via CI** – `tests/unit/utils/test_logging.py` validates emitted fields, sanitization behavior, and context propagation so Story 1.2 CI gates stay green. [Source: docs/tech-spec-epic-1.md#story-13-structured-logging-framework; docs/stories/1-2-basic-cicd-pipeline-setup.md]]]></acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>WorkDataHub - Epic Breakdown</title>
        <section>Story 1.3: Structured Logging Framework</section>
        <snippet><![CDATA[Epic 1 calls for a centralized structlog implementation with ISO-8601 timestamps, rotation, and factory helpers so every service emits consistent JSON logs.]]></snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Foundation & Core Infrastructure</title>
        <section>AC-1.3.1 – AC-1.3.6</section>
        <snippet><![CDATA[Tech spec enumerates six ACs: deliver `src/utils/logging.py`, configure structlog processors, redact secrets, support optional file logging, demonstrate `.bind()`, and add unit tests.]]></snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-8.1 Structured Logging</section>
        <snippet><![CDATA[FR-8.1 requires every log to include timestamp, level, domain, step, row counts, duration, and error details in JSON while persisting to rotated files under `logs/`.]]></snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture Decisions</title>
        <section>Decision #8: structlog with Sanitization</section>
        <snippet><![CDATA[Decision #8 mandates structlog JSONRenderer + TimeStamper(fmt="iso") with context binding and sanitization to prevent leaking sensitive data.]]></snippet>
      </doc>
      <doc>
        <path>docs/stories/1-2-basic-cicd-pipeline-setup.md</path>
        <title>Story 1.2: Basic CI/CD Pipeline Setup</title>
        <section>CI/CD Quality Gates</section>
        <snippet><![CDATA[Story 1.2 established the strict CI gates (mypy --strict, ruff lint/format, pytest, gitleaks) that this logging module must pass before merge.]]></snippet>
      </doc>
      <doc>
        <path>.github/workflows/ci.yml</path>
        <title>GitHub Actions Workflow</title>
        <section>quality/tests/secrets jobs</section>
        <snippet><![CDATA[Workflow spells out the uv-based jobs for ruff, mypy, pytest, and gitleaks, showing how logging tests will execute in CI.]]></snippet>
      </doc>
      <doc>
        <path>pyproject.toml</path>
        <title>pyproject.toml</title>
        <section>[project] and [project.optional-dependencies]</section>
        <snippet><![CDATA[Project dependencies already include structlog plus strict dev extras (`mypy>=1.17.1`, `ruff>=0.12.12`), so Story 1.3 can rely on structlog while remaining type-safe.]]></snippet>
      </doc>
    </docs>
    <code>
      <codeArtifact>
        <path>src/work_data_hub/domain/pipelines/core.py</path>
        <kind>pipeline-core</kind>
        <symbol>Pipeline / TransformStep</symbol>
        <lines>9-158</lines>
        <reason><![CDATA[Pipeline execution currently uses logging.getLogger; migrating to the central structlog factory preserves metrics context for every step.]]></reason>
      </codeArtifact>
      <codeArtifact>
        <path>src/work_data_hub/auth/eqc_auth_handler.py</path>
        <kind>auth-service</kind>
        <symbol>get_auth_token_interactively</symbol>
        <lines>7-125</lines>
        <reason><![CDATA[EQC auth flow logs browser events and tokens—sanitization must prevent credential leakage when retries happen.]]></reason>
      </codeArtifact>
      <codeArtifact>
        <path>src/work_data_hub/utils/patoken_client.py</path>
        <kind>security-client</kind>
        <symbol>PATokenClient.fetch_once</symbol>
        <lines>1-155</lines>
        <reason><![CDATA[OTP client emits password/pin diagnostics; the new helpers need automatic redaction before logging.]]></reason>
      </codeArtifact>
      <codeArtifact>
        <path>src/work_data_hub/io/loader/warehouse_loader.py</path>
        <kind>warehouse-loader</kind>
        <symbol>DataWarehouseLoader helpers</symbol>
        <lines>1-165</lines>
        <reason><![CDATA[Warehouse loader logs schema/table info; structured logging keeps loader events queryable with context fields.]]></reason>
      </codeArtifact>
      <codeArtifact>
        <path>src/work_data_hub/scripts/migrate_company_mappings.py</path>
        <kind>cli-script</kind>
        <symbol>main()</symbol>
        <lines>1-158</lines>
        <reason><![CDATA[Migration CLI sets up its own logging handlers; the shared logger should keep CLI output consistent with platform standards.]]></reason>
      </codeArtifact>
    </code>
    <dependencies>
      <dependency ecosystem="python" manifest="pyproject.toml"><![CDATA[Python stack uses pyproject.toml with structlog, dagster, pandas, psycopg2-binary, and strict dev extras (`mypy>=1.17.1`, `ruff>=0.12.12`, pytest). `uv sync --dev` installs everything the logger needs while keeping CI reproducible.]]></dependency>
    </dependencies>
  </artifacts>

  <constraints>
      <constraint source="docs/architecture.md#decision-8-structlog-with-sanitization"><![CDATA[All log events must run through structlog with ISO timestamps, logger names, event keys, and structured context; stdlib loggers should wrap the shared factory rather than reconfigure handlers ad hoc.]]></constraint>
      <constraint source="docs/PRD.md#fr-81-structured-logging"><![CDATA[Logs must include domain, pipeline step, row counts, duration, and error metadata in JSON while persisting to rotated files under `logs/` for compliance.]]></constraint>
      <constraint source="docs/stories/1-2-basic-cicd-pipeline-setup.md"><![CDATA[Implementation must remain mypy-strict, ruff-clean, and gitleaks-safe because CI now blocks merges on any failure.]]></constraint>
      <constraint source="docs/epics.md#story-13-structured-logging-framework"><![CDATA[Environment toggles such as `LOG_LEVEL` and `LOG_TO_FILE` should live in the shared logger module so all services reuse the same configuration.]]></constraint>
      <constraint source=".github/workflows/ci.yml"><![CDATA[Quality and test jobs run under uv caching; new logging tests must stay fast and deterministic to keep CI within the existing <2 minute window.]]></constraint>
  </constraints>
  <interfaces>
      <interface>
        <name>Pipeline.execute(row: Row, context: Optional[Dict] = None) -> PipelineResult</name>
        <kind>service-method</kind>
        <signature><![CDATA[Pipeline.execute(row: Row, context: Optional[Dict] = None) -> PipelineResult]]></signature>
        <path>src/work_data_hub/domain/pipelines/core.py#L80-L158</path>
      </interface>
      <interface>
        <name>get_auth_token_interactively(timeout_seconds: int = DEFAULT_TIMEOUT_SECONDS) -> Optional[str]</name>
        <kind>async function</kind>
        <signature><![CDATA[get_auth_token_interactively(timeout_seconds: int = 300) -> Optional[str]]]></signature>
        <path>src/work_data_hub/auth/eqc_auth_handler.py#L26-L125</path>
      </interface>
      <interface>
        <name>PATokenClient.fetch_once(self) -> OTPResult</name>
        <kind>client method</kind>
        <signature><![CDATA[PATokenClient.fetch_once(self) -> OTPResult]]></signature>
        <path>src/work_data_hub/utils/patoken_client.py#L116-L138</path>
      </interface>
  </interfaces>
  <tests>
    <standards><![CDATA[Follow Story 1.2 gates: run `uv run pytest -v -m unit`, keep strict mypy/ruff clean, and ensure logs remain JSON + gitleaks-safe before merging.]]></standards>
    <locations>
        <location>tests/unit/utils/test_logging.py</location>
        <location>tests/unit/**</location>
        <location>tests/integration/** (future extensions)</location>
    </locations>
    <ideas>
        <idea ac="AC-1"><![CDATA[Instantiate `get_logger` twice and assert both are structlog BoundLoggers with TimeStamper + JSONRenderer processors (no duplicate handlers).]]></idea>
        <idea ac="AC-3"><![CDATA[Feed `sanitize_for_logging` dictionaries containing passwords/tokens/DATABASE_URL entries and assert values are replaced with `[REDACTED]`.]]></idea>
        <idea ac="AC-4"><![CDATA[Set `LOG_TO_FILE=1`, emit sample events, and verify a `logs/workdatahub-YYYYMMDD.log` file contains JSON lines.]]></idea>
        <idea ac="AC-5"><![CDATA[Bind `domain="annuity"` and `execution_id="exec_123"`, emit events, and confirm serialized logs include the bound context fields.]]></idea>
    </ideas>
  </tests>
</story-context>
