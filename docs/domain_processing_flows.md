# 核心业务数据处理流程指南（面向新用户）

本文档旨在帮助新成员快速了解本项目中围绕核心业务数据（规模明细 `annuity_performance`、当年中标 `annual_award`、当年流失 `annual_loss`）所建立的 **ETL（数据抽取、转换、加载）**、**Backfill（维表回填）** 及 **MDM（主数据管理）** 系统的处理全貌。

文档结构遵循“由浅入深、由面到点”的原则，依次介绍整体调度架构、核心系统机制，以及各业务领域的特定处理细节。

---

## 一、 整体架构概述（面：宏观视角）

项目采用了基于 [Dagster](https://dagster.io/) 的声明式数据编排引擎。为了提高代码复用率和系统扩展性，上述所有业务领域均接入了统一的泛化执行作业 `generic_domain_job`。

一次完整的数据流转生命周期包含以下 6 个关键阶段：

1. **发现文件 (`discover_files_op`)**
   根据 `config/data_sources.yml` 中的配置项（匹配规则、排除规则），扫描指定路径下的 Excel 报告。在存在多版本文件时，默认采用版本号最大（最高）的内容。
2. **数据读取 (`read_data_op`)**
   统一抽取 Excel 数据。对于需要跨多 Sheet 工作（比如中标/流失分为了“受托”和“投资”两个 Sheet 页）的领域，支持自动多 Sheet 合并解析。
3. **领域流水线处理 (`process_domain_op_v2`)**
   进入各领域专属的 Bronze → Silver（原始到清洗后）数据转换流水线。这一步负责字段重命名、业务规则转换、以及极重要的 **MDM 企业标识解析 (Company ID Resolution)**。
4. **外键维度回填 (`generic_backfill_refs_op`)**
   以配置文件 `config/foreign_keys.yml` 驱动，自动将流水线处理中产出的新维度关联据（如新的客户、计划、组织等）向各个中心维表执行回填操作，保证系统的雪花/星型模型维度完整。
5. **关卡校验 (`gate_after_backfill`)**
   控制流程，确保维表彻底回填完成后，才进行最终的业务事实数据入库。
6. **最终入库 (`load_op`)**
   基于联合主键（在 `data_sources.yml` 中的 `pk` 属性定义），对主业务表进行幂等性的 UPSERT（更新或插入）操作。

---

## 二、 核心系统机制解析（中：机制视角）

在 Bronze → Silver 的转换与维表回填过程中，项目构建了两个极其重要的高级复杂机制：

### 1. MDM 企业标识解析机制 (Company Id Resolution)
各领域的数据通常只有源系统录入的机构名称（可能含有错别字、简称或曾用名）。流水线中的 `CompanyIdResolutionStep` 组件负责将这些脏名称解析为唯一的 `company_id`。
**解析优先级路由：**
1. **YAML 强制覆盖**：最高优先级，查阅人工配置的映射字典处理特殊挂靠或曾用名。
2. **本地 DB 缓存匹配**：基于以往的准确命中历史记录直接解析。
3. **EQC（天眼查/企查查 API）搜索**：调用外部服务进行模糊匹配、全称补齐获取法定企业 ID。
4. **生成临时 ID**：所有手段耗尽后，生成形如 `IN*` 的临时内部 ID 保障流程不断连。

### 2. 高级聚合维表回填机制 (FK Backfill System)
参考 `config/foreign_keys.yml` 的配置，当检测到明细宽表中出现了新的主数据维（如出现了新计划、组合、尤其是客户时），系统会根据 `insert_missing` 的原则自动回填更新各张 Master 表（如 `组织架构`表、`客户明细`表）。
**该机制支持极复杂的聚合运算以浓缩宽表信息到主数据中：**
- `max_by`：基于某个度量（如“计划规模/资产规模”）取最大值对应的条目。例如：一个客户有多笔业务，系统的 **“主拓机构” (Primary branch)** 会自动推举管理规模最大的那个分公司。
- `concat_distinct`：排重拼接。将一个客户身上的多种标签（如 `受托+投资+投管`）拼接为字符串保存在主数据中。
- `count_distinct`：计算唯一项数量（如自动统计某客户名下的关联计划总数）。
- `lambda` 与 `template`：支持将业务产生月份加工成如（"2510中标", "流失客户"）并自动以 JSON Array 等格式持久化记录到 MDM 标签系统中。

---

## 三、 业务领域特定处理逻辑（点：微观视角）

虽然享有相同的引擎骨架，但由于业务属性不同，这三大模块在 `pipeline_builder.py`（转换逻辑）及回填配置上有着各自强烈的特有行为：

### 1. 规模明细 (`annuity_performance`)
代表了持续在管的月度全量业务基底，数据体量大且最为核心。
- **独有清洗逻辑**：
  - 处理特有组合代码问题（提供 QTAN 系列默认值补偿）。
  - 集团企业客户号特殊清洗（剔除不规范的 `"C"` 前缀等）。
- **MDM 回填重点**：
  在触发回填 `fk_customer` 时发挥**压舱石**作用。回填时提供的 `期末资产规模` 值是 MDM 系统判定全公司“主渠道、大本营”等（即聚合机制中的 `max_by` 权重排序字段）的核心算力依据。

### 2. 当年中标 (`annual_award`)
记录公司新辟疆土、获取的新账户。与存量不同，这个领域经常缺少完整年金计划号，只有宽泛的计划类型（单一/集合）和金额。
- **独有清洗逻辑 (`PlanCodeEnrichmentStep`)**：
  当宽表中缺少“年金计划号”时，会拿着解好的 `company_id` 去反查主数表系统（`客户年金计划`表）。并带有智能推断逻辑：如果是集合计划，会优先抓取前缀为 **"P"** (Pooled) 的计划号填入，单一计划则优先抓取 **"S"** (Single)。
- **MDM 回填重点**：
  因缺乏“期末资产体系”，采用 `计划规模` (Plan Scale) 作为 `max_by` 算力权重。同时，通过定制化 `lambda` 代码块，向客户 MDM 系统追加诸如 **"中标客户"** 及时间戳标签（e.g., `2510中标`）。

### 3. 当年流失 (`annual_loss`)
主要处理退费、销局的客户记录。
- **关联特有逻辑**：
  与 `annual_award` 在构型上高度镜像，同样多了一层使用 `PlanCodeEnrichmentStep` 反查系统来推测并补齐缺失的年金计划号的操作。
- **MDM 回填重点**：
  利用聚合配置，系统会在回填期间自动为退回的实体在标签列 (Tags / Customer Type) 中牢牢打上 **"流失客户"** 以及时间戳标签（e.g., `2510流失`），极大地丰富了后续分析维度和防流失挽回机制的洞察力。

---

## 四、 月度快照与客户状态评定机制 (Status Evaluation & Snapshot)

在各领域数据完成 ETL 并回填到核心维度后，项目还会基于 `customer."客户年金计划"` 表（承载有效资产及计划明细的底表）自动生成反映客户最终留存情况的分析依据：**月度快照 (Monthly Snapshot)**。

目前的快照刷新流程 (`snapshot_refresh.py`) 提供了两张事实表导出：
1. **客户业务月度快照** (`ProductLine` 粒度)：用于判定客户在具体产品线（如“企年受托”、“企年投资”）上的最终业务状态标签与总规模。
2. **客户计划月度快照** (`Plan` 粒度)：用于更细化地观察单个年金计划的具体盈亏与合同状态。

### 关键客户状态判定逻辑 (Config-driven Status Evaluation)

系统避免了硬编码判断客户“是新客还是流失客”，而是通过一套纯配置驱动 (`config/customer_status_rules.yml`) 结合 `StatusEvaluator` 引擎自动生成评定规则。快照表中几个高度核心的状态与规模字段生成逻辑如下：

- **is_winning_this_year (新中标 / 本年新增)**
  **评定逻辑**：使用 `exists_in_year` 算子检测该客户（`company_id`）及对应产品线下，在当年份的 `中标客户明细` (annual_award) 表中是否**存在记录**。
- **is_loss_reported (申报流失)**
  **评定逻辑**：与中标类似，检测当年份的 `流失客户明细` (annual_loss) 表中是否存在报备。
- **is_churned_this_year (已流失)**
  **评定逻辑**：由于流失可能会在业务级（产品线全退）或计划级（退某个单一百科）发生，快照引擎灵活支持判断不同层级是否存在 `annual_loss` 记录而判定真流失。
- **is_new (新客到账)**
  **评定逻辑**：系统内采用了组合算子判定，必须满足 `is_winning_this_year = True`（当年发生过中标操作）且 `is_existing = False`（历史没有有效存量业务）。
- **aum_balance (月度确权资产管理规模)**
  **评定逻辑**：并非简单拷贝配置，而是通过按快照当月日期，跨 schema 下沉查询 `business."规模明细"` (annuity_performance) 表中，严格针对由 `company_id + 产品线代码` 限定的颗粒度执行 `SUM(期末资产规模)` 的实时汇总。

> **点金**：三大业务流负责制造与清洗（入湖），MDM系统负责拉通孤岛（关联），而**月度快照与状态评估机制**最终把异构系统的数据拍在一个时间切片上，生产出能直接服务于管理驾驶舱分析的终端成果。

---

## 五、 总结

对于接手该项目的新开发者或数据分析师，可以通过以下思路顺藤摸瓜排查问题：
1. **看文件漏读或错读**：去查 `config/data_sources.yml` 的 glob path 规则与多 Sheet 配置。
2. **看业务字段计算不对（如日期没解出、业务类型张冠李戴）**：去查对应领域下的 `src/work_data_hub/domain/[domain名]/pipeline_builder.py` 里面定义的 Bronze → Silver DataFrame Transform Steps。
3. **看中心维表没更新、主数据抓错了大头（比方说某客户归属分公司不对）**：去查 `config/foreign_keys.yml` 里面极其丰富的 Aggregation 聚合引擎规则与 `max_by` 参照系（多数为规模大小）。
