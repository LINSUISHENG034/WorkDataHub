# 年金计划类型与客户名称业务背景

**文档版本:** 1.0
**创建日期:** 2026-01-01
**业务域:** 年金业务 - ETL 处理
**相关域:** annuity_income（收入明细）、annuity_performance（规模明细）

---

## 📋 业务概述

### 核心业务概念

在年金业务 ETL 处理中，**计划类型**字段是核心的业务分类维度，它决定了：
- 计划代码与客户的关联关系
- 客户名称字段的填写规则
- Company ID 解析的业务逻辑

**关键认知：**
- 单一计划和集合计划的客户名称为空**不是数据缺陷**，而是符合业务规则的正常现象
- 不同计划类型需要差异化的 ETL 处理策略

---

## 🏢 年金计划类型详解

### 1. 单一计划（Single Plan）

#### 业务定义
**单一计划**是指由**单一企业客户**发起设立的企业年金计划。

**核心特征：**
- **一一对应关系：** 一个计划代码对应唯一的企业客户
- **客户唯一性：** 计划中的所有资产归属于同一企业
- **管理简单性：** 客户关系管理、账户管理相对简单

#### 计划名称命名规则

**标准格式：**
```
{公司全称}企业年金计划
```

**示例：**
| 计划代码 | 计划名称 | 提取的公司名称 |
|---------|---------|--------------|
| S6544 | 中关村发展集团股份有限公司**企业年金计划** | 中关村发展集团股份有限公司 |
| XNP707 | 山东重工集团有限公司**企业年金计划** | 山东重工集团有限公司 |
| XNP732 | 上海浦东发展银行股份有限公司**企业年金计划** | 上海浦东发展银行股份有限公司 |

**提取规则：**
- 去除后缀 "企业年金计划" → 获得公司全称
- 提取的公司名称可用于 EQC API 查询

#### 客户名称字段特征

**数据分布（202510 期间统计）：**
- 总记录数：12,109 条
- **有客户名称：** 1,544 条（12.8%）
- **无客户名称：** 10,565 条（87.2%）

**业务解释：**
- 客户名称为空**是正常现象**，因为：
  1. 源数据系统可能不强制填写客户名称（通过计划代码即可识别）
  2. 业务人员更关注计划代码，而非重复填写客户名称
  3. 计划名称已包含公司信息

**ETL 处理策略：**
1. ✅ **优先级 1：** 使用计划代码（plan_code）查找 company_id
2. ✅ **优先级 2：** 从计划名称提取公司名称 → EQC API 查询
3. ✅ **优先级 3：** 使用年金账户号、年金账户名等字段查找
4. ⚠️ **兜底方案：** 生成临时 company_id（待后续异步解析）

---

### 2. 集合计划（Collective Plan）

#### 业务定义
**集合计划**是指由**多个企业客户**共同参与的企业年金计划。

**核心特征：**
- **一对多关系：** 一个计划代码包含多个企业客户
- **客户多样性：** 计划中的资产归属于不同企业
- **管理复杂性：** 需要通过组合代码（portfolio_code）细分到具体企业

#### 计划名称命名规则

**标准格式：**
```
{计划品牌}企业年金集合计划
```

**示例：**
| 计划代码 | 计划名称 | 计划品牌 |
|---------|---------|---------|
| P0190 | 平安相伴今生**企业年金集合计划** | 平安相伴今生 |
| P0401 | 平安阳光人生**企业年金集合计划** | 平安阳光人生 |
| P0601 | 平安精致人生**企业年金集合计划** | 平安精致人生 |

**命名特点：**
- 计划名称反映**品牌名称**，而非具体企业客户
- 无法从计划名称中提取单一的公司名称
- 一个集合计划下通常包含多个组合代码，每个组合对应一个客户

#### 客户名称字段特征

**数据分布（202510 期间统计）：**
- 总记录数：1,530 条
- **有客户名称：** 0 条（0%）
- **无客户名称：** 1,530 条（100%）

**业务解释：**
- **100% 无客户名称是符合业务规则的**
- 原因：集合计划不属于单一企业，客户名称字段无意义
- 客户信息通过组合代码（portfolio_code）关联

**ETL 处理策略：**
1. ✅ **正确行为：** 不从计划名称提取公司名称（因为无意义）
2. ✅ **Company ID 处理：** 允许为 NULL 或使用临时 ID
3. ✅ **关键字段：** 依赖组合代码（portfolio_code）关联具体客户

---

## 📊 业务规则总结

### 计划类型对比表

| 维度 | 单一计划 | 集合计划 |
|-----|---------|---------|
| **客户数量** | 1 个企业 | 多个企业 |
| **计划代码-客户关系** | 一对一 | 一对多 |
| **客户名称字段** | 可选（通常为空） | 必须为空 |
| **计划名称格式** | {公司名称}企业年金计划 | {品牌名}企业年金集合计划 |
| **能否从计划名称提取公司** | ✅ 可以 | ❌ 不可以 |
| **Company ID 解析** | 优先从计划名称提取 | 使用 NULL 或临时 ID |
| **数据分布（202510）** | 12,109 条（87.2% 无客户名称） | 1,530 条（100% 无客户名称） |

### 关键业务规则

**规则 1：计划名称语义**
```
IF 计划类型 = "单一计划" THEN
    计划名称 = "{公司全称}企业年金计划"
    计划名称 → 可提取公司名称
ELSE IF 计划类型 = "集合计划" THEN
    计划名称 = "{品牌名}企业年金集合计划"
    计划名称 → 不包含具体公司信息
END IF
```

**规则 2：客户名称为空的业务含义**
```
IF 计划类型 = "单一计划" AND 客户名称为空 THEN
    业务含义：通过计划代码即可识别客户
    处理策略：从计划名称提取公司名称
ELSE IF 计划类型 = "集合计划" AND 客户名称为空 THEN
    业务含义：集合计划不属于单一企业
    处理策略：不提取，允许 Company ID 为 NULL
END IF
```

**规则 3：Company ID 解析优先级（单一计划）**
```
优先级 1：plan_code → company_id（最快）
优先级 2：客户名称（customer_name）→ company_id
优先级 3：从计划名称提取 → EQC API 查询
优先级 4：年金账户号（account_number）→ company_id
优先级 5：生成临时 company_id（HMAC-SHA1）
```

---

## 🔍 业务场景示例

### 场景 1：单一计划 - 客户名称为空

**源数据：**
```
计划代码: S6544
计划名称: 中关村发展集团股份有限公司企业年金计划
客户名称: [空]
计划类型: 单一计划
```

**业务判断：**
1. ✅ 客户名称为空是正常现象
2. ✅ 计划名称包含完整公司名称
3. ✅ 可以从计划名称提取："中关村发展集团股份有限公司"

**ETL 处理：**
```
步骤 1: 提取公司名称
  → "中关村发展集团股份有限公司"

步骤 2: 调用 EQC API 查询
  → company_id = "600093406"

步骤 3: 写入 enrichment_index
  → lookup_key = "中关村发展集团股份有限公司"
  → lookup_type = "customer_name"
  → company_id = "600093406"
```

### 场景 2：集合计划 - 客户名称为空

**源数据：**
```
计划代码: P0190
计划名称: 平安相伴今生企业年金集合计划
客户名称: [空]
计划类型: 集合计划
```

**业务判断：**
1. ✅ 客户名称为空是符合规则的
2. ✅ 计划名称是品牌名称，不包含具体企业
3. ✅ **不应该**从计划名称提取公司名称

**ETL 处理：**
```
步骤 1: 判断计划类型
  → "集合计划"

步骤 2: 跳过计划名称提取
  → 不提取（品牌名称非企业名称）

步骤 3: Company ID 处理
  → 使用 NULL 或临时 ID（如 IN7KZNPWPCVQXJ6AY7）
```

---

## 📈 数据质量指标

### 客户名称为空的比例（202510 期间）

| 计划类型 | 总记录数 | 无客户名称记录 | 占比 | 业务评价 |
|---------|---------|-------------|------|---------|
| 单一计划 | 12,109 | 10,565 | 87.2% | ✅ 正常 |
| 集合计划 | 1,530 | 1,530 | 100% | ✅ 符合预期 |

**关键结论：**
- **高比例的客户名称为空是业务特征，不是数据质量问题**
- ETL 处理逻辑应适应这一业务特征，而非强制填充

### Company ID 解析成功率（202510 期间）

| 计划类型 | 总记录数 | 正式 Company ID | 临时 Company ID | 成功率 |
|---------|---------|---------------|----------------|-------|
| 单一计划（无客户名称） | 10,565 | 10,268 | 297 | 97.2% |
| 集合计划（无客户名称） | 1,530 | 0 | 1,530 | N/A* |

*注：集合计划使用临时 ID 是预期行为，不代表解析失败。

---

## 🎯 业务需求映射

### 核心业务需求

**需求 1：单一计划 - 计划名称回退**
```
业务场景：单一计划客户名称为空时，应从计划名称提取公司名称
触发条件：
  1. 计划类型 = "单一计划"
  2. 客户名称为空（NULL 或空字符串）
  3. 计划名称不为空
  4. 多优先级匹配未找到 Company ID

处理动作：
  1. 从计划名称提取公司名称（去除 "企业年金计划" 后缀）
  2. 调用 EQC API 查询真实的 Company ID
  3. 将查询结果写入 enrichment_index（供后续复用）
```

**需求 2：集合计划 - 允许 NULL**
```
业务场景：集合计划不属于单一企业，应允许 Company ID 为 NULL
触发条件：
  1. 计划类型 = "集合计划"
  2. 多优先级匹配未找到 Company ID

处理动作：
  1. 不从计划名称提取公司名称（避免误提取品牌名称）
  2. 允许 Company ID 为 NULL 或使用临时 ID
```

---

## 🔗 相关文档

### 业务文档
- [ETL 执行命令参考](../../project-context.md#cli-常用命令) - ETL 命令参数说明
- [Domain Registry 架构](../../project-context.md#6-domain-registry-架构) - 域注册表架构

### 技术文档
- [客户名称为空的处理方案](../specific/customer/empty-customer-name-plan-type-handling.md) - 技术实现方案
- [Plan Code Backflow 缺陷分析](../specific/customer/plan-code-backflow-missing.md) - 技术问题分析

### 数据模型
- [Database Schema Panorama](../../database-schema-panorama.md) - 数据库表结构
- [收入明细表结构](../../database-schema-panorama.md#2-schema-business) - business.收入明细

---

## 📝 变更历史

| 版本 | 日期 | 作者 | 变更说明 |
|-----|------|------|---------|
| 1.0 | 2026-01-01 | Barry (Quick Flow Agent) | 初始版本，提取业务背景知识 |

---

## 🏷️ 标签

`business-background` `annuity` `single-plan` `collective-plan` `plan-type` `customer-name` `etl`
