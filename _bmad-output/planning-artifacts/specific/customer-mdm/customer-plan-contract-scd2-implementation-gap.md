# customer_plan_contract è¡¨ SCD Type 2 å®ç°å·®è·åˆ†æ

> **ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¥æœŸ**: 2026-02-03
> **çŠ¶æ€**: å¾…å®¡æ ¸
> **å…³è”Story**: 7.6-6 Contract Status Sync (Post-ETL Hook)

---

## 1. é—®é¢˜æ¦‚è¿°

### 1.1 é—®é¢˜å‘ç°

åœ¨å®¡æ ¸ Story 7.6-6 å®ç°æ—¶å‘ç°ï¼Œ`customer.customer_plan_contract` è¡¨çš„**è®¾è®¡æ„å›¾**ä¸**å®é™…å®ç°**å­˜åœ¨æ˜¾è‘—å·®è·ã€‚

### 1.2 é—®é¢˜å®šæ€§

| ç»´åº¦ | è¯„ä¼° |
|------|------|
| **ä¸¥é‡ç¨‹åº¦** | ğŸ”´ é«˜ â€” æ ¸å¿ƒåŠŸèƒ½æœªæŒ‰è®¾è®¡å®ç° |
| **å½±å“èŒƒå›´** | åˆçº¦çŠ¶æ€å†å²è¿½æº¯ã€BI æŠ¥è¡¨å‡†ç¡®æ€§ |
| **ä¿®å¤å¤æ‚åº¦** | ä¸­ç­‰ â€” éœ€é‡æ„ `contract_sync.py` æ ¸å¿ƒé€»è¾‘ |

---

## 2. è®¾è®¡æ„å›¾ vs å®é™…å®ç°

### 2.1 è®¾è®¡æ„å›¾ (æ¥æº: è§„èŒƒæ–‡æ¡£)

æ ¹æ® `customer-plan-contract-specification.md` ç¬¬ 5.3 èŠ‚ï¼š

> **SCD Type 2 å®ç°é€»è¾‘**ï¼šå½“å®¢æˆ·çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå…³é—­æ—§è®°å½•å¹¶æ’å…¥æ–°è®°å½•ã€‚

```sql
-- è®¾è®¡æ„å›¾ï¼šçŠ¶æ€å˜åŒ–æ—¶çš„å¤„ç†é€»è¾‘
-- Step 1: å…³é—­æ—§è®°å½•
UPDATE customer.customer_plan_contract
SET valid_to = :snapshot_date - INTERVAL '1 day',
    updated_at = CURRENT_TIMESTAMP
WHERE company_id = :company_id
  AND plan_code = :plan_code
  AND product_line_code = :product_line_code
  AND valid_to = '9999-12-31';

-- Step 2: æ’å…¥æ–°è®°å½•
INSERT INTO customer.customer_plan_contract (...)
VALUES (..., :new_status, :snapshot_date, '9999-12-31');
```

**æœŸæœ›è¡Œä¸º**ï¼š
- æ¯æ¬¡çŠ¶æ€å˜åŒ–äº§ç”Ÿæ–°ç‰ˆæœ¬è®°å½•
- æ—§ç‰ˆæœ¬ `valid_to` è¢«æ›´æ–°ä¸ºå˜æ›´å‰ä¸€å¤©
- å¯æŸ¥è¯¢ä»»æ„æ—¶é—´ç‚¹çš„åˆçº¦çŠ¶æ€

### 2.2 å®é™…å®ç° (æ¥æº: contract_sync.py)

```python
# contract_sync.py:176-178
ON CONFLICT (company_id, plan_code, product_line_code, valid_to)
DO NOTHING  -- å·²å­˜åœ¨åˆ™è·³è¿‡
```

**å®é™…è¡Œä¸º**ï¼š
- ä»…æ’å…¥é¦–æ¬¡å‡ºç°çš„è®°å½•
- å·²å­˜åœ¨çš„åˆçº¦**æ°¸ä¸æ›´æ–°**
- çŠ¶æ€å˜åŒ–**ä¸ä¼šè¢«æ•è·**

### 2.3 å¯¹æ¯”æ€»ç»“

| ç»´åº¦ | è®¾è®¡æ„å›¾ (SCD Type 2) | å®é™…å®ç° |
|------|----------------------|----------|
| **æ–°åˆçº¦** | æ’å…¥æ–°è®°å½• | âœ… æ­£ç¡® |
| **çŠ¶æ€å˜åŒ–** | å…³é—­æ—§ç‰ˆæœ¬ + æ’å…¥æ–°ç‰ˆæœ¬ | âŒ ä¸å¤„ç† |
| **å†å²æŸ¥è¯¢** | æ”¯æŒä»»æ„æ—¶é—´ç‚¹æŸ¥è¯¢ | âŒ ä»…é¦–æ¬¡çŠ¶æ€ |
| **å¹‚ç­‰æ€§** | éœ€è¦çŠ¶æ€æ¯”å¯¹é€»è¾‘ | âœ… ç®€å•å¹‚ç­‰ (DO NOTHING) |

---

## 3. é—®é¢˜è¯¦ç»†åˆ†æ

### 3.1 åœºæ™¯å¤ç°

**æµ‹è¯•æ•°æ®**ï¼š

| æœˆåº¦ | company_id | plan_code | product_line_code | æœŸæœ«èµ„äº§è§„æ¨¡ | 12ä¸ªæœˆä¾›æ¬¾ |
|------|------------|-----------|-------------------|--------------|------------|
| 2025-06 | C001 | P001 | PL201 | 1äº¿ | æœ‰ |
| 2025-12 | C001 | P001 | PL201 | 1äº¿ | **æ— ** |

**æœŸæœ›ç»“æœ** (SCD Type 2)ï¼š

| contract_id | company_id | plan_code | contract_status | valid_from | valid_to |
|-------------|------------|-----------|-----------------|------------|----------|
| 1 | C001 | P001 | **æ­£å¸¸** | 2025-06-30 | **2025-11-30** |
| 2 | C001 | P001 | **åœç¼´** | 2025-12-31 | 9999-12-31 |

**å®é™…ç»“æœ** (å½“å‰å®ç°)ï¼š

| contract_id | company_id | plan_code | contract_status | valid_from | valid_to |
|-------------|------------|-----------|-----------------|------------|----------|
| 1 | C001 | P001 | **æ­£å¸¸** | 2025-06-30 | 9999-12-31 |

> âš ï¸ çŠ¶æ€ä»"æ­£å¸¸"å˜ä¸º"åœç¼´"ï¼Œä½†è¡¨ä¸­ä»æ˜¾ç¤º"æ­£å¸¸"

### 3.2 æ ¹å› åˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ ¹å› åˆ†æ                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. å”¯ä¸€çº¦æŸè®¾è®¡é—®é¢˜                                              â”‚
â”‚     UNIQUE (company_id, plan_code, product_line_code, valid_to)  â”‚
â”‚     â””â”€ valid_to = '9999-12-31' æ—¶ï¼ŒåŒä¸€ä¸šåŠ¡é”®åªèƒ½æœ‰ä¸€æ¡è®°å½•       â”‚
â”‚                                                                  â”‚
â”‚  2. å†™å…¥ç­–ç•¥é—®é¢˜                                                  â”‚
â”‚     ON CONFLICT DO NOTHING                                       â”‚
â”‚     â””â”€ å·²å­˜åœ¨è®°å½•æ—¶ç›´æ¥è·³è¿‡ï¼Œä¸åšä»»ä½•å¤„ç†                         â”‚
â”‚                                                                  â”‚
â”‚  3. ç¼ºå¤±çŠ¶æ€æ¯”å¯¹é€»è¾‘                                              â”‚
â”‚     â””â”€ æœªæ£€æµ‹å½“å‰çŠ¶æ€ä¸å·²å­˜å‚¨çŠ¶æ€æ˜¯å¦ä¸€è‡´                         â”‚
â”‚     â””â”€ æœªå®ç°"å…³é—­æ—§ç‰ˆæœ¬"çš„ UPDATE æ“ä½œ                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 å—å½±å“çš„å­—æ®µ

ä»¥ä¸‹å­—æ®µåœ¨çŠ¶æ€å˜åŒ–æ—¶**ä¸ä¼šè¢«æ›´æ–°**ï¼š

| å­—æ®µ | å˜åŒ–åœºæ™¯ | å½±å“ |
|------|----------|------|
| `contract_status` | æ­£å¸¸â†’åœç¼´ã€åœç¼´â†’æ­£å¸¸ | BI æŠ¥è¡¨æ˜¾ç¤ºé”™è¯¯çŠ¶æ€ |
| `is_strategic` | å¹´åº¦åˆå§‹åŒ–æ—¶æˆ˜å®¢åå•å˜åŒ– | æˆ˜å®¢ç»Ÿè®¡ä¸å‡†ç¡® |
| `is_existing` | å¹´åº¦åˆå§‹åŒ–æ—¶å·²å®¢åˆ¤å®šå˜åŒ– | æ–°å®¢/å·²å®¢åˆ†ç±»é”™è¯¯ |

---

## 4. å½±å“åˆ†æ

### 4.1 ä¸šåŠ¡å½±å“

| å½±å“é¢†åŸŸ | æè¿° | ä¸¥é‡ç¨‹åº¦ |
|----------|------|----------|
| **BI æŠ¥è¡¨** | åˆçº¦çŠ¶æ€æ˜¾ç¤ºä¸å‡†ç¡®ï¼Œæ— æ³•åæ˜ æœ€æ–°çŠ¶æ€ | ğŸ”´ é«˜ |
| **å†å²è¿½æº¯** | æ— æ³•æŸ¥è¯¢"æŸå®¢æˆ·åœ¨æŸæ—¶é—´ç‚¹çš„çŠ¶æ€" | ğŸ”´ é«˜ |
| **æˆ˜å®¢ç»Ÿè®¡** | æˆ˜å®¢åå•å˜åŒ–ä¸ä¼šè¢«è®°å½• | ğŸŸ¡ ä¸­ |
| **æ•°æ®ä¸€è‡´æ€§** | ä¸ `business.è§„æ¨¡æ˜ç»†` æºæ•°æ®ä¸ä¸€è‡´ | ğŸ”´ é«˜ |

### 4.2 ä¸‹æ¸¸ä¾èµ–å½±å“

```
customer.customer_plan_contract (é—®é¢˜è¡¨)
         â”‚
         â–¼
customer.fct_customer_business_monthly_status (æœˆåº¦å¿«ç…§è¡¨)
         â”‚
         â–¼
Power BI æŠ¥è¡¨ (æœ€ç»ˆç”¨æˆ·)
```

> å¦‚æœ `customer_plan_contract` çŠ¶æ€ä¸å‡†ç¡®ï¼Œä¸‹æ¸¸ `fct_customer_business_monthly_status` å¿«ç…§ä¹Ÿä¼šç»§æ‰¿é”™è¯¯æ•°æ®ã€‚

---

## 5. ä¿®å¤æ–¹æ¡ˆå»ºè®®

### 5.1 æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æè¿° | å¤æ‚åº¦ | æ¨è |
|------|------|--------|------|
| **A. å®Œæ•´ SCD Type 2** | æ£€æµ‹å˜åŒ– â†’ å…³é—­æ—§ç‰ˆæœ¬ â†’ æ’å…¥æ–°ç‰ˆæœ¬ | é«˜ | âœ… æ¨è |
| **B. ç®€åŒ– UPSERT** | `ON CONFLICT DO UPDATE` è¦†ç›–æ›´æ–° | ä½ | âŒ ä¸¢å¤±å†å² |
| **C. æ··åˆæ–¹æ¡ˆ** | å½“å‰è®°å½• UPSERT + å†å²è¡¨å½’æ¡£ | ä¸­ | ğŸŸ¡ å¯é€‰ |

### 5.2 æ¨èæ–¹æ¡ˆï¼šå®Œæ•´ SCD Type 2 å®ç°

#### 5.2.1 æ ¸å¿ƒé€»è¾‘ä¼ªä»£ç 

```python
def sync_contract_status_scd2(snapshot_date: date):
    """SCD Type 2 åˆçº¦çŠ¶æ€åŒæ­¥"""

    # Step 1: è®¡ç®—å½“å‰æœˆåº¦çš„æœ€æ–°çŠ¶æ€
    new_status_records = calculate_current_status(snapshot_date)

    for record in new_status_records:
        business_key = (record.company_id, record.plan_code, record.product_line_code)

        # Step 2: æŸ¥è¯¢å½“å‰æœ‰æ•ˆè®°å½•
        current_record = get_active_record(business_key)

        if current_record is None:
            # Case A: æ–°åˆçº¦ â†’ ç›´æ¥æ’å…¥
            insert_new_record(record, valid_from=snapshot_date)

        elif has_status_changed(current_record, record):
            # Case B: çŠ¶æ€å˜åŒ– â†’ å…³é—­æ—§ç‰ˆæœ¬ + æ’å…¥æ–°ç‰ˆæœ¬
            close_record(current_record, valid_to=snapshot_date - 1 day)
            insert_new_record(record, valid_from=snapshot_date)

        else:
            # Case C: çŠ¶æ€æœªå˜ â†’ è·³è¿‡
            pass
```

#### 5.2.2 çŠ¶æ€å˜åŒ–æ£€æµ‹å­—æ®µ

```python
def has_status_changed(old: Record, new: Record) -> bool:
    """æ£€æµ‹éœ€è¦è§¦å‘ç‰ˆæœ¬æ›´æ–°çš„å­—æ®µ"""
    return (
        old.contract_status != new.contract_status or
        old.is_strategic != new.is_strategic or
        old.is_existing != new.is_existing
    )
```

#### 5.2.3 SQL å®ç°å‚è€ƒ

```sql
-- Step 1: å…³é—­çŠ¶æ€å·²å˜åŒ–çš„æ—§è®°å½•
UPDATE customer.customer_plan_contract AS old
SET valid_to = :snapshot_date - INTERVAL '1 day',
    updated_at = CURRENT_TIMESTAMP
FROM (
    -- è®¡ç®—å½“å‰æœˆåº¦æœ€æ–°çŠ¶æ€çš„å­æŸ¥è¯¢
    SELECT company_id, plan_code, product_line_code,
           new_contract_status, new_is_strategic, new_is_existing
    FROM ... -- çŠ¶æ€è®¡ç®—é€»è¾‘
) AS new
WHERE old.company_id = new.company_id
  AND old.plan_code = new.plan_code
  AND old.product_line_code = new.product_line_code
  AND old.valid_to = '9999-12-31'
  AND (
      old.contract_status != new.new_contract_status OR
      old.is_strategic != new.new_is_strategic OR
      old.is_existing != new.new_is_existing
  );

-- Step 2: æ’å…¥æ–°ç‰ˆæœ¬è®°å½• (åŒ…æ‹¬æ–°åˆçº¦å’ŒçŠ¶æ€å˜åŒ–çš„åˆçº¦)
INSERT INTO customer.customer_plan_contract (...)
SELECT ...
FROM ... -- çŠ¶æ€è®¡ç®—é€»è¾‘
WHERE NOT EXISTS (
    -- æ’é™¤çŠ¶æ€æœªå˜åŒ–çš„å·²å­˜åœ¨è®°å½•
    SELECT 1 FROM customer.customer_plan_contract existing
    WHERE existing.company_id = ...
      AND existing.plan_code = ...
      AND existing.product_line_code = ...
      AND existing.valid_to = '9999-12-31'
      AND existing.contract_status = new.contract_status
      AND existing.is_strategic = new.is_strategic
      AND existing.is_existing = new.is_existing
);
```

### 5.3 ä¿®å¤åçš„é¢„æœŸè¡Œä¸º

| åœºæ™¯ | æ“ä½œ | ç»“æœ |
|------|------|------|
| æ–°åˆçº¦é¦–æ¬¡å‡ºç° | INSERT | æ–°è®°å½• `valid_to = 9999-12-31` |
| çŠ¶æ€å˜åŒ– (æ­£å¸¸â†’åœç¼´) | UPDATE + INSERT | æ—§è®°å½•å…³é—­ï¼Œæ–°è®°å½•ç”Ÿæ•ˆ |
| çŠ¶æ€æœªå˜åŒ– | æ— æ“ä½œ | ä¿æŒç°æœ‰è®°å½• |
| åˆçº¦æ¶ˆå¤± (è§„æ¨¡=0) | å¯é€‰: UPDATE | å…³é—­è®°å½• (å¾…å†³ç­–) |

---

## 6. å®æ–½å»ºè®®

### 6.1 ä¿®å¤ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | è¯´æ˜ |
|--------|------|------|
| P0 | ä¿®å¤ `contract_sync.py` æ ¸å¿ƒé€»è¾‘ | å®ç°å®Œæ•´ SCD Type 2 |
| P1 | å†å²æ•°æ®ä¿®å¤ | é‡æ–°è®¡ç®—å·²å­˜å‚¨çš„é”™è¯¯çŠ¶æ€ |
| P2 | æ·»åŠ å•å…ƒæµ‹è¯• | è¦†ç›–çŠ¶æ€å˜åŒ–åœºæ™¯ |
| P3 | æ›´æ–°æ–‡æ¡£ | åŒæ­¥è§„èŒƒæ–‡æ¡£ä¸å®ç° |

### 6.2 æµ‹è¯•éªŒæ”¶æ ‡å‡†

- [ ] æ–°åˆçº¦æ­£ç¡®æ’å…¥
- [ ] çŠ¶æ€å˜åŒ–æ—¶äº§ç”Ÿæ–°ç‰ˆæœ¬è®°å½•
- [ ] æ—§ç‰ˆæœ¬ `valid_to` æ­£ç¡®æ›´æ–°
- [ ] å¯æŸ¥è¯¢ä»»æ„å†å²æ—¶é—´ç‚¹çš„åˆçº¦çŠ¶æ€
- [ ] å¹‚ç­‰æ€§ï¼šé‡å¤æ‰§è¡Œä¸äº§ç”Ÿé‡å¤è®°å½•

### 6.3 å›å½’é£é™©

| é£é™©ç‚¹ | ç¼“è§£æªæ–½ |
|--------|----------|
| å†å²æ•°æ®ä¸ä¸€è‡´ | æä¾›æ•°æ®ä¿®å¤è„šæœ¬ |
| æ€§èƒ½ä¸‹é™ | ä¼˜åŒ–çŠ¶æ€æ¯”å¯¹æŸ¥è¯¢ï¼Œä½¿ç”¨æ‰¹é‡æ“ä½œ |
| ä¸‹æ¸¸ä¾èµ–ä¸­æ–­ | ç¡®ä¿ `valid_to = 9999-12-31` æŸ¥è¯¢å…¼å®¹ |

---

## 7. é™„å½•

### 7.1 ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| è§„èŒƒæ–‡æ¡£ | `docs/specific/customer-mdm/customer-plan-contract-specification.md` | è®¾è®¡æ„å›¾ |
| å®ç°ä»£ç  | `src/work_data_hub/customer_mdm/contract_sync.py` | å½“å‰å®ç° |
| Alembic è¿ç§» | `io/schema/migrations/versions/008_create_customer_plan_contract.py` | è¡¨ç»“æ„ |
| é…ç½®æ–‡ä»¶ | `config/customer_mdm.yaml` | æˆ˜å®¢é˜ˆå€¼ç­‰å‚æ•° |

### 7.2 ä¿®è®¢å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®è®¢å†…å®¹ |
|------|------|----------|
| v1.0 | 2026-02-03 | åˆç¨¿ï¼Œå®Œæ•´é—®é¢˜æè¿°å’Œä¿®å¤æ–¹æ¡ˆ |
