# Epic 6.2 Implementation Gap: Temporary Company ID Strategy

**Date:** 2025-12-12
**Status:** Open
**Component:** Company Enrichment Service (`lookup_queue.py`)

## 1. Issue Summary
There is a critical divergence between the architectural requirement for Temporary ID generation (Story 6.2) and the current code implementation. 

- **Requirement:** Stateless, deterministic **HMAC-SHA1** hash based on company name (e.g., `IN_<base32_hash>`).
- **Implementation:** Stateful, non-deterministic **Database Sequence** (e.g., `TEMP_<000001>`).

## 2. Requirement Source
**Source:** `docs/epics/epic-6-company-enrichment-service.md` (Story 6.2)

> **Goal:** Stable temporary IDs for unresolved companies using HMAC.
> **So that:** Same company always maps to same temporary ID across runs, enabling consistent joins.
>
> **Acceptance Criteria:**
> * Generate stable ID: `HMAC_SHA1(WDH_ALIAS_SALT, "Company Name")` â†’ Base32 encode
> * Same input always produces same ID (deterministic)
> * Prefix `IN_` distinguishes temporary from real company IDs

## 3. Current Implementation Analysis
**File:** `src/work_data_hub/domain/company_enrichment/lookup_queue.py`

The current `get_next_temp_id` method uses a PostgreSQL sequence (`enterprise.temp_id_sequence`):

```python
# Current Code Logic
sql = """
    UPDATE enterprise.temp_id_sequence
    SET last_number = last_number + 1, updated_at = now()
    RETURNING last_number
"""
# Result: "TEMP_000123"
```

## 4. Impact Assessment
The current sequence-based approach creates the following risks:
1.  **Non-Idempotent:** Re-running the pipeline generates different IDs for the same unknown company (`TEMP_001` vs `TEMP_002`), breaking join consistency across runs.
2.  **Environment Inconsistency:** Staging and Production will generate different IDs for the exact same company name, making debugging difficult.
3.  **State Dependency:** Requires maintaining a database sequence state; resetting the DB resets the sequence, potentially causing ID collisions with previously exported reports.

## 5. Remediation Plan (Refactoring)
To align with Epic 6.2, the `LookupQueue.get_next_temp_id` method needs to be refactored to:

1.  **Accept Input:** Update signature to accept `company_name` (currently it takes no arguments).
2.  **Remove DB Dependency:** Remove the SQL query to `temp_id_sequence`.
3.  **Implement HMAC Logic:**
    *   Load `WDH_ALIAS_SALT` from configuration.
    *   Normalize company name (trim, lower).
    *   Compute HMAC-SHA1 digest.
    *   Base32 encode to generate `IN_...` ID.
4.  **Update Call Sites:** Update `CompanyEnrichmentService.resolve_company_id` to pass the `customer_name` when calling `get_next_temp_id`.

## 6. Code Snippet for Fix
```python
import hmac
import hashlib
import base64
import os

def generate_temp_id(company_name: str) -> str:
    salt = os.getenv("WDH_ALIAS_SALT", "default_dev_salt")
    normalized = company_name.strip().lower()
    digest = hmac.new(salt.encode(), normalized.encode(), hashlib.sha1).digest()
    # Take first 16 chars of base32 encoding
    encoded = base64.b32encode(digest)[:16].decode('ascii')
    return f"IN_{encoded}"
```
