# Implementation Plan: Story 7.6-4 Customer Tags JSONB Migration

## Plan Overview

| Attribute | Value |
|-----------|-------|
| **Story** | 7.6-4: Customer Tags JSONB Migration |
| **Goal** | Migrate `年金客户标签` VARCHAR → JSONB for multi-dimensional tag support |
| **Complexity** | Low - Single migration file, additive change |
| **Files to Create** | 1 (migration file) |
| **Files to Modify** | 1 (documentation) |

---

## Implementation Steps

### Step 1: Create Alembic Migration File

**File:** `io/schema/migrations/versions/007_add_customer_tags_jsonb.py`

**Actions:**
1. Create new migration file following the established pattern from `006_create_business_type_view.py`
2. Set revision chain: `revision = "20260115_000007"`, `down_revision = "20260115_000006"`
3. Implement `upgrade()` function with 4 SQL operations in order:
   - Add `tags` JSONB column with default `'[]'::jsonb`
   - Migrate existing `年金客户标签` data to `tags` column
   - Create GIN index `idx_年金客户_tags_gin` on tags column
   - Add deprecation comment to `年金客户标签` column
4. Implement `downgrade()` function with data loss warning

**SQL Operations (in upgrade):**
```sql
-- 1. Add JSONB column
ALTER TABLE mapping."年金客户" ADD COLUMN tags JSONB DEFAULT '[]'::jsonb;

-- 2. Migrate existing data
UPDATE mapping."年金客户"
SET tags = CASE
    WHEN "年金客户标签" IS NULL OR "年金客户标签" = '' THEN '[]'::jsonb
    ELSE jsonb_build_array("年金客户标签")
END;

-- 3. Create GIN index (after data populated)
CREATE INDEX idx_年金客户_tags_gin ON mapping."年金客户" USING GIN (tags);

-- 4. Add deprecation comment
COMMENT ON COLUMN mapping."年金客户"."年金客户标签" IS 'DEPRECATED: Use tags JSONB column instead';
```

**Acceptance Criteria Covered:** AC-1, AC-2, AC-3, AC-4

---

### Step 2: Run Migration and Verify

**Commands:**
```bash
# Execute migration
uv run --env-file .wdh_env alembic upgrade head
```

**Verification Queries:**
1. Verify column exists and has correct type
2. Verify GIN index exists
3. Verify all ~10,997 rows have `tags` populated
4. Test business scenario queries (tag filtering with `@>` operator)

**Acceptance Criteria Covered:** AC-5

---

### Step 3: Test Downgrade/Upgrade Cycle

**Commands:**
```bash
# Test downgrade
uv run --env-file .wdh_env alembic downgrade -1

# Test upgrade again
uv run --env-file .wdh_env alembic upgrade head
```

**Purpose:** Ensure migration is reversible and re-runnable

---

### Step 4: Update Documentation

**File:** `docs/database-schema-panorama.md`

**Actions:**
1. Add `tags` JSONB column to `年金客户` table section (Section 4.4)
2. Add deprecation note for `年金客户标签` column
3. Document GIN index

**Acceptance Criteria Covered:** Task 4 (documentation)

---

## File Change Summary

| File | Action | Purpose |
|------|--------|---------|
| `io/schema/migrations/versions/007_add_customer_tags_jsonb.py` | CREATE | Alembic migration |
| `docs/database-schema-panorama.md` | MODIFY | Add tags column documentation |

---

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Data loss on downgrade | Clear warning in downgrade docstring |
| Migration failure | Alembic transaction ensures atomicity |
| Performance impact | GIN index created after data migration |
| Breaking changes | Original column preserved, additive only |

---

## Verification Checklist

- [ ] Migration file created with correct revision chain
- [ ] `tags` JSONB column added with default `'[]'::jsonb`
- [ ] Data migrated: NULL/empty → `[]`, non-empty → `["value"]`
- [ ] GIN index `idx_年金客户_tags_gin` created
- [ ] Deprecation comment added to `年金客户标签`
- [ ] All ~10,997 rows have `tags` populated
- [ ] Business queries work (`@>`, `?` operators)
- [ ] Downgrade/upgrade cycle tested
- [ ] Documentation updated

---

## Notes

- **Transaction Safety:** Alembic wraps entire `upgrade()` in single transaction
- **No Code Changes:** This is schema-only; no Python model changes required
- **Future Extensibility:** JSONB enables multi-tag support without schema changes
