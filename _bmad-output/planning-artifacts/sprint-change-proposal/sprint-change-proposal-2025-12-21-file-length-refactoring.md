# Sprint Change Proposal: File Length Violations Refactoring

**Date:** 2025-12-21
**Triggered By:** Code Smell Audit - File Length Violations
**Author:** Generated by Correct Course Workflow
**Status:** ✅ Approved - 2025-12-21

---

## 1. Issue Summary

### Problem Statement

A systematic code quality audit has identified **9 Python files exceeding the 800-line limit**, requiring immediate refactoring attention.

> [!IMPORTANT]
> **Limit Adjustment:** Based on practical evaluation, the file length limit is relaxed from 500 to **800 lines**. This balances code quality with practical domain growth considerations.

### Discovery Context

- **Audit Date:** 2025-12-21
- **Scope:** All Python files in `src/` directory
- **Reference Document:** `docs/specific/code-smell/file-length-violations.md`

### Evidence Summary (Revised)

| Severity | Count | Description |
|----------|-------|-------------|
| **Critical** (>800 lines) | 9 | Files exceeding new 800-line limit |

**Files Requiring Refactoring:**

| # | File | Lines | Layer | Priority |
|---|------|-------|-------|----------|
| 1 | `orchestration/ops.py` | 2165 | Orchestration | **Critical** |
| 2 | `io/loader/warehouse_loader.py` | 1404 | IO | High |
| 3 | `infrastructure/enrichment/company_id_resolver.py` | 1342 | Infrastructure | High |
| 4 | `cli/etl.py` | 1197 | CLI | High |
| 5 | `io/connectors/eqc_client.py` | 1163 | IO | High |
| 6 | `infrastructure/enrichment/mapping_repository.py` | 1068 | Infrastructure | High |
| 7 | `io/connectors/file_connector.py` | 1051 | IO | High |
| 8 | `domain/company_enrichment/service.py` | 844 | Domain | High |
| 9 | `infrastructure/enrichment/domain_learning_service.py` | 819 | Infrastructure | High |

> [!NOTE]
> Files #10-21 from original audit (500-800 lines) are **removed from scope** under the revised 800-line limit.

---

## 2. Impact Analysis

### 2.1 Epic Impact

| Epic | Impact Level | Assessment |
|------|--------------|------------|
| Epic 6.2 (Current - In Progress) | **None** | Refactoring is independent of current functional stories |
| ~~Epic 7~~ → Epic 8 (Testing Infrastructure) | **Low** | Renumbered; refactoring improves testability |
| Future Epics | **Positive** | Better code organization reduces future development friction |

**Conclusion:** Refactoring as **Epic 7**, original Epic 7 renumbered to **Epic 8**.

### 2.2 Domain-Growth Sensitive Modules

> [!WARNING]
> **Proactive Planning Required:** Some modules will grow linearly with domain count.

| Module | Current Lines | Est. Growth/Domain | Action |
|--------|---------------|-------------------|--------|
| `infrastructure/schema/domain_registry.py` | 441 | ~80 lines | **Pre-plan modularization** |
| `orchestration/ops.py` | 2165 | Variable | Modularize by domain |
| `config/data_sources.yml` | N/A | Config growth | Already modularized (6.2-P14) |

**Recommended Strategy for `domain_registry.py`:**
```
infrastructure/schema/
├── domain_registry.py          # Core registry functions (~150 lines)
├── domains/                    # Per-domain schema definitions
│   ├── __init__.py
│   ├── annuity_performance.py  # ~80 lines
│   ├── annuity_income.py       # ~80 lines
│   ├── annuity_plans.py        # ~60 lines
│   └── portfolio_plans.py      # ~60 lines
```

### 2.3 Artifact Impact

| Artifact | Impact | Required Changes |
|----------|--------|------------------|
| **project-context.md** | **UPDATE** | Revise limit from 500 to 800; add code smell prevention rules |
| PRD | None | File structure is internal |
| Architecture | Low | Document new module organization |

---

## 3. Recommended Approach

### Selected Path: **Direct Adjustment - New Epic**

Create **Epic 7: Code Quality - File Length Refactoring**.

> [!IMPORTANT]
> **Epic Re-numbering:**
> - New **Epic 7**: Code Quality - File Length Refactoring
> - Original Epic 7 → **Epic 8**: Testing & Validation Infrastructure

---

## 4. Detailed Change Proposals

### 4.1 Epic Structure

```
Epic 7: Code Quality - File Length Refactoring
├── 7.1: Critical - orchestration/ops.py Decomposition
├── 7.2: High - IO Layer Modularization (warehouse_loader, eqc_client, file_connector)
├── 7.3: High - Infrastructure Layer Decomposition (company_id_resolver, mapping_repository)
├── 7.4: High - CLI Layer Modularization (etl.py)
├── 7.5: High - domain_registry.py Pre-modularization (Domain Growth Planning)
└── 7.6: CI Integration - Ruff Rules & Pre-commit Hook
```

### 4.2 Priority Story: 7.1 - ops.py Decomposition (Critical)

**Current State:** 2165 lines in single `orchestration/ops.py`

**Proposed Split Strategy:**

| New Module | Purpose | Est. Lines |
|------------|---------|------------|
| `orchestration/ops/__init__.py` | Public exports | ~50 |
| `orchestration/ops/company_enrichment.py` | Company enrichment ops | ~400 |
| `orchestration/ops/reference_backfill.py` | Reference data ops | ~350 |
| `orchestration/ops/file_processing.py` | File read/write ops | ~300 |
| `orchestration/ops/pipeline_ops.py` | Core pipeline ops | ~250 |
| `orchestration/ops/sync_ops.py` | Reference sync ops | ~250 |

**Acceptance Criteria:**
1. All existing imports continue to work via `orchestration.ops`
2. Each new module < 500 lines
3. All existing tests pass without modification

---

### 4.3 New Story: 7.5 - domain_registry.py Pre-modularization

**Objective:** Proactively split domain registry before it exceeds 800 lines.

**Current State:** 441 lines with 4 domains registered
**Projected Growth:** ~80 lines per new domain → 8 domains = ~720 lines

#### Architecture Design Rationale

**Why keep in `infrastructure/schema/` instead of `domain/`?**

| 目录 | 职责 | 决策依据 |
|------|------|----------|
| `domain/{domain}/models.py` | **业务模型** - Pydantic验证、转换规则 | 业务逻辑层 |
| `infrastructure/schema/` | **数据库Schema** - DDL生成、加载配置 | 基础设施层 |

`DomainSchema` 的核心用途是：
1. 生成 `CREATE TABLE` DDL
2. 配置 `delete_scope_key`, `composite_key` 供数据加载使用
3. 记录 `bronze_required`, `gold_required` 校验配置

这些都是 **基础设施关注点**，不是业务逻辑，故保持在 `infrastructure/` 符合Clean Architecture。

#### Proposed Structure

```
infrastructure/schema/
├── __init__.py                 # 公共导出
├── core.py                     # ColumnType, ColumnDef, IndexDef, DomainSchema (~150 lines)
├── registry.py                 # register_domain(), get_domain(), list_domains() (~50 lines)
├── ddl_generator.py            # generate_create_table_sql() (~100 lines)
└── definitions/                # 每个domain的schema定义
    ├── __init__.py             # 自动导入并注册所有domain
    ├── annuity_performance.py  # ~80 lines
    ├── annuity_income.py       # ~80 lines
    ├── annuity_plans.py        # ~60 lines
    └── portfolio_plans.py      # ~60 lines
```

#### 新增Domain工作量评估

**变化前 vs 变化后对比：**

| 步骤 | 变化前 (当前) | 变化后 (模块化) |
|------|--------------|----------------|
| 1 | 在 `domain_registry.py` 末尾添加 ~80行 | 创建新文件 `definitions/{domain}.py` (~80行) |
| 2 | - | 在 `definitions/__init__.py` 添加1行导入 |

**示例 - 新增 `revenue` domain：**

```python
# infrastructure/schema/definitions/revenue.py (新文件)
from ..core import DomainSchema, ColumnDef, ColumnType
from ..registry import register_domain

REVENUE_SCHEMA = DomainSchema(
    domain_name="revenue",
    pg_schema="business",
    pg_table="收入明细",
    # ... 约80行配置
)

register_domain(REVENUE_SCHEMA)
```

```python
# infrastructure/schema/definitions/__init__.py (添加一行)
from . import revenue  # 仅需添加此行
```

**工作量结论：**

| 指标 | 变化前 | 变化后 | 评估 |
|------|--------|--------|------|
| 文件数 | 修改1个 | 创建1个 + 修改1行 | 相当 |
| 代码量 | 80行 | 81行 | +1行 |
| 并行开发 | ❌ 易冲突 | ✅ 无冲突 | **更好** |
| 代码发现 | ❌ 滚动大文件 | ✅ 独立文件 | **更好** |

---

### 4.4 New Story: 7.6 - Code Quality Tooling (CI Integration)

**Objective:** Prevent future file length violations using existing tooling.

**Tool Assessment:**

| Tool | Capability | Recommendation |
|------|------------|----------------|
| **Ruff** | Already in use | ✅ Enable `PLR` rules |
| **pre-commit** | Not configured | ✅ Add with custom hook |
| **Custom Script** | 800-line enforcement | ✅ Place in `scripts/quality/` |

**Proposed pyproject.toml Changes:**

```toml
[tool.ruff.lint]
select = ["E", "F", "W", "I", "PLR"]  # Add PLR for Pylint Refactor rules

[tool.ruff.lint.pylint]
max-statements = 50   # Per function limit
max-branches = 12     # Reduce cyclomatic complexity
```

**Proposed .pre-commit-config.yaml:**

```yaml
repos:
  - repo: local
    hooks:
      - id: check-file-length
        name: Check Python file length (max 800 lines)
        entry: python scripts/quality/check_file_length.py --max-lines 800
        language: python
        types: [python]
        exclude: (legacy/|tests/)

  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.12.12
    hooks:
      - id: ruff
        args: [--fix]
      - id: ruff-format
```

**Custom Script Location:** `scripts/quality/check_file_length.py`

```python
#!/usr/bin/env python
"""Pre-commit hook to enforce 800-line limit on Python files."""
import argparse
import sys
from pathlib import Path

def main() -> int:
    parser = argparse.ArgumentParser()
    parser.add_argument("--max-lines", type=int, default=800)
    parser.add_argument("files", nargs="*")
    args = parser.parse_args()
    
    failed = []
    for path in args.files:
        lines = Path(path).read_text(encoding="utf-8").count("\n") + 1
        if lines > args.max_lines:
            failed.append(f"{path}: {lines} lines (max {args.max_lines})")
    
    if failed:
        print("Files exceeding line limit:")
        for f in failed:
            print(f"  {f}")
        return 1
    return 0

if __name__ == "__main__":
    sys.exit(main())
```

---

### 4.5 project-context.md Updates

**File:** `docs/project-context.md`

**Changes Required:**

```diff
 ### Code Structure Limits

-* **File Size:** **MAX 500 lines**. *Action:* If a file exceeds this, split it into sub-modules immediately.
+* **File Size:** **MAX 800 lines**. *Action:* If a file exceeds this, split it into sub-modules immediately.
 * **Function Size:** **MAX 50 lines**. *Action:* Extract logic into private helper functions.
 * **Class Size:** **MAX 100 lines**. *Action:* Use composition over inheritance; split large classes.
 * **Line Length:** **MAX 100 characters** (Matches `ruff` config).
+
+### Code Smell Prevention
+
+* **Pre-commit Hooks:** All commits must pass `check_file_length.py` and Ruff checks.
+* **Domain-Growth Modules:** Modules like `domain_registry.py` should be pre-modularized when domain count increases.
+* **Tooling:** Enable `PLR` (Pylint Refactor) rules in Ruff for complexity checks.
```

---

## 5. Implementation Handoff

### Change Scope Classification: **Moderate**

### Handoff Recipients

| Role | Responsibility |
|------|----------------|
| **Scrum Master** | Create Epic 7 and draft stories in sprint-status.yaml |
| **Developer** | Implement refactoring following modularization patterns |
| **Reviewer** | Ensure interface preservation and test coverage |

### Implementation Sequence

1. **Phase 0 (Tooling):** Set up pre-commit hook + update project-context.md - Story 7.6
2. **Phase 1 (Critical):** ops.py decomposition - Story 7.1
3. **Phase 2 (High):** IO and Infrastructure layer modularization - Stories 7.2, 7.3
4. **Phase 3 (High):** CLI modularization - Story 7.4
5. **Phase 4 (Planning):** domain_registry.py pre-modularization - Story 7.5

> [!TIP]
> **Tooling First:** Installing the pre-commit hook before refactoring prevents NEW violations.

### Success Criteria

- [ ] All 9 violating files reduced to < 800 lines
- [ ] All existing tests pass without modification
- [ ] No new circular import issues introduced
- [ ] Pre-commit hook prevents future violations
- [ ] project-context.md updated with new rules
- [ ] domain_registry.py pre-modularized for growth

---

## 6. Verification Plan

### Automated Verification

```bash
# Run existing test suite
uv run pytest -v -m "not postgres and not monthly_data"

# Check file lengths after refactoring
find src/ -name "*.py" -exec wc -l {} \; | awk '$1 > 800 {print}'

# Verify no import errors
uv run python -c "from work_data_hub.orchestration import ops; print('OK')"
```

### Manual Verification

1. Run ETL command and confirm normal operation:
   ```bash
   PYTHONPATH=src uv run --env-file .wdh_env python -m work_data_hub.cli etl --domains annuity_performance --plan-only
   ```
2. Review import structure in IDE for circular dependency warnings

---

## Appendix: Files Removed from Scope

The following files (originally #10-21) are **no longer in scope** under the 800-line limit:

| File | Lines | Status |
|------|-------|--------|
| orchestration/jobs.py | 752 | ✅ Under limit |
| domain/company_enrichment/lookup_queue.py | 733 | ✅ Under limit |
| domain/reference_backfill/generic_service.py | 682 | ✅ Under limit |
| infrastructure/enrichment/data_refresh_service.py | 676 | ✅ Under limit |
| domain/reference_backfill/observability.py | 676 | ✅ Under limit |
| domain/reference_backfill/sync_service.py | 671 | ✅ Under limit |
| domain/pipelines/core.py | 648 | ✅ Under limit |
| domain/company_enrichment/models.py | 647 | ✅ Under limit |
| cli/eqc_refresh.py | 602 | ✅ Under limit |
| io/loader/company_mapping_loader.py | 587 | ✅ Under limit |
| config/settings.py | 580 | ✅ Under limit |
| io/auth/auto_eqc_auth.py | 553 | ✅ Under limit |

---

**Document Status:** Ready for User Review
