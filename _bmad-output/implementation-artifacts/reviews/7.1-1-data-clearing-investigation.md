# Investigation Report: Story 7.1-1 Data Clearing Root Cause

**Date:** 2025-12-23
**Investigator:** Claude
**Status:** ✅ ROOT CAUSE IDENTIFIED

---

## 1. Problem Summary

**Symptom:** `enterprise.enrichment_index` and `enterprise.base_info` tables unexpectedly cleared.

**Impact:** Complete loss of company enrichment lookup cache and EQC API raw responses - blocking Epic 8.

---

## 2. Code Flow Analysis

### 2.1 The Culprit: `tests/conftest.py:184`

```python
# tests/conftest.py:163-185
@pytest.fixture
def postgres_db_with_migrations() -> Generator[str, None, None]:
    base_dsn = _resolve_postgres_dsn()           # Gets DATABASE_URL
    temp_dsn, temp_db, admin_dsn = _create_ephemeral_database(base_dsn)  # Creates temp DB
    
    migration_runner.upgrade(temp_dsn)           # Apply migrations to temp DB
    try:
        yield temp_dsn
    finally:
        migration_runner.downgrade(temp_dsn, "base")  # ⚠️ LINE 184 - THE ISSUE
        _drop_database(admin_dsn, temp_db)
```

### 2.2 What `downgrade("base")` Does

```python
# src/work_data_hub/io/schema/migration_runner.py:38-41
def downgrade(database_url: Optional[str] = None, revision: str = "-1") -> None:
    cfg = _build_config(database_url)
    command.downgrade(cfg, revision)  # Runs Alembic downgrade
```

When `revision="base"`, Alembic runs ALL downgrade migrations, including:

| Migration | Downgrade Action |
|-----------|------------------|
| `20251208_000001` | `DROP TABLE IF EXISTS enterprise.enrichment_index` |
| `20251206_000001` | `DROP TABLE IF EXISTS enterprise.base_info` (line 771) |

### 2.3 16 Call Sites Found

```
tests/conftest.py:184                          → downgrade("base")
tests/integration/migrations/test_enrichment_index_migration.py (5 sites)
tests/integration/migrations/test_enterprise_schema_migration.py (3 sites)
tests/integration/migrations/test_reference_tracking_fields_migration.py (6 sites)
scripts/temp/db_setup.py:82
```

---

## 3. Environment Analysis

### 3.1 Expected Flow (Safe)

```
1. _resolve_postgres_dsn() → Gets DATABASE_URL from environment
2. _create_ephemeral_database() → Creates temp DB: "testdb_test_abc123"  
3. upgrade(temp_dsn) → Applies migrations to TEMP DB only
4. yield temp_dsn → Tests run against TEMP DB
5. downgrade(temp_dsn, "base") → Drops tables in TEMP DB only
6. _drop_database() → Drops entire TEMP DB
```

### 3.2 Failure Scenario (DANGEROUS)

**IF** `DATABASE_URL` environment variable points to production **AND** `_create_ephemeral_database()` fails or is bypassed:

```
1. Tests could run against production DATABASE_URL
2. downgrade("base") would DROP TABLES in production
```

### 3.3 Current Protections

| Protection | Status | Gap |
|------------|--------|-----|
| Ephemeral DB creation | ✅ Works | No fallback if creation fails |
| DB name validation | ❌ Missing | No check that DB name contains "test" |
| `.wdh_env` auto-load | ❌ Missing | Not loaded by pytest automatically |

---

## 4. CI/CD Analysis

### 4.1 GitHub Actions Configuration

```yaml
# .github/workflows/ci.yml:94-107
services:
  postgres:
    image: postgres:15
    env:
      POSTGRES_DB: testdb  # ✅ Uses dedicated test database

# Line 137-138
run: |
  echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/testdb" >> $GITHUB_ENV
  echo "WDH_TEST_DATABASE_URI=postgresql://postgres:postgres@localhost:5432/testdb" >> $GITHUB_ENV
```

**Verdict:** CI/CD is safe - uses isolated `testdb` database in ephemeral container.

### 4.2 Risk Area: Local Development

Local development is the risk area:
- Developers may run `pytest` without loading `.wdh_env`
- System may fallback to production `DATABASE_URL`

---

## 5. Root Cause

### Primary Cause
**Missing database validation**: No safety check to verify the target database is a test database before running destructive operations like `downgrade("base")`.

### Contributing Factors
1. `.wdh_env` not auto-loaded by pytest
2. No regex validation of database name pattern
3. `downgrade("base")` runs full schema destruction (DROP TABLE)

---

## 6. Risk Assessment

| Scenario | Likelihood | Impact | Risk |
|----------|------------|--------|------|
| CI destroys production | ❌ Very Low | Critical | Low |
| Local dev destroys production | ⚠️ Medium | Critical | **HIGH** |
| Ephemeral DB cleanup fails | ⚠️ Medium | Low | Medium |

---

## 7. Recommendations

### 7.1 MUST IMPLEMENT (AC-2)

```python
def _validate_test_database(dsn: str) -> bool:
    """Ensure target is a test database before destructive operations."""
    from sqlalchemy.engine.url import make_url
    db_name = make_url(dsn).database
    if not re.search(r'(test|tmp|dev|local|sandbox)', db_name, re.IGNORECASE):
        raise RuntimeError(f"Refusing operation on non-test database: {db_name}")
    return True
```

### 7.2 MUST IMPLEMENT (AC-3)

```python
# At top of tests/conftest.py
from pathlib import Path
from dotenv import load_dotenv

_env_file = Path(__file__).parent.parent / ".wdh_env"
if _env_file.exists():
    load_dotenv(_env_file)
```

### 7.3 Call `_validate_test_database()` Before ALL Downgrades

```python
# In postgres_db_with_migrations fixture
_validate_test_database(temp_dsn)  # Add before downgrade
migration_runner.downgrade(temp_dsn, "base")
```

---

## 8. Files Analyzed

| File | Lines | Finding |
|------|-------|---------|
| `tests/conftest.py` | 219 | Contains fixture calling `downgrade("base")` |
| `migration_runner.py` | 62 | Wrapper for Alembic commands |
| `20251206_000001_create_enterprise_schema.py` | 787 | `downgrade()` drops `base_info` table |
| `20251208_000001_create_enrichment_index.py` | 232 | `downgrade()` drops `enrichment_index` table |
| `.github/workflows/ci.yml` | 238 | Uses safe `testdb` configuration |
