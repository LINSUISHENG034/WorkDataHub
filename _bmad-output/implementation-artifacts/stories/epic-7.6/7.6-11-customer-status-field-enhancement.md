# Story 7.6-11: Customer Status Field Enhancement

Status: done

## At a Glance

| Attribute | Value |
|-----------|-------|
| **Goal** | Implement full business logic for is_strategic, is_existing, and contract_status fields |
| **Impact** | Enables strategic customer analysis and new/existing customer segmentation |
| **Risk** | Low (data sources verified, code structure established) |
| **Dependencies** | Story 7.6-6 (completed) |
| **Effort** | 1.5 days |
| **Rollback** | Revert to placeholder values (FALSE) |

## Story

As a **BI Analyst**,
I want **accurate strategic customer flags and existing customer identification**,
so that **I can perform customer segmentation analysis and generate meaningful business reports**.

## Background

This story addresses a scope gap identified during post-implementation review:
- Story 7.6-6 implemented placeholder values for status fields
- Story 7.6-9 scope was limited to triggers/indexes only
- Full business logic was never assigned to any story

See: [Sprint Change Proposal 2026-02-03](../sprint-change-proposal/sprint-change-proposal-2026-02-03-status-field-gap.md)

## Acceptance Criteria

### is_strategic Strategic Customer Flag (AC-1)

**AC-1**: Implement strategic customer identification logic
- Prior year total AUM >= 500,000,000 (5B) → `is_strategic = TRUE`
- Top 10 customers per branch per product line → `is_strategic = TRUE`
- Others → `is_strategic = FALSE`
- Configuration source: `config/customer_mdm.yaml`

### is_existing Existing Customer Flag (AC-2)

**AC-2**: Implement existing customer identification logic
- Prior year (December) has asset records (AUM > 0) → `is_existing = TRUE`
- Prior year no asset records → `is_existing = FALSE`

### Annual Initialization CLI Command (AC-3)

**AC-3**: Create CLI command for annual status initialization
- Command: `customer-mdm init-year --year <YYYY>`
- Updates all contracts for specified year
- Idempotent (safe to re-run)
- Logs progress and record counts

### contract_status Full Logic (AC-4)

**AC-4**: Implement complete contract status logic with 12-month rolling window
- AUM > 0 AND 12-month rolling contribution > 0 → `正常`
- AUM > 0 AND 12-month rolling contribution = 0 → `停缴`
- Data source: `business.规模明细.供款` (99.8% coverage verified)

### Data Quality Validation (AC-5)

**AC-5**: Validate updated data
- Verify `is_strategic = TRUE` count is reasonable (expected: ~5-10% of records)
- Verify `is_existing` distribution matches business expectations
- Verify `contract_status` changes from v1 simplified logic

## Tasks / Subtasks

- [x] Task 1: Implement `is_strategic` logic (AC: 1)
  - [x] Create whitelist generation query (top 10 per branch per product line)
  - [x] Add threshold check (>= 5B)
  - [x] Update `contract_sync.py` with combined logic

- [x] Task 2: Implement `is_existing` logic (AC: 2)
  - [x] Create prior year asset check query
  - [x] Update `contract_sync.py` with existing customer logic

- [x] Task 3: Create `init-year` CLI command (AC: 3)
  - [x] Create `src/work_data_hub/cli/customer_mdm/init_year.py`
  - [x] Register command in CLI module
  - [x] Add logging and progress reporting

- [x] Task 4: Implement `contract_status` v2 logic (AC: 4)
  - [x] Create 12-month rolling contribution subquery
  - [x] Update contract_status CASE logic
  - [x] Handle edge cases (NULL 供款 values)

- [x] Task 5: Update Post-ETL hook (AC: 1, 2, 4)
  - [x] Ensure enhanced logic is called after ETL
  - [x] Add year-init trigger for January runs

- [x] Task 6: Validation and Testing (AC: 5)
  - [x] Run enhanced sync and verify distributions
  - [x] Compare before/after record counts
  - [x] Validate Power BI report functionality

## Dev Notes

### Architecture Compliance

- **Follows existing patterns** from Story 7.6-6
- **CLI Conventions**: Subcommand in `cli/customer_mdm/` package
- **Configuration**: Uses existing `config/customer_mdm.yaml`

### Reference SQL: Strategic Customer Whitelist

```sql
-- Strategic customer whitelist generation (top 10 per branch per product line)
WITH ranked_customers AS (
    SELECT
        company_id,
        计划代码 as plan_code,
        产品线代码 as product_line_code,
        机构代码,
        SUM(期末资产规模) as total_aum,
        ROW_NUMBER() OVER (
            PARTITION BY 机构代码, 产品线代码
            ORDER BY SUM(期末资产规模) DESC
        ) as rank_in_branch
    FROM business.规模明细
    WHERE 月度 = (
        SELECT MAX(月度) FROM business.规模明细
        WHERE EXTRACT(MONTH FROM 月度) = 12
          AND EXTRACT(YEAR FROM 月度) = EXTRACT(YEAR FROM CURRENT_DATE) - 1
    )
      AND company_id IS NOT NULL
    GROUP BY company_id, 计划代码, 产品线代码, 机构代码
)
SELECT company_id, plan_code, product_line_code
FROM ranked_customers
WHERE rank_in_branch <= 10
   OR total_aum >= 500000000;
```

### Reference SQL: 12-Month Rolling Contribution

```sql
-- 12-month rolling contribution check
WITH contribution_12m AS (
    SELECT
        company_id,
        计划代码,
        产品线代码,
        CASE WHEN SUM(供款) > 0 THEN TRUE ELSE FALSE END as has_contribution
    FROM business.规模明细
    WHERE 月度 >= (CURRENT_DATE - INTERVAL '12 months')
      AND company_id IS NOT NULL
    GROUP BY company_id, 计划代码, 产品线代码
)
SELECT ...
```

### Configuration Parameters

```yaml
# config/customer_mdm.yaml (existing)
customer_mdm:
  strategic_threshold: 500000000  # 5B yuan
  whitelist_top_n: 10             # Top N per branch
  status_year: 2026
```

### Data Source Verification

| Field | Table | Coverage |
|-------|-------|----------|
| 期末资产规模 | business.规模明细 | 100% |
| 供款 | business.规模明细 | 99.8% |
| 机构代码 | business.规模明细 | 100% |

### File Structure

```
src/work_data_hub/
├── cli/
│   └── customer_mdm/
│       ├── __init__.py      # [MODIFY] Register init_year
│       ├── sync.py          # [EXISTING]
│       └── init_year.py     # [NEW]
├── customer_mdm/
│   ├── __init__.py          # [EXISTING]
│   └── contract_sync.py     # [MODIFY] Enhanced logic
```

### References

- [Sprint Change Proposal](../sprint-change-proposal/sprint-change-proposal-2026-02-03-status-field-gap.md)
- [Gap Analysis](../../specific/customer-mdm/customer-plan-contract-status-field-gap-analysis.md)
- [Specification](../../specific/customer-mdm/customer-plan-contract-specification.md)
- [Story 7.6-6](./7.6-6-contract-status-sync-post-etl-hook.md)

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A - No debug issues encountered

### Completion Notes List

1. Created `strategic.py` module for strategic customer logic
2. Updated `contract_sync.py` with full business logic (is_strategic, is_existing, contract_status v2)
3. Created `year_init.py` for annual initialization
4. Created `init_year.py` CLI command
5. Updated hooks.py with year_init hook for January ETL runs
6. Added unit tests for strategic customer and contract status v2 logic
7. Added integration tests for status field validation

### Completion Notes

Story 7.6-11 implements the full business logic for customer status fields:

- **is_strategic**: Based on AUM threshold (500M) OR top 10 per branch per product line
- **is_existing**: Based on prior year December asset records
- **contract_status v2**: Based on 12-month rolling contribution window

All acceptance criteria satisfied. Unit tests pass (8/8). CLI command registered.

### File List

**New Files:**
- src/work_data_hub/customer_mdm/strategic.py
- src/work_data_hub/customer_mdm/year_init.py
- src/work_data_hub/customer_mdm/validation.py
- src/work_data_hub/cli/customer_mdm/init_year.py
- src/work_data_hub/cli/customer_mdm/validate.py
- tests/unit/customer_mdm/__init__.py
- tests/unit/customer_mdm/test_strategic_customer.py
- tests/integration/customer_mdm/test_status_fields.py
- docs/specific/customer-mdm/customer-plan-contract-status-field-gap-analysis.md
- docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2026-02-03-status-field-gap.md

**Modified Files:**
- src/work_data_hub/customer_mdm/__init__.py
- src/work_data_hub/customer_mdm/contract_sync.py
- src/work_data_hub/cli/__main__.py
- src/work_data_hub/cli/etl/hooks.py
- tests/integration/customer_mdm/conftest.py
- config/customer_mdm.yaml
