# Story 7.6-19: Table Rename Migration (年金客户 → 年金关联公司)

Status: done

## Story

As a **data engineer**,
I want **the `年金客户` table renamed to `年金关联公司` for semantic clarity**,
so that **the table name accurately reflects its contents (companies associated with annuity business, not customers) and reduces cognitive confusion for all stakeholders**.

## Acceptance Criteria

1. **Table Renamed**: `customer."年金客户"` is renamed to `customer."年金关联公司"` via migration script
2. **Backward Compatibility View**: `customer."年金客户"` alias view exists and returns all rows from `customer."年金关联公司"`
3. **FK Constraints Updated**: All foreign key constraints referencing `年金客户` point to `年金关联公司`
4. **Triggers Updated**: All triggers on `年金客户` are recreated on `年金关联公司`
5. **SQL Files Updated**: All SQL files in `src/work_data_hub/customer_mdm/sql/` reference `年金关联公司`
6. **Config Files Updated**: `config/foreign_keys.yml` and `config/data_sources.yml` reference `年金关联公司`
7. **Seed Files Renamed**: `config/seeds/001/年金客户.csv` renamed to `年金关联公司.csv`
8. **All Existing Tests Pass**: No regression in test suite

## Tasks / Subtasks

- [x] Task 1: Create migration script (AC: #1, #2, #3, #4)
  - [x] 1.1 Create `scripts/migrations/rename_annuity_customer_table.sql` with:
    - ALTER TABLE RENAME
    - FK constraint drop + recreate pointing to new table name
    - Trigger recreation on new table name
    - Backward compatibility view (`年金客户` → SELECT * FROM `年金关联公司`)
  - [x] 1.2 Create rollback script `scripts/migrations/rollback_annuity_customer_migration.sql`
  - [x] 1.3 Test migration script on database

- [x] Task 2: Update SQL query files (AC: #5)
  - [x] 2.1 Update `src/work_data_hub/customer_mdm/sql/sync_insert.sql` (line 61)
  - [x] 2.2 Update `src/work_data_hub/customer_mdm/sql/annual_cutover_insert.sql` (line 102)

- [x] Task 3: Update configuration files (AC: #6)
  - [x] 3.1 Update `config/foreign_keys.yml` - all `target_table: "年金客户"` → `"年金关联公司"`
  - [x] 3.2 Update `config/data_sources.yml` - comments referencing `年金客户`

- [x] Task 4: Rename seed file (AC: #7)
  - [x] 4.1 Rename `config/seeds/001/年金客户.csv` → `config/seeds/001/年金关联公司.csv`
  - [x] 4.2 Update `src/work_data_hub/io/schema/seed_resolver.py` docstring examples

- [x] Task 5: Update tests (AC: #8)
  - [x] 5.1 Update `tests/integration/customer_mdm/conftest.py` - table references
  - [x] 5.2 Update `tests/integration/customer_mdm/test_trigger_sync.py` - SQL references
  - [x] 5.3 Update `tests/integration/migrations/test_enterprise_schema_migration.py` - table name assertions
  - [x] 5.4 Update `tests/unit/infrastructure/sql/test_postgresql.py` - table reference
  - [x] 5.5 Update `tests/unit/domain/reference_backfill/test_generic_backfill_service.py` - target_table values
  - [x] 5.6 Run full test suite to verify no regressions

## Dev Notes

### Impact Analysis Summary

The rename affects code references across 4 categories:

| Category | Files | References |
|----------|-------|------------|
| SQL query files | 2 files in `customer_mdm/sql/` | 2 references |
| Config files | `foreign_keys.yml`, `data_sources.yml` | ~20 references |
| Migration scripts (historical) | 5 files in `scripts/migrations/` | 30+ references (NO CHANGE - historical records) |
| Test files | 5 files | 30+ references |
| Seed files | `config/seeds/001/年金客户.csv` | 1 file rename |
| Docstring examples | `seed_resolver.py` | 5 references |

> [!IMPORTANT]
> **Historical migration scripts** in `scripts/migrations/` should **NOT** be modified. They are historical records of past schema changes. The backward compatibility view ensures they remain valid for reference.

### Migration Script Design

```sql
-- 1. Rename table
ALTER TABLE customer."年金客户" RENAME TO "年金关联公司";

-- 2. Update FK constraints (customer_plan_contract → 年金关联公司)
ALTER TABLE customer.customer_plan_contract
  DROP CONSTRAINT IF EXISTS fk_contract_company,
  ADD CONSTRAINT fk_contract_company
    FOREIGN KEY (company_id) REFERENCES customer."年金关联公司"(company_id);

-- 3. Recreate triggers on renamed table
-- (Drop old triggers, create new ones with same logic)

-- 4. Create backward compatibility view
CREATE OR REPLACE VIEW customer."年金客户" AS
SELECT * FROM customer."年金关联公司";

-- 5. Also update mapping schema view if exists
CREATE OR REPLACE VIEW mapping."年金客户" AS
SELECT * FROM customer."年金关联公司";
```

### Rollback Design

```sql
-- 1. Drop views
DROP VIEW IF EXISTS customer."年金客户";
DROP VIEW IF EXISTS mapping."年金客户";

-- 2. Rename back
ALTER TABLE customer."年金关联公司" RENAME TO "年金客户";

-- 3. Recreate FK constraints pointing to original name
-- 4. Recreate triggers on original table name
```

### Files NOT Modified (with rationale)

| File | Reason |
|------|--------|
| `customer_mdm/*.py` | No Python source references to `年金客户` in customer_mdm module |
| `config/customer_status_rules.yml` | No references to `年金客户` |
| `scripts/migrations/*.sql` (historical) | Historical records, must not be modified |
| Legacy DB schema files | Historical reference, not active code |

### Project Context Compliance

- **Zero Legacy Policy**: Backward compatibility view created per sprint change proposal requirement (not a legacy wrapper - it's a SQL alias for BI continuity)
- **KISS**: Simple ALTER TABLE + VIEW approach, no complex data migration needed
- **Fail Fast**: Migration script includes verification queries

### Prerequisite

- Story 7.6-18 (Config-Driven Status Evaluation) must be `done` ✅

### References

- [Source: _bmad-output/planning-artifacts/sprint-change-proposal/sprint-change-proposal-2026-02-11-customer-mdm-optimization.md#story-7.6-19]
- [Source: docs/business-background/customer-mdm-backfill-analysis.md]
- [Source: docs/project-context.md#9-customer-mdm]

---

## Dev Agent Record

### File List

| File | Action | Description |
|------|--------|-------------|
| `scripts/migrations/rename_annuity_customer_table.sql` | Created | Migration script with table rename, FK updates, trigger recreation, and backward compatibility views |
| `scripts/migrations/rollback_annuity_customer_migration.sql` | Created | Rollback script to reverse the migration |
| `src/work_data_hub/customer_mdm/sql/sync_insert.sql` | Modified | Updated table reference from `年金客户` to `年金关联公司` (line 61) |
| `src/work_data_hub/customer_mdm/sql/annual_cutover_insert.sql` | Modified | Updated table reference from `年金客户` to `年金关联公司` (line 102) |
| `config/foreign_keys.yml` | Modified | Updated all `target_table: "年金客户"` to `"年金关联公司"` |
| `config/data_sources.yml` | Modified | Updated comments referencing `年金关联公司` |
| `config/seeds/001/年金关联公司.csv` | Renamed | From `年金客户.csv` |
| `src/work_data_hub/io/schema/seed_resolver.py` | Modified | Updated docstring examples to use `年金关联公司` |
| `tests/integration/customer_mdm/conftest.py` | Modified | Updated table references |
| `tests/integration/customer_mdm/test_trigger_sync.py` | Modified | Updated SQL references |
| `tests/integration/migrations/test_enterprise_schema_migration.py` | Modified | Updated table name assertions |
| `tests/unit/infrastructure/sql/test_postgresql.py` | Modified | Updated table reference |
| `tests/unit/domain/reference_backfill/test_generic_backfill_service.py` | Modified | Updated target_table values |

### Change Log

| Date | Author | Change |
|------|--------|--------|
| 2026-02-16 | Dev Agent | Initial implementation of all tasks |
| 2026-02-16 | Code Review (AI) | Verified implementation, updated task completion status |
