# Story 7.6-9: Index & Trigger Optimization

Status: done

## At a Glance

| Attribute | Value |
|-----------|-------|
| **Goal** | Add product line name sync trigger and verify index coverage |
| **Impact** | Ensures data consistency across denormalized tables when product line names change |
| **Risk** | Low (DDL-only changes, no data modification) |
| **Dependencies** | Story 7.6-6 (customer_plan_contract), Story 7.6-7 (fct_customer_business_monthly_status) |
| **Effort** | 0.5 days |
| **Rollback** | DROP TRIGGER + DROP FUNCTION commands |

## Story

As a **Data Engineer**,
I want **a trigger that automatically synchronizes product line names across denormalized tables**,
so that **data remains consistent when product line metadata is updated in the source dimension table**.

## Acceptance Criteria

### Product Line Name Sync Trigger (AC-1)

**AC-1**: Create `trg_sync_product_line_name` trigger on `mapping."产品线"`
- When `mapping."产品线".产品线` is updated, automatically propagate changes to:
  - `customer.customer_plan_contract.product_line_name`
  - `customer.fct_customer_business_monthly_status.product_line_name`
- Trigger fires AFTER UPDATE only when `产品线` value actually changes
- Include `updated_at` timestamp update for affected rows
- Create via Alembic migration (`011_create_sync_product_line_trigger.py`)

### Index Coverage Audit (AC-2)

**AC-2**: Verify BRIN and Partial index coverage
- Confirm BRIN indexes exist:
  - [x] `idx_contract_valid_from_brin` on `customer_plan_contract(valid_from)` (Migration 008)
  - [x] `idx_snapshot_month_brin` on `fct_customer_business_monthly_status(snapshot_month)` (Migration 009)
- Confirm Partial indexes exist:
  - [x] `idx_contract_strategic` with WHERE clause `is_strategic = TRUE` (Migration 008)
  - [x] `idx_active_contracts` with WHERE clause `valid_to = '9999-12-31'` (Migration 008)
  - [x] `idx_snapshot_strategic` with WHERE clause `is_strategic = TRUE` (Migration 009)
- Document any missing indexes and add if needed

### Trigger Validation (AC-3)

**AC-3**: Validate trigger functionality
- Test: Update `mapping."产品线".产品线` for a product line code
- Verify: Both target tables are updated with new product line name
- Verify: `updated_at` timestamps are refreshed
- Verify: Rows with different product line codes are NOT affected

## Tasks / Subtasks

- [x] Task 1: Create Alembic migration for `trg_sync_product_line_name` (AC: 1)
  - [x] Create trigger function `customer.sync_product_line_name()`
  - [x] Attach trigger to `mapping."产品线"` table
  - [x] Add IF EXISTS guard for idempotent deployment

- [x] Task 2: Audit existing index coverage (AC: 2)
  - [x] Query `pg_indexes` to verify BRIN index presence
  - [x] Query `pg_indexes` to verify Partial index presence
  - [x] Document findings in Completion Notes

- [x] Task 3: Test trigger functionality (AC: 3)
  - [x] Run migration
  - [x] Execute test UPDATE on `mapping."产品线"`
  - [x] Verify propagation to both target tables
  - [x] Rollback test changes

## Dev Notes

### Architecture Compliance

- **Trigger Pattern**: AFTER UPDATE trigger with WHEN clause for conditional firing
- **Function Scope**: Created in `customer` schema to align with target tables
- **Idempotency**: Use `CREATE OR REPLACE FUNCTION` and `DROP TRIGGER IF EXISTS`

### Trigger DDL (Migration 011)

```sql
-- Trigger Function: sync_product_line_name
-- Purpose: Propagate 产品线 name changes to denormalized columns
CREATE OR REPLACE FUNCTION customer.sync_product_line_name()
RETURNS TRIGGER AS $$
DECLARE
    v_contract_count INTEGER;
    v_snapshot_count INTEGER;
BEGIN
    -- Sync to customer_plan_contract (use IS DISTINCT FROM for NULL safety)
    UPDATE customer.customer_plan_contract
    SET product_line_name = NEW."产品线",
        updated_at = CURRENT_TIMESTAMP
    WHERE product_line_code = NEW."产品线代码"
      AND product_line_name IS DISTINCT FROM NEW."产品线";

    GET DIAGNOSTICS v_contract_count = ROW_COUNT;

    -- Sync to fct_customer_business_monthly_status
    UPDATE customer.fct_customer_business_monthly_status
    SET product_line_name = NEW."产品线",
        updated_at = CURRENT_TIMESTAMP
    WHERE product_line_code = NEW."产品线代码"
      AND product_line_name IS DISTINCT FROM NEW."产品线";

    GET DIAGNOSTICS v_snapshot_count = ROW_COUNT;

    -- Performance monitoring: log row counts
    RAISE NOTICE 'sync_product_line_name: Updated % contract rows, % snapshot rows for product_line_code=%',
        v_contract_count, v_snapshot_count, NEW."产品线代码";

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Attach trigger to mapping."产品线"
CREATE TRIGGER trg_sync_product_line_name
    AFTER UPDATE ON mapping."产品线"
    FOR EACH ROW
    WHEN (OLD."产品线" IS DISTINCT FROM NEW."产品线")
    EXECUTE FUNCTION customer.sync_product_line_name();
```

### Index Verification Query

```sql
-- Query to verify BRIN indexes
SELECT indexname, indexdef
FROM pg_indexes
WHERE schemaname = 'customer'
  AND indexdef LIKE '%USING BRIN%'
ORDER BY indexname;

-- Expected results:
-- idx_contract_valid_from_brin | ... USING BRIN (valid_from)
-- idx_snapshot_month_brin       | ... USING BRIN (snapshot_month)

-- Query to verify Partial indexes
SELECT indexname, indexdef
FROM pg_indexes
WHERE schemaname = 'customer'
  AND indexdef LIKE '%WHERE%'
ORDER BY indexname;

-- Expected results:
-- idx_active_contracts    | ... WHERE (valid_to = '9999-12-31'::date)
-- idx_contract_strategic  | ... WHERE (is_strategic = true)
-- idx_snapshot_strategic  | ... WHERE (is_strategic = true)
```

### File Structure

```
io/
└── schema/
    └── migrations/
        └── versions/
            └── 011_create_sync_product_line_trigger.py  # [NEW]
```

### Previous Story Intelligence (Story 7.6-8)

**Key Patterns to Follow:**
- Migration file naming: `011_xxx.py` (next available after 010)
- Use `conn.execute(sa.text(...))` pattern
- Include docstring with Story reference
- Use `CREATE OR REPLACE FUNCTION` for idempotency
- Use `DROP TRIGGER IF EXISTS` before CREATE TRIGGER

**Schema Context (CRITICAL):**
- Target tables are in `customer` schema
- Source table is in `mapping` schema
- Trigger function should be in `customer` schema (target scope)

**Git commit patterns:**
- `feat(schema):` for Alembic migrations

### Test Procedure

```sql
-- 1. Record baseline
SELECT product_line_code, product_line_name
FROM customer.customer_plan_contract
WHERE product_line_code = 'PL201'
LIMIT 1;

SELECT product_line_code, product_line_name
FROM customer.fct_customer_business_monthly_status
WHERE product_line_code = 'PL201'
LIMIT 1;

-- 2. Update source table (TEST ONLY - rollback after)
UPDATE mapping."产品线"
SET "产品线" = '企年受托-测试'
WHERE "产品线代码" = 'PL201';

-- 3. Verify propagation
SELECT product_line_code, product_line_name, updated_at
FROM customer.customer_plan_contract
WHERE product_line_code = 'PL201'
LIMIT 1;

SELECT product_line_code, product_line_name, updated_at
FROM customer.fct_customer_business_monthly_status
WHERE product_line_code = 'PL201'
LIMIT 1;

-- 4. Rollback test change
UPDATE mapping."产品线"
SET "产品线" = '企年受托'
WHERE "产品线代码" = 'PL201';
```

### Performance Considerations

- Trigger fires only on actual value changes (WHEN clause optimization)
- Uses `!= NEW."产品线"` filter to avoid unnecessary updates to rows already matching
- Product line dimension is small (4 rows: PL201-PL204), so update impact is minimal
- Estimated target row counts:
  - `customer_plan_contract`: ~20,000 rows per product line
  - `fct_customer_business_monthly_status`: ~10,000 rows per product line

### References

- [Source: docs/project-planning-artifacts/sprint-change-proposal-2026-01-10.md#4.1.4](file:///e:/Projects/WorkDataHub/docs/project-planning-artifacts/sprint-change-proposal-2026-01-10.md) - Story 7.6-9 definition and trigger DDL
- [Source: io/schema/migrations/versions/008_create_customer_plan_contract.py](file:///e:/Projects/WorkDataHub/io/schema/migrations/versions/008_create_customer_plan_contract.py) - BRIN/Partial index examples
- [Source: io/schema/migrations/versions/009_create_fct_customer_monthly_status.py](file:///e:/Projects/WorkDataHub/io/schema/migrations/versions/009_create_fct_customer_monthly_status.py) - BRIN/Partial index examples
- [Source: docs/sprint-artifacts/stories/epic-customer-mdm/7.6-8-power-bi-star-schema-integration.md](file:///e:/Projects/WorkDataHub/docs/sprint-artifacts/stories/epic-customer-mdm/7.6-8-power-bi-star-schema-integration.md) - Previous story patterns

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None required - clean implementation with no issues.

### Completion Notes List

**Task 1: Alembic Migration (AC-1)**
- Created `011_create_sync_product_line_trigger.py` (revision `20260129_000011`)
- Trigger function `customer.sync_product_line_name()` created with `CREATE OR REPLACE FUNCTION`
- Trigger `trg_sync_product_line_name` attached to `mapping."产品线"` with `AFTER UPDATE` and `WHEN (OLD."产品线" IS DISTINCT FROM NEW."产品线")` clause
- Idempotent: uses `DROP TRIGGER IF EXISTS` before `CREATE TRIGGER` and `CREATE OR REPLACE FUNCTION`
- Migration upgrade and downgrade both execute successfully

**Task 2: Index Coverage Audit (AC-2)**
- BRIN indexes verified (2/2):
  - `idx_contract_valid_from_brin` on `customer_plan_contract USING brin (valid_from)` ✅
  - `idx_snapshot_month_brin` on `fct_customer_business_monthly_status USING brin (snapshot_month)` ✅
- Partial indexes verified (3/3):
  - `idx_contract_strategic` WHERE `(is_strategic = true)` ✅
  - `idx_active_contracts` WHERE `(valid_to = '9999-12-31'::date)` ✅
  - `idx_snapshot_strategic` WHERE `(is_strategic = true)` ✅
- All indexes present - no missing indexes found.

**Task 3: Trigger Validation (AC-3)**
- Test performed on PL204 (职年受托, smallest dataset: 34 contract rows, 68 snapshot rows)
- Updated `mapping."产品线".产品线` from '职年受托' → '职年受托-测试'
- Verified propagation to `customer.customer_plan_contract`: `product_line_name` = '职年受托-测试' ✅
- Verified propagation to `customer.fct_customer_business_monthly_status`: `product_line_name` = '职年受托-测试' ✅
- Verified `updated_at` timestamps refreshed (2026-01-29 15:32:25) ✅
- Verified other product line codes NOT affected (only PL204 rows updated) ✅
- Rollback: restored PL204 back to '职年受托' ✅

**Pre-existing Test Failures (Not introduced by this story):**
- `test_core_tables_exist`: Hardcoded revision assertion (`20251228_000003`) does not account for migrations after 003
- `test_annuity_performance_has_correct_delete_scope_key` and related: Test assertions out of sync with domain registry

### Change Log

- 2026-01-29: Created Migration 011 (trg_sync_product_line_name trigger), verified all BRIN/Partial indexes, validated trigger propagation
- 2026-01-29: **Code Review Fixes** - H-001 (NULL handling with IS DISTINCT FROM), M-002 (performance logging with RAISE NOTICE), M-001 (SCP documentation alignment)

### File List

- `io/schema/migrations/versions/011_create_sync_product_line_trigger.py` (NEW → MODIFIED: code review fixes)
- `docs/sprint-artifacts/stories/epic-customer-mdm/7.6-9-index-trigger-optimization.md` (MODIFIED)
- `docs/sprint-artifacts/sprint-status.yaml` (MODIFIED)
- `docs/project-planning-artifacts/sprint-change-proposal-2026-01-10.md` (MODIFIED: trigger DDL alignment)
