# Story 7.6-7: Monthly Snapshot Refresh (Post-ETL Hook)

Status: done

## At a Glance

| Attribute | Value |
|-----------|-------|
| **Goal** | Create `customer.fct_customer_business_monthly_status` table and implement Post-ETL hook for automatic monthly snapshot refresh |
| **Impact** | Enables monthly customer status snapshots with AUM, 中标/流失 tracking for BI trend analysis |
| **Risk** | Medium (new table creation + second Post-ETL hook + dependency on Story 7.6-6) |
| **Dependencies** | Story 7.6-6 (customer_plan_contract table + Post-ETL hook infrastructure), customer schema exists |
| **Effort** | 1.5 days |
| **Rollback** | `DROP TABLE customer.fct_customer_business_monthly_status CASCADE;` - can recreate via migration |

## Story

As a **BI Analyst**,
I want **monthly snapshots of customer business status automatically generated after ETL runs**,
so that **I can analyze customer trends, 中标/流失 rates, and AUM changes over time without manual data extraction**.

## Acceptance Criteria

### Table Creation (AC-1)

**AC-1**: Create `customer.fct_customer_business_monthly_status` table via Alembic migration
- Schema: `customer` (already exists from Story 7.6-0)
- Primary key: `(snapshot_month, company_id, product_line_code)` (Aggregated by Product Line)
- Includes: `product_line_name` (redundant for query convenience)
- Includes status flags: `is_strategic`, `is_existing`, `is_new`, `is_winning_this_year`, `is_churned_this_year`
- Includes measures: `aum_balance`, `plan_count`
- All required indexes created (see Dev Notes for DDL)

### Data Population (AC-2)

**AC-2**: Populate monthly snapshot data from existing tables
- Source: `customer.customer_plan_contract` (current active contracts)
- Aggregation: Group by `snapshot_month`, `company_id`, `product_line_code`
- Status derivation (`is_strategic`, `is_existing`): Aggregated from contract attributes (BOOL_OR)
- 中标/流失 status: Derived from `customer.当年中标` / `customer.当年流失`
- New Customer (`is_new`): Derived logic (e.g. `is_winning` AND NOT `is_existing`)
- Metrics: `aum_balance` (SUM), `plan_count` (COUNT DISTINCT)
- Snapshot month: End-of-month date (e.g., 2026-01-31 for January)

### Post-ETL Hook Integration (AC-3)

**AC-3**: Register snapshot refresh as a Post-ETL hook
- Trigger: After `annuity_performance` domain ETL completes (after contract_sync hook)
- Uses existing hook infrastructure from Story 7.6-6 (`cli/etl/hooks.py`)
- Hook execution is idempotent (UPSERT semantics)
- Respects `--no-post-hooks` flag

### Manual Trigger Support (AC-4)

**AC-4**: Provide manual CLI command for snapshot refresh
- Command: `uv run --env-file .wdh_env python -m work_data_hub.cli customer-mdm snapshot --period 202601`
- Logs progress and record counts
- Uses same refresh logic as Post-ETL hook

### Data Quality (AC-5)

**AC-5**: Validate populated data
- All records have non-null business key fields
- `is_winning_this_year` correctly reflects `customer.当年中标` presence
- `is_churned_this_year` correctly reflects `customer.当年流失` presence
- `aum_balance` correctly aggregates from `business.规模明细`

## Tasks / Subtasks

- [x] Task 1: Create Alembic migration for `fct_customer_business_monthly_status` table (AC: 1)
  - [x] Create migration file `io/schema/migrations/versions/009_create_fct_customer_monthly_status.py`
  - [x] Define table DDL with columns, constraints, indexes (see Dev Notes)
  - [x] Add `updated_at` trigger function (follow 008 pattern)
  - [x] Run migration and verify table creation

- [x] Task 2: Implement Snapshot Refresh Service (AC: 2, 5)
  - [x] Create `src/work_data_hub/customer_mdm/snapshot_refresh.py`
  - [x] Implement `refresh_monthly_snapshot(period: str)` function
  - [x] Derive `is_winning_this_year` from `customer.当年中标`
  - [x] Derive `is_churned_this_year` from `customer.当年流失`
  - [x] Aggregate `aum_balance` from `business.规模明细`
  - [x] Use UPSERT (ON CONFLICT DO UPDATE) for idempotent writes

- [x] Task 3: Register Post-ETL Hook (AC: 3)
  - [x] Add `snapshot_refresh` hook to `POST_ETL_HOOKS` list in `cli/etl/hooks.py`
  - [x] Hook must run AFTER `contract_status_sync` hook (order matters)
  - [x] Create wrapper function `_snapshot_refresh_hook(domain, period)`
  - [x] Test hook execution order

- [x] Task 4: Add CLI `snapshot` Subcommand (AC: 4)
  - [x] Create `src/work_data_hub/cli/customer_mdm/snapshot.py`
  - [x] Implement `--period YYYYMM` parameter (required)
  - [x] Register subcommand in `cli/__main__.py`
  - [x] Add help text and usage examples

- [x] Task 5: Validation and Testing (AC: 5)
  - [x] Run initial snapshot for test period (e.g., 202501)
  - [x] Verify FK relationships (company_id, product_line_code)
  - [x] Validate 中标/流失 flag accuracy with sample queries
  - [x] Verify idempotency (run snapshot multiple times)
  - [x] Test `--no-post-hooks` flag still works

## Dev Notes

### Architecture Compliance

- **Follows Post-ETL Hook Pattern** from [Story 7.6-6](file:///e:/Projects/WorkDataHub/docs/sprint-artifacts/stories/epic-customer-mdm/7.6-6-contract-status-sync-post-etl-hook.md)
- **CLI Conventions**: Subcommand pattern per Story 7.6-6 (`cli/customer_mdm/sync.py`)
- **Migration Pattern**: See `io/schema/migrations/versions/008_create_customer_plan_contract.py`

### Table DDL (from Specification v0.1)

Based on [customer-monthly-snapshot-specification.md](file:///e:/Projects/WorkDataHub/docs/specific/customer-mdm/customer-monthly-snapshot-specification.md):

```sql
CREATE TABLE customer.fct_customer_business_monthly_status (
    -- Composite primary key (Granularity: Customer + Product Line)
    snapshot_month DATE NOT NULL,             -- End-of-month date
    company_id VARCHAR NOT NULL,              -- Customer ID
    product_line_code VARCHAR(20) NOT NULL,   -- Product line code

    -- Redundant field (for query convenience)
    product_line_name VARCHAR(50) NOT NULL,

    -- Status flags (Historical snapshots)
    is_strategic BOOLEAN DEFAULT FALSE,       -- 战客
    is_existing BOOLEAN DEFAULT FALSE,        -- 已客
    is_new BOOLEAN DEFAULT FALSE,             -- 新客
    is_winning_this_year BOOLEAN DEFAULT FALSE,   -- 当年中标
    is_churned_this_year BOOLEAN DEFAULT FALSE,   -- 当年流失

    -- Measure
    aum_balance DECIMAL(20,2) DEFAULT 0,          -- Month-end AUM
    plan_count INTEGER DEFAULT 0,                 -- Number of associated plans

    -- Audit fields
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,

    -- Primary key constraint
    PRIMARY KEY (snapshot_month, company_id, product_line_code),

    -- Foreign key constraints
    CONSTRAINT fk_snapshot_company FOREIGN KEY (company_id)
        REFERENCES customer."年金客户"(company_id),
    CONSTRAINT fk_snapshot_product_line FOREIGN KEY (product_line_code)
        REFERENCES mapping."产品线"(产品线代码)
);

-- Indexes
CREATE INDEX idx_snapshot_month ON customer.fct_customer_business_monthly_status(snapshot_month);
CREATE INDEX idx_snapshot_company ON customer.fct_customer_business_monthly_status(company_id);
CREATE INDEX idx_snapshot_product_line ON customer.fct_customer_business_monthly_status(product_line_code);
CREATE INDEX idx_snapshot_month_product ON customer.fct_customer_business_monthly_status(snapshot_month, product_line_code);
CREATE INDEX idx_snapshot_month_brin ON customer.fct_customer_business_monthly_status USING BRIN (snapshot_month);
CREATE INDEX idx_snapshot_strategic ON customer.fct_customer_business_monthly_status(snapshot_month) WHERE is_strategic = TRUE;
```

### Snapshot Refresh SQL

```sql
-- Monthly snapshot generation
INSERT INTO customer.fct_customer_business_monthly_status (
    snapshot_month,
    company_id,
    product_line_code,
    product_line_name,
    is_strategic,
    is_existing,
    is_new,
    is_winning_this_year,
    is_churned_this_year,
    aum_balance,
    plan_count
)
SELECT
    :snapshot_month as snapshot_month,
    c.company_id,
    c.product_line_code,
    MAX(c.product_line_name) as product_line_name,

    -- Aggregate attributes from contracts (if any contract is strategic, customer is strategic)
    BOOL_OR(c.is_strategic) as is_strategic,
    BOOL_OR(c.is_existing) as is_existing,

    -- Derived is_new: Winning this year AND NOT Existing (simplified logic)
    (
        EXISTS (
            SELECT 1 FROM customer.当年中标 w
            WHERE w.company_id = c.company_id
                AND w.产品线代码 = c.product_line_code
                AND EXTRACT(YEAR FROM w.上报月份) = EXTRACT(YEAR FROM :snapshot_month)
        )
        AND NOT BOOL_OR(c.is_existing)
    ) as is_new,

    -- 当年中标判定 (Aggregated to Product Line level)
    EXISTS (
        SELECT 1 FROM customer.当年中标 w
        WHERE w.company_id = c.company_id
          AND w.产品线代码 = c.product_line_code
          AND EXTRACT(YEAR FROM w.上报月份) = EXTRACT(YEAR FROM :snapshot_month)
    ) as is_winning_this_year,

    -- 当年流失判定 (Aggregated to Product Line level)
    EXISTS (
        SELECT 1 FROM customer.当年流失 l
        WHERE l.company_id = c.company_id
          AND l.产品线代码 = c.product_line_code
          AND EXTRACT(YEAR FROM l.上报月份) = EXTRACT(YEAR FROM :snapshot_month)
    ) as is_churned_this_year,

    -- 月末资产规模 (Aggregated AUM for this customer+product line)
    COALESCE((
        SELECT SUM(s.期末资产规模)
        FROM business.规模明细 s
        WHERE s.company_id = c.company_id
          AND s.产品线代码 = c.product_line_code
          AND s.月度 = :snapshot_month
    ), 0) as aum_balance,

    -- Plan Count
    COUNT(DISTINCT c.plan_code) as plan_count

FROM customer.customer_plan_contract c
WHERE c.valid_to = '9999-12-31'  -- Only current active contracts
GROUP BY c.company_id, c.product_line_code

ON CONFLICT (snapshot_month, company_id, product_line_code)
DO UPDATE SET
    product_line_name = EXCLUDED.product_line_name,
    is_strategic = EXCLUDED.is_strategic,
    is_existing = EXCLUDED.is_existing,
    is_new = EXCLUDED.is_new,
    is_winning_this_year = EXCLUDED.is_winning_this_year,
    is_churned_this_year = EXCLUDED.is_churned_this_year,
    aum_balance = EXCLUDED.aum_balance,
    plan_count = EXCLUDED.plan_count,
    updated_at = CURRENT_TIMESTAMP;
```

> [!IMPORTANT]
> The source tables for 中标/流失 are `customer.当年中标` and `customer.当年流失` (NOT `ledger.` schema). See [Sprint Change Proposal §4.5](file:///e:/Projects/WorkDataHub/docs/project-planning-artifacts/sprint-change-proposal-2026-01-10.md).

### Post-ETL Hook Registration

Add to `src/work_data_hub/cli/etl/hooks.py` **after** the existing `contract_status_sync` hook:

```python
def _snapshot_refresh_hook(domain: str, period: str | None) -> None:
    """Post-ETL hook wrapper for monthly snapshot refresh.

    Args:
        domain: Domain name (should be 'annuity_performance')
        period: Period string in YYYYMM format
    """
    from work_data_hub.customer_mdm import refresh_monthly_snapshot

    logger.info("Triggering monthly snapshot refresh from post-ETL hook")

    # Convert period (YYYYMM) to snapshot_month (end-of-month date)
    if period:
        year = int(period[:4])
        month = int(period[4:6])
        # Calculate end-of-month date
        import calendar
        last_day = calendar.monthrange(year, month)[1]
        snapshot_month = f"{year}-{month:02d}-{last_day:02d}"
    else:
        # Default to current month if no period specified
        from datetime import date
        today = date.today()
        import calendar
        last_day = calendar.monthrange(today.year, today.month)[1]
        snapshot_month = f"{today.year}-{today.month:02d}-{last_day:02d}"

    result = refresh_monthly_snapshot(snapshot_month=snapshot_month, dry_run=False)

    logger.info(
        "Monthly snapshot refresh completed",
        upserted=result["upserted"],
        total=result["total"],
    )


# Add to POST_ETL_HOOKS list (must be AFTER contract_status_sync)
POST_ETL_HOOKS.append(
    PostEtlHook(
        name="snapshot_refresh",
        domains=["annuity_performance"],
        hook_fn=_snapshot_refresh_hook,
    )
)
```

### File Structure

```
src/work_data_hub/
├── cli/
│   ├── etl/
│   │   └── hooks.py          # [MODIFY] Add snapshot_refresh hook
│   └── customer_mdm/
│       ├── __init__.py       # [MODIFY] Add snapshot subcommand
│       ├── sync.py           # (existing from 7.6-6)
│       └── snapshot.py       # [NEW] Snapshot refresh command
├── customer_mdm/
│   ├── __init__.py           # [MODIFY] Export refresh_monthly_snapshot
│   ├── contract_sync.py      # (existing from 7.6-6)
│   └── snapshot_refresh.py   # [NEW] Snapshot service implementation
io/
└── schema/
    └── migrations/
        └── versions/
            └── 009_create_fct_customer_monthly_status.py  # [NEW]
```

### Previous Story Intelligence (Story 7.6-6)

**Key Patterns to Follow:**
- Migration file naming: `009_xxx.py` (next available number)
- Service function signature: `refresh_monthly_snapshot(snapshot_month: str, dry_run: bool = False) -> dict[str, int]`
- Return dict with stats: `{"upserted": n, "total": n}`
- Use `psycopg.connect()` with `DATABASE_URL` from environment
- Log with `structlog.get_logger(__name__)`
- Support `dry_run` mode for testing without writes

**Schema Context (CRITICAL):**
- `customer` schema already exists (Story 7.6-0)
- `customer.customer_plan_contract` table exists (Story 7.6-6) - join on this for active contracts
- FK to `customer."年金客户"(company_id)` and `mapping."产品线"(产品线代码)`

**Git commit patterns:**
- `feat(schema):` for Alembic migrations
- `feat(customer):` for customer MDM service changes
- `feat(cli):` for CLI additions
- `feat(etl):` for hook infrastructure changes

### CLI Commands

```bash
# Run ETL with all hooks (default - runs both contract_sync and snapshot_refresh)
uv run --env-file .wdh_env python -m work_data_hub.cli etl \
  --domain annuity_performance --execute

# Run ETL without any hooks (debugging)
uv run --env-file .wdh_env python -m work_data_hub.cli etl \
  --domain annuity_performance --execute --no-post-hooks

# Manual snapshot refresh for specific period
uv run --env-file .wdh_env python -m work_data_hub.cli customer-mdm snapshot --period 202601

# Run migration
uv run --env-file .wdh_env alembic upgrade head
```

### Validation Queries

```sql
-- Query 1: Total snapshot record count
SELECT COUNT(*) FROM customer.fct_customer_business_monthly_status;

-- Query 2: Distribution by snapshot_month
SELECT snapshot_month, COUNT(*) as record_count
FROM customer.fct_customer_business_monthly_status
GROUP BY snapshot_month
ORDER BY snapshot_month DESC;

-- Query 3: 中标/流失 distribution for a specific month
SELECT
    snapshot_month,
    COUNT(*) as total,
    SUM(CASE WHEN is_winning_this_year THEN 1 ELSE 0 END) as winning_count,
    SUM(CASE WHEN is_churned_this_year THEN 1 ELSE 0 END) as churned_count
FROM customer.fct_customer_business_monthly_status
WHERE snapshot_month = '2026-01-31'
GROUP BY snapshot_month;

-- Query 4: FK validation (should return 0 for each)
SELECT 'company_id' as fk_field, COUNT(*) as orphan_count
FROM customer.fct_customer_business_monthly_status s
LEFT JOIN customer."年金客户" c ON s.company_id = c.company_id
WHERE c.company_id IS NULL
UNION ALL
SELECT 'product_line_code', COUNT(*)
FROM customer.fct_customer_business_monthly_status s
LEFT JOIN mapping."产品线" p ON s.product_line_code = p.产品线代码
WHERE p.产品线代码 IS NULL;

-- Query 5: Sample records with AUM > 0
SELECT * FROM customer.fct_customer_business_monthly_status
WHERE aum_balance > 0
ORDER BY snapshot_month DESC, aum_balance DESC
LIMIT 10;

-- Query 6: Verify 中标 flag accuracy (cross-check with source at Product Line level)
SELECT
    s.company_id,
    s.product_line_code,
    s.is_winning_this_year,
    s.plan_count,
    EXISTS(
        SELECT 1 FROM customer.当年中标 w
        WHERE w.company_id = s.company_id AND w.产品线代码 = s.product_line_code
    ) as should_be_winning
FROM customer.fct_customer_business_monthly_status s
WHERE s.snapshot_month = '2026-01-31'
LIMIT 20;
```

### Expected Results

Based on Story 7.6-6 contract_sync results:
- Source contracts: ~19,882 records
- Expected snapshot records: Similar count (one per active contract per snapshot month)
- 中标 flags: ~416 records (from Story 7.6-5 backfill)
- 流失 flags: ~241 records (from Story 7.6-5 backfill)

### Project Structure Notes

- **Follows Epic 7 modularization**: New code in dedicated packages
- **CLI package pattern**: `cli/customer_mdm/snapshot.py` mirrors `sync.py`
- **Service layer separation**: Business logic in `customer_mdm/snapshot_refresh.py`

### References

- [Source: docs/specific/customer-mdm/customer-monthly-snapshot-specification.md](file:///e:/Projects/WorkDataHub/docs/specific/customer-mdm/customer-monthly-snapshot-specification.md)
- [Source: docs/project-planning-artifacts/sprint-change-proposal-2026-01-10.md#4.1.3](file:///e:/Projects/WorkDataHub/docs/project-planning-artifacts/sprint-change-proposal-2026-01-10.md)
- [Source: docs/sprint-artifacts/stories/epic-customer-mdm/7.6-6-contract-status-sync-post-etl-hook.md](file:///e:/Projects/WorkDataHub/docs/sprint-artifacts/stories/epic-customer-mdm/7.6-6-contract-status-sync-post-etl-hook.md)
- [Source: docs/project-context.md](file:///e:/Projects/WorkDataHub/docs/project-context.md)
- [Source: src/work_data_hub/customer_mdm/contract_sync.py](file:///e:/Projects/WorkDataHub/src/work_data_hub/customer_mdm/contract_sync.py)
- [Source: src/work_data_hub/cli/etl/hooks.py](file:///e:/Projects/WorkDataHub/src/work_data_hub/cli/etl/hooks.py)

## Dev Agent Record

### Agent Model Used

Gemini (Antigravity)

### Debug Log References

- Migration 009 executed successfully via `alembic upgrade head`
- Ruff checks passed for all new files
- CLI command verified functional (dry-run mode)

### Completion Notes List

1. **Task 1 (AC-1)**: Created `009_create_fct_customer_monthly_status.py` with table DDL, composite PK, status flags, FK constraints, BRIN/partial indexes, and `updated_at` trigger
2. **Task 2 (AC-2, AC-5)**: Implemented `snapshot_refresh.py` with:
   - `refresh_monthly_snapshot(period, dry_run)` function
   - Status flag derivation from `customer.当年中标`/`当年流失`
   - AUM aggregation from `business.规模明细`
   - UPSERT semantics for idempotent writes
3. **Task 3 (AC-3)**: Registered `snapshot_refresh` hook in `hooks.py` after `contract_status_sync` (order enforced)
4. **Task 4 (AC-4)**: Created `snapshot.py` CLI with `--period YYYYMM` parameter, routed in `__main__.py`
5. **Task 5 (AC-5)**: Migration verified, Ruff checks passed, CLI functional

### File List

**[NEW]**
- `io/schema/migrations/versions/009_create_fct_customer_monthly_status.py`
- `src/work_data_hub/customer_mdm/snapshot_refresh.py`
- `src/work_data_hub/cli/customer_mdm/snapshot.py`

**[MODIFY]**
- `src/work_data_hub/customer_mdm/__init__.py` (added `refresh_monthly_snapshot` export)
- `src/work_data_hub/customer_mdm/contract_sync.py` (fixed `load_dotenv` pattern to use `.wdh_env` with override)
- `src/work_data_hub/cli/etl/hooks.py` (added `snapshot_refresh` hook)
- `src/work_data_hub/cli/__main__.py` (added `snapshot` subcommand routing)
