# Story 7.6-15: Ratchet Rule Implementation (只增不减规则)

Status: done

## At a Glance

| Attribute | Value |
|-----------|-------|
| **Goal** | Implement the "Ratchet Rule" for strategic customer status protection |
| **Impact** | Fixes 10,417 records with inconsistent status, ensures data integrity |
| **Risk** | Medium (modifies core SCD Type 2 logic) |
| **Dependencies** | Story 7.6-6 (done), Story 7.6-12 (done) |
| **Priority** | P0 (Critical data consistency issue) |
| **Rollback** | Revert SQL changes, re-run sync to restore previous behavior |

## Story

As a **BI Analyst**,
I want **strategic customer status to follow the "ratchet rule" (only upgrade, never downgrade within a status year)**,
So that **KPI calculations remain accurate and consistent with business rules**.

## Background

### Problem Statement

The current implementation in `close_old_records.sql` (line 57-60) triggers SCD Type 2 updates for ANY change in `is_strategic`, including downgrades:

```sql
-- CURRENT (INCORRECT)
AND (
    old.contract_status IS DISTINCT FROM new.contract_status
    OR old.is_strategic IS DISTINCT FROM new.is_strategic  -- ❌ Triggers downgrade
    OR old.is_existing IS DISTINCT FROM new.is_existing
)
```

### Business Rule Violation

Per `docs/memories/战客身份定义与更新逻辑.md` - **Principle 3: Ratchet Rule**:
- **Can upgrade**: FALSE → TRUE (普通客户 → 战客)
- **Cannot downgrade**: TRUE → FALSE (战客 must remain 战客 within same status_year)

### Data Impact

| Current Status | Expected Status | Count | Issue |
|----------------|-----------------|-------|-------|
| 正常 | **停缴** | **10,417** | contract_status not syncing |
| 正常 | 正常 | 7,572 | Correct |
| 停缴 | 停缴 | 1,638 | Correct |
| 停缴 | 正常 | 255 | Minor inconsistency |

## Acceptance Criteria

### AC-1: Ratchet Rule for is_strategic

- Strategic customers (is_strategic=TRUE) cannot be downgraded within the same status_year
- Non-strategic customers CAN be upgraded to strategic (FALSE → TRUE triggers SCD update)
- Downgrade attempts (TRUE → FALSE) are silently ignored (no SCD record created)

### AC-2: contract_status Sync Fix

- Records with `期末资产规模 > 0` AND `12-month contribution = 0` must be marked as "停缴"
- After fix, inconsistent record count should be 0

### AC-3: Python Ratchet Logic

- Implement `apply_ratchet_rule()` function in `contract_sync.py`
- Function returns `(final_status, should_trigger_scd_update)`

### AC-4: SQL Change Detection Fix

- Modify `close_old_records.sql` to only trigger on upgrade (FALSE → TRUE)
- Do NOT trigger on downgrade (TRUE → FALSE)

### AC-5: Unit Tests

- Test case: Strategic customer AUM drops → remains strategic, no SCD update
- Test case: Non-strategic customer AUM rises → becomes strategic, SCD update triggered
- Test case: contract_status change detection works correctly

### AC-6: Data Repair

- Run sync to fix 10,417 inconsistent records
- Verify post-fix: `SELECT COUNT(*) WHERE expected != actual` returns 0
- **RESOLVED**: After code review fixes, inconsistent count = **0** ✅

## Tasks / Subtasks

- [x] Task 1: Implement Python Ratchet Logic (AC: 1, 3)
  - [x] Add `apply_ratchet_rule()` function to `contract_sync.py`
  - [x] Function signature: `(is_strategic_db: bool, is_strategic_calculated: bool) -> tuple[bool, bool]`
  - [x] Return `(final_status, should_trigger_update)`

- [x] Task 2: Modify SQL Change Detection (AC: 1, 4)
  - [x] Update `close_old_records.sql` line 57-60
  - [x] Change `old.is_strategic IS DISTINCT FROM new.is_strategic` to upgrade-only logic
  - [x] New condition: `(old.is_strategic = FALSE AND new.is_strategic = TRUE)`

- [x] Task 3: Fix contract_status Sync (AC: 2)
  - [x] Verify `contribution_12m` CTE calculates correctly
  - [x] Ensure status changes from "正常" to "停缴" are detected
  - [x] Run sync and verify 10,417 records are fixed

- [x] Task 4: Add Unit Tests (AC: 5)
  - [x] `test_ratchet_rule_prevents_downgrade()`
  - [x] `test_ratchet_rule_allows_upgrade()`
  - [x] `test_contract_status_change_detection()`

- [x] Task 5: Data Validation (AC: 6)
  - [x] Run validation SQL before fix
  - [x] Execute sync with new logic
  - [x] Run validation SQL after fix (expect 0 inconsistencies)

## Dev Notes

### Architecture Compliance

- **Follows SCD Type 2 Pattern** from Story 7.6-12
- **SQL File Pattern**: SQL in `src/work_data_hub/customer_mdm/sql/` directory
- **Business Rule Source**: `docs/memories/战客身份定义与更新逻辑.md`

### Python Implementation

```python
def apply_ratchet_rule(
    is_strategic_db: bool,
    is_strategic_calculated: bool
) -> tuple[bool, bool]:
    """Apply the "Ratchet Rule" for strategic customer status.

    Business Rule (Principle 3 - 只增不减):
    - Can upgrade: FALSE → TRUE (triggers SCD update)
    - Cannot downgrade: TRUE → FALSE (no SCD update)

    Args:
        is_strategic_db: Current status in database
        is_strategic_calculated: Newly calculated status from AUM

    Returns:
        (final_strategic_status, should_trigger_scd_update)
    """
    if is_strategic_db is True and is_strategic_calculated is False:
        # Protection: Strategic customer AUM dropped, keep status
        return True, False  # No SCD update

    if is_strategic_db is False and is_strategic_calculated is True:
        # Upgrade: Non-strategic → Strategic
        return True, True  # Trigger SCD update

    # No change
    return is_strategic_calculated, False
```

### SQL Modification

**File**: `src/work_data_hub/customer_mdm/sql/close_old_records.sql`

**OLD** (line 57-60):
```sql
AND (
    old.contract_status IS DISTINCT FROM new.contract_status
    OR old.is_strategic IS DISTINCT FROM new.is_strategic
    OR old.is_existing IS DISTINCT FROM new.is_existing
)
```

**NEW**:
```sql
AND (
    old.contract_status IS DISTINCT FROM new.contract_status
    OR (old.is_strategic = FALSE AND new.is_strategic = TRUE)
    OR old.is_existing IS DISTINCT FROM new.is_existing
)
```

### File Changes

| File | Change |
|------|--------|
| `src/work_data_hub/customer_mdm/contract_sync.py` | Add `apply_ratchet_rule()` function |
| `src/work_data_hub/customer_mdm/sql/close_old_records.sql` | Fix is_strategic change detection |
| `tests/unit/customer_mdm/test_contract_sync.py` | Add ratchet rule tests |

### Validation SQL (Pre-Fix)

```sql
-- Check inconsistent records count
WITH contribution_12m AS (
    SELECT company_id, 计划代码, 产品线代码,
           CASE WHEN SUM(COALESCE(供款, 0)) > 0
                THEN TRUE ELSE FALSE END as has_contribution
    FROM business."规模明细"
    WHERE 月度 >= (CURRENT_DATE - INTERVAL '12 months')
      AND company_id IS NOT NULL
    GROUP BY company_id, 计划代码, 产品线代码
),
latest_source AS (
    SELECT DISTINCT ON (company_id, 计划代码, 产品线代码)
        company_id, 计划代码, 产品线代码, 期末资产规模
    FROM business."规模明细"
    WHERE company_id IS NOT NULL
    ORDER BY company_id, 计划代码, 产品线代码, 月度 DESC
)
SELECT
    cpc.contract_status as current_status,
    CASE WHEN ls.期末资产规模 > 0
              AND COALESCE(c12.has_contribution, FALSE) = TRUE
         THEN '正常' ELSE '停缴' END as expected_status,
    COUNT(*) as count
FROM customer.customer_plan_contract cpc
JOIN latest_source ls
    ON cpc.company_id = ls.company_id
    AND cpc.plan_code = ls.计划代码
    AND cpc.product_line_code = ls.产品线代码
LEFT JOIN contribution_12m c12
    ON ls.company_id = c12.company_id
    AND ls.计划代码 = c12.计划代码
    AND ls.产品线代码 = c12.产品线代码
WHERE cpc.valid_to = '9999-12-31'
GROUP BY cpc.contract_status, expected_status;
```

### CLI Commands

```bash
# Run contract sync with new logic
uv run --env-file .wdh_env python -m work_data_hub.cli customer-mdm sync

# Run unit tests
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/unit/customer_mdm/ -v
```

### Project Structure Notes

- Follows Epic 7 modularization pattern
- SQL files in dedicated `sql/` directory
- Unit tests mirror source structure

### References

- [Source: docs/memories/战客身份定义与更新逻辑.md](file:///e:/Projects/WorkDataHub/docs/memories/战客身份定义与更新逻辑.md)
- [Source: docs/specific/customer-mdm/customer-plan-contract-implementation-gap-analysis.md](file:///e:/Projects/WorkDataHub/docs/specific/customer-mdm/customer-plan-contract-implementation-gap-analysis.md)
- [Source: docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2026-02-05.md](file:///e:/Projects/WorkDataHub/docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2026-02-05.md)
- [Source: docs/sprint-artifacts/stories/epic-customer-mdm/7.6-12-scd2-implementation-fix.md](file:///e:/Projects/WorkDataHub/docs/sprint-artifacts/stories/epic-customer-mdm/7.6-12-scd2-implementation-fix.md)

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Fixed SQL placeholder issue: Comments containing `%s` were being counted as parameters
- Fixed UniqueViolation: Changed `SELECT DISTINCT` to `SELECT DISTINCT ON` with proper `ORDER BY`

### Completion Notes List

1. **Task 1**: Implemented `apply_ratchet_rule()` function with 6 unit tests (Python reference impl for testing)
2. **Task 2**: Modified `close_old_records.sql` to only trigger SCD update on is_strategic upgrade (FALSE → TRUE)
3. **Task 3**: Fixed contract_status sync - reduced inconsistencies from 10,417 to **0** records ✅
4. **Task 4**: Added 9 new unit tests (6 for ratchet rule, 3 for contract_status change detection)
5. **Task 5**: Validated data before/after sync - **AC-6 fully satisfied** ✅

**Code Review Fixes (2026-02-06)**:
- Fixed unique constraint: `uq_active_contract(valid_to)` → `uq_contract_version(valid_from)`
- Fixed `close_old_records.sql`: Added `latest_source` CTE to ensure latest month data
- Fixed `sync_insert.sql`: Changed `valid_from` to `CURRENT_DATE`, added same-day check in NOT EXISTS
- Cleaned up 1505 duplicate records via migration

### File List

| File | Change |
|------|--------|
| `src/work_data_hub/customer_mdm/contract_sync.py` | Added `apply_ratchet_rule()` function with reference impl docs |
| `src/work_data_hub/customer_mdm/sql/close_old_records.sql` | Ratchet Rule + latest_source CTE fix |
| `src/work_data_hub/customer_mdm/sql/sync_insert.sql` | Fixed valid_from=CURRENT_DATE, NOT EXISTS check |
| `src/work_data_hub/customer_mdm/sql/common_ctes.sql` | Removed %s from comments |
| `src/work_data_hub/cli/customer_mdm/sync.py` | Fixed output key: updated → closed |
| `tests/unit/customer_mdm/test_contract_sync.py` | Added 9 new tests for Ratchet Rule |
| `docs/sprint-artifacts/sprint-status.yaml` | Updated story status to done |
| `io/schema/migrations/versions/012_fix_contract_unique_constraint.py` | New migration: uq_active_contract → uq_contract_version |

### Change Log

- 2026-02-05: Story 7.6-15 implementation complete

