# Story 7.6-17: FK Backfill Configuration for Annual Award/Loss

Status: review

## At a Glance

| Attribute | Value |
|-----------|-------|
| **Goal** | Configure FK backfill for `annual_award` and `annual_loss` domains to populate `年金客户` table |
| **Impact** | Enables complete customer lifecycle tracking from all data sources |
| **Risk** | Low (configuration-only change, extends existing patterns) |
| **Dependencies** | Story 7.6-16 (done) - Dual-table design in place |
| **Priority** | P1 (Data completeness) |
| **Effort** | Low (0.5 day) |

## Story

As a **Data Engineer**,
I want **FK backfill configured for `annual_award` and `annual_loss` domains**,
So that **company records from award/loss data are automatically populated into the `年金客户` master table**.

## Background

### Problem Statement

当前 FK 回填仅配置了 `annuity_performance` 和 `annuity_income` 域：

| Domain | FK Backfill to `年金客户` | Status |
|--------|---------------------------|--------|
| `annuity_performance` | ✅ Configured | Done |
| `annuity_income` | ✅ Configured | Done |
| `annual_award` | ❌ Not configured | **This Story** |
| `annual_loss` | ❌ Not configured | **This Story** |

### Business Impact

- 中标客户 (`annual_award`) 可能在 `规模明细` 出现前就已存在
- 流失客户 (`annual_loss`) 可能在 `规模明细` 消失后仍需追踪
- 缺少这些数据源会导致 `年金客户` 表不完整

### Source Documents

- [Sprint Change Proposal: 2026-02-11-customer-mdm-optimization](../../planning-artifacts/sprint-change-proposal/sprint-change-proposal-2026-02-11-customer-mdm-optimization.md)
- [Business Analysis: customer-mdm-backfill-analysis](../../../docs/business-background/customer-mdm-backfill-analysis.md)

## Acceptance Criteria

### AC-1: annual_award FK Configuration

- `config/foreign_keys.yml` contains `annual_award` domain section
- FK rule `fk_customer` configured with:
  - `source_column: "company_id"`
  - `target_table: "年金客户"`
  - `target_schema: "customer"`
  - `mode: "insert_missing"`
- Backfill columns include: `company_id`, `客户全称` → `客户名称`

### AC-2: annual_loss FK Configuration

- `config/foreign_keys.yml` contains `annual_loss` domain section
- FK rule `fk_customer` configured with same pattern as `annual_award`
- Backfill columns include: `company_id`, `客户全称` → `客户名称`

### AC-3: Data Source Configuration

- `config/data_sources.yml` updated with `requires_backfill: true` for both domains
- Domain configurations validated by startup check

### AC-4: Integration Test

- FK backfill executes successfully for both domains
- Records appear in `年金客户` table after ETL run
- No duplicate records created (INSERT_MISSING mode)

## Tasks / Subtasks

- [x] Task 1: Add annual_award FK config (AC: 1)
  - [x] Add `annual_award` section to `config/foreign_keys.yml`
  - [x] Configure `fk_customer` rule with backfill columns
  - [x] Verify column mappings match source table schema

- [x] Task 2: Add annual_loss FK config (AC: 2)
  - [x] Add `annual_loss` section to `config/foreign_keys.yml`
  - [x] Configure `fk_customer` rule with backfill columns
  - [x] Verify column mappings match source table schema

- [x] Task 3: Update data_sources.yml (AC: 3)
  - [x] Add `requires_backfill: true` to `annual_award` domain
  - [x] Add `requires_backfill: true` to `annual_loss` domain

- [x] Task 4: Validation (AC: 4)
  - [x] Run ETL dry-run for both domains
  - [x] Verify FK backfill logs show correct behavior
  - [x] Run integration test if available

## Dev Notes

### Source Table Schemas

#### customer."当年中标" (annual_award)

| Column | Type | Notes |
|--------|------|-------|
| `company_id` | VARCHAR | Primary key for FK backfill |
| `客户全称` | VARCHAR | Maps to `年金客户.客户名称` |
| `上报月份` | DATE | Reporting month |
| `年金计划号` | VARCHAR | Plan reference |

#### customer."当年流失" (annual_loss)

| Column | Type | Notes |
|--------|------|-------|
| `company_id` | VARCHAR | Primary key for FK backfill |
| `客户全称` | VARCHAR | Maps to `年金客户.客户名称` |
| `上报月份` | DATE | Reporting month |
| `年金计划号` | VARCHAR | Plan reference |

### FK Configuration Pattern

Follow existing `annuity_performance` pattern but simplified (no aggregations needed):

```yaml
annual_award:
  foreign_keys:
    - name: "fk_customer"
      source_column: "company_id"
      target_table: "年金客户"
      target_key: "company_id"
      target_schema: "customer"
      mode: "insert_missing"
      skip_blank_values: true
      backfill_columns:
        - source: "company_id"
          target: "company_id"
        - source: "客户全称"
          target: "客户名称"
          optional: true
```

### Architecture Compliance

- **Config-Driven**: All changes in YAML config files, no code changes required
- **Existing Pattern**: Follows established FK backfill framework from Epic 6.2
- **INSERT_MISSING Mode**: Only adds records not already in target table

### Key Files

| File | Action |
|------|--------|
| `config/foreign_keys.yml` | Modify - Add two domain sections |
| `config/data_sources.yml` | Modify - Add `requires_backfill` flags |

### Validation Commands

```bash
# Verify config loads without errors
uv run --env-file .wdh_env python -c "from work_data_hub.domain.reference_backfill.config_loader import load_fk_config; print(load_fk_config())"

# Run ETL dry-run for annual_award
uv run --env-file .wdh_env python -m work_data_hub.cli etl --domain annual_award --dry-run

# Run ETL dry-run for annual_loss
uv run --env-file .wdh_env python -m work_data_hub.cli etl --domain annual_loss --dry-run
```

### References

- [Source: config/foreign_keys.yml] - Existing FK backfill patterns
- [Source: docs/project-context.md#6] - Domain Registry Architecture
- [Source: docs/business-background/customer-mdm-backfill-analysis.md] - Business requirements

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

- FK config validation: `load_foreign_keys_config(domain='annual_award')` returns 1 FK config
- FK config validation: `load_foreign_keys_config(domain='annual_loss')` returns 1 FK config
- Reference backfill tests: 21 passed

### Completion Notes List

- Added `annual_award` FK config to `config/foreign_keys.yml` with `fk_customer` rule targeting `customer.年金客户`
- Added `annual_loss` FK config to `config/foreign_keys.yml` with same pattern
- Updated `config/data_sources.yml` to set `requires_backfill: true` for both domains
- Configuration loads successfully, validated via Python import test
- ETL dry-run confirms domain configuration is recognized (5 domains loaded)
- All 21 reference backfill unit tests pass with no regressions

### File List

- `config/foreign_keys.yml` - Modified (added annual_award and annual_loss FK sections)
- `config/data_sources.yml` - Modified (changed requires_backfill to true for both domains)
