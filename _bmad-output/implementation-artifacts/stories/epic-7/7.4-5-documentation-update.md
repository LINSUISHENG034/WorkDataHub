# Story 7.4-5: Documentation Update

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a **Developer**,
I want **the architecture documentation to reflect the new Domain Registry pattern introduced in Epic 7.4**,
so that **future developers understand how to add new domains using the registry pattern instead of modifying hardcoded dispatch logic, and the technical debt document is marked as resolved**.

## Acceptance Criteria

1.  **Project Context Update**: Update `docs/project-context.md` to add a "Domain Registry Architecture" section explaining the `JOB_REGISTRY` pattern and `DOMAIN_SERVICE_REGISTRY` pattern, with references to relevant source files.
2.  **New Architecture Document**: Create `docs/architecture/domain-registry.md` documenting:
    - Registry pattern overview and rationale
    - `JOB_REGISTRY` structure and usage (from `orchestration/jobs.py`), including `JobEntry` dataclass fields: `job`, `multi_file_job`, `supports_backfill`
    - `DOMAIN_SERVICE_REGISTRY` structure and usage (from `orchestration/ops/pipeline_ops.py`), including `DomainServiceEntry` dataclass fields: `service_fn`, `supports_enrichment`, `domain_name`
    - Step-by-step guide for adding a new domain (reduced from 5-7 files to 2-3 files)
    - Config-driven backfill via `requires_backfill` in `data_sources.yml`
    - Startup validation via `validate_domain_registry()`
3.  **Checklist Resolution**: Mark `docs/specific/multi-domain/new-domain-checklist.md` as **RESOLVED** by:
    - Adding a prominent header/banner indicating the issues have been addressed
    - Updating the "Architectural Debt Summary" section with resolution status for each issue (MD-001 through MD-005)
    - Adding a "Resolution Summary" section linking to Epic 7.4 stories and new documentation
4.  **Cross-References**: Ensure all three documents cross-reference each other and the Epic 7.4 sprint change proposal.
5.  **No Code Changes**: This is a documentation-only story; no Python code should be modified.

## Tasks / Subtasks

- [x] **Task 1: Update Project Context** (AC1, AC4)

  - [x] 1.1 Add "Domain Registry Architecture" section to `docs/project-context.md` (after Section 5 "Key Architecture Files").
  - [x] 1.2 Document `JOB_REGISTRY` location and purpose.
  - [x] 1.3 Document `DOMAIN_SERVICE_REGISTRY` location and purpose.
  - [x] 1.4 Add cross-reference to new `docs/architecture/domain-registry.md`.

- [x] **Task 2: Create Architecture Document** (AC2, AC4)

  - [x] 2.1 Create `docs/architecture/domain-registry.md` with proper frontmatter.
  - [x] 2.2 Write "Overview" section explaining the Registry Pattern rationale (OCP, SSOT, reduced maintenance).
  - [x] 2.3 Write "JOB_REGISTRY" section with code snippet from `orchestration/jobs.py`.
  - [x] 2.4 Write "DOMAIN_SERVICE_REGISTRY" section with code snippet from `orchestration/ops/pipeline_ops.py`.
  - [x] 2.5 Write "Adding a New Domain" step-by-step guide (reduced from 5-7 files to 2-3 files).
  - [x] 2.6 Write "Configuration Options" section covering `requires_backfill` and FK config.
  - [x] 2.7 Write "Startup Validation" section documenting `validate_domain_registry()`.
  - [x] 2.8 Add cross-references to related documents.

- [x] **Task 3: Mark Checklist as Resolved** (AC3, AC4)

  - [x] 3.1 Add `> **STATUS: ✅ RESOLVED**` banner at top of `new-domain-checklist.md`.
  - [x] 3.2 Update "Issues Identified" table with resolution status and linked stories.
  - [x] 3.3 Add "Resolution Summary" section with links to Epic 7.4 stories.
  - [x] 3.4 Update "Recommended Improvements" section to show implementation status.

- [x] **Task 4: Verify & Cross-Check** (AC4, AC5)
  - [x] 4.1 Verify all cross-references are valid and consistent.
  - [x] 4.2 Verify no Python files were modified.
  - [x] 4.3 Run spell check on new documentation (optional).

## Dev Notes

### Architecture Patterns

- **Documentation-Only Story**: This story involves NO code changes. All modifications are to markdown files only.
- **Registry Pattern**: Epic 7.4 introduced a configuration-driven registry pattern to replace hardcoded if/elif dispatch.
- **Single Source of Truth**: `JOB_REGISTRY` in `jobs.py` and `DOMAIN_SERVICE_REGISTRY` in `pipeline_ops.py` are the canonical registries.

### Key Source Files (Read-Only Reference)

| File                                                  | Purpose                                                        | Story Introduced |
| ----------------------------------------------------- | -------------------------------------------------------------- | ---------------- |
| `src/work_data_hub/orchestration/jobs.py`             | `JOB_REGISTRY` dictionary, `JobEntry` dataclass                | Story 7.4-1      |
| `src/work_data_hub/orchestration/ops/pipeline_ops.py` | `DOMAIN_SERVICE_REGISTRY` dict, `DomainServiceEntry` dataclass | Story 7.4-3      |
| `src/work_data_hub/cli/etl/executors.py`              | Uses `JOB_REGISTRY.get()` for dispatch                         | Story 7.4-1      |
| `src/work_data_hub/cli/etl/domain_validation.py`      | `validate_domain_registry()` function                          | Story 7.4-4      |
| `config/data_sources.yml`                             | `requires_backfill: true/false` field                          | Story 7.4-2      |

### Issue Resolution Matrix (From new-domain-checklist.md)

| Issue ID | Severity | Description                                | Resolution Story |
| -------- | -------- | ------------------------------------------ | ---------------- |
| MD-001   | **High** | Job dispatch uses hardcoded if/elif chain  | ✅ Story 7.4-1   |
| MD-002   | Medium   | Backfill domain list hardcoded             | ✅ Story 7.4-2   |
| MD-003   | Medium   | Each domain requires dedicated op function | ✅ Story 7.4-3   |
| MD-004   | Low      | Error message lists domains manually       | ✅ Story 7.4-1   |
| MD-005   | Low      | No validation config domains have jobs     | ✅ Story 7.4-4   |

### Documentation Structure

The new `docs/architecture/domain-registry.md` should follow this outline:

```markdown
# Domain Registry Architecture

## Overview

- Why we adopted the Registry Pattern
- Benefits: OCP, reduced maintenance, explicit domain list

## Registry Entry Types

### JobEntry (orchestration/jobs.py)

- Dataclass fields: `job`, `multi_file_job`, `supports_backfill`
- Purpose: Encapsulates job metadata for dispatch

### DomainServiceEntry (orchestration/ops/pipeline_ops.py)

- Dataclass fields: `service_fn`, `supports_enrichment`, `domain_name`
- Purpose: Encapsulates domain processing service metadata

## JOB_REGISTRY (orchestration/jobs.py)

- Structure: Dict[str, JobEntry]
- JobEntry dataclass with `job`, `multi_file_job`, `supports_backfill` fields
- How CLI uses it for dispatch

## DOMAIN_SERVICE_REGISTRY (orchestration/ops/pipeline_ops.py)

- Structure: Dict[str, DomainServiceEntry]
- DomainServiceEntry dataclass with `service_fn`, `supports_enrichment`, `domain_name` fields
- How ops layer uses it for processing

## Adding a New Domain

### Before Epic 7.4 (5-7 files)

### After Epic 7.4 (2-3 files)

### Step-by-Step Guide

## Configuration Options

### requires_backfill (data_sources.yml)

### Foreign Keys (foreign_keys.yml)

## Startup Validation

- validate_domain_registry() behavior
- SPECIAL_DOMAINS exclusion

## Related Documentation

- Links to project-context.md, SCP, stories
```

### Project Structure Notes

- `docs/project-context.md`: **Modify** - Add Domain Registry section
- `docs/architecture/domain-registry.md`: **Create** - New architecture document
- `docs/specific/multi-domain/new-domain-checklist.md`: **Modify** - Mark as RESOLVED

### Files to Modify

| File                                                 | Change Type | Description                                  |
| ---------------------------------------------------- | ----------- | -------------------------------------------- |
| `docs/project-context.md`                            | Modify      | Add Domain Registry Architecture section     |
| `docs/architecture/domain-registry.md`               | New         | Comprehensive registry pattern documentation |
| `docs/specific/multi-domain/new-domain-checklist.md` | Modify      | Mark issues as RESOLVED                      |

### Success Criteria Reference

From Sprint Change Proposal Section 5:

1. ✅ Adding new domain requires **≤2 file changes** (domain package + config) - **Document this achievement**
2. ✅ No if/elif chains in domain dispatch logic - **Reference Story 7.4-1**
3. ✅ All existing tests pass without modification - **N/A (documentation only)**
4. ✅ CLI interface remains backward compatible - **Document this constraint**
5. ✅ `new-domain-checklist.md` marked as RESOLVED - **This story's primary deliverable**

### Code Snippets for Documentation

**Use these verified code snippets when writing documentation:**

**JobEntry Dataclass (from `orchestration/jobs.py:51-63`):**

```python
@dataclass(frozen=True)
class JobEntry:
    """Registry entry for a domain's Dagster job(s).

    Attributes:
        job: The primary Dagster JobDefinition (required, must not be None)
        multi_file_job: Optional job for max_files > 1 scenarios
        supports_backfill: Whether domain has FK backfill configured in foreign_keys.yml
    """

    job: Any  # Dagster JobDefinition - MUST be a valid job, never None
    multi_file_job: Optional[Any] = None  # For max_files > 1 scenarios
    supports_backfill: bool = False  # Whether domain has FK backfill configured
```

**JOB_REGISTRY Example (from `orchestration/jobs.py:280-295`):**

```python
JOB_REGISTRY: Dict[str, JobEntry] = {
    "annuity_performance": JobEntry(
        job=annuity_performance_job,
        supports_backfill=True,
    ),
    "annuity_income": JobEntry(
        job=annuity_income_job,
        supports_backfill=True,
    ),
    "sandbox_trustee_performance": JobEntry(
        job=sandbox_trustee_performance_job,
        multi_file_job=sandbox_trustee_performance_multi_file_job,
        supports_backfill=True,
    ),
}
```

**DomainServiceEntry Dataclass (from `orchestration/ops/pipeline_ops.py:32-59`):**

```python
@dataclass(frozen=True)
class DomainServiceEntry:
    """Registry entry for a domain's processing service.

    Attributes:
        service_fn: Callable that processes rows and returns models/results.
            Expected signature: (rows: List[Dict], data_source: str, **kwargs) -> Any
        supports_enrichment: Whether the domain supports company enrichment
            (EQC lookup, cache queries, etc.)
        domain_name: Human-readable domain name for logging and error messages
    """

    service_fn: Callable[[List[Dict[str, Any]], str], Any]
    supports_enrichment: bool = False
    domain_name: str = ""
```

**DOMAIN_SERVICE_REGISTRY Example (from `orchestration/ops/pipeline_ops.py:66-82`):**

```python
DOMAIN_SERVICE_REGISTRY: Dict[str, DomainServiceEntry] = {
    "annuity_performance": DomainServiceEntry(
        service_fn=process_with_enrichment,
        supports_enrichment=True,
        domain_name="Annuity Performance (规模明细)",
    ),
    "annuity_income": DomainServiceEntry(
        service_fn=process_annuity_income_with_enrichment,
        supports_enrichment=False,
        domain_name="Annuity Income (收入明细)",
    ),
    "sandbox_trustee_performance": DomainServiceEntry(
        service_fn=process,
        supports_enrichment=False,
        domain_name="Sandbox Trustee Performance",
    ),
}
```

### References

- [Sprint Change Proposal](../sprint-change-proposal/sprint-change-proposal-2025-12-30-domain-registry-architecture.md) - Domain Registry Architecture
- [Story 7.4-1](./7.4-1-job-registry-pattern.md) - JOB_REGISTRY pattern
- [Story 7.4-2](./7.4-2-config-driven-backfill-list.md) - Config-Driven Backfill
- [Story 7.4-3](./7.4-3-generic-process-domain-op.md) - DOMAIN_SERVICE_REGISTRY
- [Story 7.4-4](./7.4-4-domain-autodiscovery-validation.md) - Domain Autodiscovery Validation
- [new-domain-checklist.md](../../specific/multi-domain/new-domain-checklist.md) - Technical debt to resolve

### Scope Boundaries

> **IN SCOPE:**
>
> - Update `docs/project-context.md` with Domain Registry section
> - Create `docs/architecture/domain-registry.md`
> - Mark `new-domain-checklist.md` as RESOLVED
> - Ensure cross-references between documents

> **OUT OF SCOPE:**
>
> - Any Python code changes
> - Any configuration file changes
> - Updating sprint-status.yaml epic status (done by code-review workflow)

### Done When (Verification Criteria)

Before marking this story as complete, verify:

1. **Project Context Updated**:

   - [x] `docs/project-context.md` contains "Domain Registry Architecture" section
   - [x] Section references both `JOB_REGISTRY` and `DOMAIN_SERVICE_REGISTRY`
   - [x] Cross-link to `docs/architecture/domain-registry.md` is present

2. **Architecture Document Created**:

   - [x] `docs/architecture/domain-registry.md` exists
   - [x] Contains `JobEntry` dataclass documentation with all 3 fields
   - [x] Contains `DomainServiceEntry` dataclass documentation with all 3 fields
   - [x] Contains "Adding a New Domain" step-by-step guide
   - [x] Contains "Before/After Epic 7.4" comparison (5-7 files → 2-3 files)

3. **Checklist Marked Resolved**:

   - [x] `new-domain-checklist.md` has `> **STATUS: ✅ RESOLVED**` banner
   - [x] All 5 issues (MD-001 through MD-005) show resolution status
   - [x] Resolution Summary section links to Epic 7.4 stories

4. **Cross-References Valid**:

   - [x] All markdown links between 3 documents work correctly
   - [x] Sprint Change Proposal link works

5. **No Code Changes**:
   - [x] `git diff --name-only` shows only `.md` files in `docs/` directory

## Dev Agent Record

### Agent Model Used

Claude Opus 4 (claude-opus-4-5-20251101)

### Implementation Plan

**Documentation-Only Story** - No code changes required.

**Task Breakdown:**

1. Update `docs/project-context.md` - Add Section 6 "Domain Registry Architecture"
2. Create `docs/architecture/domain-registry.md` - Comprehensive technical documentation
3. Mark `docs/specific/multi-domain/new-domain-checklist.md` as RESOLVED
4. Verify cross-references and ensure no Python files were modified

**Key Documentation Content:**

- JOB_REGISTRY structure and usage (with code snippets)
- DOMAIN_SERVICE_REGISTRY structure and usage
- Before/After Epic 7.4 comparison (5-7 files → 2-3 files)
- Step-by-step guide for adding a new domain
- Configuration options (`requires_backfill`, foreign_keys.yml)
- Startup validation (`validate_domain_registry()`)

### Completion Notes List

**Implementation Summary:**

All tasks completed successfully:

1. ✅ **Project Context Updated** (`docs/project-context.md`)

   - Added Section 6 "Domain Registry Architecture" after Section 5
   - Documented JOB_REGISTRY and DOMAIN_SERVICE_REGISTRY
   - Added "Adding a New Domain (Post-Epic 7.4)" guide
   - Cross-referenced new architecture document
   - Renumbered subsequent sections (7→8)

2. ✅ **Architecture Document Created** (`docs/architecture/domain-registry.md`)

   - Overview with problem statement and solution
   - JobEntry and DomainServiceEntry dataclass documentation
   - JOB_REGISTRY structure with code snippets
   - DOMAIN_SERVICE_REGISTRY structure with code snippets
   - "Before Epic 7.4" vs "After Epic 7.4" comparison
   - Step-by-step guide for adding a new domain
   - Configuration options (`requires_backfill`, foreign_keys.yml)
   - Startup validation (`validate_domain_registry()`)
   - Issue resolution matrix (MD-001 through MD-005)
   - Cross-references to related documents

3. ✅ **Checklist Marked Resolved** (`docs/specific/multi-domain/new-domain-checklist.md`)

   - Added `> **STATUS: ✅ RESOLVED**` banner
   - Updated "Architectural Debt Summary" with resolution status
   - Added "Resolution Summary" section with Epic 7.4 mapping
   - Updated version history

4. ✅ **Cross-References Verified**
   - All markdown links work correctly
   - Sprint Change Proposal linked in all documents
   - Epic 7.4 stories properly referenced

**Verification Criteria Met:**

- ✅ Only `.md` files modified (no Python code changes)
- ✅ All 5 acceptance criteria satisfied
- ✅ Documentation cross-references are valid
- ✅ Story 7.4-5 status updated to "in-progress" in sprint-status.yaml

### File List

**Modified Files:**

- `docs/project-context.md` - Added Section 6 "Domain Registry Architecture"
- `docs/specific/multi-domain/new-domain-checklist.md` - Marked as RESOLVED
- `docs/sprint-artifacts/sprint-status.yaml` - Updated story 7.4-5 status

**New Files:**

- `docs/architecture/domain-registry.md` - Comprehensive registry pattern documentation
- `docs/sprint-artifacts/stories/7.4-5-documentation-update.md` - This story file
- `docs/sprint-artifacts/reviews/validation-report-7.4-5-20251230.md` - Story validation report

**No Python files modified** (Documentation-only story)
