# Story 7.5-2: Plan Name Fallback for Single-Plan Records

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a **Data Engineer**,
I want **empty customer names for single-plan records to be filled from the plan name**,
so that **these records can be correctly resolved to company IDs via EQC lookup instead of receiving temp IDs**.

## Acceptance Criteria

1. **AC-1: Plan Name Extraction Logic**

   - New function `_fill_customer_name_from_plan_name()` extracts company name from plan name
   - Extraction rule: `{CompanyName}企业年金计划` → `{CompanyName}`
   - Only applies to records where:
     - `计划类型` == "单一计划"
     - `客户名称` is empty (NULL, "", or "0")
     - `计划名称` matches pattern `*企业年金计划`
   - **CRITICAL:** If plan name doesn't match pattern, customer name remains NULL (do NOT use plan name as-is)

2. **AC-2: Collective Plan Exclusion**

   - Records where `计划类型` == "集合计划" are NOT processed
   - Collective-plan customer names remain empty (as-is behavior)
   - This is intentional: collective plans belong to multiple customers
   - **Note:** Even if collective plan name ends with "企业年金计划", it must NOT be extracted (checked via `计划类型` first)

3. **AC-3: Pipeline Integration**

   - Replace `_fill_customer_name` with `_fill_customer_name_from_plan_name` at Step 6
   - Extracted names go through CleansingStep (Step 10) for normalization
   - CompanyIdResolutionStep (Step 11) will then resolve via multi-priority matching
   - Add structured logging for operational visibility

4. **AC-4: Unit Tests**
   - Test: company name extraction from plan name suffix
   - Test: single-plan records get extracted names
   - Test: collective-plan records are skipped
   - Test: existing non-empty customer names are preserved
   - Test: plan names without suffix return NULL (not the plan name)
   - Test: edge cases (None, empty string, whitespace, suffix-only)

## Tasks / Subtasks

- [x] **Task 1: Create New Function** (AC-1)

  - [x] 1.1 Implement `_fill_customer_name_from_plan_name(df: pd.DataFrame) -> pd.Series`
  - [x] 1.2 Handle edge cases: NULL plan name, no suffix match → return NULL (not plan name)
  - [x] 1.3 Add docstring documenting Story 7.5-2 and extraction rules
  - [x] 1.4 Add structured logging: count extracted, skipped (collective), skipped (no match)

- [x] **Task 2: Update Pipeline Integration** (AC-2, AC-3)

  - [x] 2.1 Replace `_fill_customer_name` with `_fill_customer_name_from_plan_name` at line 253
  - [x] 2.2 Update Step 6 comment (line 198-199) to reflect new behavior
  - [x] 2.3 Preserve existing behavior for non-single-plan records

- [x] **Task 3: Create Unit Tests** (AC-4)

  - [x] 3.1 Update test file imports (see Import Change section)
  - [x] 3.2 Add test class `TestFillCustomerNameFromPlanName` in `test_pipeline.py`
  - [x] 3.3 Implement positive tests (extraction, single-plan, preserves existing)
  - [x] 3.4 Implement negative tests (collective skipped, no suffix → NULL, edge cases)

- [x] **Task 4: Integration Verification** (AC-1, AC-3)
  - [x] 4.1 Run existing pipeline tests to verify no regressions
  - [x] 4.2 Verify extracted names flow through CleansingStep correctly

## Dev Notes

### Problem Context (PN-001)

**Issue ID:** PN-001 - Single-plan records with empty customer names don't extract company names from plan names

**Impact Statistics (from 202510 ETL run):**

| Metric                                       | Value  | Notes                                  |
| -------------------------------------------- | ------ | -------------------------------------- |
| Single-plan records with empty customer name | 10,565 | 87.2% of single-plan total             |
| Single-plan records with temp ID             | 297    | 2.8% - should be reducible to ~0       |
| Collective-plan records with temp ID         | 1,530  | 100% - expected behavior (multi-owner) |
| Missing plan_code enrichment_index entries   | 18     | Fixed by Story 7.5-1 (P0)              |

**Root Cause:** `_fill_customer_name()` at lines 43-51 keeps customer name as-is, without extracting from plan name.

### Plan Name Format Analysis

**Single Plan Pattern:** `{CompanyName}企业年金计划`

| 计划代码 | 计划名称                                 | 提取的公司名称               |
| -------- | ---------------------------------------- | ---------------------------- |
| S6544    | 中关村发展集团股份有限公司企业年金计划   | 中关村发展集团股份有限公司   |
| XNP707   | 山东重工集团有限公司企业年金计划         | 山东重工集团有限公司         |
| XNP732   | 上海浦东发展银行股份有限公司企业年金计划 | 上海浦东发展银行股份有限公司 |

**Collective Plan Pattern:** `{BrandName}企业年金集合计划` (NOT the company name)

| 计划代码 | 计划名称                     | 备注              |
| -------- | ---------------------------- | ----------------- |
| P0190    | 平安相伴今生企业年金集合计划 | 集合计划 - 不提取 |
| P0401    | 平安阳光人生企业年金集合计划 | 集合计划 - 不提取 |

### Implementation

**File:** `src/work_data_hub/domain/annuity_income/pipeline_builder.py`

```python
# NEW FUNCTION (replace _fill_customer_name at lines 43-51):
def _fill_customer_name_from_plan_name(df: pd.DataFrame) -> pd.Series:
    """Fill customer name from plan name for single-plan records only.

    Story 7.5-2: For '单一计划' records with empty customer name,
    extract company name from plan name by removing suffix '企业年金计划'.

    Extraction rules:
    - Single plan with matching suffix: "{CompanyName}企业年金计划" → "{CompanyName}"
    - Single plan without matching suffix: Keep NULL (do NOT use plan name as-is)
    - Collective plan: Skip (belongs to multiple customers)

    Args:
        df: DataFrame with columns 客户名称, 计划名称, 计划类型

    Returns:
        pd.Series: Customer names (extracted or original)
    """
    if "客户名称" not in df.columns:
        return pd.Series([pd.NA] * len(df), index=df.index)

    result = df["客户名称"].copy()

    # Check required columns for extraction
    if "计划类型" not in df.columns or "计划名称" not in df.columns:
        return result  # Keep as-is if missing columns

    # Build mask: single-plan + empty customer name + valid plan name
    # Note: "0" is a known empty placeholder in source data
    empty_mask = result.isna() | (result == "") | (result == "0")
    single_plan_mask = df["计划类型"] == "单一计划"
    has_plan_name = df["计划名称"].notna() & (df["计划名称"] != "")
    target_mask = empty_mask & single_plan_mask & has_plan_name

    # Extract company name from plan name (only if suffix matches)
    suffix = "企业年金计划"

    def extract_company_name(plan_name: str) -> object:
        """Extract company name if plan name matches pattern, else return NA."""
        if not isinstance(plan_name, str):
            return pd.NA
        if plan_name.endswith(suffix):
            extracted = plan_name[: -len(suffix)].strip()
            # Guard: suffix-only plan name (e.g., "企业年金计划") returns NA
            return extracted if extracted else pd.NA
        # No suffix match: return NA (do NOT use plan name as customer name)
        return pd.NA

    extracted = df.loc[target_mask, "计划名称"].apply(extract_company_name)
    result.loc[target_mask] = extracted

    # Structured logging for operational visibility
    extracted_count = extracted.notna().sum()
    skipped_no_match = extracted.isna().sum()
    collective_count = ((df["计划类型"] == "集合计划") & empty_mask).sum()

    logger.bind(domain="annuity_income", step="fill_customer_name").info(
        "Plan name extraction complete",
        extracted=extracted_count,
        skipped_no_match=skipped_no_match,
        skipped_collective=collective_count,
    )

    return result
```

**Pipeline Integration (line 253):**

```python
# BEFORE:
"客户名称": _fill_customer_name,

# AFTER:
"客户名称": _fill_customer_name_from_plan_name,
```

**Comment Update (lines 198-199):**

```python
# BEFORE:
# 6. CalculationStep: Customer/income defaults (客户名称 fallback to 计划名称,
#    income nulls → 0)

# AFTER:
# 6. CalculationStep: Customer/income defaults (客户名称 from 计划名称 for single-plan,
#    income nulls → 0) - Story 7.5-2
```

### Test Import Change

**File:** `tests/unit/domain/annuity_income/test_pipeline.py`

```python
# BEFORE (line 20-27):
from work_data_hub.domain.annuity_income.pipeline_builder import (
    CompanyIdResolutionStep,
    build_bronze_to_silver_pipeline,
    load_plan_override_mapping,
    _apply_portfolio_code_defaults,
    _fill_customer_name,  # Story 7.3-6: Test null preservation
    _apply_plan_code_defaults,  # Story 7.3-6: Test plan code defaults
)

# AFTER:
from work_data_hub.domain.annuity_income.pipeline_builder import (
    CompanyIdResolutionStep,
    build_bronze_to_silver_pipeline,
    load_plan_override_mapping,
    _apply_portfolio_code_defaults,
    _fill_customer_name_from_plan_name,  # Story 7.5-2: Plan name extraction
    _apply_plan_code_defaults,  # Story 7.3-6: Test plan code defaults
)
```

### Test Cases

**File:** `tests/unit/domain/annuity_income/test_pipeline.py`

```python
class TestFillCustomerNameFromPlanName:
    """Tests for _fill_customer_name_from_plan_name function (Story 7.5-2)."""

    def test_extracts_company_name_from_plan_name(self):
        """Extracts company name by removing 企业年金计划 suffix."""
        df = pd.DataFrame({
            "客户名称": [None],
            "计划名称": ["中关村发展集团股份有限公司企业年金计划"],
            "计划类型": ["单一计划"],
        })

        result = _fill_customer_name_from_plan_name(df)

        assert result[0] == "中关村发展集团股份有限公司"

    def test_single_plan_gets_extracted_name(self):
        """Single-plan records with empty customer name get extracted name."""
        df = pd.DataFrame({
            "客户名称": [None, "", "0"],
            "计划名称": ["A公司企业年金计划", "B公司企业年金计划", "C公司企业年金计划"],
            "计划类型": ["单一计划", "单一计划", "单一计划"],
        })

        result = _fill_customer_name_from_plan_name(df)

        assert result[0] == "A公司"
        assert result[1] == "B公司"
        assert result[2] == "C公司"

    def test_collective_plan_skipped(self):
        """Collective-plan records are skipped (customer name remains empty)."""
        df = pd.DataFrame({
            "客户名称": [None, None],
            "计划名称": ["平安相伴今生企业年金集合计划", "A公司企业年金计划"],
            "计划类型": ["集合计划", "单一计划"],
        })

        result = _fill_customer_name_from_plan_name(df)

        assert pd.isna(result[0])  # Collective - skipped
        assert result[1] == "A公司"  # Single - extracted

    def test_collective_plan_with_matching_suffix_still_skipped(self):
        """Collective plan with 企业年金计划 suffix is still skipped (type check first)."""
        df = pd.DataFrame({
            "客户名称": [None],
            "计划名称": ["某品牌企业年金计划"],  # Ends with suffix but is collective
            "计划类型": ["集合计划"],
        })

        result = _fill_customer_name_from_plan_name(df)

        assert pd.isna(result[0])  # Skipped because 计划类型 == 集合计划

    def test_preserves_existing_customer_name(self):
        """Existing non-empty customer names are preserved."""
        df = pd.DataFrame({
            "客户名称": ["已有客户"],
            "计划名称": ["某公司企业年金计划"],
            "计划类型": ["单一计划"],
        })

        result = _fill_customer_name_from_plan_name(df)

        assert result[0] == "已有客户"  # Preserved

    def test_plan_name_without_suffix_returns_null(self):
        """Plan names without 企业年金计划 suffix return NULL (not the plan name)."""
        df = pd.DataFrame({
            "客户名称": [None],
            "计划名称": ["其他类型计划"],
            "计划类型": ["单一计划"],
        })

        result = _fill_customer_name_from_plan_name(df)

        # CRITICAL: Must return NULL, NOT the plan name
        assert pd.isna(result[0])

    def test_handles_none_plan_name(self):
        """NULL plan name is handled gracefully."""
        df = pd.DataFrame({
            "客户名称": [None],
            "计划名称": [None],
            "计划类型": ["单一计划"],
        })

        result = _fill_customer_name_from_plan_name(df)

        assert pd.isna(result[0])

    def test_handles_empty_string_plan_name(self):
        """Empty string plan name is handled gracefully."""
        df = pd.DataFrame({
            "客户名称": [None],
            "计划名称": [""],
            "计划类型": ["单一计划"],
        })

        result = _fill_customer_name_from_plan_name(df)

        assert pd.isna(result[0])

    def test_handles_suffix_only_plan_name(self):
        """Plan name that is only the suffix returns NULL."""
        df = pd.DataFrame({
            "客户名称": [None],
            "计划名称": ["企业年金计划"],  # Suffix only, no company name
            "计划类型": ["单一计划"],
        })

        result = _fill_customer_name_from_plan_name(df)

        assert pd.isna(result[0])  # No company name extracted

    def test_handles_whitespace_plan_name(self):
        """Whitespace-only plan name is handled gracefully."""
        df = pd.DataFrame({
            "客户名称": [None],
            "计划名称": ["   "],
            "计划类型": ["单一计划"],
        })

        result = _fill_customer_name_from_plan_name(df)

        assert pd.isna(result[0])
```

### Project Structure Notes

- **Target File:** `src/work_data_hub/domain/annuity_income/pipeline_builder.py`
- **Test File:** `tests/unit/domain/annuity_income/test_pipeline.py`
- **Function Export:** `_fill_customer_name_from_plan_name` is internal (NOT added to `__all__`), consistent with `_fill_customer_name`
- **Domain Scope:** This change applies to `annuity_income` only. The `annuity_performance` domain uses different source data patterns and does not require this extraction logic.

### Done When (Verification Criteria)

Before marking this story as complete, verify:

1. **Code Change Applied:**

   - [x] New function `_fill_customer_name_from_plan_name()` implemented with logging
   - [x] Function replaces `_fill_customer_name` at pipeline Step 6 (line 307)
   - [x] Docstring documents Story 7.5-2 and extraction rules
   - [x] Non-matching plan names return NULL (not the plan name)

2. **Tests Pass:**

   - [x] `pytest tests/unit/domain/annuity_income/test_pipeline.py -v` passes (37/38, 1 pre-existing failure)
   - [x] New test class `TestFillCustomerNameFromPlanName` with 10 test cases
   - [x] All existing tests remain passing

3. **Regression Check:**
   - [x] ETL dry-run shows extracted customer names in output
   - [x] Collective-plan records still have empty customer names (expected)
   - [x] Plan names without suffix result in NULL customer names

### Command Reference

```bash
# Run unit tests
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/unit/domain/annuity_income/test_pipeline.py -v

# Run all annuity_income tests
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/ -k "annuity_income" -v

# Dry-run ETL to verify extraction
PYTHONPATH=src uv run --env-file .wdh_env python -m work_data_hub.cli.etl \
  --domain annuity_income --period 202510 --dry-run
```

## Dev Agent Record

### Agent Model Used

glm-4.7 (Claude Opus 4.5)

### Debug Log References

None - implementation completed without issues

### Completion Notes List

**Implementation Summary:**

1. ✅ **Function Implementation**: Created `_fill_customer_name_from_plan_name()` function with:

   - Suffix-based extraction: "{CompanyName}企业年金计划" → "{CompanyName}"
   - Single-plan only filtering (via 计划类型 == "单一计划")
   - NULL-safe handling for edge cases (None, "", "0", whitespace, no suffix match)
   - Structured logging with extracted/skip counts

2. ✅ **Pipeline Integration**: Replaced `_fill_customer_name` with new function at Step 6

   - Updated pipeline comment to reflect new behavior
   - Preserved existing behavior for non-single-plan records
   - Extracted names flow through CleansingStep for normalization

3. ✅ **Unit Tests**: Added 10 comprehensive test cases in `TestFillCustomerNameFromPlanName`:

   - ✅ Company name extraction from plan name suffix
   - ✅ Single-plan records get extracted names
   - ✅ Collective-plan records are skipped
   - ✅ Collective plans with matching suffix still skipped (type check first)
   - ✅ Existing non-empty customer names are preserved
   - ✅ Plan names without suffix return NULL (not the plan name)
   - ✅ NULL/empty/whitespace plan name handling
   - ✅ Suffix-only plan name returns NULL

4. ✅ **Test Results**: 37/38 tests passing

   - 10 new tests: 100% pass rate
   - 27 existing tests: 100% pass rate
   - 1 pre-existing failure (test_full_pipeline_execution) - unrelated to Story 7.5-2

5. ✅ **Code Quality**:
   - Follows project coding standards (Zero Legacy Policy)
   - No magic values (uses named constant for suffix)
   - Comprehensive docstring with Story reference
   - Structured logging for operational visibility

**Test Evidence:**

```bash
PYTHONPATH=src uv run --env-file .wdh_env pytest \
  tests/unit/domain/annuity_income/test_pipeline.py::TestFillCustomerNameFromPlanName -v

# Result: 10 passed in 0.78s
```

**Files Modified:**

- `src/work_data_hub/domain/annuity_income/pipeline_builder.py`: Replaced function, updated comment
- `tests/unit/domain/annuity_income/test_pipeline.py`: Updated imports, added test class, removed 2 deprecated tests

### File List

**Modified:**

- `src/work_data_hub/domain/annuity_income/pipeline_builder.py` - Replace `_fill_customer_name` with `_fill_customer_name_from_plan_name`

**Test Files:**

- `tests/unit/domain/annuity_income/test_pipeline.py` - Add `TestFillCustomerNameFromPlanName` class with 10 test cases
