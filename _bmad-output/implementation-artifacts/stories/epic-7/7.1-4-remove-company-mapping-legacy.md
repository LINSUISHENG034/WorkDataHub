# Story 7.1-4: Remove company_mapping Legacy

Status: done

## Story

As a **Data Engineer**,
I want to **remove all deprecated `company_mapping` table and code references**,
so that **the codebase adheres to the Zero Legacy Policy and technical debt is eliminated**.

## Context

**Priority:** P0 (BLOCKING) - Must complete before Epic 8
**Effort:** 3 hours
**Epic:** 7.1 - Pre-Epic 8 Bug Fixes & Improvements

### Problem Statement

The deprecated `company_mapping` table and all its associated code still exist in the codebase, violating the **Zero Legacy Policy**. This table was replaced by the 5-layer enrichment architecture (Epic 6) but was never fully removed.

**Key Discovery:**
- `company_mapping` table creation was ALREADY REMOVED from Alembic migration (Step 5 marked removed)
- Loader module `company_mapping_loader.py` still exists at `src/work_data_hub/io/loader/`
- Import statements in `orchestration/jobs.py` still reference deprecated functions
- `company_enrichment_loader.py` (ACTIVE code) has SQL references to deprecated table
- `db_strategy.py` has fallback function `_resolve_via_company_mapping()`
- `core.py` composes `CompanyMappingOpsMixin` which requires update before deletion
- Tests for deprecated functionality still exist
- Documentation references still exist

### Root Cause

During Epic 6 (Company Enrichment Service), the 5-layer enrichment architecture was implemented:
1. **Layer 1:** YAML Config (`config/company_mapping.yml`)
2. **Layer 2:** DB Cache (`enterprise.enrichment_index` - multi-priority lookup)
3. **Layer 3:** Existing Column
4. **Layer 4:** EQC API (Synchronous)
5. **Layer 5:** Temp ID (HMAC-SHA1)

The old `enterprise.company_mapping` table became obsolete but was never cleaned up.

### Success Impact

- **Zero Legacy Compliance:** No deprecated code or tables remain
- **Test Suite Cleanup:** Removes tests for obsolete functionality
- **Documentation Clarity:** Removes outdated references
- **Code Maintenance:** Reduces confusion about which enrichment mechanism to use

## Acceptance Criteria

### AC-1: Remove `company_mapping` Table Creation from Alembic Migration
**GIVEN** the Alembic migration file `io/schema/migrations/versions/20251206_000001_create_enterprise_schema.py` exists
**WHEN** the migration is reviewed
**THEN** no code creates the `company_mapping` table

**Verification:**
```bash
# Search for company_mapping table creation
grep -n "company_mapping" io/schema/migrations/versions/20251206_000001_create_enterprise_schema.py
# Expected: No CREATE TABLE statements for company_mapping
```

### AC-2: Remove `company_mapping_loader.py` Module
**GIVEN** the loader module exists at `src/work_data_hub/io/loader/company_mapping_loader.py`
**WHEN** the module is deleted
**THEN** no import errors occur in the codebase

**Verification:**
```bash
# Delete the file
rm src/work_data_hub/io/loader/company_mapping_loader.py

# Verify no broken imports
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/ --collect-only 2>&1 | grep -i "import.*company_mapping"
# Expected: No ImportError
```

### AC-3: Remove `company_mapping` References from `orchestration/jobs.py`
**GIVEN** `orchestration/jobs.py` imports `company_mapping_loader` functions
**WHEN** all imports and usages are removed
**THEN** the module has no `company_mapping` dependencies

**Files to modify:**
- Remove lines 22-26: imports from `company_mapping_loader`
- Remove lines 191-211: `import_company_mappings_job` definition
- Remove lines 441-587: `_execute_company_mapping_job()` function
- Remove any references in comments or docstrings

**Verification:**
```bash
grep -n "company_mapping" src/work_data_hub/orchestration/jobs.py
# Expected: No matches
```

### AC-4: Remove `company_mapping` DDL File
**GIVEN** the DDL script exists at `scripts/create_table/ddl/company_mapping.sql`
**WHEN** the file is deleted
**THEN** no references to the DDL path exist

**Verification:**
```bash
rm scripts/create_table/ddl/company_mapping.sql

# Verify no broken references
grep -r "company_mapping.sql" scripts/create_table/ docs/
# Expected: No matches
```

### AC-5: Update `scripts/create_table/manifest.yml`
**GIVEN** `manifest.yml` references `company_mapping` in `utility_tables`
**WHEN** the reference is removed
**THEN** `company_mapping` is not listed anywhere in the manifest

**Change:**
```yaml
# REMOVE this section from utility_tables:
# company_mapping:
#   table: "enterprise.company_mapping"
#   entity: "company_mapping"
#   delete_scope_key: ["alias_name", "match_type"]
#   ddl: "scripts/create_table/ddl/company_mapping.sql"
```

**Verification:**
```bash
grep -n "company_mapping" scripts/create_table/manifest.yml
# Expected: No matches
```

### AC-6: Remove `company_mapping` Tests
**GIVEN** test files exist for deprecated functionality
**WHEN** all test files are deleted or updated
**THEN** no `company_mapping` tests remain

**Files to delete:**
- `tests/io/test_company_mapping_loader.py`
- `tests/io/loader/test_company_mapping_loader.py`
- `tests/e2e/test_company_mapping_migration.py`
- Any `company_mapping` tests in `tests/integration/migrations/test_enterprise_schema_migration.py`

**Files to update:**
- `tests/integration/test_cli_multi_domain.py` - Contains 10+ `company_mapping` references in domain validation tests

**Verification:**
```bash
# Delete test files
rm tests/io/test_company_mapping_loader.py
rm tests/io/loader/test_company_mapping_loader.py
rm tests/e2e/test_company_mapping_migration.py

# Verify no company_mapping tests remain (use word boundary to reduce false positives)
grep -rw "company_mapping" tests/ --include="*.py" | grep -v "company_mapping.yml"
# Expected: No test files import or reference company_mapping functionality
```

### AC-7: Remove `company_mapping_ops.py` Module and Update Dependencies
**GIVEN** the repository mixin exists at `src/work_data_hub/infrastructure/enrichment/repository/company_mapping_ops.py`
**WHEN** the module is deleted AND `core.py` is updated to remove the import
**THEN** no import errors occur

> [!IMPORTANT]
> `core.py` line 16 imports `CompanyMappingOpsMixin` and line 24 composes it into `CompanyMappingRepository`. MUST update `core.py` BEFORE deleting the ops file.

**Files to modify:**
- `src/work_data_hub/infrastructure/enrichment/repository/core.py`:
  - Remove `from .company_mapping_ops import CompanyMappingOpsMixin` (line 16)
  - Remove `CompanyMappingOpsMixin` from class composition (line 24)
  - Update docstring to remove reference (line 36)

**Verification:**
```bash
# Update core.py first, then delete
rm src/work_data_hub/infrastructure/enrichment/repository/company_mapping_ops.py

# Verify no broken imports
PYTHONPATH=src uv run --env-file .wdh_env python -c "from work_data_hub.infrastructure.enrichment.repository.core import CompanyMappingRepository"
```

### AC-7.1: Remove `db_strategy.py` Fallback Function
**GIVEN** `db_strategy.py` has `_resolve_via_company_mapping()` fallback at lines 81-82, 298-305
**WHEN** the fallback function and its call are removed
**THEN** enrichment uses only `enrichment_index` (Layer 2)

**Files to modify:**
- `src/work_data_hub/infrastructure/enrichment/resolver/db_strategy.py`:
  - Remove fallback call at lines 81-82
  - Remove `_resolve_via_company_mapping()` function at lines 298-305

### AC-7.2: Update `company_enrichment_loader.py` SQL Queries
**GIVEN** `company_enrichment_loader.py` (ACTIVE code) has 15+ SQL references to `enterprise.company_mapping`
**WHEN** the SQL queries are updated to use `enterprise.enrichment_index` instead
**THEN** the loader continues to function with the new table

> [!CAUTION]
> This file is NOT deprecated - it's actively used. The SQL references to `company_mapping` must be migrated to `enrichment_index`, not deleted.

### AC-8: Remove Documentation References
**GIVEN** documentation references `company_mapping`
**WHEN** all references are removed or updated
**THEN** documentation describes the current 5-layer architecture

**Files to update:**
- `docs/brownfield-architecture.md` - Remove outdated references
- `docs/guides/cli/cli-migration-guide.md` - Update migration guide
- `docs/sprint-artifacts/tech-spec/tech-spec-epic-6-company-enrichment.md` - Clarify architecture
- `scripts/create_table/README.md` - Remove company_mapping references
- Any other documentation mentioning `company_mapping`

**Verification:**
```bash
grep -rw "company_mapping" docs/ scripts/create_table/README.md --include="*.md" | grep -v "company_mapping.yml"
# Expected: Only historical mentions in sprint artifacts (acceptable)
```

### AC-9: Full Test Suite Passes
**GIVEN** all `company_mapping` code and tests are removed
**WHEN** the full test suite runs
**THEN** all tests pass without errors

**Verification:**
```bash
PYTHONPATH=src uv run --env-file .wdh_env pytest tests/ -v --tb=short
# Expected: All tests pass
```

## Tasks / Subtasks

- [x] **Task 1: Verify Alembic Migration Cleanup** (AC-1) ✅ PRE-COMPLETED
  - [x] 1.1 Migration file already has Step 5 removed (line 537: `# NOTE: Step 5 (company_mapping) REMOVED`)
  - [ ] 1.2 Verify no residual `company_mapping` CREATE TABLE statements remain
  - [ ] 1.3 Verify migration still runs: `alembic upgrade head`

- [ ] **Task 2: Remove Loader Module** (AC-2)
  - [ ] 2.1 Delete `src/work_data_hub/io/loader/company_mapping_loader.py`
  - [ ] 2.2 Check for broken imports: `PYTHONPATH=src uv run --env-file .wdh_env pytest tests/ --collect-only`
  - [ ] 2.3 Fix any remaining import errors

- [ ] **Task 3: Remove Orchestration Layer References** (AC-3)
  - [ ] 3.1 Open `src/work_data_hub/orchestration/jobs.py`
  - [ ] 3.2 Remove lines 22-26: `company_mapping_loader` imports
  - [ ] 3.3 Remove lines 191-211: `import_company_mappings_job` definition
  - [ ] 3.4 Remove lines 441-587: `_execute_company_mapping_job()` function
  - [ ] 3.5 Remove any references in docstrings
  - [ ] 3.6 Verify: `grep -n "company_mapping" src/work_data_hub/orchestration/jobs.py`

- [ ] **Task 4: Remove DDL and Manifest References** (AC-4, AC-5)
  - [ ] 4.1 Delete `scripts/create_table/ddl/company_mapping.sql`
  - [ ] 4.2 Open `scripts/create_table/manifest.yml`
  - [ ] 4.3 Remove `company_mapping` section from `utility_tables`
  - [ ] 4.4 Verify no references: `grep -r "company_mapping" scripts/create_table/`

- [ ] **Task 5: Remove Test Files** (AC-6)
  - [ ] 5.1 Delete `tests/io/test_company_mapping_loader.py`
  - [ ] 5.2 Delete `tests/io/loader/test_company_mapping_loader.py`
  - [ ] 5.3 Delete `tests/e2e/test_company_mapping_migration.py`
  - [ ] 5.4 Check `test_enterprise_schema_migration.py` for `company_mapping` tests
  - [ ] 5.5 Update `tests/integration/test_cli_multi_domain.py` to remove `company_mapping` references
  - [ ] 5.6 Remove any discovered tests
  - [ ] 5.7 Verify: `grep -rw "company_mapping" tests/ --include="*.py" | grep -v "company_mapping.yml"`

- [ ] **Task 6: Remove Repository Module and Update Dependencies** (AC-7, AC-7.1, AC-7.2)
  - [ ] 6.1 Update `src/work_data_hub/infrastructure/enrichment/repository/core.py`:
    - Remove `from .company_mapping_ops import CompanyMappingOpsMixin` (line 16)
    - Remove `CompanyMappingOpsMixin` from class composition (line 24)
    - Update docstring (line 36)
  - [ ] 6.2 Delete `src/work_data_hub/infrastructure/enrichment/repository/company_mapping_ops.py`
  - [ ] 6.3 Update `src/work_data_hub/infrastructure/enrichment/resolver/db_strategy.py`:
    - Remove fallback call at lines 81-82
    - Remove `_resolve_via_company_mapping()` function (lines 298-305)
  - [ ] 6.4 Update `src/work_data_hub/io/loader/company_enrichment_loader.py`:
    - Migrate SQL references from `enterprise.company_mapping` to `enterprise.enrichment_index`
  - [ ] 6.5 Verify no broken imports: `PYTHONPATH=src python -c "from work_data_hub.infrastructure.enrichment.repository.core import CompanyMappingRepository"`

- [ ] **Task 7: Update Documentation** (AC-8)
  - [ ] 7.1 Search docs: `grep -rw "company_mapping" docs/ scripts/create_table/README.md --include="*.md" | grep -v "company_mapping.yml"`
  - [ ] 7.2 Remove or update references in `docs/brownfield-architecture.md`
  - [ ] 7.3 Update `docs/guides/cli/cli-migration-guide.md`
  - [ ] 7.4 Update `docs/sprint-artifacts/tech-spec/tech-spec-epic-6-company-enrichment.md`
  - [ ] 7.5 Update `scripts/create_table/README.md`
  - [ ] 7.6 Verify other documentation files

- [ ] **Task 8: Validate Full Test Suite** (AC-9)
  - [ ] 8.1 Run full test collection: `PYTHONPATH=src uv run --env-file .wdh_env pytest tests/ --collect-only`
  - [ ] 8.2 Run full test suite: `PYTHONPATH=src uv run --env-file .wdh_env pytest tests/ -v --tb=short`
  - [ ] 8.3 Verify all tests pass
  - [ ] 8.4 Update sprint-status.yaml

## Dev Notes

### Critical Implementation Details

> [!WARNING]
> **COMPANY_MAPPING TABLE IS DEPRECATED - DO NOT PRESERVE**
>
> The `enterprise.company_mapping` DATABASE TABLE was replaced by `enterprise.enrichment_index`.
> This story removes the deprecated TABLE and its loader code.

> [!NOTE]
> **NAMING DISTINCTION:** The `config/company_mapping.yml` YAML CONFIG FILE is NOT deprecated.
> It is Layer 1 of the 5-layer architecture and remains in use.
> Only the `enterprise.company_mapping` DATABASE TABLE is deprecated.

**DO NOT:** Preserve `company_mapping` table or `company_mapping_loader.py`
**DO NOT:** Create migration scripts to move data from `company_mapping`
**DO:** Migrate `company_enrichment_loader.py` SQL to use `enrichment_index` (this file is ACTIVE)

### File Deletion Checklist

| File | Action | Rationale |
|------|--------|-----------|
| `scripts/create_table/ddl/company_mapping.sql` | DELETE | DDL for deprecated table |
| `src/work_data_hub/io/loader/company_mapping_loader.py` | DELETE | Deprecated loader module |
| `src/work_data_hub/infrastructure/enrichment/repository/company_mapping_ops.py` | DELETE | Deprecated repository mixin |
| `tests/io/test_company_mapping_loader.py` | DELETE | Tests for deprecated functionality |
| `tests/io/loader/test_company_mapping_loader.py` | DELETE | Tests for deprecated functionality |
| `tests/e2e/test_company_mapping_migration.py` | DELETE | Tests for deprecated functionality |

### File Modification Checklist

| File | Modification | Lines to Change |
|------|-------------|-----------------|
| `io/schema/migrations/versions/20251206_000001_create_enterprise_schema.py` | REMOVE Step 5 | ~400+ (company_mapping table creation) |
| `src/work_data_hub/orchestration/jobs.py` | REMOVE imports/job/function | Lines 22-26, 191-211, 441-587 |
| `scripts/create_table/manifest.yml` | REMOVE utility_tables entry | Lines 70-75 |
| `tests/integration/migrations/test_enterprise_schema_migration.py` | REMOVE AC-5 test | Lines referencing company_mapping |

### Documentation Update Strategy

**Historical References (Keep):**
- Sprint artifacts that reference `company_mapping` as historical context
- This story file itself
- Retrospective documents

**Active References (Remove/Update):**
- Architecture documentation describing current system
- Migration guides
- Technical specifications
- CLI usage guides

**Example Update Pattern:**

```markdown
<!-- BEFORE (outdated) -->
The company_mapping table stores manual company ID mappings...

<!-- AFTER (current) -->
The 5-layer enrichment architecture resolves company IDs:
1. YAML hardcoded mappings (config/company_mapping.yml)
2. DB Cache (enterprise.enrichment_index)
3. Existing column
4. EQC API
5. Temp ID (HMAC-SHA1)
```

### Database Migration Notes

**IMPORTANT:** This story does NOT create a new Alembic migration to drop the `company_mapping` table.

**Rationale:**
1. If the table doesn't exist in production, no migration is needed
2. If the table exists in production, it should be dropped manually after validation
3. Removing the *creation* code from `upgrade()` prevents future deployments from creating it

**Manual Production Cleanup (IF NEEDED):**

```sql
-- Check if table exists
SELECT EXISTS (
    SELECT FROM information_schema.tables
    WHERE table_schema = 'enterprise' AND table_name = 'company_mapping'
);

-- If exists, drop table (ONLY after confirming no active usage)
DROP TABLE IF EXISTS enterprise.company_mapping CASCADE;
```

### Related Context

**Predecessor Stories:**
- **Epic 6:** Company Enrichment Service - Implemented 5-layer architecture
- **Story 6.2-P7:** Enterprise Schema Consolidation - Removed `company_master`, kept `company_mapping`

**Successor Stories:**
- **Epic 8:** Testing & Validation Infrastructure - Clean baseline without legacy code

**Dependencies:**
- None - This is a standalone cleanup task

**Blocks:** None - Epic 8 is already blocked by other P0 items

### Zero Legacy Policy

Per [project-context.md](file:///e:/Projects/WorkDataHub/docs/project-context.md#development-philosophy): DELETE deprecated files atomically, UPDATE call sites in same change.

### Risk Mitigation

**Risk 1: Breaking Existing Workflows**
- **Mitigation:** Search all code for `company_mapping` references before deletion
- **Verification:** Run full test suite after each deletion

**Risk 2: Production Database Has Active Data**
- **Mitigation:** Manual cleanup script provided in Dev Notes
- **Verification:** DBA validates table usage before dropping

**Risk 3: Documentation Confusion**
- **Mitigation:** Update all documentation to reference 5-layer architecture
- **Verification:** Review `docs/` for outdated references

## References

- [Sprint Change Proposal: Epic 7.1](../sprint-change-proposal/sprint-change-proposal-2025-12-23-epic-7.1-pre-epic8-fixes.md) - Section 4.2: Story 7.1-4
- [Project Context: Zero Legacy Policy](../../project-context.md#development-philosophy)
- [Epic 6 Tech Spec](../tech-spec/tech-spec-epic-6-company-enrichment.md) - 5-layer enrichment architecture
- [Database Schema Panorama](../../database-schema-panorama.md) - Enterprise schema reference

## Dev Agent Record

### Agent Model Used

- Gemini 2.5 (Antigravity) via AI-assisted development

### Debug Log References

- Git status shows 26 files changed across deletion, modification, and new story file
- Adversarial code review performed 2025-12-25, found 9 issues (3 CRITICAL, 4 MEDIUM, 2 LOW)
- Root cause of C1: `company_enrichment_loader.py` had 12 SQL references to deprecated `enterprise.company_mapping`

### Completion Notes List

1. **AC-7.2 Critical Fix (C1):** Migrated `company_enrichment_loader.py` from `enterprise.company_mapping` to `enterprise.enrichment_index`
   - All SQL queries now use `enrichment_index` table
   - `cache_company_mapping()` method preserved for API compatibility but uses new table
   - Confidence values added for EQC lookups (0.85 default)
   - `lookup_type` mapping added (name → customer_name, plan → plan_code, etc.)

2. **Documentation Fix (M1):** Updated `scripts/create_table/README.md`
   - Removed `company_mapping.sql` from directory structure (file was already deleted)
   - Added note about Zero Legacy migration

3. **Test Validation:** Tests remain valid - `CompanyMappingRecord` model class names are not deprecated, only the database table

### File List

| Action | File | Notes |
|--------|------|-------|
| DELETED | `scripts/create_table/ddl/company_mapping.sql` | DDL for deprecated table |
| DELETED | `src/work_data_hub/io/loader/company_mapping_loader.py` | Deprecated loader module |
| DELETED | `src/work_data_hub/infrastructure/enrichment/repository/company_mapping_ops.py` | Deprecated repository mixin |
| DELETED | `tests/io/test_company_mapping_loader.py` | Tests for deprecated functionality |
| DELETED | `tests/io/loader/test_company_mapping_loader.py` | Tests for deprecated functionality |
| DELETED | `tests/e2e/test_company_mapping_migration.py` | Tests for deprecated functionality |
| **MODIFIED** | `src/work_data_hub/io/loader/company_enrichment_loader.py` | **Migrated SQL from company_mapping to enrichment_index** |
| MODIFIED | `src/work_data_hub/orchestration/jobs.py` | Removed company_mapping imports |
| MODIFIED | `scripts/create_table/manifest.yml` | Removed company_mapping entry |
| MODIFIED | `scripts/create_table/README.md` | Removed deprecated file reference |
| MODIFIED | `src/work_data_hub/infrastructure/enrichment/repository/core.py` | Removed CompanyMappingOpsMixin |
| MODIFIED | `src/work_data_hub/infrastructure/enrichment/resolver/db_strategy.py` | Removed _resolve_via_company_mapping |
| MODIFIED | `tests/integration/migrations/test_enterprise_schema_migration.py` | Added AC5 test for table non-existence |
| MODIFIED | `tests/integration/test_cli_multi_domain.py` | Updated domain validation tests |

