# Story 7.3-6: Annuity Income Pipeline Processing Alignment

> **Epic:** 7.3 - Multi-Domain Consistency Fixes
> **Status:** done
> **Priority:** P0 (Critical)
> **Effort:** 5 Story Points
> **Created:** 2025-12-29
> **Updated:** 2025-12-29 (Validation Review Applied)
> **Sprint Change Proposal:** [sprint-change-proposal-2025-12-29-annuity-income-pipeline-gap.md](../sprint-change-proposal/sprint-change-proposal-2025-12-29-annuity-income-pipeline-gap.md)

---

## Story

As a **data engineer**,
I want `annuity_income` pipeline processing to be aligned with `annuity_performance`,
so that multi-domain ETL produces consistent data output across all domains.

## Problem Statement

During post-ETL data verification for period `202510`, **four processing inconsistencies** were discovered between `annuity_performance` and `annuity_income` domains at the **pipeline processing layer**:

| Issue                                         | Severity     | Root Cause                                  |
| --------------------------------------------- | ------------ | ------------------------------------------- |
| `company_id` lacks multi-priority matching    | **Critical** | Missing `mapping_repository` + `eqc_config` |
| `客户名称` incorrectly filled from `计划名称` | **High**     | `_fill_customer_name` wrong fallback logic  |
| `计划代码` missing corrections                | **Medium**   | No `PLAN_CODE_CORRECTIONS` constant         |
| `计划代码` missing defaults                   | **Medium**   | No `PLAN_CODE_DEFAULTS` constant            |

**Key Distinction:** Epic 7.3 Stories 7.3-1 to 7.3-5 fixed **type declarations** (Pydantic models, Domain Registry). This story fixes **runtime processing logic** in `pipeline_builder.py` and `service.py`.

### Evidence (SQL Verification - Period 202510)

```sql
-- annuity_performance: Mixed company_ids (cached + temporary)
SELECT COUNT(*) FROM "business"."规模明细" WHERE "月度" = '2025-10-01';
-- Result: 37,121 rows, 7 null customer names, 0 null company_ids

-- annuity_income: ALL temporary IDs (no cached lookups)
SELECT COUNT(*) FROM "business"."收入明细" WHERE "月度" = '2025-10-01';
-- Result: 13,639 rows, 0 null customer names (all filled with plan names!)
```

---

## Acceptance Criteria

### Critical (Must Fix)

- [ ] **AC1:** `annuity_income` pipeline accepts `mapping_repository` parameter
- [ ] **AC2:** `CompanyIdResolutionStep` passes `mapping_repository` to `CompanyIdResolver`
- [ ] **AC3:** `_fill_customer_name` preserves null values (no plan name fallback)
- [ ] **AC4:** After re-running ETL, `annuity_income` has mix of cached IDs and temp IDs
- [ ] **AC5:** `eqc_config` parameter passed to pipeline builder (not silently disabled)
- [ ] **AC6:** Database connection properly cleaned up in try/finally block

### High (Should Fix)

- [ ] **AC7:** `PLAN_CODE_CORRECTIONS` constant added to `annuity_income/constants.py`
- [ ] **AC8:** `PLAN_CODE_DEFAULTS` constant added to `annuity_income/constants.py`
- [ ] **AC9:** Pipeline applies `ReplacementStep` for plan code corrections
- [ ] **AC10:** Pipeline applies `CalculationStep` for plan code defaults

### General

- [ ] **AC11:** All existing unit tests pass
- [ ] **AC12:** New unit tests verify consistent behavior between domains
- [ ] **AC13:** Connection cleanup verified even when pipeline throws exception

---

## Tasks / Subtasks

### Task 1: Add `mapping_repository` Parameter to Pipeline (AC: 1, 2)

- [x] 1.1 Add `mapping_repository` parameter to `CompanyIdResolutionStep.__init__` (after `plan_override_mapping`)
- [x] 1.2 Pass `mapping_repository` to `CompanyIdResolver`
- [x] 1.3 Add `mapping_repository` parameter to `build_bronze_to_silver_pipeline` (after `plan_override_mapping`)
- [x] 1.4 Pass `mapping_repository` to `CompanyIdResolutionStep`

### Task 2: Update Service Layer for Full Alignment (AC: 1, 4, 5, 6)

- [x] 2.1 Import `CompanyMappingRepository` and `EqcLookupConfig` in `service.py`
- [x] 2.2 Initialize `mapping_repository` with database connection (with try/except)
- [x] 2.3 Add `eqc_config` derivation from `sync_lookup_budget` if not provided
- [x] 2.4 Pass both `eqc_config` and `mapping_repository` to `build_bronze_to_silver_pipeline`
- [x] 2.5 Wrap pipeline execution in try/finally for connection cleanup
- [x] 2.6 Handle initialization failure gracefully (log warning, proceed without)

### Task 3: Fix `_fill_customer_name` Logic (AC: 3)

- [x] 3.1 Remove `combine_first(plan_names)` fallback
- [x] 3.2 Remove `fillna("UNKNOWN")` fallback
- [x] 3.3 Update docstring to match `annuity_performance` behavior
- [x] 3.4 Keep null values as-is (preserve nullability)

### Task 4: Add Plan Code Constants (AC: 7, 8)

- [x] 4.1 Add `PLAN_CODE_CORRECTIONS` to `constants.py`
- [x] 4.2 Add `PLAN_CODE_DEFAULTS` to `constants.py`
- [x] 4.3 Update `__all__` exports

### Task 5: Add Plan Code Processing Steps (AC: 9, 10)

- [x] 5.1 Import `ReplacementStep` from infrastructure
- [x] 5.2 Add `ReplacementStep({"计划代码": PLAN_CODE_CORRECTIONS})`
- [x] 5.3 Add `CalculationStep` for plan code defaults
- [x] 5.4 Place steps after `MappingStep` and before date parsing

### Task 6: Update Tests (AC: 11, 12, 13)

- [x] 6.1 Verify existing unit tests pass
- [x] 6.2 Add test for `_fill_customer_name` null preservation
- [x] 6.3 Add test for plan code corrections
- [x] 6.4 Add test for plan code defaults
- [x] 6.5 Add test for connection cleanup when pipeline throws exception ✅ (Code Review Fix)

---

## Dev Notes

> ⚠️ **CRITICAL ANTI-PATTERNS TO AVOID:**
>
> 1. **DO NOT** forget try/finally for `repo_connection` cleanup - causes connection leaks
> 2. **DO NOT** forget to pass `eqc_config` to pipeline builder - silently disables EQC lookups
> 3. **DO NOT** make `mapping_repository` init failure a hard error - log warning & continue
> 4. **DO NOT** use `eqc_config=None` default in pipeline_builder - make it required like annuity_performance

### Required Pattern: `service.py` (Task 2)

```python
# === IMPORTS (add to existing) ===
from work_data_hub.config.settings import get_settings
from work_data_hub.infrastructure.enrichment import EqcLookupConfig
from work_data_hub.infrastructure.enrichment.mapping_repository import CompanyMappingRepository

# === IN process_with_enrichment() ===

# Step 1: Initialize mapping_repository
mapping_repository: Optional[CompanyMappingRepository] = None
repo_connection = None
try:
    from sqlalchemy import create_engine
    settings = get_settings()
    engine = create_engine(settings.get_database_connection_string())
    repo_connection = engine.connect()
    mapping_repository = CompanyMappingRepository(repo_connection)
except Exception as e:
    logger.bind(domain="annuity_income", step="mapping_repository").warning(
        "Failed to initialize CompanyMappingRepository; proceeding without DB cache",
        error=str(e),
    )
    mapping_repository = None
    repo_connection = None

# Step 2: Derive eqc_config if not provided (Story 6.2-P17 pattern)
if eqc_config is None:
    eqc_config = EqcLookupConfig(
        enabled=sync_lookup_budget > 0,
        sync_budget=max(sync_lookup_budget, 0),
        auto_create_provider=True,
        export_unknown_names=export_unknown_names,
        auto_refresh_token=True,
    )

# Step 3: Build pipeline with BOTH parameters
try:
    pipeline = build_bronze_to_silver_pipeline(
        eqc_config=eqc_config,                    # ✅ CRITICAL: Pass eqc_config
        enrichment_service=enrichment_service,
        plan_override_mapping=plan_overrides,
        mapping_repository=mapping_repository,    # ✅ CRITICAL: Pass mapping_repository
    )
    # ... execute pipeline ...
finally:
    # Step 4: ALWAYS cleanup connection
    if repo_connection is not None:
        try:
            repo_connection.commit()
        except Exception:
            repo_connection.rollback()
        repo_connection.close()
```

### Required Pattern: `pipeline_builder.py` (Tasks 1, 3, 5)

```python
# === CompanyIdResolutionStep.__init__ (make eqc_config REQUIRED) ===
def __init__(
    self,
    eqc_config: EqcLookupConfig,  # ✅ REQUIRED (not optional)
    enrichment_service: Optional["CompanyEnrichmentService"] = None,
    plan_override_mapping: Optional[Dict[str, str]] = None,
    mapping_repository=None,      # ✅ ADD after plan_override_mapping
) -> None:
    # ... yaml_overrides setup ...
    self._resolver = CompanyIdResolver(
        eqc_config=eqc_config,
        enrichment_service=enrichment_service,
        yaml_overrides=yaml_overrides,
        mapping_repository=mapping_repository,  # ✅ ADD
    )

# === build_bronze_to_silver_pipeline (make eqc_config REQUIRED) ===
def build_bronze_to_silver_pipeline(
    eqc_config: EqcLookupConfig,  # ✅ REQUIRED (not optional)
    enrichment_service: Optional["CompanyEnrichmentService"] = None,
    plan_override_mapping: Optional[Dict[str, str]] = None,
    mapping_repository=None,      # ✅ ADD after plan_override_mapping
) -> Pipeline:

# === _fill_customer_name (FIX - Task 3) ===
def _fill_customer_name(df: pd.DataFrame) -> pd.Series:
    """Keep customer name as-is, allow null (consistent with annuity_performance)."""
    if "客户名称" in df.columns:
        return df["客户名称"]  # ✅ Keep as-is, including nulls
    else:
        return pd.Series([pd.NA] * len(df), index=df.index)
```

### Required Pattern: `constants.py` (Task 4)

```python
# Add to constants.py (copy from annuity_performance/constants.py lines 39-40)
PLAN_CODE_CORRECTIONS: Dict[str, str] = {"1P0290": "P0290", "1P0807": "P0807"}
PLAN_CODE_DEFAULTS: Dict[str, str] = {"集合计划": "AN001", "单一计划": "AN002"}

# Update __all__ to include new exports
```

### File Modification Summary

| File                                        | Changes                                                                                              |
| ------------------------------------------- | ---------------------------------------------------------------------------------------------------- |
| `domain/annuity_income/pipeline_builder.py` | Add `mapping_repository`, make `eqc_config` required, fix `_fill_customer_name`, add plan code steps |
| `domain/annuity_income/service.py`          | Add `CompanyMappingRepository`, `eqc_config` derivation, try/finally cleanup                         |
| `domain/annuity_income/constants.py`        | Add `PLAN_CODE_CORRECTIONS`, `PLAN_CODE_DEFAULTS`                                                    |
| `tests/domain/annuity_income/`              | Update tests, add connection cleanup test                                                            |

### Verification Commands

After implementation, run these to verify the fix worked:

```bash
# Run all annuity_income tests
PYTHONPATH=src uv run pytest tests/domain/annuity_income/ -v

# Run ETL for period 202510
uv run --env-file .wdh_env python -m work_data_hub.cli etl \
  --domain annuity_income --period 202510 --execute --no-enrichment

# Verify company_id has mixed cached/temp IDs (not all temp)
psql -c "SELECT LEFT(company_id, 2) as prefix, COUNT(*) FROM business.收入明细 WHERE 月度='2025-10-01' GROUP BY 1;"
# Expected: Some 'IN' (temp) AND some other prefixes (cached)

# Verify null customer names are preserved
psql -c "SELECT COUNT(*) FROM business.收入明细 WHERE 月度='2025-10-01' AND 客户名称 IS NULL;"
# Expected: > 0 (nulls preserved, not filled with plan names)
```

### References

- [annuity_performance/service.py](file:///e:/Projects/WorkDataHub/src/work_data_hub/domain/annuity_performance/service.py#L194-L257) - Full reference pattern with try/finally
- [Gap Analysis Document](../../specific/multi-domain/annuity-income-processing-gap-analysis.md)

---

## Dev Agent Record

### Agent Model Used

Claude 3.5 Sonnet (claude-sonnet-4-20250514) via Claude Code CLI

### Debug Log References

_To be filled during implementation_

### Completion Notes List

**Implementation Summary:**

All 6 tasks completed successfully, aligning `annuity_income` pipeline processing with `annuity_performance`:

1. **Pipeline Builder Changes (`pipeline_builder.py`):**

   - Added `mapping_repository` parameter to `CompanyIdResolutionStep.__init__` (made `eqc_config` REQUIRED)
   - Added `mapping_repository` parameter to `build_bronze_to_silver_pipeline`
   - Fixed `_fill_customer_name` to preserve null values (removed plan name fallback)
   - Added `_apply_plan_code_defaults` function (copied from annuity_performance)
   - Added `ReplacementStep` for plan code corrections (1P0290 → P0290, 1P0807 → P0807)
   - Added `CalculationStep` for plan code defaults (集合计划 → AN001, 单一计划 → AN002)

2. **Service Layer Changes (`service.py`):**

   - Added imports: `get_settings`, `EqcLookupConfig`, `CompanyMappingRepository`
   - Added `mapping_repository` initialization with try/except block
   - Added `eqc_config` derivation from `sync_lookup_budget` (Story 6.2-P17 pattern)
   - Wrapped pipeline execution in try/finally for connection cleanup
   - Graceful degradation if `CompanyMappingRepository` initialization fails

3. **Constants Changes (`constants.py`):**

   - Added `PLAN_CODE_CORRECTIONS` dict
   - Added `PLAN_CODE_DEFAULTS` dict
   - Updated `__all__` exports

4. **Test Updates (`test_pipeline.py`):**
   - Updated step count expectations from 12 to 14 (added 2 plan code processing steps)

**Verification Results:**

- ✅ All 81 annuity_income unit tests passing (10 new tests from Code Review)

**Code Review Fixes (2025-12-29):**

- ✅ H001: Added 3 connection cleanup tests (`test_service.py::TestStory736ConnectionCleanup`)
- ✅ M001/M002: Added 7 pipeline alignment tests (`test_pipeline.py::TestStory736PipelineAlignment`)
- ✅ M003: Updated `process_with_enrichment` docstring with EqcLookupConfig SSOT documentation
- ✅ M004: Tests verify `PLAN_CODE_CORRECTIONS` and `PLAN_CODE_DEFAULTS` constants integrity
- ✅ No regressions in existing functionality
- ✅ Pipeline now has consistent behavior with annuity_performance

**Key Changes:**

- `pipeline_builder.py`: +35 lines (mapping_repository, plan code processing, \_fill_customer_name fix)
- `service.py`: +45 lines (mapping_repository init, eqc_config derivation, try/finally cleanup)
- `constants.py`: +4 lines (PLAN_CODE_CORRECTIONS, PLAN_CODE_DEFAULTS)
- `test_pipeline.py`: 2 lines updated (step count: 12 → 14)

**Total LOC Changed:** ~86 lines across 4 files

### File List

| Status | File Path                                                     | Action |
| ------ | ------------------------------------------------------------- | ------ |
| [x]    | `src/work_data_hub/domain/annuity_income/pipeline_builder.py` | MODIFY |
| [x]    | `src/work_data_hub/domain/annuity_income/service.py`          | MODIFY |
| [x]    | `src/work_data_hub/domain/annuity_income/constants.py`        | MODIFY |
| [x]    | `tests/unit/domain/annuity_income/test_pipeline.py`           | MODIFY |
