# Story 7.4-1: Job Registry Pattern - Replace if/elif Dispatch

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a **developer**,
I want **a dictionary-based job registry pattern** to replace the hardcoded if/elif dispatch chain,
so that **adding new domains only requires registering them in the registry instead of modifying dispatch logic**.

## Acceptance Criteria

1. **AC1: JOB_REGISTRY Dictionary Created**

   - Create `JOB_REGISTRY: Dict[str, JobEntry]` in `orchestration/jobs.py`
   - Each entry contains: `job`, `multi_file_job` (optional), `supports_backfill` (bool)
   - All existing domains registered: `annuity_performance`, `annuity_income`, `sandbox_trustee_performance`

2. **AC2: CLI Executor Refactored**

   - Remove if/elif chain in `executors.py` (lines 200-232)
   - Replace with `JOB_REGISTRY.get(domain_key)` lookup
   - Special domains (`company_lookup_queue`, `reference_sync`) still handled via dedicated functions

3. **AC3: Error Message Auto-Generated**

   - Unsupported domain error message auto-generates from `JOB_REGISTRY.keys()`
   - No manual list maintenance required (fixes MD-004)

4. **AC4: Multi-File Job Support Preserved**

   - Registry lookup respects `max_files > 1` for domains with `multi_file_job`
   - `sandbox_trustee_performance` current behavior unchanged

5. **AC5: All Existing Tests Pass**
   - No behavioral changes - pure refactoring
   - CI pipeline green
   - Key test files: `tests/cli/test_etl_executor.py`, `tests/orchestration/test_jobs.py`

## Tasks / Subtasks

- [x] Task 1: Create JobEntry dataclass (AC: 1)

  - [x] 1.1 Define `JobEntry` with fields: `job`, `multi_file_job`, `supports_backfill`
  - [x] 1.2 Add type hints and docstring explaining registry pattern

- [x] Task 2: Create JOB_REGISTRY dictionary with all domains (AC: 1)

  - [x] 2.1 Register all 3 domains with correct flags (see code example below)

  ```python
  JOB_REGISTRY: Dict[str, JobEntry] = {
      "annuity_performance": JobEntry(
          job=annuity_performance_job,
          supports_backfill=True,
      ),
      "annuity_income": JobEntry(
          job=annuity_income_job,
          supports_backfill=True,  # Story 7.3-7 added backfill support
      ),
      "sandbox_trustee_performance": JobEntry(
          job=sandbox_trustee_performance_job,
          multi_file_job=sandbox_trustee_performance_multi_file_job,
          supports_backfill=True,
      ),
  }
  ```

- [x] Task 3: Refactor `_execute_single_domain()` (AC: 2, 3)

  - [x] 3.1 Import `JOB_REGISTRY` from orchestration.jobs
  - [x] 3.2 Replace if/elif chain with registry lookup
  - [x] 3.3 Keep special domain handling (`company_lookup_queue`, `reference_sync`)
  - [x] 3.4 Generate error message from `JOB_REGISTRY.keys()`

- [x] Task 4: Preserve multi-file job selection (AC: 4)

  - [x] 4.1 Check `job_entry.multi_file_job` when `max_files > 1`
  - [x] 4.2 Maintain warning for unsupported multi-file domains

- [x] Task 5: Verify tests and CI (AC: 5)
  - [x] 5.1 Run `pytest tests/cli/` - all tests pass
  - [x] 5.2 Run `pytest tests/orchestration/` - all tests pass
  - [x] 5.3 Run full test suite - no regressions

## Dev Notes

### Critical Architecture Decisions

1. **JobEntry Location**: Define in `orchestration/jobs.py` alongside job definitions (single source of truth)
2. **Lazy Imports**: Registry entries can use lazy imports if needed to avoid circular dependencies
3. **Special Domains**: Keep `company_lookup_queue` and `reference_sync` as special cases - they don't follow the standard job pattern
4. **Import Strategy**: JOB_REGISTRY can be imported at module level in executors.py. If circular import issues arise, use a lazy initialization pattern (function that returns the registry on first call).

### Scope Boundaries

> **OUT OF SCOPE:** The backfill domain list in `config.py:157-161` (MD-002) is addressed in **Story 7.4-2**, not this story. This story only refactors the job dispatch logic in `executors.py`.
>
> **NOTE:** The `supports_backfill` field in `JobEntry` is defined for future use by Story 7.4-2 but is not utilized in this story's executor refactoring.

### References

- [Sprint Change Proposal](../sprint-change-proposal/sprint-change-proposal-2025-12-30-domain-registry-architecture.md#Story-7.4-1)
- [Technical Debt Analysis](../../specific/multi-domain/new-domain-checklist.md#Architectural-Debt-Summary)
- [Target Code Location](../../../src/work_data_hub/cli/etl/executors.py#L200-232)

### Target Code Pattern

**Before (executors.py:200-232):**

```python
if domain_key == "annuity_performance":
    from work_data_hub.orchestration.jobs import annuity_performance_job
    selected_job = annuity_performance_job
elif domain_key == "annuity_income":
    from work_data_hub.orchestration.jobs import annuity_income_job
    selected_job = annuity_income_job
# ... more elif branches
else:
    raise ValueError(f"Unsupported domain: {domain}...")
```

**After:**

```python
from work_data_hub.orchestration.jobs import JOB_REGISTRY

# Handle special non-standard domains first
if domain_key in ("company_lookup_queue", "reference_sync"):
    return _execute_special_domain(args, domain_key)

job_entry = JOB_REGISTRY.get(domain_key)
if not job_entry:
    supported = ", ".join(sorted(JOB_REGISTRY.keys()))
    raise ValueError(f"Unsupported domain: {domain}. Supported: {supported}")

# Select job based on max_files parameter
selected_job = job_entry.job
if max_files > 1:
    if job_entry.multi_file_job:
        selected_job = job_entry.multi_file_job
    else:
        print(f"Warning: max_files > 1 not yet supported for {domain}, using 1")
```

### JobEntry DataClass Design

```python
from dataclasses import dataclass
from typing import Any, Optional

@dataclass(frozen=True)
class JobEntry:
    """Registry entry for a domain's Dagster job(s).

    Attributes:
        job: The primary Dagster JobDefinition (required, must not be None)
        multi_file_job: Optional job for max_files > 1 scenarios
        supports_backfill: Whether domain has FK backfill configured in foreign_keys.yml
    """
    job: Any  # Dagster JobDefinition - MUST be a valid job, never None
    multi_file_job: Optional[Any] = None  # For max_files > 1 scenarios
    supports_backfill: bool = False  # Whether domain has FK backfill configured
```

> **Note:** The `job` field must always contain a valid Dagster JobDefinition. If `job` is None, the registry lookup will succeed but job execution will fail. Validation occurs at runtime when `selected_job.execute_in_process()` is called.

### Files to Modify

| File                    | Lines         | Change Type | Description                                |
| ----------------------- | ------------- | ----------- | ------------------------------------------ |
| `orchestration/jobs.py` | After imports | Add         | `JobEntry` dataclass + `JOB_REGISTRY` dict |
| `cli/etl/executors.py`  | 200-232       | Replace     | if/elif chain → registry lookup            |

### Testing Strategy

1. **Unit Tests**: Existing CLI tests should pass unchanged
   - `tests/cli/test_etl_executor.py` - executor dispatch tests (if exists)
   - `tests/orchestration/test_jobs.py` - job definition tests (if exists)
2. **Manual Validation**:
   - `uv run --env-file .wdh_env python -m work_data_hub.cli.etl --domain annuity_performance --dry-run`
   - `uv run --env-file .wdh_env python -m work_data_hub.cli.etl --domain annuity_income --dry-run`
   - `uv run --env-file .wdh_env python -m work_data_hub.cli.etl --domain invalid_domain` (verify auto-generated error message)
3. **Regression Check**:
   - `PYTHONPATH=src uv run --env-file .wdh_env pytest tests/ -v` - full suite must pass

### Issues Addressed

| Issue ID | Description                               | Status   |
| -------- | ----------------------------------------- | -------- |
| MD-001   | Job dispatch uses hardcoded if/elif chain | ✅ Fixed |
| MD-004   | Error message lists domains manually      | ✅ Fixed |

### Project Structure Notes

- Alignment with unified project structure: Changes confined to orchestration and cli layers
- No domain layer changes required
- No database/migration changes

## Dev Agent Record

### Agent Model Used

claude-opus-4-5-20251101 (Story implementation)

### Debug Log References

No critical issues encountered. Implementation followed TDD approach with all tests passing.

### Completion Notes List

**Story 7.4-1 Implementation Summary:**

1. **JobEntry Dataclass Created** (src/work_data_hub/orchestration/jobs.py:48-59)

   - Frozen dataclass with `job`, `multi_file_job`, `supports_backfill` fields
   - Type hints and comprehensive docstring added
   - Immutable (frozen=True) for safety

2. **JOB_REGISTRY Dictionary Created** (src/work_data_hub/orchestration/jobs.py:273-290)

   - Single source of truth for domain → job mapping
   - All 3 domains registered: annuity_performance, annuity_income, sandbox_trustee_performance
   - Properly configured with backfill flags (all True per Story 7.3-7)

3. **CLI Executor Refactored** (src/work_data_hub/cli/etl/executors.py:200-224)

   - Replaced 33-line if/elif chain with 25-line registry lookup
   - Special domains (company_lookup_queue, reference_sync) preserved
   - Auto-generated error message from JOB_REGISTRY.keys() (fixes MD-004)
   - Multi-file job selection logic preserved

4. **Tests Added** (tests/orchestration/test_jobs.py:28-108)

   - TestJobEntry: 4 tests for dataclass functionality
   - TestJobRegistry: 6 tests for registry configuration
   - All new tests pass + 94 existing tests pass

5. **Verification Complete**
   - ✅ AC1: JOB_REGISTRY created with all domains
   - ✅ AC2: CLI executor refactored
   - ✅ AC3: Auto-generated error messages
   - ✅ AC4: Multi-file job support preserved
   - ✅ AC5: All tests pass (94 passed, 43 skipped)

**Code Quality:**

- Zero regression issues
- Clean separation of concerns
- Follows Open/Closed Principle (extensible without modification)
- Self-documenting through registry structure

### File List

- src/work_data_hub/orchestration/jobs.py (modified: +37 lines)
- src/work_data_hub/cli/etl/executors.py (modified: replaced lines 200-232)
- tests/orchestration/test_jobs.py (modified: +80 lines for new tests)
- docs/sprint-artifacts/sprint-status.yaml (modified: story status update)
