# Story 6.2-P12: Domain Comparison Framework Generalization

**Epic**: Epic 6.2 - Generic Reference Data Management
**Status**: done
**Priority**: P2
**Created**: 2025-12-18
**Sprint Change Proposal**: `docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-18.md`

---

## Story

As a **data engineer**,
I want **the cleaner-comparison module to be configuration-driven and domain-agnostic**,
So that **I can validate any domain's ETL pipeline against its Legacy cleaner without code duplication**.

---

## Background

The `cleaner-comparison` module (`scripts/validation/CLI/`) was developed during Epic 6.2 for validating the `annuity_performance` domain. The module successfully validates ETL strategy differences between Legacy System and New Pipeline through actual data write testing.

**Problem**: The module is tightly coupled to `annuity_performance` domain with hardcoded:
- Field configurations (`NUMERIC_FIELDS`, `DERIVED_FIELDS`)
- Direct imports of `AnnuityPerformanceCleaner`
- Direct imports of `annuity_performance.pipeline_builder`
- Default sheet name (`规模明细`)
- File naming (`guimo_iter_*` implies single domain)

**Solution**: Refactor to configuration-driven architecture where each domain only needs to define a config class.

---

## Hard Constraints

1. **No new dependencies / frameworks**: Keep using stdlib `argparse` + existing pandas-based approach. Do not introduce Click/Typer/etc.
2. **No capability regressions**: The refactor must preserve all existing CLI behaviors/flags (unless explicitly renamed):
   - `--month` auto-discovery (via `FileDiscoveryService`)
   - `--enrichment` + token validation/auto-refresh behavior (and `--no-auto-refresh-token`)
   - `--new-only`, `--debug`, `--export`, `--sync-budget`, `--sheet`, `--limit`
3. **Secrets safety**: Never log EQC tokens or other secrets; keep token refresh UX unchanged.
4. **Performance guardrail**: If `--limit 0` (full dataset), print a warning about runtime/memory and keep `--limit` semantics unchanged.
5. **Deterministic validation**: Exported artifacts must be comparable in a deterministic way:
   - Either: provide a `--run-id` option and ensure exported files do not include “current time” content.
   - Or: define explicit normalization rules for equivalence (e.g., ignore run directory name and “Generated” line).
6. **Legacy imports remain lazy**: Domain configs must lazy-import legacy/new pipeline modules so `--new-only` works without legacy dependencies installed.

---

## Acceptance Criteria

### AC1: Base Config Class Implementation
**Given** the refactored module structure
**When** `configs/base.py` is implemented
**Then** `DomainComparisonConfig` ABC defines all required abstract properties:
- `domain_name: str`
- `sheet_name: str`
- `numeric_fields: List[str]`
- `derived_fields: List[str]`
- `get_legacy_cleaner() -> Type`
- `build_new_pipeline(excel_path: str, sheet_name: str, row_limit: Optional[int], enable_enrichment: bool, sync_lookup_budget: int) -> pandas.DataFrame`

**And** it defines default properties used by existing implementation:
- `upgrade_fields` defaulting to `["company_id"]`
- `column_name_mapping` defaulting to `{}`

### AC2: Domain Config Migration
**Given** existing hardcoded values in `guimo_iter_config.py`
**When** `configs/annuity_performance.py` is created
**Then** all domain-specific values are migrated:
- `NUMERIC_FIELDS` → `numeric_fields` property
- `DERIVED_FIELDS` → `derived_fields` property
- `COLUMN_NAME_MAPPING` → `column_name_mapping` property
- `DEFAULT_SHEET_NAME` → `sheet_name` property
- Legacy cleaner import → `get_legacy_cleaner()` method
- Pipeline builder import → `build_new_pipeline()` method

### AC3: CLI Domain Selection
**Given** the refactored `cleaner_compare.py`
**When** executed with `--domain annuity_performance`
**Then** it produces identical **comparison results** to current `guimo_iter_cleaner_compare.py` for the same input (diff counts, classifications, and examples), and preserves existing CLI flags/behavior.

### AC4: Functional Equivalence
**Given** same input data (baseline: `--month 202311`, `--limit 100`)
**When** comparing old script vs new script output
**Then** exported CSV/MD artifacts are verifiably equivalent via one of:
1. **Deterministic export**: `--run-id` (or equivalent) makes exports stable (no dynamic timestamps/content).
2. **Normalized comparison**: the comparison ignores run-specific metadata (run directory name and any “Generated” timestamp line), while all reported diffs/classifications/examples remain identical.

### AC5: Documentation Update
**Given** the new CLI interface
**When** `cleaner-comparison-usage-guide.md` is updated
**Then** it documents:
- New `--domain` required argument
- Available domain choices
- How to add new domain configs
- Artifact equivalence rules (deterministic via `--run-id` if implemented; otherwise normalized comparison guidance)

---

## Tasks / Subtasks

### Phase 1: Directory Structure [~15 min]
- [x] T1.1: Create `scripts/validation/CLI/configs/` directory (AC: #1)
- [x] T1.2: Create `scripts/validation/CLI/configs/__init__.py` with `DOMAIN_CONFIGS` registry (AC: #1)

### Phase 2: Base Config Class [~20 min]
- [x] T2.1: Implement `configs/base.py` with `DomainComparisonConfig` ABC (AC: #1)
  - Abstract properties: `domain_name`, `sheet_name`, `numeric_fields`, `derived_fields`
  - Default properties: `upgrade_fields` (default: `["company_id"]`), `column_name_mapping` (default: `{}`)
  - Abstract methods: `get_legacy_cleaner()`, `build_new_pipeline()`

### Phase 3: Domain Config Migration [~30 min]
- [x] T3.1: Create `configs/annuity_performance.py` (AC: #2)
  - Migrate `NUMERIC_FIELDS` list
  - Migrate `DERIVED_FIELDS` list
  - Migrate `COLUMN_NAME_MAPPING` dict
  - Implement `get_legacy_cleaner()` with lazy import
  - Implement `build_new_pipeline()` with lazy import
- [x] T3.2: Register config in `configs/__init__.py` (AC: #2)

### Phase 4: Script Refactoring [~45 min]
- [x] T4.1: Rename `guimo_iter_cleaner_compare.py` → `cleaner_compare.py` (AC: #3)
- [x] T4.2: Add `--domain` CLI argument (required, choices from `DOMAIN_CONFIGS.keys()`) (AC: #3)
- [x] T4.3: Implement `load_domain_config(domain: str)` function (AC: #3)
- [x] T4.4: Replace hardcoded imports with config-driven calls (AC: #3)
  - `run_legacy_cleaner()`: Use `config.get_legacy_cleaner()`
  - `run_new_pipeline()`: Use `config.build_new_pipeline(...)`
  - Field comparisons: Use `config.numeric_fields`, `config.derived_fields`, etc.
- [x] T4.5: Rename `guimo_iter_config.py` → `domain_config.py` (keep non-domain constants) (AC: #3)
- [x] T4.6: Rename `guimo_iter_report_generator.py` → `report_generator.py` (update imports only) (AC: #3)
- [x] T4.7: Preserve existing flags and behaviors (`--month`, `--enrichment`, `--new-only`, `--debug`, `--export`, `--sync-budget`, etc.) while adding `--domain` (Hard Constraints #2)
- [x] T4.8: Add deterministic export support (`--run-id` or equivalent) OR document normalization rules for equivalence (Hard Constraints #5)

### Phase 5: Validation [~30 min]
- [x] T5.1: Run functional equivalence test (AC: #4)
  ```bash
  PYTHONPATH=src uv run python scripts/validation/CLI/cleaner_compare.py \
      --domain annuity_performance --month 202311 --limit 100 --export
  ```
- [x] T5.2: Compare output artifacts with pre-refactor baseline (AC: #4)
- [x] T5.3: Run unit tests: `PYTHONPATH=src uv run pytest tests/unit/domain/annuity_performance/ -v` (AC: #4)
- [x] T5.4: Run e2e tests: `PYTHONPATH=src uv run pytest tests/e2e/test_pipeline_vs_legacy.py -v` (AC: #4)

### Phase 6: Documentation & Cleanup [~15 min]
- [x] T6.1: Update `cleaner-comparison-usage-guide.md` with new CLI interface (AC: #5)
- [x] T6.2: Delete old `guimo_iter_*` files after validation passes (AC: #3)
- [x] T6.3: Update any imports in other scripts that reference old filenames (AC: #3)

---

## Dev Notes

### Architecture Pattern: Config-Driven Domain Abstraction

```python
# Each domain only needs to define a config class
class AnnuityPerformanceConfig(DomainComparisonConfig):
    domain_name = "annuity_performance"
    sheet_name = "规模明细"
    numeric_fields = [...]  # migrated from guimo_iter_config.py
    derived_fields = [...]  # migrated from guimo_iter_config.py

    def get_legacy_cleaner(self) -> Type:
        from annuity_hub.data_handler.data_cleaner import AnnuityPerformanceCleaner
        return AnnuityPerformanceCleaner

    def build_new_pipeline(
        self,
        excel_path: str,
        sheet_name: str,
        row_limit: Optional[int],
        enable_enrichment: bool,
        sync_lookup_budget: int,
    ) -> "pandas.DataFrame":
        # Implement as a thin wrapper around the existing run_new_pipeline logic,
        # using lazy imports to keep --new-only usable without legacy deps.
        ...
```

### Files to Create

| File | Description |
|------|-------------|
| `scripts/validation/CLI/configs/__init__.py` | Domain config registry |
| `scripts/validation/CLI/configs/base.py` | `DomainComparisonConfig` ABC |
| `scripts/validation/CLI/configs/annuity_performance.py` | 规模明细 config |

### Files to Rename

| Old Name | New Name |
|----------|----------|
| `guimo_iter_cleaner_compare.py` | `cleaner_compare.py` |
| `guimo_iter_config.py` | `domain_config.py` |
| `guimo_iter_report_generator.py` | `report_generator.py` |

### Critical Implementation Notes

1. **Lazy Imports**: Use lazy imports in config methods to avoid import errors when Legacy dependencies aren't installed
2. **No Backward Compatibility**: Per SCP approval, old `guimo_iter_*` files can be deleted without deprecation
3. **YAGNI**: `annuity_income` config deferred to Epic 10 when actually needed
4. **Config Registry**: `DOMAIN_CONFIGS` dict in `__init__.py` maps domain names to config classes

### Project Structure Notes

- **Location**: `scripts/validation/CLI/` (validation scripts, not main package)
- **Import Pattern**: Local imports with `sys.path` manipulation (existing pattern)
- **Artifacts**: Output to `_artifacts/` subdirectory (unchanged)

### References

- [Source: `docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-18.md`] - Full change proposal
- [Source: `scripts/validation/CLI/guimo_iter_config.py`] - Current hardcoded values
- [Source: `scripts/validation/CLI/guimo_iter_cleaner_compare.py`] - Main comparison script
- [Source: `scripts/validation/CLI/guimo_iter_report_generator.py`] - Report generation utilities
- [Source: `scripts/validation/CLI/cleaner-comparison-usage-guide.md`] - Current usage documentation

---

## Test Strategy

### Validation Commands

```bash
# 1. Functional equivalence test (CRITICAL)
PYTHONPATH=src uv run python scripts/validation/CLI/cleaner_compare.py \
    --domain annuity_performance --month 202311 --limit 100 --export

# Optional (recommended): deterministic run directory / reproducible exports
# (Only applicable if `--run-id` is implemented per Hard Constraints #5)
PYTHONPATH=src uv run python scripts/validation/CLI/cleaner_compare.py \
    --domain annuity_performance --month 202311 --limit 100 --export --run-id baseline-202311-limit100

# 2. Unit tests for pipeline infrastructure
PYTHONPATH=src uv run pytest tests/unit/domain/annuity_performance/ -v

# 3. E2E pipeline tests
PYTHONPATH=src uv run pytest tests/e2e/test_pipeline_vs_legacy.py -v

# 4. Integration tests
PYTHONPATH=src uv run pytest tests/integration/test_pipeline_end_to_end.py -v
```

### Validation Criteria

| Test | Pass Condition |
|------|----------------|
| Functional equivalence | Results equivalent to baseline (either deterministic exports via `--run-id`, or normalized comparison ignoring run-specific metadata) |
| Unit tests | All `tests/unit/domain/annuity_performance/` pass |
| E2E tests | `test_pipeline_vs_legacy.py` passes |
| Config isolation | New script with `--domain annuity_performance` produces equivalent CSV/MD artifacts under the same comparison rules |

---

## Rollback Strategy

| Scenario | Rollback Action |
|----------|-----------------|
| Refactor introduces bugs | `git revert` to commit before changes |
| Partial completion needed | Old `guimo_iter_*` files remain functional until T6.2 |
| Config class design issues | Iterate on `base.py` without affecting existing functionality |

**Git Safety:**
- Create feature branch: `feature/domain-comparison-generalization`
- Commit after each phase (atomic commits)
- Old files deleted only after full validation (T6.2)

---

## Success Criteria

- [x] `cleaner_compare.py --domain annuity_performance` works identically to current script
- [x] Output artifacts (CSV, MD) are deterministically comparable (Hard Constraints #5)
- [x] Adding new domain requires only creating a config file (framework verified)
- [x] All test suites pass (unit, integration, e2e)
- [x] Documentation updated with new CLI interface

---

## Definition of Done

- [x] All tasks completed
- [x] Functional equivalence validated
- [x] Unit tests passing
- [x] E2E tests passing
- [x] No CLI capability regressions (Hard Constraints #2)
- [x] Deterministic or normalized artifact equivalence confirmed (Hard Constraints #5)
- [x] Code review passed
- [x] Documentation updated
- [x] Old files deleted
- [x] sprint-status.yaml updated to `done`

---

## Dev Agent Record

### Agent Model Used

Gemini 2.5 Pro (Antigravity)

### Debug Log References

N/A - No debug issues encountered.

### Completion Notes List

- Implemented config-driven architecture with `DomainComparisonConfig` ABC
- Created `annuity_performance` domain config with all field definitions migrated
- New `cleaner_compare.py` accepts required `--domain` argument
- Added `--run-id` for deterministic export directory naming
- All existing CLI flags preserved (--month, --enrichment, --new-only, etc.)
- Deleted old `guimo_iter_*` files after validation
- Updated usage guide with new CLI interface and "Adding a New Domain" section

### Change Log

| Date | Author | Change |
|------|--------|--------|
| 2025-12-18 | SM Agent | Story created from SCP sprint-change-proposal-2025-12-18.md |
| 2025-12-18 | Dev Agent | Implemented all phases (P1-P6): config-driven architecture, --domain arg, --run-id support, documentation |

### File List

| File | Change Type | Description |
|------|-------------|-------------|
| `scripts/validation/CLI/configs/__init__.py` | Create | Domain config registry |
| `scripts/validation/CLI/configs/base.py` | Create | DomainComparisonConfig ABC |
| `scripts/validation/CLI/configs/annuity_performance.py` | Create | 规模明细 domain config |
| `scripts/validation/CLI/cleaner_compare.py` | Create (rename) | Main script with --domain arg |
| `scripts/validation/CLI/domain_config.py` | Create (rename) | Shared constants |
| `scripts/validation/CLI/report_generator.py` | Create (rename) | Report utilities |
| `scripts/validation/CLI/cleaner-comparison-usage-guide.md` | Modify | Update CLI documentation |
| `scripts/validation/CLI/guimo_iter_*.py` | Delete | Old hardcoded scripts |
