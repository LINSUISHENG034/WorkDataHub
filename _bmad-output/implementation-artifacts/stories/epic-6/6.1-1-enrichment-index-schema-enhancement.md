# Story 6.1.1: Enrichment Index Schema Enhancement

Status: Ready for Review

## Story

As a **data engineer**,
I want **a new `enrichment_index` table that supports multi-type lookups (plan_code, account_name, account_number, customer_name, plan_customer)**,
so that **Layer 2 (Database Cache) can implement the same 5-priority decision flow as Layer 1 (YAML Configuration), improving cache hit rates and reducing dependency on EQC API**.

## Acceptance Criteria

1. **AC1: New Table Created** - `enterprise.enrichment_index` table exists with all required columns:
   - `id` (SERIAL PRIMARY KEY)
   - `lookup_key` (VARCHAR(255) NOT NULL)
   - `lookup_type` (VARCHAR(20) NOT NULL) - enum: plan_code, account_name, account_number, customer_name, plan_customer
   - `company_id` (VARCHAR(100) NOT NULL)
   - `confidence` (DECIMAL(3,2) DEFAULT 1.00)
   - `source` (VARCHAR(50) NOT NULL) - enum: yaml, eqc_api, manual, backflow, domain_learning, legacy_migration
   - `source_domain` (VARCHAR(50) NULLABLE)
   - `source_table` (VARCHAR(100) NULLABLE)
   - `hit_count` (INT DEFAULT 0)
   - `last_hit_at` (TIMESTAMP NULLABLE)
   - `created_at` (TIMESTAMP DEFAULT NOW())
   - `updated_at` (TIMESTAMP DEFAULT NOW())

2. **AC2: Unique Constraint** - UNIQUE constraint on `(lookup_key, lookup_type)` prevents duplicate mappings

3. **AC3: Indexes Created** - Performance indexes exist:
   - `ix_enrichment_index_type_key` on `(lookup_type, lookup_key)` for efficient lookup
   - `ix_enrichment_index_source` on `(source)` for filtering by source
   - `ix_enrichment_index_source_domain` on `(source_domain)` for domain-based queries

4. **AC4: Repository Methods** - `CompanyMappingRepository` has new methods:
   - `lookup_enrichment_index(lookup_key, lookup_type)` - single lookup
   - `lookup_enrichment_index_batch(keys_by_type: Dict[str, List[str]])` - batch lookup
   - `insert_enrichment_index_batch(records: List[EnrichmentIndexRecord])` - batch insert with ON CONFLICT DO UPDATE using `confidence = GREATEST(existing, excluded)` and incremented `hit_count`, `last_hit_at`, `updated_at`
   - `update_hit_count(lookup_key, lookup_type)` - increment hit_count and update last_hit_at/updated_at
   - All repository methods reuse the shared normalizer for `lookup_key` formation (customer_name, plan_customer)

5. **AC5: Migration Idempotent** - Alembic migration uses IF NOT EXISTS patterns for safe re-runs

6. **AC6: Unit Tests** - All new repository methods have unit tests with >90% coverage

7. **AC7: Normalization & Key Formation** - `lookup_key` rules are explicit and reuse the existing normalizer: customer_name normalized identically to Layer 1/CompanyIdResolver; plan_customer key = `{plan_code}|{normalized_customer_name}`

## Tasks / Subtasks

- [x] Task 1: Create Alembic migration script (AC: 1, 2, 3, 5)
  - [x] 1.1 Create migration file `io/schema/migrations/versions/20251208_000001_create_enrichment_index.py`
  - [x] 1.2 Implement `upgrade()` with table creation and indexes
  - [x] 1.3 Implement `downgrade()` with proper cleanup
  - [x] 1.4 Add idempotency checks (IF NOT EXISTS patterns)

- [x] Task 2: Create EnrichmentIndexRecord dataclass (AC: 4)
  - [x] 2.1 Add `EnrichmentIndexRecord` to `types.py`
  - [x] 2.2 Define `LookupType` enum (plan_code, account_name, account_number, customer_name, plan_customer)
  - [x] 2.3 Define `SourceType` enum (yaml, eqc_api, manual, backflow, domain_learning, legacy_migration)
  - [x] 2.4 Reuse the existing company name normalizer for lookup_key creation; document `{plan_code}|{normalized_name}` for plan_customer

- [x] Task 3: Extend CompanyMappingRepository (AC: 4)
  - [x] 3.1 Implement `lookup_enrichment_index()` method
  - [x] 3.2 Implement `lookup_enrichment_index_batch()` method with batch query optimization
  - [x] 3.3 Implement `insert_enrichment_index_batch()` with ON CONFLICT DO UPDATE (GREATEST confidence, increment hit_count, touch timestamps)
  - [x] 3.4 Implement `update_hit_count()` method (increments + last_hit_at/updated_at)
  - [x] 3.5 Ensure methods integrate with DB-P1..P5 flow in CompanyIdResolver (no duplication with company_name_index/company_mapping)

- [x] Task 4: Write unit tests (AC: 6)
  - [x] 4.1 Test `lookup_enrichment_index()` - found and not found cases
  - [x] 4.2 Test `lookup_enrichment_index_batch()` - multiple types, partial matches
  - [x] 4.3 Test `insert_enrichment_index_batch()` - insert and conflict update (confidence GREATEST, hit_count increment, timestamps)
  - [x] 4.4 Test `update_hit_count()` - increment and timestamp update
  - [x] 4.5 Regression: existing `company_name_index`/`company_mapping` code paths remain unaffected; coverage >90%

- [x] Task 5: Integration test (AC: 5)
  - [x] 5.1 Test migration up/down cycle
  - [x] 5.2 Verify table structure matches spec

## Dev Notes

### Architecture Compliance

**CRITICAL: Follow existing patterns from Epic 6 implementation**

1. **Migration Location**: `io/schema/migrations/versions/` - NOT in src folder
2. **Schema**: Use `enterprise` schema (already exists from Story 6.3)
3. **Repository Pattern**: Extend existing `CompanyMappingRepository` class
4. **Idempotency**: All migrations MUST use IF NOT EXISTS patterns (see `20251206_000001_create_enterprise_schema.py`)
5. **Guarded Creation**: Use `_table_exists` / `_index_exists` helpers (same pattern as `20251206_000001_create_enterprise_schema.py`) plus `CREATE ... IF NOT EXISTS` for partial indexes; reruns must be no-op and downgrade safe

### Database Schema Reference

```sql
-- New table: enterprise.enrichment_index
CREATE TABLE enterprise.enrichment_index (
    id SERIAL PRIMARY KEY,

    -- Lookup keys
    lookup_key VARCHAR(255) NOT NULL,
    lookup_type VARCHAR(20) NOT NULL,  -- plan_code, account_name, account_number, customer_name, plan_customer

    -- Mapping result
    company_id VARCHAR(100) NOT NULL,  -- align with enterprise.company_master

    -- Metadata
    confidence DECIMAL(3,2) DEFAULT 1.00,
    source VARCHAR(50) NOT NULL,       -- yaml, eqc_api, manual, backflow, domain_learning, legacy_migration
    source_domain VARCHAR(50),         -- Learning source domain
    source_table VARCHAR(100),         -- Learning source table

    -- Statistics
    hit_count INT DEFAULT 0,
    last_hit_at TIMESTAMP,

    -- Audit
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    UNIQUE (lookup_key, lookup_type)
);

-- Indexes
CREATE INDEX ix_enrichment_index_type_key ON enterprise.enrichment_index(lookup_type, lookup_key);
CREATE INDEX ix_enrichment_index_source ON enterprise.enrichment_index(source);
CREATE INDEX ix_enrichment_index_source_domain ON enterprise.enrichment_index(source_domain);
```

### lookup_type Values

| lookup_type | Description | lookup_key Format |
|-------------|-------------|-------------------|
| `plan_code` | Plan code (DB-P1) | Raw value |
| `account_name` | Annuity account name (DB-P2) | Raw value |
| `account_number` | Annuity account number (DB-P3) | Raw value |
| `customer_name` | Customer name (DB-P4) | **Normalized** value (reuse existing normalizer) |
| `plan_customer` | Plan + Customer combo (DB-P5) | `{plan_code}\|{normalized_name}` (normalized with same normalizer) |

### source Values

| source | Description | Default Confidence |
|--------|-------------|-------------------|
| `yaml` | Synced from YAML config | 1.00 |
| `eqc_api` | EQC API query result | 1.00 |
| `manual` | Manually added | 1.00 |
| `backflow` | Layer 3 Backflow | 1.00 |
| `domain_learning` | Domain data learning | 0.85-0.95 |
| `legacy_migration` | Legacy data migration | 0.90-1.00 |

### Code Location Reference

| Component | Path |
|-----------|------|
| Types | `src/work_data_hub/infrastructure/enrichment/types.py` |
| Repository | `src/work_data_hub/infrastructure/enrichment/mapping_repository.py` |
| Migrations | `io/schema/migrations/versions/` |
| Tests | `tests/unit/infrastructure/enrichment/` |
| Normalizer | `src/work_data_hub/infrastructure/enrichment/normalizer.py` |

### Existing Repository Methods (DO NOT MODIFY)

The `CompanyMappingRepository` already has these methods for `company_name_index` table:
- `insert_company_name_index_batch()` - for company_name_index
- `lookup_batch()` - for company_name_index
- `insert_batch()` - for company_mapping
- `enqueue_for_enrichment()` - for enrichment_requests

**ADD NEW METHODS** for `enrichment_index` table, do not modify existing methods.

### Conflict and Update Semantics

- `insert_enrichment_index_batch`: ON CONFLICT (lookup_key, lookup_type) DO UPDATE SET `confidence = GREATEST(existing, excluded)`, `hit_count = existing.hit_count + 1`, `last_hit_at = NOW()`, `updated_at = NOW()`, keep `source`/`source_domain`/`source_table` from the higher-confidence or existing row per business rule (default: prefer existing unless new confidence is higher).
- `update_hit_count`: increments `hit_count`, touches `last_hit_at` and `updated_at`.

### Normalization Rules

- Reuse the existing company name normalizer (same as CompanyIdResolver) for `customer_name` and the customer portion of `plan_customer`.
- `plan_customer` key format: `{plan_code}|{normalized_customer_name}`.
- Keep lookup_key casing/whitespace handling identical to Layer 1 (YAML) rules; no bespoke normalization beyond the shared normalizer.

### Constraints and Checks

- `company_id` VARCHAR(100) to align with `enterprise.company_master`.
- Add CHECK constraints for `lookup_type` and `source` enums; enforce `confidence` between 0.00 and 1.00.
- Consider optional FK: `company_id` → `enterprise.company_master.company_id` (nullable if this blocks migration speed; document decision in migration comments).

### Project Structure Notes

- Alignment with unified project structure (paths, modules, naming)
- Migration file naming: `YYYYMMDD_NNNNNN_description.py`
- Test file naming: `test_<module>_<feature>.py`

### Testing Standards

- Use pytest fixtures for database connections
- Mock database for unit tests
- Use real database for integration tests
- Target >90% coverage for new code; include conflict update path, normalization path, hit_count path; validate that existing `company_name_index`/`company_mapping` behaviors are unchanged (regression guard)

### Integration Notes (DB-P1..P5)

- Repository methods feed Layer 2 DB-P1..P5 flow in `CompanyIdResolver`: plan_code, account_name, account_number, customer_name (normalized), plan_customer (plan_code + normalized).
- Avoid duplication/conflict with `company_name_index` (legacy cache) and `company_mapping`; enrichment_index becomes the Layer 2 cache for multi-priority lookups while existing tables remain for compatibility until migration completes.
- Provide clear handoff outputs for Story 6.1.2 (multi-priority lookup) and 6.1.3/6.1.4 (learning/migration) so they can rely on schema, constraints, and repository contract defined here.

### References

- [Source: docs/specific/company-enrichment-service/layer2-enrichment-index-enhancement.md#3.1]
- [Source: docs/guides/company-enrichment-service.md#5.1]
- [Source: docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-08-layer2-enrichment-enhancement.md#4.2]
- [Source: io/schema/migrations/versions/20251206_000001_create_enterprise_schema.py] - Reference for migration patterns

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

### Completion Notes List

- Story created from Sprint Change Proposal: Layer 2 Enrichment Index Enhancement
- This is the first story in Epic 6.1, prerequisite for Stories 6.1.2, 6.1.3, 6.1.4
- Backward compatible: Does not modify existing `company_name_index` or `company_mapping` tables
- ✅ Implementation completed 2025-12-08
- ✅ All 5 tasks completed with 30 new unit tests (all passing)
- ✅ 207 total enrichment module tests pass (no regressions)
- ✅ Migration follows idempotent patterns from Story 6.3
- ✅ Repository methods use UNNEST for batch efficiency
- ✅ ON CONFLICT DO UPDATE implements GREATEST confidence semantics

### File List

**Files Created:**
- `io/schema/migrations/versions/20251208_000001_create_enrichment_index.py`
- `tests/unit/infrastructure/enrichment/test_mapping_repository_enrichment_index.py`
- `tests/integration/migrations/test_enrichment_index_migration.py`

**Files Modified:**
- `src/work_data_hub/infrastructure/enrichment/types.py` (added EnrichmentIndexRecord, LookupType, SourceType)
- `src/work_data_hub/infrastructure/enrichment/mapping_repository.py` (added 4 new methods)

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2025-12-08 | Story implementation completed - all tasks done | Claude Opus 4.5 |
