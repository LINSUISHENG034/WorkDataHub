# Story 6.2-P3: Orchestration Layer Architecture Unification

**Epic:** 6.2 - Generic Reference Data Management
**Type:** Patch Story
**Priority:** High (blocks real-data validation)
**Status:** Done

## Story

As a **data engineer**,
I want **the orchestration layer to use the Epic 3 file discovery architecture (FileDiscoveryService) for Epic 3 schema domains instead of the legacy DataSourceConnector**,
so that **the workflow can reliably discover and process real data files using the unified configuration schema without regressions**.

## Scope

### In Scope

- Orchestration-layer discovery must support **Epic 3 schema** domains in `config/data_sources.yml`.
- CLI must support a period parameter that resolves `{YYYYMM}` template variables.
- Orchestration must support running **both** `annuity_performance` and `annuity_income` successfully (at least as two separate runs).
- Keep legacy discovery working for existing tests/integrations that rely on `DataSourceConnector` + legacy schema.

### Out of Scope (Non-goals)

- Redesigning the Epic 3 file discovery internals (VersionScanner/FilePatternMatcher/ExcelReader).
- Changing how the domain layer processes rows (domain services remain unchanged).
- Implementing a “single command multi-domain run” CLI; sequential per-domain execution is sufficient for this story.

## Critical Constraints / Assumptions

1. **File patterns must match exactly 1 file** after excludes. The Epic 3 `FilePatternMatcher` raises `DiscoveryError` on ambiguous matches.
2. **Do not read Excel twice.** Orchestration should not trigger an Excel load during discovery if a downstream op will read the file again.
3. **Template variable name is `month` (or `YYYYMM`).** `_resolve_template_vars()` reads `template_vars["month"]` or `template_vars["YYYYMM"]`.
4. **Real-data fixture note:** `tests/fixtures/real_data/202510/收集数据/数据采集/V2/` contains **two** candidate files (`...1110.xlsx`, `...1111.xlsx`). The current pattern `*规模收入数据*.xlsx` will match both unless refined.

## Acceptance Criteria

1. **AC1: Dual-schema discovery (no regressions)**
   - Given orchestration discovery runs for a configured domain
   - When the domain config uses **legacy schema** (`pattern`, `select`)
   - Then `discover_files_op` must continue to use `DataSourceConnector.discover()` and behave as before
   - And existing tests/integrations remain compatible

2. **AC2: Epic 3 schema discovery uses FileDiscoveryService (discovery-only)**
   - Given the domain config uses **Epic 3 schema** (`base_path`, `file_patterns`, `version_strategy`, `sheet_name`, `output`)
   - When `discover_files_op` runs for that domain
   - Then it must use `FileDiscoveryService` to perform **template resolution + version detection + file matching**
   - And it must return `List[str]` (JSON-serializable file paths) for backward compatibility
   - And it must **not** load Excel data during discovery

3. **AC3: CLI supports `--period` and resolves `{YYYYMM}`**
   - Given a domain’s `base_path` contains `{YYYYMM}`
   - When the CLI is invoked with `--period 202510`
   - Then discovery resolves `{YYYYMM}` to `202510` and searches the correct directory
   - And if `--period` is missing, CLI fails fast with an actionable error

4. **AC4: Sheet selection comes from configuration by default**
   - Given `config/data_sources.yml` defines `sheet_name` for each Epic 3 domain
   - When the pipeline runs without explicit `--sheet`
   - Then `read_excel_op` uses the configured `sheet_name` for that domain (`规模明细` for `annuity_performance`, `收入明细` for `annuity_income`)
   - And `--sheet` remains as an override for advanced/debug usage

5. **AC5: `annuity_income` is supported by orchestration CLI**
   - Given both `annuity_performance` and `annuity_income` are configured
   - When executing `--domain annuity_performance --period 202510 --plan-only`
   - And executing `--domain annuity_income --period 202510 --plan-only`
   - Then both runs succeed and process the correct sheet for each domain

6. **AC6: Ambiguous file matches fail loudly and actionably**
   - Given file discovery finds multiple candidate files after filtering
   - When discovery runs
   - Then it must raise `DiscoveryError` (stage `file_matching`) with an error message listing candidates and patterns used
   - And logs must use `str(e)` or `e.to_dict()` (no `.message` attribute usage)

7. **AC7: Legacy connector deprecation is explicit and safe**
   - Given Epic 3 schema discovery is in use for Epic 3 domains
   - When developers review the codebase
   - Then `DataSourceConnector` is clearly marked deprecated **for Epic 3 schema domains**
   - And it remains available for backward compatibility where legacy schema is still used

## Tasks / Subtasks

- [x] Task 1: Add a discovery-only API to FileDiscoveryService (supports AC2/AC6)
  - [x] 1.1 Add a small result type (e.g., `DiscoveryMatch`) containing: `file_path`, `version`, `sheet_name`, `resolved_base_path`
  - [x] 1.2 Add `FileDiscoveryService.discover_file(domain, version_override=None, **template_vars)` that performs:
        template resolution → version detection → file matching
  - [x] 1.3 Ensure `discover_file` does **not** call ExcelReader
  - [x] 1.4 Reuse existing structured logging and wrap failures as `DiscoveryError` with correct `failed_stage`

- [x] Task 2: Update `discover_files_op` to route by schema (supports AC1/AC2/AC6)
  - [x] 2.1 Extend `DiscoverFilesConfig` with `period: Optional[str] = None`
  - [x] 2.2 Detect config schema per-domain (Epic 3 schema vs legacy schema) based on keys present
  - [x] 2.3 For Epic 3 schema domains: call `FileDiscoveryService.discover_file(domain=..., month=config.period)` and return `[str(file_path)]`
  - [x] 2.4 For legacy schema domains: keep `DataSourceConnector.discover()` and return `[file.path for file in discovered]`
  - [x] 2.5 Ensure error logging uses `str(e)` or `e.to_dict()`; do not reference `.message`

- [x] Task 3: Add CLI `--period` and propagate to run_config (supports AC3)
  - [x] 3.1 Add `--period` to `argparse` in `jobs.py:main()` (string, `YYYYMM`)
  - [x] 3.2 Pass `period` into `discover_files_op` config via `build_run_config()`
  - [x] 3.3 Validate `--period` format (`YYYYMM`) and fail fast when required by `{YYYYMM}` base_path

- [x] Task 4: Sheet selection defaults to `data_sources.yml` for Epic 3 domains (supports AC4)
  - [x] 4.1 Change `--sheet` default to `None` (so "not provided" is detectable)
  - [x] 4.2 In `build_run_config()`, if `--sheet` is `None` and domain is Epic 3 schema:
        read `sheet_name` from `config/data_sources.yml` and pass it to `read_excel_op`
  - [x] 4.3 Keep existing behavior for legacy domains / sample jobs (default sheet 0)

- [x] Task 5: Add orchestration support for `annuity_income` (supports AC5)
  - [x] 5.1 Add `annuity_income_job` (or route to an existing generic job) mirroring annuity_performance flow
  - [x] 5.2 Add `process_annuity_income_op` in `ops.py` calling `domain.annuity_income.service.process_annuity_income(...)` (plan-only safe)
  - [x] 5.3 Update CLI domain dispatch to include `annuity_income`

- [x] Task 6: Deprecate DataSourceConnector safely (supports AC7)
  - [x] 6.1 Add a deprecation notice in `DataSourceConnector` docstring indicating it targets legacy schema only
  - [x] 6.2 Add a runtime `DeprecationWarning` (or structured log) when initialized against Epic 3 schema config
  - [x] 6.3 Add a short migration note pointing to `FileDiscoveryService`

## Dev Notes

### Architecture Context (Why this story exists)

The orchestration layer currently relies on `DataSourceConnector`, which expects a legacy schema (`pattern`, `select`) and cannot consume the Epic 3 schema used by `config/data_sources.yml`. Epic 3 already provides `FileDiscoveryService` which is the correct I/O-layer abstraction for version-aware discovery.

### Key Design Decisions (Disaster Prevention)

1. **Keep discovery output stable:** `discover_files_op` continues to return `List[str]` for Dagster config compatibility.
2. **Avoid double-read:** discovery must not load Excel if `read_excel_op` will load it later.
3. **Dual-schema routing:** maintain legacy behavior for existing tests/integrations while enabling Epic 3 schema domains.

### Implementation Notes (Gotchas)

- `FileDiscoveryService._resolve_template_vars()` expects `month` or `YYYYMM` (not `period`).
- `FilePatternMatcher` intentionally fails when multiple files match; update patterns/excludes so exactly one file remains.
- `DiscoveryError` does not expose `.message`; use `str(e)` or `e.to_dict()` for logging.

### Key Files to Modify

| File | Change |
|------|--------|
| `src/work_data_hub/orchestration/ops.py` | Route discovery by schema; add `period`; add annuity_income op |
| `src/work_data_hub/orchestration/jobs.py` | Add `--period`; support annuity_income; default `sheet_name` from config |
| `src/work_data_hub/io/connectors/file_connector.py` | Add `discover_file` discovery-only API; deprecate DataSourceConnector (legacy) |
| `config/data_sources.yml` | Ensure patterns resolve to exactly 1 file per period/version (may require refinement) |
| `tests/orchestration/test_ops.py` | Add unit tests for Epic 3 schema routing, period validation, and annuity_income op |

**Note on `annuity_income` backfill:** The `annuity_income_job` does NOT use `generic_backfill_refs_op` because this domain does not require reference data backfill (unlike `annuity_performance` which needs plan/portfolio refs). This is intentional - the job loads directly to DB without backfill step.

## Testing / Validation

### Unit Tests (Must)

1. `discover_files_op`:
   - Legacy schema domain routes to `DataSourceConnector`
   - Epic 3 schema domain routes to `FileDiscoveryService.discover_file`
   - Missing/invalid `--period` fails fast when `{YYYYMM}` is present
   - Logging uses `DiscoveryError.to_dict()` / `str(e)`

2. CLI:
   - `--period` is parsed and propagated into run_config
   - `--sheet` default `None` triggers config-based sheet selection for Epic 3 domains

### Integration Validation (Must, plan-only)

- `uv run --env-file .wdh_env python -m work_data_hub.orchestration.jobs --domain annuity_performance --period 202510 --plan-only --mode append`
- `uv run --env-file .wdh_env python -m work_data_hub.orchestration.jobs --domain annuity_income --period 202510 --plan-only --mode append`

Notes:
- Use `--mode append` for plan-only validation unless/ until PK configuration is explicitly defined for delete_insert in orchestration config.
- If discovery fails with “Ambiguous match”, refine `file_patterns` / `exclude_patterns` so only one file remains.

## Definition of Done

- [x] AC1–AC7 all satisfied
- [x] Unit tests updated/added for dual-schema routing and period propagation
- [x] Integration plan-only runs succeed for both annuity domains
- [x] No regressions in orchestration tests (sample jobs remain compatible)

## References

- `docs/sprint-artifacts/sprint-change-proposal/sprint-change-proposal-2025-12-13-real-data-validation.md`
- `docs/epics/epic-3-intelligent-file-discovery-version-detection.md`
- `docs/architecture-boundaries.md`
- `src/work_data_hub/io/connectors/file_connector.py` (FileDiscoveryService)
- `src/work_data_hub/io/connectors/file_pattern_matcher.py` (ambiguous match behavior)

## Senior Developer Review (AI)

**Date:** 2025-12-14
**Outcome:** Approved (after fixes)

### What Was Fixed (High/Medium)

- Fixed broken test patch targets so unit tests actually validate orchestration behavior.
- Restored runtime compatibility by:
  - Making `DataSourceConnector` safe to import and explicitly legacy-only.
  - Adding `sample_trustee_performance` to `config/data_sources.yml` so schedules/sensors/CLI defaults are valid.
  - Updating schedules/sensors table resolution to use Epic 3 `output.schema_name` + `output.table`.
- Fixed `build_run_config()` to read Epic 3 `output` and to be resilient when config load fails.
- Fixed `.wdh_env` to reference the real config path so plan-only integration commands work.
- Fixed generic backfill config parsing and optional-column handling so annuity plan-only runs succeed:
  - `ForeignKeyConfig` now accepts `target_schema` and `skip_blank_values`.
  - Generic candidate derivation no longer crashes on missing optional columns.
- Fixed quoting for schema-qualified table names (e.g., `business.收入明细`) so SQL plans use `"business"."收入明细"`.

### Validation Performed

- Unit tests: `PYTHONPATH=src uv run pytest tests/orchestration/test_ops.py`
- Plan-only runs:
  - `uv run --env-file .wdh_env python -m work_data_hub.orchestration.jobs --domain annuity_performance --period 202510 --plan-only --mode append`
  - `uv run --env-file .wdh_env python -m work_data_hub.orchestration.jobs --domain annuity_income --period 202510 --plan-only --mode append`

### Known Notes

- The test suite prints noisy SQLAlchemy cleanup warnings (`sqlite3.ProgrammingError: Cannot operate on a closed database.`) but the tests still pass; this looks like a fixture/connection lifecycle issue outside this story’s scope.

## Dev Agent Record

### File List

- `config/data_sources.yml`
- `.wdh_env`
- `docs/sprint-artifacts/sprint-status.yaml`
- `src/work_data_hub/config/settings.py`
- `src/work_data_hub/domain/reference_backfill/generic_service.py`
- `src/work_data_hub/domain/reference_backfill/models.py`
- `src/work_data_hub/infrastructure/settings/data_source_schema.py`
- `src/work_data_hub/io/connectors/file_connector.py`
- `src/work_data_hub/io/loader/warehouse_loader.py`
- `src/work_data_hub/orchestration/jobs.py`
- `src/work_data_hub/orchestration/ops.py`
- `src/work_data_hub/orchestration/schedules.py`
- `src/work_data_hub/orchestration/sensors.py`
- `tests/orchestration/test_ops.py`

### Change Log

- 2025-12-14: Fixed orchestration dual-schema discovery, config pathing, schema-qualified quoting, and backfill parsing; validated with unit tests + plan-only runs for both annuity domains.
