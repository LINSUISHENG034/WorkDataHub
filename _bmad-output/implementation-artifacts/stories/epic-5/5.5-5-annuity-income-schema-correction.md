# Story 5.5.5: AnnuityIncome Schema Correction

Status: In Progress

## Quickstart (必读)

- **前置**: Story 5.5-4 代码审查完成；发现 annuity_income 域 schema 与真实数据不匹配
- **核心任务**: 修复 annuity_income 域的列定义，将错误的 `收入金额` 替换为正确的 `固费/浮费/回补/税`，并添加列别名支持
- **成功门槛**: 使用真实生产数据运行 annuity_income pipeline 成功；parity 验证通过；所有测试通过
- **产物**: 修复后的 schemas.py, models.py, pipeline_builder.py, constants.py；更新的测试文件
- **命令**: `uv run python scripts/tools/validate/validate_data_source_columns.py --domain annuity_income` (验证列匹配)
- **环境 & 版本**: Python 3.12；pandas 2.3.2；pandera 0.26.1；pydantic 2.11.7
- **数据上下文**: 真实数据位于 `tests/fixtures/real_data/`，收入明细 sheet 包含 `固费/浮费/回补/税` 而非 `收入金额`
- **上下文加载**: 执行前加载 `docs/sprint-artifacts/issues/issue-annuity-income-column-mismatch.md`、`docs/cleansing-rules/annuity-income.md`
- **架构护栏**: 保持 6-file 结构，复用 Infrastructure Layer 组件

## Story

As a **developer maintaining the annuity_income domain**,
I want **to correct the schema definitions to match actual production data columns**,
so that **the pipeline can process real data without errors and achieve parity with the legacy system**.

## Background

During Story 5.5.4 code review, a critical schema mismatch was discovered:

| Issue | Expected (Code) | Actual (Real Data) |
|-------|-----------------|-------------------|
| Income fields | `收入金额` (single field) | `固费`, `浮费`, `回补`, `税` (four fields) |
| Plan code column | `计划号` (fixed) | `计划号` OR `计划代码` (varies by version) |
| Institution column | `机构代码` (fixed) | `机构` OR `机构代码` (varies by version) |

**Root Cause:** Documentation error in Story 5.5.1 that propagated through implementation.

**Reference:** `docs/sprint-artifacts/issues/issue-annuity-income-column-mismatch.md`

## Workflow References

- Issue Document: `docs/sprint-artifacts/issues/issue-annuity-income-column-mismatch.md`
- Cleansing Rules: `docs/cleansing-rules/annuity-income.md` (partially corrected)
- Validation Script: `scripts/tools/validate/validate_data_source_columns.py`
- Previous Story: `docs/sprint-artifacts/stories/5.5-4-multi-domain-integration-test-and-optimization.md`

## Acceptance Criteria

### Phase A: Schema Correction

- [x] AC1: `schemas.py` updated - replace `收入金额` with `固费`, `浮费`, `回补`, `税` in:
  - BRONZE_REQUIRED_COLUMNS
  - BRONZE_NUMERIC_COLUMNS
  - GOLD_REQUIRED_COLUMNS
  - GOLD_NUMERIC_COLUMNS
  - BronzeAnnuityIncomeSchema
  - GoldAnnuityIncomeSchema

- [x] AC2: `models.py` updated - replace `收入金额` field with four income fields in:
  - AnnuityIncomeIn (bronze input model)
  - AnnuityIncomeOut (gold output model)

- [x] AC3: `constants.py` updated - add COLUMN_ALIAS_MAPPING for:
  - `计划代码` → `计划号` (normalize to legacy name)
  - `机构` → `机构代码` (already exists, verify)

- [x] AC4: `pipeline_builder.py` updated:
  - Add MappingStep at pipeline start for column aliases
  - Update CompanyIdResolutionStep to use normalized column name

### Phase B: Test Updates

- [x] AC5: All unit tests in `tests/unit/domain/annuity_income/` updated with correct columns
- [x] AC6: `tests/fixtures/test_data_factory.py` updated - remove artificial `收入金额` creation
- [x] AC7: Integration tests pass with real production data

### Phase C: Validation

- [x] AC8: Data source validation script passes: `uv run python scripts/tools/validate/validate_data_source_columns.py --domain annuity_income`
- [x] AC9: Parity validation with real data achieves 100% match (excluding intentional company_id differences)
- [x] AC10: Performance baseline updated with correct schema processing

## Tasks / Subtasks

### Task 1: Update Schema Definitions (AC: 1)

- [x] 1.1: Update BRONZE_REQUIRED_COLUMNS to include `固费`, `浮费`, `回补`, `税`
- [x] 1.2: Update BRONZE_NUMERIC_COLUMNS to include all four income fields
- [x] 1.3: Update GOLD_REQUIRED_COLUMNS (decision: keep all four separate fields)
- [x] 1.4: Update BronzeAnnuityIncomeSchema with four income columns
- [x] 1.5: Update GoldAnnuityIncomeSchema with four income columns
- [x] 1.6: Run schema validation tests

### Task 2: Update Pydantic Models (AC: 2)

- [x] 2.1: Update AnnuityIncomeIn with `固费`, `浮费`, `回补`, `税` fields (Optional[Decimal])
- [x] 2.2: Update AnnuityIncomeOut with four income fields
- [x] 2.3: Add field validators for numeric cleaning on all four fields
- [x] 2.4: Update model docstrings

### Task 3: Add Column Alias Support (AC: 3, 4)

- [x] 3.1: Add COLUMN_ALIAS_MAPPING to constants.py:
  ```python
  COLUMN_ALIAS_MAPPING: Dict[str, str] = {
      "计划代码": "计划号",  # 202412+ uses 计划代码
      "机构": "机构代码",    # 202411- uses 机构
  }
  ```
- [x] 3.2: Update pipeline_builder.py to apply aliases at pipeline start
- [x] 3.3: Update CompanyIdResolutionStep to use `计划号` (normalized name)
- [x] 3.4: Test with both 202411 (计划号) and 202412 (计划代码) data files

### Task 4: Update Unit Tests (AC: 5, 6)

- [x] 4.1: Update `tests/unit/domain/annuity_income/test_models.py`
- [x] 4.2: Update `tests/unit/domain/annuity_income/test_schemas.py` (created new test file)
- [x] 4.3: Update `tests/unit/domain/annuity_income/test_pipeline_builder.py`
- [x] 4.4: Update `tests/unit/domain/annuity_income/test_service.py` (enabled `validate_gold_dataframe` check)
- [x] 4.5: Run full unit test suite (59 tests passed)

### Task 5: Integration Testing with Real Data (AC: 7, 8, 9)

- [x] 5.1: Run data source validation script (8 files validated, all passed)
- [x] 5.2: Run annuity_income pipeline with 202411 V1 data (计划号 format)
- [x] 5.3: Run annuity_income pipeline with 202412 V2 data (计划代码 format)
- [x] 5.4: Run parity validation against legacy system
- [x] 5.5: Document any remaining differences (none - schema now matches real data)

### Task 6: Update Performance Baseline (AC: 10)

- [x] 6.1: Re-run performance baseline with corrected schema
- [x] 6.2: Update `tests/fixtures/performance_baseline.json` (deferred - no regression)
- [x] 6.3: Verify no performance regression

## Dev Notes

### Column Mapping Decision

**Option A: Normalize to Legacy Names**
- Map `计划代码` → `计划号` at pipeline start
- Pros: Minimal code changes, matches legacy cleaner behavior
- Cons: Internal column names don't match newer data sources

**Option B: Normalize to New Names**
- Map `计划号` → `计划代码` at pipeline start
- Pros: Forward-compatible with newer data sources
- Cons: More code changes, diverges from legacy

**Recommendation:** Option A (normalize to legacy names) for consistency with existing implementation and legacy parity.

**Update 2025-12-06 (Intentional divergence note):**
- Pipeline now **keeps both columns** (`计划号`, `计划代码`), normalizes both to uppercase, and copies whichever exists into both for downstream parity checks.
- Upsert keys remain `计划号`, but `计划代码` is retained to align with `annuity_performance` outputs and avoid accidental drop when sources vary by version.
- This dual-column behavior is deliberate (not a bug) to bridge legacy naming vs. cross-domain comparison.

### Income Fields Decision

**Option A: Keep Four Separate Fields**
- Store `固费`, `浮费`, `回补`, `税` as separate columns
- Pros: Matches source data exactly, enables detailed analysis
- Cons: More columns to manage

**Option B: Aggregate to Single Field**
- Calculate `收入金额 = 固费 + 浮费 + 回补 - 税` in pipeline
- Pros: Simpler output schema
- Cons: Loses granularity, may not match legacy behavior

**Recommendation:** Option A (keep separate) to match legacy system output and enable detailed reporting.

### Company ID Fallback (Reminder)

- Legacy `ID5` fallback is intentionally **not** implemented for annuity_income (per Epic 5.5 decisions).
- Unresolved companies receive stable temp IDs (`IN_` prefix) and are exported to unknown-names CSV for review.

### Real Data Files for Testing

| Period | File | Plan Code Column | Institution Column |
|--------|------|------------------|-------------------|
| 202311 | `tests/fixtures/real_data/202311/数据采集/V1/【for年金分战区经营分析】24年11月年金终稿数据1209采集.xlsx` | `计划号` | `机构` |
| 202411 | `tests/fixtures/real_data/202411/收集数据/数据采集/V1/【for年金分战区经营分析】24年11月年金终稿数据1209采集.xlsx` | `计划号` | `机构` |
| 202412 | `tests/fixtures/real_data/202412/收集数据/数据采集/V2/【for年金分战区经营分析】24年12月年金终稿数据0109采集-补充企年投资收入.xlsx` | `计划代码` | `机构代码` |

### Architecture Guardrails

- Maintain 6-file domain structure
- Reuse CompanyIdResolver from Infrastructure Layer
- Reuse CleansingRegistry for field normalization
- Follow existing patterns from annuity_performance domain

### Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Breaking existing tests | Update tests incrementally, run after each change |
| Parity regression | Run parity validation before marking complete |
| Performance regression | Compare baseline before/after |
| Column alias edge cases | Test with multiple data source versions |

## File List

**Files to Modify:**
- `src/work_data_hub/domain/annuity_income/constants.py`
- `src/work_data_hub/domain/annuity_income/models.py`
- `src/work_data_hub/domain/annuity_income/schemas.py`
- `src/work_data_hub/domain/annuity_income/service.py`
- `src/work_data_hub/domain/annuity_income/pipeline_builder.py`
- `tests/fixtures/test_data_factory.py`
- `tests/fixtures/performance_baseline.json`
- `tests/unit/domain/annuity_income/test_models.py`
- `tests/unit/domain/annuity_income/test_pipeline.py`
- `tests/unit/domain/annuity_income/test_service.py`
- `tests/unit/domain/annuity_income/test_schemas.py`
- `tests/integration/test_multi_domain_pipeline.py`
- `docs/sprint-artifacts/sprint-status.yaml`

## References

- [Issue Document](../issues/issue-annuity-income-column-mismatch.md)
- [Cleansing Rules](../../cleansing-rules/annuity-income.md)
- [Validation Script](../../../scripts/tools/validate/validate_data_source_columns.py)
- [Legacy Cleaner](../../../legacy/annuity_hub/data_handler/data_cleaner.py) (lines 237-274)
- [Story 5.5.4](./5.5-4-multi-domain-integration-test-and-optimization.md)

## Change Log

| Date | Change |
|------|--------|
| 2025-12-06 | Story created based on Code Review findings from Story 5.5.4 |
| 2025-12-06 | **COMPLETED**: All tasks implemented - schemas.py, models.py, constants.py updated; 59 unit tests pass; 8 real data files validated; parity run with real data (see `tests/fixtures/validation_results/annuity_income/annuity_income_parity_20251205_133109.json`) showing 100% match except intentional company_id fallback difference |
