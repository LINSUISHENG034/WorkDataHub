# WorkDataHub Data Source Configuration
# Epic 3: Intelligent File Discovery & Version Detection
# Schema Version: 1.1
#
# Story 6.2-P14: Config File Modularization (2025-12-19)
# This file now contains ONLY domain file discovery patterns.
# FK backfill rules: config/foreign_keys.yml
# Reference sync: config/reference_sync.yml
#
# Story 6.2-P14 AC-4: Defaults/Overrides Mechanism (2025-12-20)
# Uses: defaults + per-domain overrides pattern (similar to Ansible defaults)
#
# Inheritance Rules:
# - Scalars: domain value wins over default
# - Lists: replace by default. Use "+" prefix to extend (e.g., "+*pattern*")
# - Dicts: deep merge (domain values override defaults)

# Schema version for backward compatibility
# Version 1.0: Initial schema with file discovery patterns
# Version 1.1: Added defaults section with inheritance support
schema_version: "1.1"

# ============================================================================
# DEFAULTS - Applied to all domains unless overridden
# ============================================================================
defaults:
  # Common exclusion patterns for all domains
  exclude_patterns:
    - "~$*"         # Excel temp files
    - "*.eml"       # Email files

  # Default version selection strategy
  version_strategy: "highest_number"
  fallback: "error"

  # Default output schema
  output:
    schema_name: "business"

# ============================================================================
# DOMAINS - Only specify what differs from defaults
# ============================================================================
domains:
  # Sandbox Trustee Performance Domain (dev/test)
  # Used by Dagster schedules/sensors and sandbox jobs.
  # Override: output.schema_name = sandbox (instead of business)
  sandbox_trustee_performance:
    # NOTE: No {YYYYMM} here to keep sensors/schedules period-free.
    base_path: "tests/fixtures/real_data/202411/收集数据/业务收集"

    # Trustee files live under nested folders (e.g., "每月业务收集-11月"), so use recursive glob.
    file_patterns:
      - "**/*受托业绩*.xlsx"

    # This sheet is primarily for sample job usage; override via CLI if needed.
    sheet_name: 0

    output:
      table: "sandbox_trustee_performance"
      schema_name: "sandbox"  # Override: sandbox instead of business

  # Annuity Performance Domain
  # ✅ VALIDATED with real 202411 data (Epic 3 Tech Spec Action Item #2)
  # Path structure: tests/fixtures/real_data/202411/收集数据/数据采集/V1/*.xlsx
  #
  # Story 6.2-P14: FK backfill rules moved to config/foreign_keys.yml
  annuity_performance:
    # Base path with template variable {YYYYMM} (e.g., 202501)
    base_path: "tests/fixtures/real_data/{YYYYMM}/收集数据/数据采集"

    # File patterns to match (glob syntax)
    file_patterns:
      - "*规模收入数据*.xlsx"

    # Extend default exclusions with domain-specific pattern
    exclude_patterns:
      - "+*回复*"    # Extend: add to default exclusions (+ prefix)

    # Excel sheet name to load
    sheet_name: "规模明细"

    # Output destination configuration
    output:
      table: "规模明细"
      # Refresh key for delete_insert mode (Legacy-compatible refresh scope)
      pk:
        - "月度"
        - "业务类型"
        - "计划类型"

  # Annuity Income Domain (Epic 5.5 - Pipeline Architecture Validation)
  # Story 5.5.2: Second domain to validate Infrastructure Layer architecture
  annuity_income:
    # Base path with template variable {YYYYMM}
    base_path: "tests/fixtures/real_data/{YYYYMM}/收集数据/数据采集"

    # File patterns to match (glob syntax)
    file_patterns:
      - "*规模收入数据*.xlsx"

    # Extend default exclusions
    exclude_patterns:
      - "+*回复*"    # Extend defaults

    # Excel sheet name to load (different from annuity_performance)
    sheet_name: "收入明细"

    # Output destination configuration
    output:
      table: "收入明细"
      # Primary key for delete_insert mode (matches GOLD_COMPOSITE_KEY in schemas.py)
      pk:
        - "月度"
        - "计划号"
        - "组合代码"
        - "company_id"

  # Future domains (Epic 9) can be added here:
  # Minimal config using defaults inheritance:
  #
  # universal_insurance:
  #   base_path: "reference/monthly/{YYYYMM}/收集数据/业务收集"
  #   file_patterns:
  #     - "*万能险*.xlsx"
  #   sheet_name: "明细数据"
  #   output:
  #     table: "universal_insurance"  # Only override what's needed

# =============================================================================
# Configuration Split Notice (Story 6.2-P14)
# =============================================================================
# The following configurations have been moved to dedicated files:
#
# 1. Foreign Key Backfill Rules:
#    - Moved to: config/foreign_keys.yml
#    - Contains: domains.*.foreign_keys sections
#    - Used by: load_foreign_keys_config() in config_loader.py
#
# 2. Reference Sync Configuration:
#    - Moved to: config/reference_sync.yml
#    - Contains: reference_sync section (schedule, tables, etc.)
#    - Used by: load_reference_sync_config() in sync_config_loader.py
# =============================================================================
