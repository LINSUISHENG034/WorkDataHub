# WorkDataHub Data Source Configuration
# Epic 3: Intelligent File Discovery & Version Detection
# Schema Version: 1.1
#
# Story 6.2-P14: Config File Modularization (2025-12-19)
# This file now contains ONLY domain file discovery patterns.
# FK backfill rules: config/foreign_keys.yml
# Reference sync: config/reference_sync.yml
#
# Story 6.2-P14 AC-4: Defaults/Overrides Mechanism (2025-12-20)
# Uses: defaults + per-domain overrides pattern (similar to Ansible defaults)
#
# Inheritance Rules:
# - Scalars: domain value wins over default
# - Lists: replace by default. Use "+" prefix to extend (e.g., "+*pattern*")
# - Dicts: deep merge (domain values override defaults)

# Schema version for backward compatibility
# Version 1.0: Initial schema with file discovery patterns
# Version 1.1: Added defaults section with inheritance support
# Version 1.2: Added requires_backfill field (Story 7.4-2)
schema_version: "1.2"

# ============================================================================
# DEFAULTS - Applied to all domains unless overridden
# ============================================================================
defaults:
  # Common exclusion patterns for all domains
  exclude_patterns:
    - "~$*"         # Excel temp files
    - "*.eml"       # Email files

  # Default version selection strategy
  version_strategy: "highest_number"
  fallback: "error"

  # Default output schema
  output:
    schema_name: "business"

  # Story 7.4-2: FK backfill enablement (defaults to true)
  # Domains can override to false if they don't require FK backfill
  requires_backfill: true

# ============================================================================
# DOMAINS - Only specify what differs from defaults
# ============================================================================
domains:
  # Sandbox Trustee Performance Domain (dev/test)
  # Used by Dagster schedules/sensors and sandbox jobs.
  # Override: output.schema_name = sandbox (instead of business)
  sandbox_trustee_performance:
    # NOTE: No {YYYYMM} here to keep sensors/schedules period-free.
    base_path: "data/real_data/202411/收集数据/业务收集"

    # Trustee files live under nested folders (e.g., "每月业务收集-11月"), so use recursive glob.
    file_patterns:
      - "**/*受托业绩*.xlsx"

    # This sheet is primarily for sample job usage; override via CLI if needed.
    sheet_name: 0

    output:
      table: "sandbox_trustee_performance"
      schema_name: "sandbox"  # Override: sandbox instead of business

  # Annuity Performance Domain
  # ✅ VALIDATED with real 202411 data (Epic 3 Tech Spec Action Item #2)
  # Path structure: tests/fixtures/real_data/202411/收集数据/数据采集/*.xlsx
  #
  # Story 6.2-P14: FK backfill rules moved to config/foreign_keys.yml
  annuity_performance:
    # Base path with template variable {YYYYMM} (e.g., 202501)
    base_path: "data/real_data/{YYYYMM}/收集数据/数据采集"

    # File patterns to match (glob syntax)
    file_patterns:
      - "*规模收入数据*.xlsx"

    # Extend default exclusions with domain-specific pattern
    exclude_patterns:
      - "+*回复*"    # Extend: add to default exclusions (+ prefix)

    # Excel sheet name to load
    sheet_name: "规模明细"

    # Output destination configuration
    output:
      table: "规模明细"
      # Refresh key for delete_insert mode (Legacy-compatible refresh scope)
      pk:
        - "月度"
        - "业务类型"
        - "计划类型"

  # Annuity Income Domain (Epic 5.5 - Pipeline Architecture Validation)
  # Story 5.5.2: Second domain to validate Infrastructure Layer architecture
  annuity_income:
    # Base path with template variable {YYYYMM}
    base_path: "data/real_data/{YYYYMM}/收集数据/数据采集"

    # File patterns to match (glob syntax)
    file_patterns:
      - "*规模收入数据*.xlsx"

    # Extend default exclusions
    exclude_patterns:
      - "+*回复*"    # Extend defaults

    # Excel sheet name to load (different from annuity_performance)
    sheet_name: "收入明细"

    # Output destination configuration
    output:
      table: "收入明细"
      # Refresh key for delete_insert mode (matches delete_scope_key in schema definitions)
      pk:
        - "月度"
        - "业务类型"
        - "计划类型"

  # Annual Award Domain (当年中标)
  # Story: Domain Migration - Merged TrusteeAwardCleaner + InvesteeAwardCleaner
  # Supports both 企年受托中标 and 企年投资中标 sheets
  annual_award:
    # Base path for manual data input (Epic 3 schema)
    # File structure: tests/fixtures/real_data/{YYYYMM}/收集数据/业务收集
    base_path: "data/real_data/{YYYYMM}/收集数据/业务收集"

    # File patterns for annual award data
    file_patterns:
      - "*台账登记*.xlsx"
      - "*当年中标*.xlsx"

    # Sheet names for trustee and investee awards (multi-sheet support)
    # read_excel_op will merge data from all listed sheets
    sheet_name: "企年受托中标(空白)"  # Fallback for single-sheet mode
    sheet_names:
      - "企年受托中标(空白)"
      - "企年投资中标(空白)"

    # Output destination configuration
    output:
      table: "中标客户明细"
      schema_name: "customer"
      pk:
        - "上报月份"
        - "业务类型"

    # Story 7.6-17: Enable FK backfill to 客户明细 table
    requires_backfill: true

  # Annual Loss Domain (流失客户明细)
  # Story: Domain Migration - Merged TrusteeLossCleaner + InvesteeLossCleaner
  # Supports both 企年受托流失 and 企年投资流失 sheets
  annual_loss:
    # Base path for manual data input
    base_path: "data/real_data/{YYYYMM}/收集数据/业务收集"

    # File patterns for annual loss data
    file_patterns:
      - "*台账登记*.xlsx"
      - "*当年流失*.xlsx"

    # Sheet names for trustee and investee loss (multi-sheet support)
    sheet_name: "企年受托流失(解约)"  # Fallback for single-sheet mode
    sheet_names:
      - "企年受托流失(解约)"
      - "企年投资流失(解约)"

    # Output destination configuration
    output:
      table: "流失客户明细"
      schema_name: "customer"
      pk:
        - "上报月份"
        - "业务类型"

    # Story 7.6-17: Enable FK backfill to 客户明细 table
    requires_backfill: true

  # Future domains (Epic 9) can be added here:
  # Minimal config using defaults inheritance:
  #
  # universal_insurance:
  #   base_path: "reference/monthly/{YYYYMM}/收集数据/业务收集"
  #   file_patterns:
  #     - "*万能险*.xlsx"
  #   sheet_name: "明细数据"
  #   output:
  #     table: "universal_insurance"  # Only override what's needed

# =============================================================================
# Configuration Split Notice (Story 6.2-P14)
# =============================================================================
# The following configurations have been moved to dedicated files:
#
# 1. Foreign Key Backfill Rules:
#    - Moved to: config/foreign_keys.yml
#    - Contains: domains.*.foreign_keys sections
#    - Used by: load_foreign_keys_config() in config_loader.py
#
# 2. Reference Sync Configuration:
#    - Moved to: config/reference_sync.yml
#    - Contains: reference_sync section (schedule, tables, etc.)
#    - Used by: load_reference_sync_config() in sync_config_loader.py
# =============================================================================
