# WorkDataHub Foreign Key Backfill Configuration
# Story 6.2-P14: Config File Modularization
# Story 6.2-P15: Complex Mapping Backfill Enhancement (added aggregation support)
# Story 6.2-P18: Advanced Aggregation Capabilities (template, count_distinct, lambda)
# Created: 2025-12-19
# Updated: 2026-01-03
#
# This file contains foreign key backfill configurations extracted from
# data_sources.yml to follow Single Responsibility Principle (SRP).
#
# Previously: config/data_sources.yml → domains.*.foreign_keys sections
# Schema Version: 1.2 (Story 6.2-P18 added advanced aggregations)
#
# Usage: Loaded by work_data_hub.domain.reference_backfill.config_loader
#
# Configuration Structure:
# - domains: Map of domain_name → foreign_keys config list
# - Each domain can have multiple FK rules with dependencies
# - mode: insert_missing (add records not in target)
# - depends_on: List of FK names to process first
# - skip_blank_values: Skip "(空白)" and empty values
#
# Aggregation Types:
#
# Story 6.2-P15 (Basic):
# - first: Default, takes first non-null value per group
# - max_by: Select value from row with maximum order_column value
#     Required: order_column (column to order by)
# - concat_distinct: Concatenate distinct values with separator
#     Optional: separator (default "+"), sort (default true)
#
# Story 6.2-P18 (Advanced):
# - template: Construct composite text from static template with placeholders
#     Required: template (string with {field} placeholders)
#     Optional: template_fields (list of field names, auto-extracted if omitted)
#     Example: template: "新建客户_{月度}"
# - count_distinct: Count unique non-null/non-blank values per group
#     No additional fields required
# - lambda: Execute custom Python lambda expression on each group
#     Required: code (Python lambda expression string)
#     Example: code: 'lambda g: g["月度"].iloc[0][:4]'
#     Note: Config files are developer-controlled (trusted source)

schema_version: "1.2"

domains:
  # Annuity Performance Domain
  # Validated with real 202411 data (Epic 3 Tech Spec)
  annuity_performance:
    foreign_keys:
      # 年金计划 (Annuity Plan) reference table backfill
      # Fixed 2025-12-13: Added target_schema: mapping (actual location in Legacy DB)
      # Story 6.2-P15: Added aggregation for 主拓代码, 主拓机构, 管理资格
      - name: "fk_plan"
        source_column: "计划代码"
        target_table: "年金计划"
        target_key: "年金计划号"
        target_schema: "mapping"
        mode: "insert_missing"
        backfill_columns:
          - source: "计划代码"
            target: "年金计划号"
          - source: "计划名称"
            target: "计划全称" # Fixed: actual column name
            optional: true
          - source: "计划类型"
            target: "计划类型"
            optional: true
          - source: "客户名称"
            target: "客户名称"
            optional: true
          # Story 6.2-P15: max_by aggregation for 主拓代码
          # Selects 机构代码 from record with maximum 期末资产规模
          - source: "机构代码"
            target: "主拓代码"
            optional: true
            aggregation:
              type: "max_by"
              order_column: "期末资产规模"
          # Story 6.2-P15: max_by aggregation for 主拓机构
          # Selects 机构名称 from record with maximum 期末资产规模
          - source: "机构名称"
            target: "主拓机构"
            optional: true
            aggregation:
              type: "max_by"
              order_column: "期末资产规模"
          # Story 6.2-P15: concat_distinct aggregation for 管理资格
          # Concatenates distinct 业务类型 values with "+" separator
          - source: "业务类型"
            target: "管理资格"
            optional: true
            aggregation:
              type: "concat_distinct"
              separator: "+"
              sort: true
          - source: "company_id"
            target: "company_id"
            optional: true

      # 组合计划 (Portfolio Plan) reference table backfill
      # Fixed 2025-12-13: Added target_schema: mapping
      - name: "fk_portfolio"
        source_column: "组合代码"
        target_table: "组合计划"
        target_key: "组合代码"
        target_schema: "mapping"
        mode: "insert_missing"
        depends_on: ["fk_plan"] # Portfolio depends on Plan
        backfill_columns:
          - source: "组合代码"
            target: "组合代码"
          - source: "计划代码"
            target: "年金计划号" # Foreign key to 年金计划
          - source: "组合名称"
            target: "组合名称"
            optional: true
          - source: "组合类型"
            target: "组合类型"
            optional: true

      # 产品线 (Product Line) reference table backfill
      # Note: 产品线代码 is derived by Pipeline Step 6 (业务类型 → 产品线代码)
      # via BUSINESS_TYPE_CODE_MAPPING in infrastructure/mappings/shared.py
      # FK Backfill runs AFTER pipeline, so 产品线代码 column will exist
      - name: "fk_product_line"
        source_column: "产品线代码"
        target_table: "产品线"
        target_key: "产品线代码"
        target_schema: "mapping"
        mode: "insert_missing"
        backfill_columns:
          - source: "产品线代码"
            target: "产品线代码"
          - source: "业务类型"
            target: "产品线"
            optional: true

      # 组织架构 (Organization) reference table backfill
      # Fixed 2025-12-13: source_column and target_key corrected to 机构代码
      # Edge case: "(空白)" values should be skipped (handled by skip_blank_values flag)
      - name: "fk_organization"
        source_column: "机构代码"
        target_table: "组织架构"
        target_key: "机构代码"
        target_schema: "mapping"
        mode: "insert_missing"
        skip_blank_values: true # Skip "(空白)" and empty values
        backfill_columns:
          - source: "机构代码"
            target: "机构代码"
          - source: "机构"
            target: "机构"
            optional: true

      # 年金客户 (Annuity Customer) reference table backfill
      # Story 7.3-7: Add company_id → 年金客户 FK relationship (BF-001)
      # Story 7.6: Table migrated from mapping to customer schema
      # Uses max_by aggregation (Story 6.2-P15) for 主拓机构代码/主拓机构
      - name: "fk_customer"
        source_column: "company_id"
        target_table: "年金客户"
        target_key: "company_id"
        target_schema: "customer"
        mode: "insert_missing"
        skip_blank_values: true # Skip temp IDs (IN*)
        backfill_columns:
          - source: "company_id"
            target: "company_id"
          - source: "客户名称"
            target: "客户名称"
            optional: true
          - source: "机构代码"
            target: "主拓机构代码"
            optional: true
            aggregation:
              type: "max_by"
              order_column: "期末资产规模"
          - source: "机构名称"
            target: "主拓机构"
            optional: true
            aggregation:
              type: "max_by"
              order_column: "期末资产规模"
          - source: "业务类型"
            target: "管理资格"
            optional: true
            aggregation:
              type: "concat_distinct"
              separator: "+"
              sort: true
          - source: "计划类型"
            target: "年金计划类型"
            optional: true
            aggregation:
              type: "concat_distinct"
              separator: "/"
              sort: true
          - source: "计划代码"
            target: "关键年金计划"
            optional: true
            aggregation:
              type: "max_by"
              order_column: "期末资产规模"
          - source: "计划代码"
            target: "其他年金计划"
            optional: true
            aggregation:
              type: "concat_distinct"
              separator: ","
              sort: true
          - source: "计划代码"
            target: "关联计划数"
            optional: true
            aggregation:
              type: "count_distinct"
          - source: "机构名称"
            target: "关联机构数"
            optional: true
            aggregation:
              type: "count_distinct"
          - source: "机构名称"
            target: "其他开拓机构"
            optional: true
            aggregation:
              type: "concat_distinct"
              separator: ","
              sort: true
          - source: "月度"
            target: "年金客户标签"
            optional: true
            aggregation:
              # 日期格式化: "2025-10-01" → strftime("%y%m") → "2510新建"
              type: "lambda"
              code: 'lambda g: pd.to_datetime(g["月度"].dropna().iloc[0]).strftime("%y%m") + "新建" if len(g["月度"].dropna()) > 0 else ""'
          # 固定值场景：template 无占位符 = 常量赋值（最简洁方式）
          - source: "月度"
            target: "年金客户类型"
            optional: true
            aggregation:
              type: "template"
              template: "新客"

  # Annuity Income Domain
  # Story 7.3-7: Add FK backfill configuration (parity with annuity_performance)
  # Reference: docs/specific/multi-domain/fk-backfill-gap-analysis.md (BF-002)
  # NOTE: fk_customer does NOT use max_by aggregation (期末资产规模 column not available)
  annuity_income:
    foreign_keys:
      # 年金计划 (Annuity Plan) reference table backfill
      - name: "fk_plan"
        source_column: "计划代码"
        target_table: "年金计划"
        target_key: "年金计划号"
        target_schema: "mapping"
        mode: "insert_missing"
        backfill_columns:
          - source: "计划代码"
            target: "年金计划号"
          - source: "计划名称"
            target: "计划全称"
            optional: true
          - source: "客户名称"
            target: "客户名称"
            optional: true
          - source: "company_id"
            target: "company_id"
            optional: true

      # 组合计划 (Portfolio Plan) reference table backfill
      - name: "fk_portfolio"
        source_column: "组合代码"
        target_table: "组合计划"
        target_key: "组合代码"
        target_schema: "mapping"
        mode: "insert_missing"
        depends_on: ["fk_plan"]
        backfill_columns:
          - source: "组合代码"
            target: "组合代码"
          - source: "计划代码"
            target: "年金计划号"
          - source: "组合名称"
            target: "组合名称"
            optional: true
          - source: "组合类型"
            target: "组合类型"
            optional: true

      # 产品线 (Product Line) reference table backfill
      - name: "fk_product_line"
        source_column: "产品线代码"
        target_table: "产品线"
        target_key: "产品线代码"
        target_schema: "mapping"
        mode: "insert_missing"
        backfill_columns:
          - source: "产品线代码"
            target: "产品线代码"
          - source: "业务类型"
            target: "产品线"
            optional: true

      # 组织架构 (Organization) reference table backfill
      - name: "fk_organization"
        source_column: "机构代码"
        target_table: "组织架构"
        target_key: "机构代码"
        target_schema: "mapping"
        mode: "insert_missing"
        skip_blank_values: true
        backfill_columns:
          - source: "机构代码"
            target: "机构代码"
          - source: "机构名称"
            target: "机构"
            optional: true

      # 年金客户 (Annuity Customer) reference table backfill
      # NOTE: No max_by aggregation - 期末资产规模 not available in annuity_income
      # Story 7.6: Table migrated from mapping to customer schema
      - name: "fk_customer"
        source_column: "company_id"
        target_table: "年金客户"
        target_key: "company_id"
        target_schema: "customer"
        mode: "insert_missing"
        skip_blank_values: true
        backfill_columns:
          - source: "company_id"
            target: "company_id"
          - source: "客户名称"
            target: "客户名称"
            optional: true
          - source: "机构代码"
            target: "主拓机构代码"
            optional: true
            aggregation:
              type: "max_by"
              order_column: "固费"
          - source: "机构名称"
            target: "主拓机构"
            optional: true
            aggregation:
              type: "max_by"
              order_column: "固费"
          - source: "计划代码"
            target: "关键年金计划"
            optional: true
            aggregation:
              type: "max_by"
              order_column: "固费"
          - source: "计划代码"
            target: "其他年金计划"
            optional: true
            aggregation:
              type: "concat_distinct"
              separator: ","
              sort: true
          - source: "计划代码"
            target: "关联计划数"
            optional: true
            aggregation:
              type: "count_distinct"
          - source: "机构名称"
            target: "关联机构数"
            optional: true
            aggregation:
              type: "count_distinct"
          - source: "机构名称"
            target: "其他开拓机构"
            optional: true
            aggregation:
              type: "concat_distinct"
              separator: ","
              sort: true
          - source: "月度"
            target: "年金客户标签"
            optional: true
            aggregation:
              # 日期格式化: "2025-10-01" → strftime("%y%m") → "2510新建"
              type: "lambda"
              code: 'lambda g: pd.to_datetime(g["月度"].dropna().iloc[0]).strftime("%y%m") + "新建" if len(g["月度"].dropna()) > 0 else ""'
          # 固定值场景：template 无占位符 = 常量赋值（最简洁方式）
          - source: "月度"
            target: "年金客户类型"
            optional: true
            aggregation:
              type: "template"
              template: "新客*"

  # Annual Award Domain (当年中标)
  # Story 7.6-17: FK backfill to 年金客户 table
  # Enhanced: Full column mapping with aggregations for multi-record scenarios
  annual_award:
    foreign_keys:
      # 年金客户 (Annuity Customer) reference table backfill
      - name: "fk_customer"
        source_column: "company_id"
        target_table: "年金客户"
        target_key: "company_id"
        target_schema: "customer"
        mode: "insert_missing"
        skip_blank_values: true
        backfill_columns:
          - source: "company_id"
            target: "company_id"
          - source: "客户名称"
            target: "客户名称"
            optional: true
          - source: "机构代码"
            target: "主拓机构代码"
            optional: true
            aggregation:
              type: "max_by"
              order_column: "计划规模"
          - source: "机构名称"
            target: "主拓机构"
            optional: true
            aggregation:
              type: "max_by"
              order_column: "计划规模"
          - source: "业务类型"
            target: "管理资格"
            optional: true
            aggregation:
              type: "concat_distinct"
              separator: "+"
              sort: true
          - source: "计划类型"
            target: "年金计划类型"
            optional: true
            aggregation:
              type: "concat_distinct"
              separator: "/"
              sort: true
          - source: "年金计划号"
            target: "关键年金计划"
            optional: true
            aggregation:
              type: "max_by"
              order_column: "计划规模"
          - source: "年金计划号"
            target: "其他年金计划"
            optional: true
            aggregation:
              type: "concat_distinct"
              separator: ","
              sort: true
          - source: "年金计划号"
            target: "关联计划数"
            optional: true
            aggregation:
              type: "count_distinct"
          - source: "机构名称"
            target: "关联机构数"
            optional: true
            aggregation:
              type: "count_distinct"
          - source: "机构名称"
            target: "其他开拓机构"
            optional: true
            aggregation:
              type: "concat_distinct"
              separator: ","
              sort: true
          - source: "上报月份"
            target: "tags"
            optional: true
            aggregation:
              type: "jsonb_append"
              code: 'lambda g: [pd.to_datetime(g["上报月份"].dropna().iloc[0]).strftime("%y%m") + "中标"] if len(g["上报月份"].dropna()) > 0 else []'
          - source: "上报月份"
            target: "年金客户类型"
            optional: true
            aggregation:
              type: "template"
              template: "中标客户"

  # Annual Loss Domain (当年流失)
  # Story 7.6-17: FK backfill to 年金客户 table
  # Enhanced: Full column mapping with aggregations for multi-record scenarios
  annual_loss:
    foreign_keys:
      # 年金客户 (Annuity Customer) reference table backfill
      - name: "fk_customer"
        source_column: "company_id"
        target_table: "年金客户"
        target_key: "company_id"
        target_schema: "customer"
        mode: "insert_missing"
        skip_blank_values: true
        backfill_columns:
          - source: "company_id"
            target: "company_id"
          - source: "客户名称"
            target: "客户名称"
            optional: true
          - source: "机构代码"
            target: "主拓机构代码"
            optional: true
            aggregation:
              type: "max_by"
              order_column: "计划规模"
          - source: "机构名称"
            target: "主拓机构"
            optional: true
            aggregation:
              type: "max_by"
              order_column: "计划规模"
          - source: "业务类型"
            target: "管理资格"
            optional: true
            aggregation:
              type: "concat_distinct"
              separator: "+"
              sort: true
          - source: "计划类型"
            target: "年金计划类型"
            optional: true
            aggregation:
              type: "concat_distinct"
              separator: "/"
              sort: true
          - source: "年金计划号"
            target: "关键年金计划"
            optional: true
            aggregation:
              type: "max_by"
              order_column: "计划规模"
          - source: "年金计划号"
            target: "其他年金计划"
            optional: true
            aggregation:
              type: "concat_distinct"
              separator: ","
              sort: true
          - source: "年金计划号"
            target: "关联计划数"
            optional: true
            aggregation:
              type: "count_distinct"
          - source: "机构名称"
            target: "关联机构数"
            optional: true
            aggregation:
              type: "count_distinct"
          - source: "机构名称"
            target: "其他开拓机构"
            optional: true
            aggregation:
              type: "concat_distinct"
              separator: ","
              sort: true
          - source: "上报月份"
            target: "tags"
            optional: true
            aggregation:
              type: "jsonb_append"
              code: 'lambda g: [pd.to_datetime(g["上报月份"].dropna().iloc[0]).strftime("%y%m") + "流失"] if len(g["上报月份"].dropna()) > 0 else []'
          - source: "上报月份"
            target: "年金客户类型"
            optional: true
            aggregation:
              type: "template"
              template: "流失客户"
